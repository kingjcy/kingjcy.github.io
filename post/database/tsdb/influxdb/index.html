<!DOCTYPE html>

<html lang="zh-cn">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="author" content="fatedier">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="description" content="InfluxDB是一个由InfluxData开发的开源时序型数据库。 它由Go写成，着力于高性能地查询与存储时序型数据。 InfluxDB被广泛应用于存储系统的监控数据，IoT行业的实时数据等场景。">
<meta property="og:url" content="https://kingjcy.github.io/"><meta property="og:type" content="article">
<meta property="og:title" content="Influxdb - kingjcy blog"><meta property="og:site_name" content="kingjcy blog">

<title>
    
    Influxdb
    
</title>

<link rel="stylesheet" href="/onlyone/onlyone.css">
<link rel="shortcut icon" href="/assets/favicon.ico">
<script src="/onlyone/onlyone.js"></script>
<link rel="alternate" type="application/rss+xml" title="RSS" href="/index.xml">
</head>
<body>


<div class="container">
    <header class="nav">
        <nav class="navbar navbar-default">
            <div class="container-fluid">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="/">kingjcy blog</a>
                </div>

                <div class="collapse navbar-collapse" id="navbar-collapse">
                    <ul class="nav navbar-nav">
                        <li><a href="/categories/技术文章/">技术文章</a></li>
                        <li><a href="/categories/读书笔记/">读书笔记</a></li>
                        <li><a href="/categories/人生感悟/">人生感悟</a></li>
                        <li><a href="/tags/">分类</a></li>
                        <li><a href="/about/">关于我</a></li>
                        <li>
                            <form method="get" style="padding: 8px" action="https://www.google.com/search" target="_blank">
                                <input type="hidden" name="sitesearch" value="kingjcy.github.io"/>
                                <input type="text" class="form-control" name="q" placeholder="Press enter to search">
                            </form>
                        </li>
                    </ul>

                </div>
            </div>
        </nav>
    </header>


<div class="row">
    <div class="col-md-8">
        <article class="post single">

            <header>
                <div class="post-date">
                    2018年04月17日 
                </div>
                <h1 class="post-title">Influxdb</h1>
            </header>

            <div class="post-content">
                <p>InfluxDB是一个由InfluxData开发的开源时序型数据库。 它由Go写成，着力于高性能地查询与存储时序型数据。 InfluxDB被广泛应用于存储系统的监控数据，IoT行业的实时数据等场景。</p>

<p>安装</p>

<p>wget <a href="https://dl.influxdata.com/influxdb/releases/influxdb-1.5.0.x86_64.rpm">https://dl.influxdata.com/influxdb/releases/influxdb-1.5.0.x86_64.rpm</a></p>

<p>yum localinstall influxdb-1.5.0.x86_64.rpm</p>

<p>InfluxDB在0.13版本以后，就默认关闭了web管理页面，而国内的文档大多都以旧版的InfluxDB为标准写的，所以下载安装好最新版本以后，就会出现8083端口的web管理页面访问不了的问题。</p>

<p>基础概念</p>

<pre><code>influxDB中的名词    传统数据库中的概念
database    数据库
measurement 数据库中的表
points  表里面的一行数据
</code></pre>

<p>1）Point</p>

<p>Point由时间戳（time）、数据（field）、标签（tags）组成。</p>

<p>Point相当于传统数据库里的一行数据，如下表所示：</p>

<pre><code>Point属性 传统数据库中的概念
time    每个数据记录时间，是数据库中的主索引(会自动生成)
fields  各种记录值（没有索引的属性）也就是记录的值：温度， 湿度
tags    各种有索引的属性：地区，海拔
</code></pre>

<p>2）series</p>

<pre><code>所有在数据库中的数据，都需要通过图表来展示，而这个series表示这个表里面的数据，可以在图表上画成几条线：通过tags排列组合算出来。
</code></pre>

<p>如下所示：</p>

<pre><code>&gt;show series from cpu
key
cpu,cpu=cpu-total,host=ResourcePool-0246-billing07
cpu,cpu=cpu-total,host=billing07
cpu,cpu=cpu0,host=ResourcePool-0246-billing07
cpu,cpu=cpu0,host=billing07
cpu,cpu=cpu1,host=ResourcePool-0246-billing07
cpu,cpu=cpu1,host=billing07
cpu,cpu=cpu10,host=ResourcePool-0246-billing07
cpu,cpu=cpu10,host=billing07
cpu,cpu=cpu11,host=ResourcePool-0246-billing07
cpu,cpu=cpu11,host=billing07
cpu,cpu=cpu12,host=ResourcePool-0246-billing07
cpu,cpu=cpu12,host=billing07
cpu,cpu=cpu13,host=ResourcePool-0246-billing07
cpu,cpu=cpu13,host=billing07
cpu,cpu=cpu14,host=ResourcePool-0246-billing07
cpu,cpu=cpu14,host=billing07
cpu,cpu=cpu15,host=ResourcePool-0246-billing07
cpu,cpu=cpu15,host=billing07
cpu,cpu=cpu16,host=ResourcePool-0246-billing07
cpu,cpu=cpu17,host=ResourcePool-0246-billing07
cpu,cpu=cpu18,host=ResourcePool-0246-billing07
cpu,cpu=cpu19,host=ResourcePool-0246-billing07
cpu,cpu=cpu2,host=ResourcePool-0246-billing07
cpu,cpu=cpu2,host=billing07
cpu,cpu=cpu20,host=ResourcePool-0246-billing07
cpu,cpu=cpu21,host=ResourcePool-0246-billing07
cpu,cpu=cpu22,host=ResourcePool-0246-billing07
cpu,cpu=cpu23,host=ResourcePool-0246-billing07
cpu,cpu=cpu3,host=ResourcePool-0246-billing07
cpu,cpu=cpu3,host=billing07
cpu,cpu=cpu4,host=ResourcePool-0246-billing07
cpu,cpu=cpu4,host=billing07
cpu,cpu=cpu5,host=ResourcePool-0246-billing07
cpu,cpu=cpu5,host=billing07
cpu,cpu=cpu6,host=ResourcePool-0246-billing07
cpu,cpu=cpu6,host=billing07
cpu,cpu=cpu7,host=ResourcePool-0246-billing07
cpu,cpu=cpu7,host=billing07
cpu,cpu=cpu8,host=ResourcePool-0246-billing07
cpu,cpu=cpu8,host=billing07
cpu,cpu=cpu9,host=ResourcePool-0246-billing07
cpu,cpu=cpu9,host=billing07
</code></pre>

<p>数据库操作</p>

<p>库类似mysql</p>

<pre><code>show databases
create database test
drop database test
use xk_name
</code></pre>

<p>表</p>

<p>在InfluxDB当中，并没有表（table）这个概念，取而代之的是MEASUREMENTS，MEASUREMENTS的功能与传统数据库中的表一致，因此我们也可以将MEASUREMENTS称为InfluxDB中的表。</p>

<p>SHOW MEASUREMENTS</p>

<p>新建表</p>

<p>InfluxDB中没有显式的新建表的语句，只能通过insert数据的方式来建立新表。如下所示：</p>

<pre><code>insert disk_free,hostname=server01 value=442221834240i 1435362189575692182
</code></pre>

<p>其中 disk_free 就是表名，hostname是索引，value=xx是记录值，记录值可以有多个，最后是指定的时间</p>

<p>执行后结果如下</p>

<pre><code>&gt; select * from disk_free
name: disk_free
---------------
time            hostname    value
1435362189575692182    server01    442221834240
</code></pre>

<p>删除表</p>

<pre><code>&gt; drop measurement disk_free
</code></pre>

<p>增加数据</p>

<p>增加数据采用insert的方式，要注意的是 InfluxDB的insert中，表名与数据之间用逗号（,）分隔，tag和field之间用 空格分隔，多个tag或者多个field之间用逗号（,）分隔。</p>

<pre><code>&gt; insert disk_free,hostname=server01 value=442221834240i 1435362189575692182
&gt; select * from disk_free
name: disk_free
---------------
time            hostname    value
1435362189575692182    server01    442221834240
</code></pre>

<p>在这条语句中，disk_free是表名,hostname=server01是tag，属于索引，value=xx是field，这个可以随意写，随意定义。</p>

<p>2）查询数据</p>

<pre><code>查询语句与SQL一样，在此不再赘述。
</code></pre>

<p>3）修改和删除数据</p>

<p>InfluxDB属于时序数据库，没有提供修改和删除数据的方法。</p>

<p>但是删除可以通过InfluxDB的数据保存策略（Retention Policies）来实现，这个会在以后的文章中讲到。</p>

<p>1）查询策略</p>

<p>可以通过如下语句查看数据库的现有策略：</p>

<pre><code>&gt; SHOW RETENTION POLICIES ON telegraf
name    duration    shardGroupDuration    replicaN    default
default    0        168h0m0s        1        true
</code></pre>

<p>可以看到，telegraf只有一个策略，各字段的含义如下：</p>

<p>name&ndash;名称，此示例名称为 default</p>

<p>duration&ndash;持续时间，0代表无限制</p>

<p>shardGroupDuration&ndash;shardGroup的存储时间，shardGroup是InfluxDB的一个基本储存结构，应该大于这个时间的数据在查询效率上应该有所降低。</p>

<p>replicaN&ndash;全称是REPLICATION，副本个数</p>

<p>default&ndash;是否是默认策略</p>

<p>2）新建策略</p>

<pre><code>&gt; CREATE RETENTION POLICY &quot;2_hours&quot; ON &quot;telegraf&quot; DURATION 2h REPLICATION 1 DEFAULT
&gt; SHOW RETENTION POLICIES ON telegraf
name    duration    shardGroupDuration    replicaN    default
default    0        168h0m0s        1        false
2_hours    2h0m0s        1h0m0s            1        true
</code></pre>

<p>通过上面的语句可以添加策略，本例在 telegraf 库添加了一个2小时的策略，名字叫做 2_hours， duration为2小时，副本为1，设置为默认策略。</p>

<p>因为名为default的策略不再是默认策略，因此，在查询使用default策略的表时要显式的加上策略名 “default”。</p>

<pre><code>&gt; select * from &quot;default&quot;.cpu limit 2
name: cpu
---------
time            cpu        host                host_id    usage_guest    usage_guest_nice    usage_idle   usage_iowait        usage_irq    usage_nice        usage_softirq    usage_steal    usage_system        usage_user
1467884670000000000    cpu-total    ResourcePool-0246-billing07        0        0            99.79994164175388    0            0        0.06251823446523729    0        0        0.12920435125646068    0.008335764603451727
1467884670000000000    cpu9        billing07                0        0            97.79338014069532    1.8054162487519367    0        0            0        0        0.10030090272883943    0.3009027081135398
</code></pre>

<p>3）修改策略</p>

<p>修改策略使用如下语句修改</p>

<pre><code>&gt; ALTER RETENTION POLICY &quot;2_hours&quot; ON &quot;telegraf&quot; DURATION 4h DEFAULT
&gt; show retention POLICIES on telegraf
name    duration    shardGroupDuration    replicaN    default
default    0        168h0m0s        1        false
2_hours    4h0m0s        1h0m0s            1        true
</code></pre>

<p>可以看到，修改后的策略发生了变化。</p>

<p>4）删除策略</p>

<p>InfluxDB中策略的删除操作如下所示：</p>

<pre><code>&gt; drop retention POLICY &quot;2_hours&quot; ON &quot;telegraf&quot;
&gt; show retention POLICIES on telegraf
name    duration    shardGroupDuration    replicaN    default
default    0        168h0m0s        1        false
</code></pre>

<p>可以看到，名为2_hours的策略已经被删除了。</p>

<p>四、其他说明</p>

<p>策略这个关键词“POLICY”在使用是应该大写，小写应该会出粗。</p>

<p>当一个表使用的策略不是默认策略时，在进行操作时一定要显式的指定策略名称，否则会出现错误。</p>

<p>查看当前数据库的Retention Policies</p>

<pre><code>SHOW RETENTION POLICIES ON &quot;testDB&quot;
</code></pre>

<p>创建新的Retention Policies</p>

<p>CREATE RETENTION POLICY &ldquo;rp_name&rdquo; ON &ldquo;db_name&rdquo; DURATION 30d REPLICATION 1 DEFAULT</p>

<p>其中：</p>

<pre><code>rp_name：策略名
db_name：具体的数据库名
30d：保存30天，30天之前的数据将被删除
它具有各种时间参数，比如：h（小时），w（星期）
REPLICATION 1：副本个数，这里填1就可以了
DEFAULT 设为默认的策略
</code></pre>

<p>修改Retention Policies</p>

<pre><code>ALTER RETENTION POLICY &quot;rp_name&quot; ON db_name&quot; DURATION 3w DEFAULT
</code></pre>

<p>删除Retention Policies</p>

<pre><code>DROP RETENTION POLICY &quot;rp_name&quot; ON &quot;db_name&quot;
</code></pre>

<p>连续查询（Continuous Queries）</p>

<p>当数据超过保存策略里指定的时间之后，就会被删除。</p>

<p>如果我们不想完全删除掉，比如做一个数据统计采样：把原先每秒的数据，存为每小时的数据，让数据占用的空间大大减少（以降低精度为代价）。</p>

<p>这就需要InfluxDB提供的：连续查询（Continuous Queries）。</p>

<p>当前数据库的Continuous Queries</p>

<p>这条命令得在命令行下输入，在web管理界面不能显示。</p>

<pre><code>SHOW CONTINUOUS QUERIES
</code></pre>

<p>创建新的Continuous Queries</p>

<pre><code>&gt; CREATE CONTINUOUS QUERY cq_30m ON testDB BEGIN SELECT mean(temperature) INTO weather30m FROM weather GROUP BY time(30m) END
</code></pre>

<p>其中：
    cq_30m：连续查询的名字
    testDB：具体的数据库名
    mean(temperature): 算平均温度
    weather： 当前表名
    weather30m： 存新数据的表名
    30m：时间间隔为30分钟</p>

<p>当我们插入新数据之后，可以发现数据库中多了一张名为weather30m(里面已经存着计算好的数据了)。这一切都是通过Continuous Queries自动完成的。</p>

<pre><code>&gt; SHOW MEASUREMENTS
name: measurements
------------------
name
weather
weather30m
删除Continuous Queries
DROP CONTINUOUS QUERY &lt;cq_name&gt; ON &lt;database_name&gt;
</code></pre>

<p>以下语句都可以直接在InfluxDB的Web管理界面中调用</p>

<p>显示用户</p>

<pre><code>SHOW USERS
</code></pre>

<p>创建用户</p>

<pre><code>CREATE USER &quot;username&quot; WITH PASSWORD 'password'
</code></pre>

<p>创建管理员权限的用户</p>

<pre><code>CREATE USER &quot;username&quot; WITH PASSWORD 'password' WITH ALL PRIVILEGES
</code></pre>

<p>删除用户</p>

<pre><code>DROP USER &quot;username&quot;
</code></pre>
            </div>
            
            <div style="border: 1px dashed #e0e0e0; margin-bottom: 15px; padding: 10px 10px 10px 10px; background-color: #fffeee; background-repeat: no-repeat; background-attachment: scroll; background-position: 1% 50%; -moz-background-size: auto auto; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial;">
                <div>
                    <p style="margin-top:0px;">作者：<a target="_blank" href="http://blog.fatedier.com/">kingjcy</a>
                    <br />本文出处：<a target="_blank" href="https://kingjcy.github.io/post/database/tsdb/influxdb/">https://kingjcy.github.io/post/database/tsdb/influxdb/</a>
                    <br />
                    文章版权归本人所有，欢迎转载，但未经作者同意必须保留此段声明，且在文章页面明显位置给出原文链接，否则保留追究法律责任的权利。 </p>
                </div>
            </div>

            <aside>
                
                <ul class="list-inline post-tags">
                    
                    <li>
                        <a href="/tags/influxdb/">
                            <i class="fa fa-tags"></i>
                            Influxdb
                        </a>
                    </li>
                    
                </ul>

                
                
                <h4 id="real-rels">相关文章</h4>
                <ul class="post-rels" id="real-rels"></ul>
            </aside>
                
            
            <footer>
                <nav>
                    <ul class="pager">

                        
                        <li class="previous"><a href="/post/architecture/heartbeat/"><span aria-hidden="true">&larr;</span> Prev</a></li>
                        

                        <li><a href="/post/">All Posts</a></li>

                        
                        <li class="next"><a href="/post/monitor/prometheus/ui/grafana/">Next <span aria-hidden="true">&rarr;</span></a></li>
                        

                    </ul>
                </nav>
            </footer>

        </article>
    </div>
    <div class="col-md-4">
        
<aside>
        <div class="toc panel panel-default hidden-xs hidden-sm affix-top" data-spy="affix" data-offset-top="125" data-offset-bottom="300">
            <div class="panel-heading">
                <h2 class="panel-title">Catalog</h2>
            </div>

            
        </div>
</aside>

    </div>
</div>

</div>
<hr>

<footer class="container copy">
    <p>&copy; 2020  kingjcy blog </p>
	<p>Powered by <a href="https://gohugo.io" target="_blank">Hugo</a></p>
</footer>

<script>hljs.initHighlightingOnLoad();</script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?ace3ec99de96c4080ead1eb8d52db3b3";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-92600390-2', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

