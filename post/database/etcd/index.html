<!DOCTYPE html>

<html lang="zh-cn">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="author" content="fatedier">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="description" content="ETCD是用于共享配置和服务发现的分布式，一致性的KV存储系统。是一款类似于zk有望取代复杂的zk的用go语言开发的存储系统。

flannel是一款针对kubernetes设计的网络规划服务，它的目的就是让集群中的不同节点主机创建的Docker容器都具有全集群唯一的虚拟IP地址。">
<meta property="og:url" content="https://kingjcy.github.io/"><meta property="og:type" content="article">
<meta property="og:title" content="Etcd  - kingjcy blog"><meta property="og:site_name" content="kingjcy blog">

<title>
    
    Etcd 
    
</title>

<link rel="stylesheet" href="/onlyone/onlyone.css">
<link rel="shortcut icon" href="/assets/favicon.ico">
<script src="/onlyone/onlyone.js"></script>
<link rel="alternate" type="application/rss+xml" title="RSS" href="/index.xml">
</head>
<body>


<div class="container">
    <header class="nav">
        <nav class="navbar navbar-default">
            <div class="container-fluid">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="/">kingjcy blog</a>
                </div>

                <div class="collapse navbar-collapse" id="navbar-collapse">
                    <ul class="nav navbar-nav">
                        <li><a href="/categories/技术文章/">技术文章</a></li>
                        <li><a href="/categories/读书笔记/">读书笔记</a></li>
                        <li><a href="/categories/人生感悟/">人生感悟</a></li>
                        <li><a href="/tags/">分类</a></li>
                        <li><a href="/about/">关于我</a></li>
                        <li>
                            <form method="get" style="padding: 8px" action="https://www.google.com/search" target="_blank">
                                <input type="hidden" name="sitesearch" value="kingjcy.github.io"/>
                                <input type="text" class="form-control" name="q" placeholder="Press enter to search">
                            </form>
                        </li>
                    </ul>

                </div>
            </div>
        </nav>
    </header>


<div class="row">
    <div class="col-md-8">
        <article class="post single">

            <header>
                <div class="post-date">
                    2017年02月14日 
                </div>
                <h1 class="post-title">Etcd </h1>
            </header>

            <div class="post-content">
                <p>ETCD是用于共享配置和服务发现的分布式，一致性的KV存储系统。是一款类似于zk有望取代复杂的zk的用go语言开发的存储系统。</p>

<p>flannel是一款针对kubernetes设计的网络规划服务，它的目的就是让集群中的不同节点主机创建的Docker容器都具有全集群唯一的虚拟IP地址。</p>

<h1 id="etcd">etcd</h1>

<p>etcd有着几方面的优势：</p>

<ul>
<li><p>一致性协议： ETCD使用[Raft]协议， ZK使用ZAB（类PAXOS协议），前者容易理解，方便工程实现；</p>

<p>etcd采用对是强一致性。</p>

<p>一致性又可以分为强一致性与弱一致性。
强一致性可以理解为一致性又可以分为强一致性与弱一致性。
强一致性可以理解为在任意时刻，所有节点中的数据是一样的。同一时间点，你在节点A中获取到key1的值与在节点B中获取到key1的值应该都是一样的。
弱一致性包含很多种不同的实现，目前分布式系统中广泛实现的是最终一致性。
所谓最终一致性，就是不保证在任意时刻任意节点上的同一份数据都是相同的，但是随着时间的迁移，不同节点上的同一份数据总是在向趋同的方向变化。也可以简单的理解为在一段时间后，节点间的数据会最终达到一致状态。</p></li>

<li><p>运维方面：ETCD方便运维，ZK难以运维；</p></li>

<li><p>项目活跃度：ETCD社区与开发活跃，ZK已经快死了；</p></li>

<li><p>API：ETCD提供HTTP+JSON, gRPC接口，跨平台跨语言，ZK需要使用其客户端；</p></li>

<li><p>访问安全方面：ETCD支持HTTPS访问，ZK在这方面缺失；</p></li>
</ul>

<p>etcd的使用场景和zk相似</p>

<ul>
<li>配置管理</li>
<li>服务注册于发现</li>
<li>选主</li>
<li>应用调度</li>
<li>分布式队列</li>
<li>分布式锁</li>
</ul>

<h2 id="安装">安装</h2>

<p>安装比较简单，直接去开源的github上去下在压缩包，然后解压就有对应的可执行文件，可以将可执行文件etcd，etcdctl复制到/usr/bin下面使用</p>

<h2 id="集群部署">集群部署</h2>

<p>静态部署用命令直接启动</p>

<p>node1</p>

<pre><code>etcd -name niub1 -debug \
-initial-advertise-peer-urls http://node1-ip:2380 \
-listen-peer-urls http://node1-ip:2380 \
-listen-client-urls http://node1-ip:2379,http://127.0.0.1:2379 \
-advertise-client-urls http://node1-ip:2379 \
-initial-cluster-token etcd-cluster-1 \
-initial-cluster niub1=http://node1-ip:2380,niub2=http://node2-ip:2380,niub3=http://node3-ip:2380 \
-initial-cluster-state new  &gt;&gt; ./etcd.log 2&gt;&amp;1 &amp;
</code></pre>

<p>node2</p>

<pre><code>etcd -name niub2 -debug \
-initial-advertise-peer-urls http://node2-ip:2380 \
-listen-peer-urls http://node2-ip:2380 \
-listen-client-urls http://node2-ip:2379,http://127.0.0.1:2379 \
-advertise-client-urls http://node2-ip:2379 \
-initial-cluster-token etcd-cluster-1 \
-initial-cluster niub1=http://node1-ip:2380,niub2=http://node2-ip:2380,niub3=http://node3-ip:2380 \
-initial-cluster-state new  &gt;&gt; ./etcd.log 2&gt;&amp;1 &amp;
</code></pre>

<p>node3</p>

<pre><code>etcd -name niub3 -debug \
-initial-advertise-peer-urls http://node3-ip:2380 \
-listen-peer-urls http://node3-ip:2380 \
-listen-client-urls http://node3-ip:2379,http://127.0.0.1:2379 \
-advertise-client-urls http://node3-ip:2379 \
-initial-cluster-token etcd-cluster-1 \
-initial-cluster niub1=http://node1-ip:2380,niub2=http://node2-ip:2380,niub3=http://node3-ip:2380 \
-initial-cluster-state new  &gt;&gt; ./etcd.log 2&gt;&amp;1 &amp;
</code></pre>

<p>然后就可以检查一下对集群情况了</p>

<pre><code>etcdctl member list
curl http://10.10.0.14:2379/v2/members
</code></pre>

<p>两种放肆都能返回三个节点的相关情况，也可以使用</p>

<pre><code>etcdctl cluster-health
</code></pre>

<p>这样etcd的集群就搭建成功了。</p>

<p>正常会将其加入到系统服务中，首先创建设置配置文件</p>

<pre><code>cat /etc/etcd/etcd.conf

# [member]
ETCD_NAME=&quot;etcd-2&quot;
ETCD_DATA_DIR=&quot;/data/etcd/&quot;
#ETCD_WAL_DIR=&quot;&quot;
#ETCD_SNAPSHOT_COUNT=&quot;10000&quot;
#ETCD_HEARTBEAT_INTERVAL=&quot;100&quot;
#ETCD_ELECTION_TIMEOUT=&quot;1000&quot;
#ETCD_LISTEN_PEER_URLS=&quot;http://localhost:2380&quot;
#ETCD_LISTEN_CLIENT_URLS=&quot;http://localhost:2379&quot;
ETCD_LISTEN_PEER_URLS=&quot;http://0.0.0.0:7001&quot;
ETCD_LISTEN_CLIENT_URLS=&quot;http://0.0.0.0:4001&quot;
#ETCD_MAX_SNAPSHOTS=&quot;5&quot;
#ETCD_MAX_WALS=&quot;5&quot;
#ETCD_CORS=&quot;&quot;
#
#[cluster]
#ETCD_INITIAL_ADVERTISE_PEER_URLS=&quot;http://localhost:2380&quot;
ETCD_INITIAL_ADVERTISE_PEER_URLS=&quot;http://172.32.148.128:7001&quot;
# if you use different ETCD_NAME (e.g. test), set ETCD_INITIAL_CLUSTER value for this name, i.e. &quot;test=http://...&quot;
#ETCD_INITIAL_CLUSTER=&quot;default=http://localhost:2380&quot;
ETCD_INITIAL_CLUSTER=&quot;etcd-1=http://172.32.148.127:7001,etcd-2=http://172.32.148.128:7001,etcd-3=http://172.32.148.129:7001,etcd-4=http://172.32.148.130:7001&quot;
ETCD_INITIAL_CLUSTER_STATE=&quot;new&quot;
#ETCD_INITIAL_CLUSTER_TOKEN=&quot;etcd-cluster&quot;
#ETCD_ADVERTISE_CLIENT_URLS=&quot;http://localhost:2379&quot;
ETCD_ADVERTISE_CLIENT_URLS=&quot;http://172.32.148.128:4001&quot;
#ETCD_DISCOVERY=&quot;&quot;
#ETCD_DISCOVERY_SRV=&quot;&quot;
#ETCD_DISCOVERY_FALLBACK=&quot;proxy&quot;
#ETCD_DISCOVERY_PROXY=&quot;&quot;
#ETCD_STRICT_RECONFIG_CHECK=&quot;false&quot;
#ETCD_AUTO_COMPACTION_RETENTION=&quot;0&quot;
.......
</code></pre>

<p>然后增加开机启动配置</p>

<pre><code>cat /uusr/lib/systemd/system/etcd.service

[Unit]
Description=Etcd Server
After=network.target
After=network-online.target
Wants=network-online.target

[Service]
Type=notify
WorkingDirectory=/var/lib/etcd/
EnvironmentFile=-/etc/etcd/etcd.conf
User=root
# set GOMAXPROCS to number of processors
#ExecStart=/bin/bash -c &quot;GOMAXPROCS=$(nproc) /usr/bin/etcd --name=\&quot;${
ETCD_NAME}\&quot; --data-dir=\&quot;${
ETCD_DATA_DIR}\&quot; --listen-client-urls=\&quot;${
ETCD_LISTEN_CLIENT_URLS}\&quot;&quot;


ExecStart=/bin/bash -c &quot;GOMAXPROCS=$(nproc) /usr/bin/etcd --name=\&quot;${
ETCD_NAME}\&quot; --data-dir=\&quot;${
ETCD_DATA_DIR}\&quot; --listen-client-urls=\&quot;${
ETCD_LISTEN_CLIENT_URLS}\&quot; --listen-peer-urls=\&quot;${
ETCD_LISTEN_PEER_URLS}\&quot; --advertise-client-urls=\&quot;${
ETCD_ADVERTISE_CLIENT_URLS}\&quot; --initial-advertise-peer-urls=\&quot;${
ETCD_INITIAL_ADVERTISE_PEER_URLS}\&quot; --initial-cluster=\&quot;${
ETCD_INITIAL_CLUSTER}\&quot; --initial-cluster-state=\&quot;${
ETCD_INITIAL_CLUSTER_STATE}\&quot;&quot;


Restart=on-failure
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
</code></pre>

<p>当然我们可以使用别人的rpm包来安装，就有现成的配置文件，我们在上面修改就行了。</p>

<p>下面我们来来系统启动etcd</p>

<pre><code>systemctl daemon-reload
systemctl enable etcd.service
systemctl start etcd.service
</code></pre>

<p>可以检查集群了，有一些需要主要的地方，一个就是服务的用户要有对应目录的权限。</p>

<h2 id="使用">使用</h2>

<p>直接参考官方的md文件。就是正常的key/value类型的数据库的使用方法，类似于redis的使用。</p>

<p>重安全到非安全</p>

<p>只要删除参数重的ca配置</p>

<p>输出数据目录数据</p>

<p>rm -rf /var/lib/etcd/*</p>

<h1 id="flannel">flannel</h1>

<h2 id="安装-1">安装</h2>

<p>这个和etcd一样，到开源到github上下载一个二进制文件可以直接使用，这个是建立在etcd到基础上使用的。</p>

<h2 id="使用-1">使用</h2>

<p>首先创建一个配置文件flannel-config.json</p>

<pre><code>{
    &quot;Network&quot;: &quot;172.17.0.0/16&quot;,
    &quot;SubnetLen&quot;: 24,
    &quot;Backend&quot;: {
        &quot;Type&quot;: &quot;vxlan&quot;,
        &quot;VNI&quot;: 1
     }
 }
</code></pre>

<p>首先在etcd集群中插入数据，也是flannel启动的时候需要读取的,这个就设定flannel分配ip的地址段。</p>

<pre><code>etcdctl --no-sync --peers &quot;http://ETCD IP:2379&quot; set /newland.com/network/config &lt; flannel-config.json
</code></pre>

<p>然后在每个节点分别启动Flannel：</p>

<pre><code>flanneld &amp;
</code></pre>

<p>最后需要给Docker动一点手脚，修改它的启动参数和docker0地址。</p>

<p>在每个节点上执行：</p>

<pre><code>sudo mk-docker-opts.sh -i
source /run/flannel/subnet.env
sudo rm /var/run/docker.pid
sudo ifconfig docker0 ${FLANNEL_SUBNET} 
</code></pre>

<p>重启动一次Docker，这样配置就完成了。</p>

<p>现在在两个节点分别启动一个Docker容器，它们之间已经通过IP地址直接相互ping通了。</p>

<p>到此，整个Flannel集群也就正常运行了。</p>

<p>最后，前面反复提到过Flannel有一个保存在Etcd的路由表，可以在Etcd数据中找到这些路由记录。</p>
            </div>
            
            <div style="border: 1px dashed #e0e0e0; margin-bottom: 15px; padding: 10px 10px 10px 10px; background-color: #fffeee; background-repeat: no-repeat; background-attachment: scroll; background-position: 1% 50%; -moz-background-size: auto auto; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial;">
                <div>
                    <p style="margin-top:0px;">作者：<a target="_blank" href="http://blog.fatedier.com/">kingjcy</a>
                    <br />本文出处：<a target="_blank" href="https://kingjcy.github.io/post/database/etcd/">https://kingjcy.github.io/post/database/etcd/</a>
                    <br />
                    文章版权归本人所有，欢迎转载，但未经作者同意必须保留此段声明，且在文章页面明显位置给出原文链接，否则保留追究法律责任的权利。 </p>
                </div>
            </div>

            <aside>
                
                <ul class="list-inline post-tags">
                    
                    <li>
                        <a href="/tags/etcd/">
                            <i class="fa fa-tags"></i>
                            Etcd
                        </a>
                    </li>
                    
                </ul>

                
                
                <h4 id="real-rels">相关文章</h4>
                <ul class="post-rels" id="real-rels"></ul>
            </aside>
                
            
            <footer>
                <nav>
                    <ul class="pager">

                        
                        <li class="previous"><a href="/post/database/redis/redis_cluster/"><span aria-hidden="true">&larr;</span> Prev</a></li>
                        

                        <li><a href="/post/">All Posts</a></li>

                        
                        <li class="next"><a href="/post/database/event/">Next <span aria-hidden="true">&rarr;</span></a></li>
                        

                    </ul>
                </nav>
            </footer>

        </article>
    </div>
    <div class="col-md-4">
        
<aside>
        <div class="toc panel panel-default hidden-xs hidden-sm affix-top" data-spy="affix" data-offset-top="125" data-offset-bottom="300">
            <div class="panel-heading">
                <h2 class="panel-title">Catalog</h2>
            </div>

            <nav id="TableOfContents">
<ul>
<li><a href="#etcd">etcd</a>
<ul>
<li><a href="#安装">安装</a></li>
<li><a href="#集群部署">集群部署</a></li>
<li><a href="#使用">使用</a></li>
</ul></li>
<li><a href="#flannel">flannel</a>
<ul>
<li><a href="#安装-1">安装</a></li>
<li><a href="#使用-1">使用</a></li>
</ul></li>
</ul>
</nav>
        </div>
</aside>

    </div>
</div>

</div>
<hr>

<footer class="container copy">
    <p>&copy; 2020  kingjcy blog </p>
	<p>Powered by <a href="https://gohugo.io" target="_blank">Hugo</a></p>
</footer>

<script>hljs.initHighlightingOnLoad();</script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?ace3ec99de96c4080ead1eb8d52db3b3";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-92600390-2', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

