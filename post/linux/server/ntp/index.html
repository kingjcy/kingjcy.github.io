<!DOCTYPE html>

<html lang="zh-cn">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="author" content="fatedier">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="description" content="NTP是网络时间协议(Network Time Protocol)，它是用来同步网络中各个计算机的时间的协议。">
<meta property="og:url" content="https://kingjcy.github.io/"><meta property="og:type" content="article">
<meta property="og:title" content="Ntp - kingjcy blog"><meta property="og:site_name" content="kingjcy blog">

<title>
    
    Ntp
    
</title>

<link rel="stylesheet" href="/onlyone/onlyone.css">
<link rel="shortcut icon" href="/assets/favicon.ico">
<script src="/onlyone/onlyone.js"></script>
<link rel="alternate" type="application/rss+xml" title="RSS" href="/index.xml">
</head>
<body>


<div class="container">
    <header class="nav">
        <nav class="navbar navbar-default">
            <div class="container-fluid">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="/">kingjcy blog</a>
                </div>

                <div class="collapse navbar-collapse" id="navbar-collapse">
                    <ul class="nav navbar-nav">
                        <li><a href="/categories/技术文章/">技术文章</a></li>
                        <li><a href="/categories/读书笔记/">读书笔记</a></li>
                        <li><a href="/categories/人生感悟/">人生感悟</a></li>
                        <li><a href="/tags/">分类</a></li>
                        <li><a href="/about/">关于我</a></li>
                        <li>
                            <form method="get" style="padding: 8px" action="https://www.google.com/search" target="_blank">
                                <input type="hidden" name="sitesearch" value="kingjcy.github.io"/>
                                <input type="text" class="form-control" name="q" placeholder="Press enter to search">
                            </form>
                        </li>
                    </ul>

                </div>
            </div>
        </nav>
    </header>


<div class="row">
    <div class="col-md-8">
        <article class="post single">

            <header>
                <div class="post-date">
                    0001年01月01日 
                </div>
                <h1 class="post-title">Ntp</h1>
            </header>

            <div class="post-content">
                <p>NTP是网络时间协议(Network Time Protocol)，它是用来同步网络中各个计算机的时间的协议。</p>

<h2 id="时区">时区</h2>

<p>地球就被分成 24 个时区，</p>

<p>标准时间：</p>

<p>在 1880 年代的时间标准是以 GMT 时间为主的，但是 GMT 时间是以太阳通过格林威治的那一刻来作为计时的标准。 然而我们都知道啊，地球自转的轨道以及公转的轨道并非正圆，加上地球的自转速度好像有逐年递减的问题， 所以这个 GMT 时间与我们目前计时的时间就有点不一样了</p>

<p>在计算时间的时候，最准确的计算应该是使用『原子震荡周期』所计算的物理时钟了 (Atomic Clock, 也被称为原子钟)，这也被定义为标准时间 (International Atomic Time)。而我们常常看见的 UTC 也就是 Coordinated Universal Time (协和标准时间)就是利用这种 Atomic Clock 为基准所定义出来的正确时间。</p>

<p>我们的时间：</p>

<p>我们处于东八区，是就是在utc的时间上加8h</p>

<p>上述在日志中可能使用，了解其概念。</p>

<p>闰秒</p>

<p>闰秒是在UTC（中文“世界标准时间”或“世界协调时间”／英文“Coordinated Universal Time”／法文“Temps Universel Cordonné”）向Atomic Clock（原子时钟）对齐的一种方法，因为UTC是民用时间，其精确值是毫秒，而Atomic Clock精确值是纳秒，所以，1972年制定的UTC为了确保其时间相对于Atomic Clock的时间误差不能超过0.9秒，因为在过一段时间后需要加一秒。下图是有UTC以来闰秒的调整表</p>

<p>那么，我们的操作系统是怎么处理正闰秒通知的？通常来说有三种实现：</p>

<p>● 后退一秒。</p>

<p>● 停止一秒。</p>

<p>● 真正的增加一秒。</p>

<h2 id="ntp">ntp</h2>

<ol>
<li>缘由</li>
</ol>

<p>Linux 操作系统的计时方式主要是由 1970/01/01 开始计算总秒数，因此，如果你还记得 date 这个指令的话， 会发现它有个 +%s 的参数，可以取得总秒数，这个就是软件时钟。但，如同前面说的，计算机硬件主要是以 BIOS 内部的时间为主要的时间依据 (硬件时钟)，而偏偏这个时间可能因为 BIOS 内部芯片本身的问题，而导致 BIOS 时间与标准时间 (UTC) 有一点点的差异存在！所以为了避免主机时间因为长期运作下所导致的时间偏差，进行时间同步 (synchronize) 的工作就显的很重要了！所以就要用ntp了</p>

<pre><code>软件时钟：由 Linux 操作系统根据 1970/01/01 开始计算的总秒数；
硬件时钟：主机硬件系统上面的时钟，例如 BIOS 记录的时间；
</code></pre>

<ol>
<li><p>Network Time Protocol 工作原理</p>

<p>首先，主机当然需要启动这个 daemon ，之后，
Client 会向 NTP Server 发送出调校时间的 message ，
然后 NTP Server 会送出目前的标准时间给 Client ，
Client 接收了来自 Server 的时间后，会据以调整自己的时间，就达成了网络校时咯！</p></li>

<li><p>客户端</p></li>

<li><p>ntpd</p></li>

<li><p>ntp是一个时间服务。可以同步时间源</p></li>

<li><p>采用柔性时间调整策略，让时间的变化和调整尽量减少对业务的影响。</p></li>

<li><p>不盲目相信远端时钟，服务器时间和远端时钟超过恐慌阈值（默认1000秒），ntp甚至会停止时间同步。</p></li>

<li><p>ntpd自己会思考。它相信本地时间可能不对，但是不会忽快忽慢甚至停滞。ntpd通过多次收发包选择权威稳定的时间源，算出双方间的网络延迟，然后才会采信新的远端时钟进行时间同步。</p></li>

<li><p>NTPD 在和时间服务器的同步过程中，会把BIOS振荡时钟和远程时间服务的偏移量记录下来，这样即使网络有问题，本机仍然能维持一个相当精确的走时。</p></li>
</ol>

<p>软件与软件结构</p>

<p>在 CentOS 6.x 上头，你所需要的软件其实仅有 ntp 这个玩意儿而已，请自行使用 rpm 去找找看，若没有安装，请利用 yum install ntp 即可啊！不过，我们还需要时区相关的数据文件，所以你需要的软件有：</p>

<pre><code>ntp： 就是 NTP 服务器的主要软件啦，包括配置文件以及执行档等等。
tzdata： 软件名称为『 Time Zone data 』的缩写，提供各时区对应的显示格式。
</code></pre>

<p>与时间及 NTP 服务器设定相关的配置文件与重要数据文件有底下几个：</p>

<pre><code>/etc/ntp.conf： 就是 NTP 服务器的主要配置文件，也是唯一的一个；

/usr/share/zoneinfo/： 由 tzdata 所提供，为各时区的时间格式对应档。 例如台湾地区的时区格式对应档案在 /usr/share/zoneinfo/Asia/Taipei 就是了！这个目录里面的档案与底下要谈的两个档案 (clock 与 localtime) 是有关系的喔！

/etc/sysconfig/clock： 设定时区与是否使用 UTC 时间钟的配置文件。 每次开机后 Linux 会自动的读取这个档案来设定自己系统所默认要显示的时间说！举个例子来说， 在我们台湾地区的本地时间设定中，这个档案内应该会出现一行『ZONE=&quot;Asia/Taipei&quot;』的字样， 这表示我们的时间配置文件案『要取用 /usr/share/zoneinfo/Asia/Taipei 那个档案』的意思！

/etc/localtime： 这个档案就是『本地端的时间配置文件』啦！刚刚那个 clock 档案里面规定了使用的时间配置文件 (ZONE) 为 /usr/share/zoneinfo/Asia/Taipei ，所以说这就是本地端的时间了，此时 Linux 系统就会将 Taipei 那个档案复制一份成为 /etc/localtime ，所以未来我们的时间显示就会以 Taipei 那个时间配置文件案为准。
至于在常用于时间服务器与修改时间的指令方面，主要有底下这几个啦：

/bin/date： 用于 Linux 时间 (软件时钟) 的修改与显示的指令；

/sbin/hwclock： 用于 BIOS 时钟 (硬件时钟) 的修改与显示的指令。 这是一个 root 才能执行的指令，因为 Linux 系统上面 BIOS 时间与 Linux 系统时间是分开的，所以使用 date 这个指令调整了时间之后，还需要使用 hwclock 才能将修改过后的时间写入 BIOS 当中！

/usr/sbin/ntpd： 主要提供 NTP 服务的程序啰！配置文件为 /etc/ntp.conf

/usr/sbin/ntpdate： 用于客户端的时间校正，如果你没有要启用 NTP 而仅想要使用 NTP Client 功能的话，那么只会用到这个指令而已啦！
</code></pre>

<p>查看与上层服务器连接情况</p>

<p>#ntpq -p</p>

<pre><code>     remote           refid      st t when poll reach   delay   offset  jitter
==============================================================================
+time.iqnet.com  62.201.214.162   2 u  108   64  126  461.009  -70.675   6.842
*ns02.hns.net.in 200.98.196.212   2 u   39   64  373  491.613   -9.184  15.730
</code></pre>

<p>remote 本地主机所连接的上层NTP服务器</p>

<pre><code>*目前正在使用的上层NTP

+已连线,可提供时间更新的候补服务器
</code></pre>

<p>refid 给上层NTP服务器提供时间校对的服务器</p>

<p>st 就是stratum 上层NTP的级别</p>

<p>when 几秒钟前曾做过时间同步更新</p>

<p>poll 下一次更新在几秒后</p>

<p>reach 已经向上层服务器要求更新的次数</p>

<p>delay 网络传输过程中的延迟时间</p>

<p>offset 本地主机与上层NTP服务器的时间差,该值的绝对值越接近0,与上层服务器的时间就越接近</p>

<p>jitter 一个统计值,这个值的绝对值越小,本地主机的时间就越精确</p>

<ol>
<li><p>ntpdate</p></li>

<li><p>ntpdate是一个时间同步命令，通常采用crond+ntpdate方式同步时间。</p></li>

<li><p>ntpdate盲目信任远端时钟，如果远端时钟错误，ntpdate永远相信远端时钟是正确的，可能造成服务器时钟停滞，甚至回逆。</p></li>

<li><p>ntpdate简单粗暴，无脑不会思考。采用野蛮式（brute force，国外资料中这个词用的很好）、跃进式调整服务器时间。</p></li>
</ol>

<p>ntpdate –q 时钟源   查看与时钟源的时间偏移值</p>

<ol>
<li>chronyd</li>
</ol>

<p>监控主要也是获取这些指标，可以具体查看监控篇。</p>
            </div>
            
            <div style="border: 1px dashed #e0e0e0; margin-bottom: 15px; padding: 10px 10px 10px 10px; background-color: #fffeee; background-repeat: no-repeat; background-attachment: scroll; background-position: 1% 50%; -moz-background-size: auto auto; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial;">
                <div>
                    <p style="margin-top:0px;">作者：<a target="_blank" href="http://blog.fatedier.com/">kingjcy</a>
                    <br />本文出处：<a target="_blank" href="https://kingjcy.github.io/post/linux/server/ntp/">https://kingjcy.github.io/post/linux/server/ntp/</a>
                    <br />
                    文章版权归本人所有，欢迎转载，但未经作者同意必须保留此段声明，且在文章页面明显位置给出原文链接，否则保留追究法律责任的权利。 </p>
                </div>
            </div>

            <aside>
                
                <ul class="list-inline post-tags">
                    
                    <li>
                        <a href="/tags/ntp/">
                            <i class="fa fa-tags"></i>
                            ntp
                        </a>
                    </li>
                    
                </ul>

                
                
                <h4 id="real-rels">相关文章</h4>
                <ul class="post-rels" id="real-rels"><li id="li-rels"><a href="/post/monitor/server/ntp/">Ntp</a>&nbsp;&nbsp;<span class="post-date" style="font-size:14px">&nbsp;(2018年10月15日)</span></li></ul>
            </aside>
                
            
            <footer>
                <nav>
                    <ul class="pager">

                        
                        <li class="previous"><a href="/post/middleware/network/udp/"><span aria-hidden="true">&larr;</span> Prev</a></li>
                        

                        <li><a href="/post/">All Posts</a></li>

                        
                        <li class="next disabled"><a href="#">Next <span aria-hidden="true">&rarr;</span></a></li>
                        

                    </ul>
                </nav>
            </footer>

        </article>
    </div>
    <div class="col-md-4">
        
<aside>
        <div class="toc panel panel-default hidden-xs hidden-sm affix-top" data-spy="affix" data-offset-top="125" data-offset-bottom="300">
            <div class="panel-heading">
                <h2 class="panel-title">Catalog</h2>
            </div>

            <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#时区">时区</a></li>
<li><a href="#ntp">ntp</a></li>
</ul></li>
</ul>
</nav>
        </div>
</aside>

    </div>
</div>

</div>
<hr>

<footer class="container copy">
    <p>&copy; 2020  kingjcy blog </p>
	<p>Powered by <a href="https://gohugo.io" target="_blank">Hugo</a></p>
</footer>

<script>hljs.initHighlightingOnLoad();</script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?ace3ec99de96c4080ead1eb8d52db3b3";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-92600390-2', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

