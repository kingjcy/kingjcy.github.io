<!DOCTYPE html>

<html lang="zh-cn">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="author" content="fatedier">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="description" content="第一阶段 现象 内存持续增加不释放，应该是内存泄漏
分析  查看日志,有一个error一直在报错  找到对应的日志在代码中的位置
在这边只是检查文件的状态，难道是这个返回的时候，资源没有释放导致的？于是打开采集组件的debug日志和开启pprof来看filebeat运行的资源使用情况，查看pprof的时候发现果然goroutine泄漏了，达到了16W。然后主要看泄漏的地方
这个图上面的协程数由于没有保留，就用来这个，其实第一个达到8W，下面都是4W左右。
在/go/src/github.com/elastic/beats/filebeat/channel/util.go的这边有好几万的协程在运行。我们来看代码
再来看看上一层的代码调用返回后是不是导致这个goroutine没有释放，还真的是这块没有调用close
查看官方确实存在着这个问题issue
在7.5的版本中进行了修复，于是对filebeat进行升级，然后进行多kafka的改造。完成修复。
第二阶段 现象 升级后，好景不长，在filebeat组件运行的三天内突然出现cpu和内存使用持续增长并且过度使用资源的情况。如下图
分析  查看日志,有一个error一直在报错  还是这个报错，难道这个bug没有修复，在测试环境是测试OK，确实在新代码中也会close
如果状态不对return，是会调用
defer cleanupIfNeeded(out.Close) defer cleanupIfNeeded(stateOut.Close)  并不会导致这个的协程泄漏。这个问题其实就是第一阶段的内存泄漏问题，已经修复，那么问题来了。为什么还会有大量的goroutine泄漏。
只能在源码中找答案了，但是一整套的采集流程都走下来，发现都没有泄漏的场景。
没办法，打开debug日志，来一行行追踪。
最初的想法是肯定是哪边的状态检查不通过，导致的goroutine的泄漏。
因为有很多的特殊情况，日志采集是处于已经采集的状态的，还真找到了一种特殊情况
这种特殊情况和我们的容器的发布使用场景有关：我们的发布使用的原地重启的方式，并不会删除pod，而是重启container
再去看log-polit的机制，发现pod的原地重启的情况下，会对同一个日志文件进行重新生成，这个时候历史日志不删除，就会出现一个不同文件名但是内容完全相同的的配置文件
这个时候就有一个新的文件进行重新加载，开一个采集器去采集日志，但是我们在记录中这个日志已经采集了，并不会真正的去采集，所以整个流程并木有闭环，所以很多地方开启的goroutine并没获取关闭的信号
而且这个采集器还会定时去检查，检查的过程中也会造成这种情况。
修复方案：
1、在这情况下，调用close关闭相关的资源，但是不能保障所有的情况，如果其他类似特殊情况的话，还是会出现问题。pass 2、在重载哪边做去重的机制，使用hash算法，如果一直的不进行重新加载 3、在服务发现机制那边做去重，但是我们是基于docker事件的，如果需要去重，改造的工作量特别大，可以做长期的计划  综上所述，采用的方案二进行临时修复，方案三作为长期规划。">
<meta property="og:url" content="https://kingjcy.github.io/"><meta property="og:type" content="article">
<meta property="og:title" content="生产问题排查解决系列---- filebeat resource leak - kingjcy blog"><meta property="og:site_name" content="kingjcy blog">

<title>
    
    生产问题排查解决系列---- filebeat resource leak
    
</title>

<link rel="stylesheet" href="/onlyone/onlyone.css">
<link rel="shortcut icon" href="/assets/favicon.ico">
<script src="/onlyone/onlyone.js"></script>
<link rel="alternate" type="application/rss+xml" title="RSS" href="/index.xml">
</head>
<body>


<div class="container">
    <header class="nav">
        <nav class="navbar navbar-default">
            <div class="container-fluid">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="/">kingjcy blog</a>
                </div>

                <div class="collapse navbar-collapse" id="navbar-collapse">
                    <ul class="nav navbar-nav">
                        <li><a href="/categories/技术文章/">技术文章</a></li>
                        <li><a href="/categories/读书笔记/">读书笔记</a></li>
                        <li><a href="/categories/人生感悟/">人生感悟</a></li>
                        <li><a href="/tags/">分类</a></li>
                        <li><a href="/about/">关于我</a></li>
                        <li>
                            <form method="get" style="padding: 8px" action="https://www.google.com/search" target="_blank">
                                <input type="hidden" name="sitesearch" value="kingjcy.github.io"/>
                                <input type="text" class="form-control" name="q" placeholder="Press enter to search">
                            </form>
                        </li>
                    </ul>

                </div>
            </div>
        </nav>
    </header>


<div class="row">
    <div class="col-md-8">
        <article class="post single">

            <header>
                <div class="post-date">
                    2020年03月02日 
                </div>
                <h1 class="post-title">生产问题排查解决系列---- filebeat resource leak</h1>
            </header>

            <div class="post-content">
                

<h1 id="第一阶段">第一阶段</h1>

<h2 id="现象">现象</h2>

<p>内存持续增加不释放，应该是内存泄漏</p>

<h2 id="分析">分析</h2>

<ol>
<li>查看日志,有一个error一直在报错</li>
</ol>

<p><img src="/media/product/filebeat_leak/leak2.png" alt="" /></p>

<p>找到对应的日志在代码中的位置</p>

<p><img src="/media/product/filebeat_leak/leak3.png" alt="" /></p>

<p>在这边只是检查文件的状态，难道是这个返回的时候，资源没有释放导致的？于是打开采集组件的debug日志和开启pprof来看filebeat运行的资源使用情况，查看pprof的时候发现果然goroutine泄漏了，达到了16W。然后主要看泄漏的地方</p>

<p><img src="/media/product/filebeat_leak/leak5.png" alt="" /></p>

<p>这个图上面的协程数由于没有保留，就用来这个，其实第一个达到8W，下面都是4W左右。</p>

<p>在/go/src/github.com/elastic/beats/filebeat/channel/util.go的这边有好几万的协程在运行。我们来看代码</p>

<p><img src="/media/product/filebeat_leak/leak6.png" alt="" /></p>

<p>再来看看上一层的代码调用返回后是不是导致这个goroutine没有释放，还真的是这块没有调用close</p>

<p><img src="/media/product/filebeat_leak/leak7.png" alt="" /></p>

<p>查看官方确实存在着这个问题<a href="https://github.com/elastic/beats/issues/6797">issue</a></p>

<p>在7.5的版本中进行了修复，于是对filebeat进行升级，然后进行多kafka的改造。完成修复。</p>

<h1 id="第二阶段">第二阶段</h1>

<h1 id="现象-1">现象</h1>

<p>升级后，好景不长，在filebeat组件运行的三天内突然出现cpu和内存使用持续增长并且过度使用资源的情况。如下图</p>

<p><img src="/media/product/filebeat_leak/leak.png" alt="" /></p>

<h1 id="分析-1">分析</h1>

<ol>
<li>查看日志,有一个error一直在报错</li>
</ol>

<p><img src="/media/product/filebeat_leak/leak2.png" alt="" /></p>

<p>还是这个报错，难道这个bug没有修复，在测试环境是测试OK，确实在新代码中也会close</p>

<p><img src="/media/product/filebeat_leak/leak4.png" alt="" /></p>

<p>如果状态不对return，是会调用</p>

<pre><code>defer cleanupIfNeeded(out.Close)
defer cleanupIfNeeded(stateOut.Close)
</code></pre>

<p>并不会导致这个的协程泄漏。这个问题其实就是第一阶段的内存泄漏问题，已经修复，那么问题来了。为什么还会有大量的goroutine泄漏。</p>

<p>只能在源码中找答案了，但是一整套的采集流程都走下来，发现都没有泄漏的场景。</p>

<p>没办法，打开debug日志，来一行行追踪。</p>

<p>最初的想法是肯定是哪边的状态检查不通过，导致的goroutine的泄漏。</p>

<p>因为有很多的特殊情况，日志采集是处于已经采集的状态的，还真找到了一种特殊情况</p>

<p>这种特殊情况和我们的容器的发布使用场景有关：我们的发布使用的原地重启的方式，并不会删除pod，而是重启container</p>

<p>再去看log-polit的机制，发现pod的原地重启的情况下，会对同一个日志文件进行重新生成，这个时候历史日志不删除，就会出现一个不同文件名但是内容完全相同的的配置文件</p>

<p>这个时候就有一个新的文件进行重新加载，开一个采集器去采集日志，但是我们在记录中这个日志已经采集了，并不会真正的去采集，所以整个流程并木有闭环，所以很多地方开启的goroutine并没获取关闭的信号</p>

<p>而且这个采集器还会定时去检查，检查的过程中也会造成这种情况。</p>

<p>修复方案：</p>

<pre><code>1、在这情况下，调用close关闭相关的资源，但是不能保障所有的情况，如果其他类似特殊情况的话，还是会出现问题。pass
2、在重载哪边做去重的机制，使用hash算法，如果一直的不进行重新加载
3、在服务发现机制那边做去重，但是我们是基于docker事件的，如果需要去重，改造的工作量特别大，可以做长期的计划
</code></pre>

<p>综上所述，采用的方案二进行临时修复，方案三作为长期规划。</p>

            </div>
            
            <div style="border: 1px dashed #e0e0e0; margin-bottom: 15px; padding: 10px 10px 10px 10px; background-color: #fffeee; background-repeat: no-repeat; background-attachment: scroll; background-position: 1% 50%; -moz-background-size: auto auto; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial;">
                <div>
                    <p style="margin-top:0px;">作者：<a target="_blank" href="http://blog.fatedier.com/">kingjcy</a>
                    <br />本文出处：<a target="_blank" href="https://kingjcy.github.io/post/product/filebeat_leak/">https://kingjcy.github.io/post/product/filebeat_leak/</a>
                    <br />
                    文章版权归本人所有，欢迎转载，但未经作者同意必须保留此段声明，且在文章页面明显位置给出原文链接，否则保留追究法律责任的权利。 </p>
                </div>
            </div>

            <aside>
                
                <ul class="list-inline post-tags">
                    
                    <li>
                        <a href="/tags/filebeat/">
                            <i class="fa fa-tags"></i>
                            filebeat
                        </a>
                    </li>
                    
                    <li>
                        <a href="/tags/leak/">
                            <i class="fa fa-tags"></i>
                            leak
                        </a>
                    </li>
                    
                    <li>
                        <a href="/tags/product-problem/">
                            <i class="fa fa-tags"></i>
                            product problem
                        </a>
                    </li>
                    
                </ul>

                
                
                <h4 id="real-rels">相关文章</h4>
                <ul class="post-rels" id="real-rels"><li id="li-rels"><a href="/post/product/filebeat_optimization/">生产问题排查解决系列---- filebeat resource optimization</a>&nbsp;&nbsp;<span class="post-date" style="font-size:14px">&nbsp;(2020年03月02日)</span></li><li id="li-rels"><a href="/post/log/collect/filebeat/filebeat/">日志采集系列---- Filebeat</a>&nbsp;&nbsp;<span class="post-date" style="font-size:14px">&nbsp;(2018年07月08日)</span></li><li id="li-rels"><a href="/post/log/collect/filebeat/filebeat-principle/">日志采集系列---- Filebeat原理</a>&nbsp;&nbsp;<span class="post-date" style="font-size:14px">&nbsp;(2018年07月08日)</span></li></ul>
            </aside>
                
            
            <footer>
                <nav>
                    <ul class="pager">

                        
                        <li class="previous"><a href="/post/middleware/mq/emq/"><span aria-hidden="true">&larr;</span> Prev</a></li>
                        

                        <li><a href="/post/">All Posts</a></li>

                        
                        <li class="next"><a href="/post/product/filebeat_optimization/">Next <span aria-hidden="true">&rarr;</span></a></li>
                        

                    </ul>
                </nav>
            </footer>

        </article>
    </div>
    <div class="col-md-4">
        
<aside>
        <div class="toc panel panel-default hidden-xs hidden-sm affix-top" data-spy="affix" data-offset-top="125" data-offset-bottom="300">
            <div class="panel-heading">
                <h2 class="panel-title">Catalog</h2>
            </div>

            <nav id="TableOfContents">
<ul>
<li><a href="#第一阶段">第一阶段</a>
<ul>
<li><a href="#现象">现象</a></li>
<li><a href="#分析">分析</a></li>
</ul></li>
<li><a href="#第二阶段">第二阶段</a></li>
<li><a href="#现象-1">现象</a></li>
<li><a href="#分析-1">分析</a></li>
</ul>
</nav>
        </div>
</aside>

    </div>
</div>

</div>
<hr>

<footer class="container copy">
    <p>&copy; 2020  kingjcy blog </p>
	<p>Powered by <a href="https://gohugo.io" target="_blank">Hugo</a></p>
</footer>

<script>hljs.initHighlightingOnLoad();</script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?ace3ec99de96c4080ead1eb8d52db3b3";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-92600390-2', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

