<!DOCTYPE html>

<html lang="zh-cn">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="author" content="fatedier">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="description" content="记录一次生产ping大量延时误报的场景问题">
<meta property="og:url" content="https://kingjcy.github.io/"><meta property="og:type" content="article">
<meta property="og:title" content="生产问题排查解决系列---- Ping - kingjcy blog"><meta property="og:site_name" content="kingjcy blog">

<title>
    
    生产问题排查解决系列---- Ping
    
</title>

<link rel="stylesheet" href="/onlyone/onlyone.css">
<link rel="shortcut icon" href="/assets/favicon.ico">
<script src="/onlyone/onlyone.js"></script>
<link rel="alternate" type="application/rss+xml" title="RSS" href="/index.xml">
</head>
<body>


<div class="container">
    <header class="nav">
        <nav class="navbar navbar-default">
            <div class="container-fluid">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="/">kingjcy blog</a>
                </div>

                <div class="collapse navbar-collapse" id="navbar-collapse">
                    <ul class="nav navbar-nav">
                        <li><a href="/categories/技术文章/">技术文章</a></li>
                        <li><a href="/categories/读书笔记/">读书笔记</a></li>
                        <li><a href="/categories/人生感悟/">人生感悟</a></li>
                        <li><a href="/tags/">分类</a></li>
                        <li><a href="/about/">关于我</a></li>
                        <li>
                            <form method="get" style="padding: 8px" action="https://www.google.com/search" target="_blank">
                                <input type="hidden" name="sitesearch" value="kingjcy.github.io"/>
                                <input type="text" class="form-control" name="q" placeholder="Press enter to search">
                            </form>
                        </li>
                    </ul>

                </div>
            </div>
        </nav>
    </header>


<div class="row">
    <div class="col-md-8">
        <article class="post single">

            <header>
                <div class="post-date">
                    2019年04月29日 
                </div>
                <h1 class="post-title">生产问题排查解决系列---- Ping</h1>
            </header>

            <div class="post-content">
                <p>记录一次生产ping大量延时误报的场景问题</p>

<p>关于昨晚promes的ping告警问题</p>

<p>现象：我们的balckbox探针探测所有的机器都延时超过500ms，出现大量告警。</p>

<ol>
<li><p>首先是我们机器的问题，在昨天那个时间段我们所有的ping的机器都出来了ping延时高的问题，实际上，ping我们机器出现延时高，ping其他机器并没有延时高（第三方zabbix也是这个情况），所以是我们的机器出现问题。</p></li>

<li><p>我们机器有在这个时间段都出来了ping延时高的问题，但是都在23：30自动恢复了，期间重启三台机器的blackbox进程，但是并没有解决问题，还是会出来延时现象。</p></li>

<li><p>在这段时间有几台出现了资源争抢问题，所有机器都出现cpu使用升高的现象。</p></li>
</ol>

<p>总结</p>

<ol>
<li><p>网络抖动，我们部署的blackbox机器网络出现抖动，导致了大量的超时连接，然后可能导致cpu升高，甚至出现资源争抢，然后23:30网络恢复，自行恢复。</p></li>

<li><p>资源争抢，和我们blackbox的在一起的机器，其他业务出现争抢我们资源，导致我们处理变慢，出现ping延时，然后23:30争抢结束，自行恢复。</p></li>
</ol>

<p>下午查看了我们blackbox机器所在的物理机，没有发现别的机器争抢资源，所以是我们的机器在争抢资源，排除上午第二条的可能性，然后仔细分析了我们的所有机器的各项数据，只有这八台机器10.96.48.164，10.96.48.165，10.96.48.167，10.96.48.168，10.96.48.169.10.96.48.199，10.96.48.200，10.96.48.202的tcp的连接数和cpu的使用率发生了上升，其他数据正常，初步判断tcp连接数导致了cpu的使用率变高，tcp的连接数，峰值在18K左右，我们目前监控的机器是12W，二十个节点，一个节点有六千个机器，所以单次请求最高连接是6000，我们是30s请求一次，而单次ping超时10s，而后出现time_wait默认系统是2m进行回收，如果网络出现问题，持续2m，应该会有3次峰值的time_wait，也即是18K，数据基本符合。</p>

<p>总结</p>

<p>网络抖动，昨天在22:20开始出现网络抖动，导致了大量的超时连接，然后可能导致cpu升高，甚至出现资源争抢，然后23:30网络恢复，自行恢复。</p>

<p>处理</p>

<p>出现大量的time_wait，建议开启机器的快速回收和复用功能，后面峰值也就停留在6000，在大量的ping超时情况下，不会出现资源不够用</p>

<p>后续</p>

<p>需要讨论自监控方案，有方案继续同步。</p>

<p>第二天下午又出现了大量ping出问题的情况，经过查看只有10.96.48.165出现问题，上机器查看，通过其他机器ping这台机器ping延时很高，但是进机器一看，连接数达到了18K，而且都是estab状态，和昨天处理的猜测的wait状态，有出入，所有大量连接数导致的cpu使用过高，然后ping延时就会变大，停掉进程，重启后恢复正常，可见网络没有问题。当然不排除网络抖动</p>

<p>有两个疑问</p>

<p>一是什么引起的连接数变高？</p>

<p>二是为什么都是estab状态的连接？</p>

<p>12W。 20台。30s。====200个&mdash;-1000个连接&ndash;18K&ndash;90s</p>

<p>解决</p>

<p>解决连接数问题，也不会使得cpu升高，哪怕触发点再次触发，也不会出现问题。</p>

<ol>
<li>扩容</li>
</ol>

<p>目前已经扩容，继续观察。扩容了一倍的机器，正常连接数变为一半，一天内未出现问题。几天都未出现问题</p>

<p>20190614</p>

<p>今天又出来了ping大量延迟问题，经检查只有10.96.48.164出现问题，estb的连接达到了12K，然后9点开始，15点就结束了，cpu突然上升，感觉像是请求变多了，会不会是负载均衡策略又问题，查看是round-robin的轮询策略，应该不会有问题，但是可能有策略和权重调整，所以决定加一层nginx，给nginx做vip，然后我们来控制轮询。</p>

<p>事件</p>

<pre><code>昨天上午九点我们的ping探测，有一台blackbox机器10.96.48.164，突然cpu和连接数升高（其他机器都正常），导致了ping失败，出现告警。下午三点自动恢复。
</code></pre>

<p>分析</p>

<pre><code>之前我们机器出现类似的情况，我们后期扩容了8台机器，运行到昨天都没有问题，针对之前的网络问题，昨天和网络服务器相关人员排查都说没有什么问题，所以针对资源使用突增的情况，我们考虑了我们的任务量，我们的采集过程是promethues---&gt;VIP---若干台采集器---&gt;用户的机器，关于vip的负载均衡策略，咨询过后，正常情况下是轮询，也有可能出现后大量任务负载到一台的情况，这样就会导致我们机器自身的网络出现问题，探测的网络都出现高延迟，甚至ping失败产生告警的情况
</code></pre>

<p>解决</p>

<pre><code>就负载均衡问题，我们申请了机器，自身做负载均衡，目前流程正在审批中，到位后立马处理
</code></pre>

<p>现状</p>

<pre><code>昨天下午三点后机器已经恢复正常，到目前机器各方面资源使用都很均衡
</code></pre>

<p>20190617</p>

<p>今天又发生了机器出现问题，和以上一样，但是发生在了10.96.48.167机器上，于是上去查看相关情况，先查看连接数</p>

<pre><code>chunyindeMacBook-Pro:Downloads chunyinjiang$ cat a |awk '{print$5}'|awk -F : '{print$4}'|sort|uniq -c|sort -rn
1136 10.104.245.248
1121 10.104.245.245
1099 10.104.245.241
1090 10.104.245.242
1084 10.104.245.247
1080 10.104.245.249
1077 10.104.245.244
1025 10.104.245.243
1012 10.104.245.246
 200
   3 10.104.245.251
   1 10.104.245.250
   1 *
</code></pre>

<p>正常情况是</p>

<pre><code>[root@promesprdapp149 blackbox_exporter-0.12.0.linux-amd64]# netstat -anp | grep 9115 | awk '{print$5}'|awk -F : '{print$4}'|sort|uniq -c|sort -rn
120 10.104.245.243
113 10.104.245.241
111 10.104.245.248
107 10.104.245.246
107 10.104.245.242
105 10.104.245.244
102 10.104.245.249
100 10.104.245.247
 98 10.104.245.245
  1 *
</code></pre>

<p>很明显的考验看出prometheus来拉去的的任务量翻了十倍，我们的流程是</p>

<pre><code>promethues---&gt;VIP---若干台采集器---&gt;用户的机器
</code></pre>

<p>现在在prometheus到采集器之间的连接数翻十倍，也就是请求量加大了十倍，我们是通过vip来实现负载均衡，所以可以确定vip负载均衡做了处理，所以我们必须要搭建一套我们的nginx负载均衡。</p>

<p>然后打开日志debug，可见</p>

<pre><code>[root@promesprdapp149 blackbox_exporter-0.12.0.linux-amd64]# cat start.log | grep &quot;10.246.52.2 &quot;
ts=2019-06-17T02:34:02.066373851Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Beginning probe&quot; probe=icmp timeout_seconds=5
ts=2019-06-17T02:34:02.066457483Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Resolving target address&quot; preferred_ip_protocol=ip4
ts=2019-06-17T02:34:02.06649665Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Resolved target address&quot; ip=10.246.52.2
ts=2019-06-17T02:34:02.066533167Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Creating socket&quot;
ts=2019-06-17T02:34:02.066606744Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Creating ICMP packet&quot; seq=40913 id=28709
ts=2019-06-17T02:34:02.066643485Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Writing out packet&quot;
ts=2019-06-17T02:34:02.066713378Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Waiting for reply packets&quot;
ts=2019-06-17T02:34:02.067312458Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Found matching reply packet&quot;
ts=2019-06-17T02:34:02.077487599Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Creating ICMP packet&quot; seq=40923 id=28709
ts=2019-06-17T02:34:02.07752867Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Writing out packet&quot;
ts=2019-06-17T02:34:02.077611582Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Waiting for reply packets&quot;
ts=2019-06-17T02:34:02.08210071Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Found matching reply packet&quot;
ts=2019-06-17T02:34:02.092249935Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Creating ICMP packet&quot; seq=40933 id=28709
ts=2019-06-17T02:34:02.092384887Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Writing out packet&quot;
ts=2019-06-17T02:34:02.09245955Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Waiting for reply packets&quot;
ts=2019-06-17T02:34:02.092699874Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Found matching reply packet&quot;
ts=2019-06-17T02:34:02.103155596Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Creating ICMP packet&quot; seq=40943 id=28709
ts=2019-06-17T02:34:02.103189199Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Writing out packet&quot;
ts=2019-06-17T02:34:02.103277775Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Waiting for reply packets&quot;
ts=2019-06-17T02:34:02.103781408Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Found matching reply packet&quot;
ts=2019-06-17T02:34:02.115737361Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Creating ICMP packet&quot; seq=40952 id=28709
ts=2019-06-17T02:34:02.115772538Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Writing out packet&quot;
ts=2019-06-17T02:34:02.115877988Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Waiting for reply packets&quot;
ts=2019-06-17T02:34:02.116273201Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Found matching reply packet&quot;
ts=2019-06-17T02:34:02.126386412Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Creating ICMP packet&quot; seq=40956 id=28709
ts=2019-06-17T02:34:02.126408975Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Writing out packet&quot;
ts=2019-06-17T02:34:02.126468605Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Waiting for reply packets&quot;
ts=2019-06-17T02:34:02.12668105Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Found matching reply packet&quot;
ts=2019-06-17T02:34:02.136924337Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Creating ICMP packet&quot; seq=40963 id=28709
ts=2019-06-17T02:34:02.136975987Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Writing out packet&quot;
ts=2019-06-17T02:34:02.137288874Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Waiting for reply packets&quot;
ts=2019-06-17T02:34:02.137702526Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Found matching reply packet&quot;
ts=2019-06-17T02:34:02.147891857Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Creating ICMP packet&quot; seq=40972 id=28709
ts=2019-06-17T02:34:02.147932974Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Writing out packet&quot;
ts=2019-06-17T02:34:02.148010363Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Waiting for reply packets&quot;
ts=2019-06-17T02:34:02.148830706Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Found matching reply packet&quot;
ts=2019-06-17T02:34:02.159058507Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Creating ICMP packet&quot; seq=40984 id=28709
ts=2019-06-17T02:34:02.15909878Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Writing out packet&quot;
ts=2019-06-17T02:34:02.159172823Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Waiting for reply packets&quot;
ts=2019-06-17T02:34:02.159414572Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Found matching reply packet&quot;
ts=2019-06-17T02:34:02.169597269Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Creating ICMP packet&quot; seq=40994 id=28709
ts=2019-06-17T02:34:02.169640504Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Writing out packet&quot;
ts=2019-06-17T02:34:02.169722965Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Waiting for reply packets&quot;
ts=2019-06-17T02:34:02.169974829Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Found matching reply packet&quot;
ts=2019-06-17T02:34:02.180370441Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Probe succeeded&quot; duration_seconds=0.113942614
ts=2019-06-17T02:34:32.066298047Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Beginning probe&quot; probe=icmp timeout_seconds=5
ts=2019-06-17T02:34:32.066381199Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Resolving target address&quot; preferred_ip_protocol=ip4
ts=2019-06-17T02:34:32.066420834Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Resolved target address&quot; ip=10.246.52.2
ts=2019-06-17T02:34:32.06645508Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Creating socket&quot;
ts=2019-06-17T02:34:32.066536333Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Creating ICMP packet&quot; seq=25637 id=28709
ts=2019-06-17T02:34:32.066574079Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Writing out packet&quot;
ts=2019-06-17T02:34:32.066699582Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Waiting for reply packets&quot;
ts=2019-06-17T02:34:32.066970342Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Found matching reply packet&quot;
ts=2019-06-17T02:34:32.077192743Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Creating ICMP packet&quot; seq=25655 id=28709
ts=2019-06-17T02:34:32.077228729Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Writing out packet&quot;
ts=2019-06-17T02:34:32.077303043Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Waiting for reply packets&quot;
ts=2019-06-17T02:34:32.077585069Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Found matching reply packet&quot;
ts=2019-06-17T02:34:32.090984561Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Creating ICMP packet&quot; seq=25668 id=28709
ts=2019-06-17T02:34:32.091772445Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Writing out packet&quot;
ts=2019-06-17T02:34:32.092700262Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Waiting for reply packets&quot;
ts=2019-06-17T02:34:32.092938397Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Found matching reply packet&quot;
ts=2019-06-17T02:34:32.103170738Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Creating ICMP packet&quot; seq=25689 id=28709
ts=2019-06-17T02:34:32.103210461Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Writing out packet&quot;
ts=2019-06-17T02:34:32.103278283Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Waiting for reply packets&quot;
ts=2019-06-17T02:34:32.103476639Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Found matching reply packet&quot;
ts=2019-06-17T02:34:32.113700972Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Creating ICMP packet&quot; seq=25706 id=28709
ts=2019-06-17T02:34:32.113741892Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Writing out packet&quot;
ts=2019-06-17T02:34:32.113820071Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Waiting for reply packets&quot;
ts=2019-06-17T02:34:32.114125208Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Found matching reply packet&quot;
ts=2019-06-17T02:34:32.124264431Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Creating ICMP packet&quot; seq=25722 id=28709
ts=2019-06-17T02:34:32.124424871Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Writing out packet&quot;
ts=2019-06-17T02:34:32.124518016Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Waiting for reply packets&quot;
ts=2019-06-17T02:34:32.125386328Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Found matching reply packet&quot;
ts=2019-06-17T02:34:32.135575982Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Creating ICMP packet&quot; seq=25741 id=28709
ts=2019-06-17T02:34:32.135613753Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Writing out packet&quot;
ts=2019-06-17T02:34:32.1356903Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Waiting for reply packets&quot;
ts=2019-06-17T02:34:32.13604716Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Found matching reply packet&quot;
ts=2019-06-17T02:34:32.146198849Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Creating ICMP packet&quot; seq=25756 id=28709
ts=2019-06-17T02:34:32.146285271Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Writing out packet&quot;
ts=2019-06-17T02:34:32.146370482Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Waiting for reply packets&quot;
ts=2019-06-17T02:34:32.146664958Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Found matching reply packet&quot;
ts=2019-06-17T02:34:32.156846137Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Creating ICMP packet&quot; seq=25775 id=28709
ts=2019-06-17T02:34:32.156883808Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Writing out packet&quot;
ts=2019-06-17T02:34:32.156959605Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Waiting for reply packets&quot;
ts=2019-06-17T02:34:32.157270036Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Found matching reply packet&quot;
ts=2019-06-17T02:34:32.167463056Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Creating ICMP packet&quot; seq=25794 id=28709
ts=2019-06-17T02:34:32.167519042Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Writing out packet&quot;
ts=2019-06-17T02:34:32.167594848Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Waiting for reply packets&quot;
ts=2019-06-17T02:34:32.167887369Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Found matching reply packet&quot;
ts=2019-06-17T02:34:32.178192489Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Probe succeeded&quot; duration_seconds=0.111847237
ts=2019-06-17T02:37:32.066182623Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Beginning probe&quot; probe=icmp timeout_seconds=5
ts=2019-06-17T02:37:32.066396265Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Resolving target address&quot; preferred_ip_protocol=ip4
ts=2019-06-17T02:37:32.066494943Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Resolved target address&quot; ip=10.246.52.2
ts=2019-06-17T02:37:32.067204438Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Creating socket&quot;
ts=2019-06-17T02:37:32.067337703Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Creating ICMP packet&quot; seq=40029 id=28709
ts=2019-06-17T02:37:32.067390554Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Writing out packet&quot;
ts=2019-06-17T02:37:32.067465955Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Waiting for reply packets&quot;
ts=2019-06-17T02:37:32.067766008Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Found matching reply packet&quot;
ts=2019-06-17T02:37:32.077923936Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Creating ICMP packet&quot; seq=40047 id=28709
ts=2019-06-17T02:37:32.078020558Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Writing out packet&quot;
ts=2019-06-17T02:37:32.078313845Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Waiting for reply packets&quot;
ts=2019-06-17T02:37:32.078555384Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Found matching reply packet&quot;
ts=2019-06-17T02:37:32.088704202Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Creating ICMP packet&quot; seq=40064 id=28709
ts=2019-06-17T02:37:32.088726667Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Writing out packet&quot;
ts=2019-06-17T02:37:32.08878061Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Waiting for reply packets&quot;
ts=2019-06-17T02:37:32.089101803Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Found matching reply packet&quot;
ts=2019-06-17T02:37:32.09954378Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Creating ICMP packet&quot; seq=40078 id=28709
ts=2019-06-17T02:37:32.099800481Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Writing out packet&quot;
ts=2019-06-17T02:37:32.100558678Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Waiting for reply packets&quot;
ts=2019-06-17T02:37:32.100719994Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Found matching reply packet&quot;
ts=2019-06-17T02:37:32.110878989Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Creating ICMP packet&quot; seq=40098 id=28709
ts=2019-06-17T02:37:32.110901938Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Writing out packet&quot;
ts=2019-06-17T02:37:32.111013718Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Waiting for reply packets&quot;
ts=2019-06-17T02:37:32.11118034Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Found matching reply packet&quot;
ts=2019-06-17T02:37:32.121475348Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Creating ICMP packet&quot; seq=40114 id=28709
ts=2019-06-17T02:37:32.121515451Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Writing out packet&quot;
ts=2019-06-17T02:37:32.121601607Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Waiting for reply packets&quot;
ts=2019-06-17T02:37:32.121784123Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Found matching reply packet&quot;
ts=2019-06-17T02:37:32.132008756Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Creating ICMP packet&quot; seq=40131 id=28709
ts=2019-06-17T02:37:32.132046486Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Writing out packet&quot;
ts=2019-06-17T02:37:32.132156231Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Waiting for reply packets&quot;
ts=2019-06-17T02:37:32.132290778Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Found matching reply packet&quot;
ts=2019-06-17T02:37:32.142471236Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Creating ICMP packet&quot; seq=40151 id=28709
ts=2019-06-17T02:37:32.142498552Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Writing out packet&quot;
ts=2019-06-17T02:37:32.142553676Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Waiting for reply packets&quot;
ts=2019-06-17T02:37:32.142842589Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Found matching reply packet&quot;
ts=2019-06-17T02:37:32.153019445Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Creating ICMP packet&quot; seq=40167 id=28709
ts=2019-06-17T02:37:32.153058904Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Writing out packet&quot;
ts=2019-06-17T02:37:32.153787249Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Waiting for reply packets&quot;
ts=2019-06-17T02:37:32.153941817Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Found matching reply packet&quot;
ts=2019-06-17T02:37:32.164106811Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Creating ICMP packet&quot; seq=40183 id=28709
ts=2019-06-17T02:37:32.164138732Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Writing out packet&quot;
ts=2019-06-17T02:37:32.164204094Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Waiting for reply packets&quot;
ts=2019-06-17T02:37:32.164434414Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Found matching reply packet&quot;
ts=2019-06-17T02:37:32.174733606Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Probe succeeded&quot; duration_seconds=0.1084358
ts=2019-06-17T02:39:02.066061555Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Beginning probe&quot; probe=icmp timeout_seconds=5
ts=2019-06-17T02:39:02.066130953Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Resolving target address&quot; preferred_ip_protocol=ip4
ts=2019-06-17T02:39:02.066173486Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Resolved target address&quot; ip=10.246.52.2
ts=2019-06-17T02:39:02.066206364Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Creating socket&quot;
ts=2019-06-17T02:39:02.066258052Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Creating ICMP packet&quot; seq=41325 id=28709
ts=2019-06-17T02:39:02.066279145Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Writing out packet&quot;
ts=2019-06-17T02:39:02.066340288Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Waiting for reply packets&quot;
ts=2019-06-17T02:39:02.066638796Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Found matching reply packet&quot;
ts=2019-06-17T02:39:02.076843927Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Creating ICMP packet&quot; seq=41335 id=28709
ts=2019-06-17T02:39:02.076964095Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Writing out packet&quot;
ts=2019-06-17T02:39:02.077055779Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Waiting for reply packets&quot;
ts=2019-06-17T02:39:02.077305888Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Found matching reply packet&quot;
ts=2019-06-17T02:39:02.087472761Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Creating ICMP packet&quot; seq=41342 id=28709
ts=2019-06-17T02:39:02.087508241Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Writing out packet&quot;
ts=2019-06-17T02:39:02.087590206Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Waiting for reply packets&quot;
ts=2019-06-17T02:39:02.087798779Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Found matching reply packet&quot;
ts=2019-06-17T02:39:02.098010081Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Creating ICMP packet&quot; seq=41349 id=28709
ts=2019-06-17T02:39:02.098057728Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Writing out packet&quot;
ts=2019-06-17T02:39:02.098147227Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Waiting for reply packets&quot;
ts=2019-06-17T02:39:02.098559404Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Found matching reply packet&quot;
ts=2019-06-17T02:39:02.108720605Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Creating ICMP packet&quot; seq=41357 id=28709
ts=2019-06-17T02:39:02.108753317Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Writing out packet&quot;
ts=2019-06-17T02:39:02.108827358Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Waiting for reply packets&quot;
ts=2019-06-17T02:39:02.109055448Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Found matching reply packet&quot;
ts=2019-06-17T02:39:02.119296998Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Creating ICMP packet&quot; seq=41365 id=28709
ts=2019-06-17T02:39:02.119337291Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Writing out packet&quot;
ts=2019-06-17T02:39:02.119414356Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Waiting for reply packets&quot;
ts=2019-06-17T02:39:02.120157801Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Found matching reply packet&quot;
ts=2019-06-17T02:39:02.130325529Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Creating ICMP packet&quot; seq=41373 id=28709
ts=2019-06-17T02:39:02.130355006Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Writing out packet&quot;
ts=2019-06-17T02:39:02.130422945Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Waiting for reply packets&quot;
ts=2019-06-17T02:39:02.130698471Z caller=main.go:177 module=icmp target=10.246.52.2 level=debug msg=&quot;Found matching reply packet&quot;
</code></pre>

<p>每个循环流程都是正常的，没有出现无限循环等待，一个请求就是如下</p>

<pre><code>ts=2019-04-29T07:43:07.354100909Z caller=main.go:177 module=icmp target=10.105.59.28 level=debug msg=&quot;Creating ICMP packet&quot; seq=26243 id=30788
ts=2019-04-29T07:43:07.354166713Z caller=main.go:177 module=icmp target=10.105.59.28 level=debug msg=&quot;Writing out packet&quot;
ts=2019-04-29T07:43:07.354423787Z caller=main.go:177 module=icmp target=10.105.59.28 level=debug msg=&quot;Waiting for reply packets&quot;
ts=2019-04-29T07:43:07.354450417Z caller=main.go:177 module=icmp target=10.100.65.164 level=debug msg=&quot;Creating ICMP packet&quot; seq=26244 id=30788
ts=2019-04-29T07:43:07.354515927Z caller=main.go:177 module=icmp target=10.100.65.164 level=debug msg=&quot;Writing out packet&quot;
ts=2019-04-29T07:43:07.35459178Z caller=main.go:177 module=icmp target=10.103.132.233 level=debug msg=&quot;Creating ICMP packet&quot; seq=26245 id=30788
ts=2019-04-29T07:43:07.354645654Z caller=main.go:177 module=icmp target=10.103.132.233 level=debug msg=&quot;Writing out packet&quot;
ts=2019-04-29T07:43:07.354649947Z caller=main.go:177 module=icmp target=10.105.59.28 level=debug msg=&quot;Found matching reply packet&quot;
ts=2019-04-29T07:43:07.3546965Z caller=main.go:177 module=icmp target=10.100.65.164 level=debug msg=&quot;Waiting for reply packets&quot;
</code></pre>

<p>icmp协议是和tcp，udp等同的，他是基于ip协议的基础上实现的，ip本身不需要建立连接，icmp也是不需要建立连接的，等待返回，错误处理，超时结束，这样处理不会出现问题。</p>

<p>可见就是负载均衡有问题了。</p>
            </div>
            
            <div style="border: 1px dashed #e0e0e0; margin-bottom: 15px; padding: 10px 10px 10px 10px; background-color: #fffeee; background-repeat: no-repeat; background-attachment: scroll; background-position: 1% 50%; -moz-background-size: auto auto; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial;">
                <div>
                    <p style="margin-top:0px;">作者：<a target="_blank" href="http://blog.fatedier.com/">kingjcy</a>
                    <br />本文出处：<a target="_blank" href="https://kingjcy.github.io/post/product/pings/">https://kingjcy.github.io/post/product/pings/</a>
                    <br />
                    文章版权归本人所有，欢迎转载，但未经作者同意必须保留此段声明，且在文章页面明显位置给出原文链接，否则保留追究法律责任的权利。 </p>
                </div>
            </div>

            <aside>
                
                <ul class="list-inline post-tags">
                    
                    <li>
                        <a href="/tags/problems/">
                            <i class="fa fa-tags"></i>
                            problems
                        </a>
                    </li>
                    
                    <li>
                        <a href="/tags/ping/">
                            <i class="fa fa-tags"></i>
                            ping
                        </a>
                    </li>
                    
                </ul>

                
                
                <h4 id="real-rels">相关文章</h4>
                <ul class="post-rels" id="real-rels"><li id="li-rels"><a href="/post/product/memory/">生产问题排查解决系列----  Memory</a>&nbsp;&nbsp;<span class="post-date" style="font-size:14px">&nbsp;(2019年11月29日)</span></li></ul>
            </aside>
                
            
            <footer>
                <nav>
                    <ul class="pager">

                        
                        <li class="previous"><a href="/post/database/sqlite/"><span aria-hidden="true">&larr;</span> Prev</a></li>
                        

                        <li><a href="/post/">All Posts</a></li>

                        
                        <li class="next"><a href="/post/database/zookeeper/">Next <span aria-hidden="true">&rarr;</span></a></li>
                        

                    </ul>
                </nav>
            </footer>

        </article>
    </div>
    <div class="col-md-4">
        
<aside>
        <div class="toc panel panel-default hidden-xs hidden-sm affix-top" data-spy="affix" data-offset-top="125" data-offset-bottom="300">
            <div class="panel-heading">
                <h2 class="panel-title">Catalog</h2>
            </div>

            
        </div>
</aside>

    </div>
</div>

</div>
<hr>

<footer class="container copy">
    <p>&copy; 2020  kingjcy blog </p>
	<p>Powered by <a href="https://gohugo.io" target="_blank">Hugo</a></p>
</footer>

<script>hljs.initHighlightingOnLoad();</script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?ace3ec99de96c4080ead1eb8d52db3b3";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-92600390-2', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

