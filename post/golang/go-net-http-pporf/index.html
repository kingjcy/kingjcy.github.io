<!DOCTYPE html>

<html lang="zh-cn">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="author" content="fatedier">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="description" content="golang å¼€å‘è¿‡ç¨‹è¿›è¡Œæ€§èƒ½è°ƒä¼˜ï¼Œpprof ä¸€å®šæ˜¯ä¸€ä¸ªå¤§æ€å™¨èˆ¬çš„å·¥å…·ã€‚">
<meta property="og:url" content="https://kingjcy.github.io/"><meta property="og:type" content="article">
<meta property="og:title" content="golangä½¿ç”¨ç³»åˆ—---- net/http/pprof - kingjcy blog"><meta property="og:site_name" content="kingjcy blog">

<title>
    
    golangä½¿ç”¨ç³»åˆ—---- net/http/pprof
    
</title>

<link rel="stylesheet" href="/onlyone/onlyone.css">
<link rel="shortcut icon" href="/assets/favicon.ico">
<script src="/onlyone/onlyone.js"></script>
<link rel="alternate" type="application/rss+xml" title="RSS" href="/index.xml">
</head>
<body>


<div class="container">
    <header class="nav">
        <nav class="navbar navbar-default">
            <div class="container-fluid">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="/">kingjcy blog</a>
                </div>

                <div class="collapse navbar-collapse" id="navbar-collapse">
                    <ul class="nav navbar-nav">
                        <li><a href="/categories/æŠ€æœ¯æ–‡ç« /">æŠ€æœ¯æ–‡ç« </a></li>
			<li><a href="/categories/è¯»ä¹¦ç¬”è®°/">è¯»ä¹¦ç¬”è®°</a></li>
                        <li><a href="/categories/äººç”Ÿæ„Ÿæ‚Ÿ/">äººç”Ÿæ„Ÿæ‚Ÿ</a></li>
                        <li><a href="/categories/">å½’æ¡£</a></li>
                        <li><a href="/tags/">åˆ†ç±»</a></li>
                        <li><a href="/about/">å…³äºæˆ‘</a></li>
                        <li>
                            <form method="get" style="padding: 8px" action="https://www.google.com/search" target="_blank">
                                <input type="hidden" name="sitesearch" value="https://kingjcy.github.io/"/>
                                <input type="text" class="form-control" name="q" placeholder="Press enter to search">
                            </form>
                        </li>
                    </ul>

                </div>
            </div>
        </nav>
    </header>


<div class="row">
    <div class="col-md-8">
        <article class="post single">

            <header>
                <div class="post-date">
                    2019å¹´12æœˆ26æ—¥ 
                </div>
                <h1 class="post-title">golangä½¿ç”¨ç³»åˆ—---- net/http/pprof</h1>
            </header>

            <div class="post-content">
                <p>golang å¼€å‘è¿‡ç¨‹è¿›è¡Œæ€§èƒ½è°ƒä¼˜ï¼Œpprof ä¸€å®šæ˜¯ä¸€ä¸ªå¤§æ€å™¨èˆ¬çš„å·¥å…·ã€‚</p>

<h1 id="pprof">PProf</h1>

<p>æƒ³è¦è¿›è¡Œæ€§èƒ½ä¼˜åŒ–ï¼Œé¦–å…ˆç©ç›®åœ¨ Go è‡ªèº«æä¾›çš„å·¥å…·é“¾æ¥ä½œä¸ºåˆ†æä¾æ®ï¼Œæœ¬æ–‡å°†å¸¦ä½ å­¦ä¹ ã€ä½¿ç”¨ Go åèŠ±å›­ï¼Œæ¶‰åŠå¦‚ä¸‹ï¼š</p>

<pre><code>runtime/pprofï¼šé‡‡é›†ç¨‹åºï¼ˆé Serverï¼‰çš„è¿è¡Œæ•°æ®è¿›è¡Œåˆ†æ
net/http/pprofï¼šé‡‡é›† HTTP Server çš„è¿è¡Œæ—¶æ•°æ®è¿›è¡Œåˆ†æ
</code></pre>

<p>å…¶å®net/http/pprofä¸­åªæ˜¯ä½¿ç”¨runtime/pprofåŒ…æ¥è¿›è¡Œå°è£…äº†ä¸€ä¸‹ï¼Œå¹¶åœ¨httpç«¯å£ä¸Šæš´éœ²å‡ºæ¥</p>

<h1 id="åŸºæœ¬åŸç†">åŸºæœ¬åŸç†</h1>

<p>pprof æ˜¯ç”¨äºå¯è§†åŒ–å’Œåˆ†ææ€§èƒ½åˆ†ææ•°æ®çš„å·¥å…·,pprof ä»¥ profile.proto è¯»å–åˆ†ææ ·æœ¬çš„é›†åˆï¼Œå¹¶ç”ŸæˆæŠ¥å‘Šä»¥å¯è§†åŒ–å¹¶å¸®åŠ©åˆ†ææ•°æ®ï¼ˆæ”¯æŒæ–‡æœ¬å’Œå›¾å½¢æŠ¥å‘Šï¼‰</p>

<p>profile.proto æ˜¯ä¸€ä¸ª Protocol Buffer v3 çš„æè¿°æ–‡ä»¶ï¼Œå®ƒæè¿°äº†ä¸€ç»„ callstack å’Œ symbolization ä¿¡æ¯ï¼Œ ä½œç”¨æ˜¯è¡¨ç¤ºç»Ÿè®¡åˆ†æçš„ä¸€ç»„é‡‡æ ·çš„è°ƒç”¨æ ˆï¼Œæ˜¯å¾ˆå¸¸è§çš„ stacktrace é…ç½®æ–‡ä»¶æ ¼å¼</p>

<h1 id="åŸºæœ¬ä½¿ç”¨">åŸºæœ¬ä½¿ç”¨</h1>

<p>1ã€ä½¿ç”¨æ–¹å¼</p>

<ul>
<li>åŸºå‡†æµ‹è¯•æ–‡ä»¶ï¼šä¾‹å¦‚ä½¿ç”¨å‘½ä»¤go test . -bench . -cpuprofile prof.cpu ç”Ÿæˆé‡‡æ ·æ–‡ä»¶åï¼Œå†é€šè¿‡å‘½ä»¤ go tool pprof [binary] prof.cpu æ¥è¿›è¡Œåˆ†æã€‚</li>
<li>import _ net/http/pprofï¼šå¦‚æœæˆ‘ä»¬çš„åº”ç”¨æ˜¯ä¸€ä¸ªwebæœåŠ¡ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨httpæœåŠ¡å¯åŠ¨çš„ä»£ç æ–‡ä»¶(eg: main.go)æ·»åŠ  import _ net/http/pprofï¼Œè¿™æ ·æˆ‘ä»¬çš„æœåŠ¡ ä¾¿èƒ½è‡ªåŠ¨å¼€å¯profileåŠŸèƒ½ï¼Œæœ‰åŠ©äºæˆ‘ä»¬ç›´æ¥åˆ†æé‡‡æ ·ç»“æœã€‚</li>
<li>é€šè¿‡åœ¨ä»£ç é‡Œé¢è°ƒç”¨ runtime.StartCPUProfileæˆ–è€…runtime.WriteHeapProfileã€‚</li>
</ul>

<p>2ã€æ”¯æŒä»€ä¹ˆä½¿ç”¨æ¨¡å¼</p>

<ul>
<li>Report generationï¼šæŠ¥å‘Šç”Ÿæˆ</li>
<li>Interactive terminal useï¼šäº¤äº’å¼ç»ˆç«¯ä½¿ç”¨</li>
<li>Web interfaceï¼šWeb ç•Œé¢</li>
</ul>

<p>3ã€å¯ä»¥åšä»€ä¹ˆ</p>

<ul>
<li>CPU Profilingï¼šCPU åˆ†æï¼ŒæŒ‰ç…§ä¸€å®šçš„é¢‘ç‡é‡‡é›†æ‰€ç›‘å¬çš„åº”ç”¨ç¨‹åº CPUï¼ˆå«å¯„å­˜å™¨ï¼‰çš„ä½¿ç”¨æƒ…å†µï¼Œå¯ç¡®å®šåº”ç”¨ç¨‹åºåœ¨ä¸»åŠ¨æ¶ˆè€— CPU å‘¨æœŸæ—¶èŠ±è´¹æ—¶é—´çš„ä½ç½®</li>
<li>Memory Profilingï¼šå†…å­˜åˆ†æï¼Œåœ¨åº”ç”¨ç¨‹åºè¿›è¡Œå †åˆ†é…æ—¶è®°å½•å †æ ˆè·Ÿè¸ªï¼Œç”¨äºç›‘è§†å½“å‰å’Œå†å²å†…å­˜ä½¿ç”¨æƒ…å†µï¼Œä»¥åŠæ£€æŸ¥å†…å­˜æ³„æ¼</li>
<li>Block Profilingï¼šé˜»å¡åˆ†æï¼Œè®°å½• goroutine é˜»å¡ç­‰å¾…åŒæ­¥ï¼ˆåŒ…æ‹¬å®šæ—¶å™¨é€šé“ï¼‰çš„ä½ç½®</li>
<li>Mutex Profilingï¼šäº’æ–¥é”åˆ†æï¼ŒæŠ¥å‘Šäº’æ–¥é”çš„ç«äº‰æƒ…å†µ</li>
</ul>

<p>ä¸Šé¢åªæ˜¯å¸¸ç”¨çš„ä¸€éƒ¨åˆ†ï¼Œè¿˜æœ‰å¦‚ä¸‹éƒ½å¯ä»¥åˆ†æï¼Œåªä¸è¿‡ä½¿ç”¨çš„ä¸å¤šã€‚</p>

<pre><code>Profile Descriptions:
allocs: A sampling of all past memory allocations
block: Stack traces that led to blocking on synchronization primitives
cmdline: The command line invocation of the current program
goroutine: Stack traces of all current goroutines
heap: A sampling of memory allocations of live objects. You can specify the gc GET parameter to run GC before taking the heap sample.
mutex: Stack traces of holders of contended mutexes
profile: CPU profile. You can specify the duration in the seconds GET parameter. After you get the profile file, use the go tool pprof command to investigate the profile.
threadcreate: Stack traces that led to the creation of new OS threads
trace: A trace of execution of the current program. You can specify the duration in the seconds GET parameter. After you get the trace file, use the go tool trace command to investigate the trace.
</code></pre>

<h2 id="ä½¿ç”¨">ä½¿ç”¨</h2>

<blockquote>
<p>ç¬¬ä¸€ç§ä½¿ç”¨æ–¹å¼</p>
</blockquote>

<p>ç¼–å†™æµ‹è¯•ç”¨ä¾‹</p>

<pre><code>package data

import &quot;testing&quot;

const url = &quot;https://github.com/EDDYCJY&quot;

func TestAdd(t *testing.T) {
    s := Add(url)
    if s == &quot;&quot; {
        t.Errorf(&quot;Test.Add error!&quot;)
    }
}

func BenchmarkAdd(b *testing.B) {
    for i := 0; i &lt; b.N; i++ {
        Add(url)
    }
}
</code></pre>

<p>æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹</p>

<pre><code>$ go test -bench=. -cpuprofile=cpu.prof
pkg: github.com/EDDYCJY/go-pprof-example/data
BenchmarkAdd-4       10000000           187 ns/op
PASS
ok      github.com/EDDYCJY/go-pprof-example/data    2.300s
</code></pre>

<p>å¯åŠ¨ PProf å¯è§†åŒ–ç•Œé¢è¿›è¡Œåˆ†æ</p>

<pre><code>æ–¹æ³•ä¸€ï¼š
$ go tool pprof -http=:8080 cpu.prof
æ–¹æ³•äºŒï¼š
$ go tool pprof cpu.prof
$ (pprof) web
</code></pre>

<blockquote>
<p>ç¬¬äºŒç§ä½¿ç”¨æ–¹å¼</p>
</blockquote>

<p>æˆ‘ä»¬æœ€å¸¸ç”¨çš„å°±æ˜¯ç¬¬äºŒç§æ–¹å¼ï¼Œimport _ net/http/pprofï¼Œæˆ‘ä»¬å°†ç¼–å†™ä¸€ä¸ªç®€å•ä¸”æœ‰ç‚¹é—®é¢˜çš„ä¾‹å­ï¼Œç”¨äºåŸºæœ¬çš„ç¨‹åºåˆæ­¥åˆ†æ</p>

<pre><code>package main

import (
    &quot;log&quot;
    &quot;net/http&quot;
    _ &quot;net/http/pprof&quot;
    &quot;github.com/EDDYCJY/go-pprof-example/data&quot;
)

func main() {
    go func() {
        for {
            log.Println(data.Add(&quot;https://github.com/EDDYCJY&quot;))
        }
    }()

    http.ListenAndServe(&quot;0.0.0.0:6060&quot;, nil)
}



package data

var datas []string

func Add(str string) string {
    data := []byte(str)
    sData := string(data)
    datas = append(datas, sData)

    return sData
}
</code></pre>

<p>è¿è¡Œè¿™ä¸ªæ–‡ä»¶ï¼Œä½ çš„ HTTP æœåŠ¡ä¼šå¤šå‡º /debug/pprof çš„ endpoint å¯ç”¨äºè§‚å¯Ÿåº”ç”¨ç¨‹åºçš„æƒ…å†µ</p>

<h2 id="äº¤äº’åˆ†æ">äº¤äº’åˆ†æ</h2>

<blockquote>
<p>é€šè¿‡ Web ç•Œé¢</p>
</blockquote>

<p>æŸ¥çœ‹å½“å‰æ€»è§ˆï¼šè®¿é—® <a href="http://127.0.0.1:6060/debug/pprof/">http://127.0.0.1:6060/debug/pprof/</a></p>

<pre><code>/debug/pprof/

profiles:
0    block
5    goroutine
3    heap
0    mutex
9    threadcreate

full goroutine stack dump
</code></pre>

<p>è¿™ä¸ªé¡µé¢ä¸­æœ‰è®¸å¤šå­é¡µé¢ï¼Œå’±ä»¬ç»§ç»­æ·±ç©¶ä¸‹å»ï¼Œçœ‹çœ‹å¯ä»¥å¾—åˆ°ä»€ä¹ˆï¼Ÿ</p>

<pre><code>cpuï¼ˆCPU Profilingï¼‰: $HOST/debug/pprof/profileï¼Œé»˜è®¤è¿›è¡Œ 30s çš„ CPU Profilingï¼Œå¾—åˆ°ä¸€ä¸ªåˆ†æç”¨çš„ profile æ–‡ä»¶
blockï¼ˆBlock Profilingï¼‰ï¼š$HOST/debug/pprof/blockï¼ŒæŸ¥çœ‹å¯¼è‡´é˜»å¡åŒæ­¥çš„å †æ ˆè·Ÿè¸ª
goroutineï¼š$HOST/debug/pprof/goroutineï¼ŒæŸ¥çœ‹å½“å‰æ‰€æœ‰è¿è¡Œçš„ goroutines å †æ ˆè·Ÿè¸ª
heapï¼ˆMemory Profilingï¼‰: $HOST/debug/pprof/heapï¼ŒæŸ¥çœ‹æ´»åŠ¨å¯¹è±¡çš„å†…å­˜åˆ†é…æƒ…å†µ
mutexï¼ˆMutex Profilingï¼‰ï¼š$HOST/debug/pprof/mutexï¼ŒæŸ¥çœ‹å¯¼è‡´äº’æ–¥é”çš„ç«äº‰æŒæœ‰è€…çš„å †æ ˆè·Ÿè¸ª
threadcreateï¼š$HOST/debug/pprof/threadcreateï¼ŒæŸ¥çœ‹åˆ›å»ºæ–°OSçº¿ç¨‹çš„å †æ ˆè·Ÿè¸ª
</code></pre>

<blockquote>
<p>é€šè¿‡äº¤äº’å¼ç»ˆç«¯ä½¿ç”¨</p>
</blockquote>

<p>ï¼ˆ1ï¼‰è·å–cpuç›¸å…³ï¼šgo tool pprof <a href="http://localhost:6060/debug/pprof/profile?seconds=60">http://localhost:6060/debug/pprof/profile?seconds=60</a></p>

<pre><code>$ go tool pprof http://localhost:6060/debug/pprof/profile\?seconds\=60

Fetching profile over HTTP from http://localhost:6060/debug/pprof/profile?seconds=60
Saved profile in /Users/eddycjy/pprof/pprof.samples.cpu.007.pb.gz
Type: cpu
Duration: 1mins, Total samples = 26.55s (44.15%)
Entering interactive mode (type &quot;help&quot; for commands, &quot;o&quot; for options)
(pprof)
</code></pre>

<p>æ‰§è¡Œè¯¥å‘½ä»¤åï¼Œéœ€ç­‰å¾… 60 ç§’ï¼ˆå¯è°ƒæ•´ seconds çš„å€¼ï¼‰ï¼Œpprof ä¼šè¿›è¡Œ CPU Profilingã€‚ç»“æŸåå°†é»˜è®¤è¿›å…¥ pprof çš„äº¤äº’å¼å‘½ä»¤æ¨¡å¼ï¼Œå¯ä»¥å¯¹åˆ†æçš„ç»“æœè¿›è¡ŒæŸ¥çœ‹æˆ–å¯¼å‡ºã€‚å…·ä½“å¯æ‰§è¡Œ pprof help æŸ¥çœ‹å‘½ä»¤è¯´æ˜</p>

<pre><code>(pprof) top10
Showing nodes accounting for 25.92s, 97.63% of 26.55s total
Dropped 85 nodes (cum &lt;= 0.13s)
Showing top 10 nodes out of 21
      flat  flat%   sum%        cum   cum%
    23.28s 87.68% 87.68%     23.29s 87.72%  syscall.Syscall
     0.77s  2.90% 90.58%      0.77s  2.90%  runtime.memmove
     0.58s  2.18% 92.77%      0.58s  2.18%  runtime.freedefer
     0.53s  2.00% 94.76%      1.42s  5.35%  runtime.scanobject
     0.36s  1.36% 96.12%      0.39s  1.47%  runtime.heapBitsForObject
     0.35s  1.32% 97.44%      0.45s  1.69%  runtime.greyobject
     0.02s 0.075% 97.51%     24.96s 94.01%  main.main.func1
     0.01s 0.038% 97.55%     23.91s 90.06%  os.(*File).Write
     0.01s 0.038% 97.59%      0.19s  0.72%  runtime.mallocgc
     0.01s 0.038% 97.63%     23.30s 87.76%  syscall.Write
flatï¼šç»™å®šå‡½æ•°ä¸Šè¿è¡Œè€—æ—¶
flat%ï¼šåŒä¸Šçš„ CPU è¿è¡Œè€—æ—¶æ€»æ¯”ä¾‹
sum%ï¼šç»™å®šå‡½æ•°ç´¯ç§¯ä½¿ç”¨ CPU æ€»æ¯”ä¾‹
cumï¼šå½“å‰å‡½æ•°åŠ ä¸Šå®ƒä¹‹ä¸Šçš„è°ƒç”¨è¿è¡Œæ€»è€—æ—¶
cum%ï¼šåŒä¸Šçš„ CPU è¿è¡Œè€—æ—¶æ€»æ¯”ä¾‹
æœ€åä¸€åˆ—ä¸ºå‡½æ•°åç§°ï¼Œåœ¨å¤§å¤šæ•°çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™äº”åˆ—å¾—å‡ºä¸€ä¸ªåº”ç”¨ç¨‹åºçš„è¿è¡Œæƒ…å†µï¼ŒåŠ ä»¥ä¼˜åŒ– ğŸ¤”
</code></pre>

<p>ï¼ˆ2ï¼‰è·å–å†…å­˜ç›¸å…³ï¼šgo tool pprof <a href="http://localhost:6060/debug/pprof/heap">http://localhost:6060/debug/pprof/heap</a></p>

<pre><code>$ go tool pprof http://localhost:6060/debug/pprof/heap
Fetching profile over HTTP from http://localhost:6060/debug/pprof/heap
Saved profile in /Users/eddycjy/pprof/pprof.alloc_objects.alloc_space.inuse_objects.inuse_space.008.pb.gz
Type: inuse_space
Entering interactive mode (type &quot;help&quot; for commands, &quot;o&quot; for options)
(pprof) top
Showing nodes accounting for 837.48MB, 100% of 837.48MB total
      flat  flat%   sum%        cum   cum%
  837.48MB   100%   100%   837.48MB   100%  main.main.func1
-inuse_spaceï¼šåˆ†æåº”ç”¨ç¨‹åºçš„å¸¸é©»å†…å­˜å ç”¨æƒ…å†µ
-alloc_objectsï¼šåˆ†æåº”ç”¨ç¨‹åºçš„å†…å­˜ä¸´æ—¶åˆ†é…æƒ…å†µ
</code></pre>

<p>ï¼ˆ3ï¼‰è·å–é˜»å¡ç›¸å…³ï¼šgo tool pprof <a href="http://localhost:6060/debug/pprof/block">http://localhost:6060/debug/pprof/block</a></p>

<p>ï¼ˆ4ï¼‰è·å–é”ç›¸å…³ï¼šgo tool pprof <a href="http://localhost:6060/debug/pprof/mutex">http://localhost:6060/debug/pprof/mutex</a></p>

<blockquote>
<p>PProf å¯è§†åŒ–ç•Œé¢</p>
</blockquote>

<p>1ã€webå‘½ä»¤</p>

<p>å¯åŠ¨ PProf å¯è§†åŒ–ç•Œé¢æ­£å¸¸æœ‰ä¸¤ç§æ–¹å¼ï¼Œä¸€ç§å°±æ˜¯å¯¹cpuæ–‡ä»¶è¿›è¡Œåˆ†æï¼Œæ¯”å¦‚ä¸Šé¢benchçš„cpu.profï¼Œæˆ–è€…äº¤äº’ç”Ÿæˆçš„pprof.samples.cpu.007.pb.gzï¼Œåœ¨äº¤äº’çš„å‘½ä»¤ä¸­è¾“å…¥webï¼Œå°±å¯ä»¥é€šè¿‡webè¿›è¡Œè®¿é—®ã€‚</p>

<pre><code>$ (pprof) web
</code></pre>

<p>å¦‚æœå‡ºç° Could not execute dot; may need to install graphviz.ï¼Œå°±æ˜¯æç¤ºä½ è¦å®‰è£… graphviz äº† ï¼Œæˆ‘ä»¬ç®€å•è¯´æ˜ä¸€ä¸‹å®‰è£…ï¼ˆè¯¦ç»†è¯·å³æ‹è°·æ­Œï¼‰ã€‚</p>

<pre><code>brew install graphviz # for macos
apt install graphviz # for ubuntu
yum install graphviz # for centos
</code></pre>

<p>æŸ¥çœ‹ PProf å¯è§†åŒ–ç•Œé¢ï¼Œä¸‹é¢æ˜¯url</p>

<pre><code>ï¼ˆ1ï¼‰Top
ï¼ˆ2ï¼‰Graph
æ¡†è¶Šå¤§ï¼Œçº¿è¶Šç²—ä»£è¡¨å®ƒå ç”¨çš„æ—¶é—´è¶Šå¤§å“¦
ï¼ˆ3ï¼‰Peek
ï¼ˆ4ï¼‰Source
</code></pre>

<p>é€šè¿‡ PProf çš„å¯è§†åŒ–ç•Œé¢ï¼Œæˆ‘ä»¬èƒ½å¤Ÿæ›´æ–¹ä¾¿ã€æ›´ç›´è§‚çš„çœ‹åˆ° Go åº”ç”¨ç¨‹åºçš„è°ƒç”¨é“¾ã€ä½¿ç”¨æƒ…å†µç­‰ï¼Œå¹¶ä¸”åœ¨ View èœå•æ ä¸­ï¼Œè¿˜æ”¯æŒå¦‚ä¸Šå¤šç§æ–¹å¼çš„åˆ‡æ¢</p>

<p>æˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´æ¥åœ¨ä¸Šé¢çš„å‘½ä»¤è¡Œä¸­ç›´æ¥æ“ä½œï¼Œå®‰è£…å®Œæˆåï¼Œæˆ‘ä»¬ç»§ç»­åœ¨ä¸Šæ–‡çš„äº¤äº’å¼ç»ˆç«¯é‡Œè¾“å…¥ webï¼Œæ³¨æ„ï¼Œè™½ç„¶è¿™ä¸ªå‘½ä»¤çš„åå­—å«â€œwebâ€ï¼Œä½†å®ƒçš„å®é™…è¡Œä¸ºæ˜¯äº§ç”Ÿä¸€ä¸ª .svg æ–‡ä»¶ï¼Œå¹¶è°ƒç”¨ä½ çš„ç³»ç»Ÿé‡Œè®¾ç½®çš„é»˜è®¤æ‰“å¼€ .svg çš„ç¨‹åºæ‰“å¼€å®ƒã€‚å¦‚æœä½ çš„ç³»ç»Ÿé‡Œæ‰“å¼€ .svg çš„é»˜è®¤ç¨‹åºå¹¶ä¸æ˜¯æµè§ˆå™¨ï¼ˆæ¯”å¦‚å¯èƒ½æ˜¯ä½ çš„ä»£ç ç¼–è¾‘å™¨ï¼‰ï¼Œè¿™æ—¶å€™ä½ éœ€è¦è®¾ç½®ä¸€ä¸‹é»˜è®¤ä½¿ç”¨æµè§ˆå™¨æ‰“å¼€ .svg æ–‡ä»¶ï¼Œç›¸ä¿¡è¿™éš¾ä¸å€’ä½ ã€‚</p>

<p>2ã€PProf ç«ç„°å›¾</p>

<p>å¦ä¸€ç§å¯è§†åŒ–æ•°æ®çš„æ–¹æ³•æ˜¯ç«ç„°å›¾ï¼ŒåŸå…ˆæ˜¯ uber å¼€æºçš„ä¸€ä¸ªå·¥å…·ï¼šgo-torchï¼Œå¯ä»¥ç›´æ¥è¯»å– golang profiling æ•°æ®ï¼Œå¹¶ç”Ÿæˆä¸€ä¸ªç«ç„°å›¾çš„ svg æ–‡ä»¶ã€‚ç«ç„°å›¾ svg æ–‡ä»¶å¯ä»¥é€šè¿‡æµè§ˆå™¨æ‰“å¼€ï¼Œå®ƒå¯¹äºè°ƒç”¨å›¾çš„æœ€ä¼˜ç‚¹æ˜¯å®ƒæ˜¯åŠ¨æ€çš„ï¼šå¯ä»¥é€šè¿‡ç‚¹å‡»æ¯ä¸ªæ–¹å—æ¥ zoom in åˆ†æå®ƒä¸Šé¢çš„å†…å®¹ã€‚</p>

<p>ç°åœ¨è¿™ä¸ªé¡¹ç›®å·²ç»åˆå¹¶åˆ°å·¥å…·pprofä¸­å»äº†</p>

<pre><code>go-torch is deprecated, use pprof instead
</code></pre>

<p>éœ€è¦å®‰è£…FlameGraphçš„è„šæœ¬</p>

<pre><code>git clone https://github.com/brendangregg/FlameGraph.git
</code></pre>

<p>æŠŠflamegraph.plæ‹·åˆ°æˆ‘ä»¬æœºå™¨ç¯å¢ƒå˜é‡$PATHçš„è·¯å¾„ä¸­å»</p>

<pre><code>cp flamegraph.pl /usr/local/bin
</code></pre>

<p>åœ¨ç»ˆç«¯è¾“å…¥ flamegraph.pl -h æ˜¯å¦å®‰è£…FlameGraphæˆåŠŸ</p>

<p>1.è·å–cpuprofile</p>

<p>è·å–æœ€è¿‘10ç§’ç¨‹åºè¿è¡Œçš„cpuprofile,-secondså‚æ•°ä¸å¡«é»˜è®¤ä¸º30ã€‚</p>

<pre><code>go tool pprof http://127.0.0.1:8080/debug/pprof/profile -seconds 10
</code></pre>

<p>ç­‰10såä¼šç”Ÿæˆä¸€ä¸ª: pprof.samples.cpu.001.pb.gzæ–‡ä»¶</p>

<p>2.ç”Ÿæˆç«ç„°å›¾</p>

<pre><code>go tool pprof -http=:8081 ~/pprof/pprof.samples.cpu.001.pb.gz
</code></pre>

<p>å…¶ä¸­-http=:8081ä¼šå¯åŠ¨ä¸€ä¸ªhttpæœåŠ¡,ç«¯å£ä¸º8081,ç„¶åæµè§ˆå™¨ä¼šå¼¹å‡ºæ­¤æ–‡ä»¶çš„å›¾è§£</p>

<p>è¿˜æ˜¯éœ€è¦åŸºäºä¸Šé¢å®‰è£…çš„graphvizï¼Œå¦‚æœæ²¡æœ‰å®‰è£…éœ€è¦å…ˆå®‰è£…ä¸€ä¸‹ã€‚ç„¶åå¯ä»¥åœ¨ç•Œé¢é€‰æ‹©</p>

<p><img src="/media/golang/net/pprof/pprof.png" alt="" /></p>

<p>åœ¨ä½¿ç”¨ç«ç„°å›¾çš„æ—¶å€™ï¼Œä¹Ÿæ˜¯éœ€è¦ä½¿ç”¨äº¤äº’çš„å‘½ä»¤çš„ï¼Œæ¯”å¦‚åœ¨listå‡½æ•°çš„æ—¶å€™ï¼Œä¹Ÿå¯ä»¥çœ‹å‡ºæ¯ä¸ªå‡½æ•°çš„è°ƒç”¨æ—¶é—´ã€‚</p>

<h1 id="å®æˆ˜">å®æˆ˜</h1>

<h2 id="è·å–é—®é¢˜ç¨‹åº">è·å–é—®é¢˜ç¨‹åº</h2>

<p>ç›´æ¥åˆ°githubä¸Šä¸‹è½½</p>

<pre><code>go get -d github.com/wolfogre/go-pprof-practice
cd $GOPATH/src/github.com/wolfogre/go-pprof-practice
</code></pre>

<p>ç®€å•çœ‹ä¸€ä¸‹</p>

<pre><code>package main

import (
    // ç•¥
    _ &quot;net/http/pprof&quot; // ä¼šè‡ªåŠ¨æ³¨å†Œ handler åˆ° http serverï¼Œæ–¹ä¾¿é€šè¿‡ http æ¥å£è·å–ç¨‹åºè¿è¡Œé‡‡æ ·æŠ¥å‘Š
    // ç•¥
)

func main() {
    // ç•¥

    runtime.GOMAXPROCS(1) // é™åˆ¶ CPU ä½¿ç”¨æ•°ï¼Œé¿å…è¿‡è½½
    runtime.SetMutexProfileFraction(1) // å¼€å¯å¯¹é”è°ƒç”¨çš„è·Ÿè¸ª
    runtime.SetBlockProfileRate(1) // å¼€å¯å¯¹é˜»å¡æ“ä½œçš„è·Ÿè¸ª

    go func() {
        // å¯åŠ¨ä¸€ä¸ª http serverï¼Œæ³¨æ„ pprof ç›¸å…³çš„ handler å·²ç»è‡ªåŠ¨æ³¨å†Œè¿‡äº†
        if err := http.ListenAndServe(&quot;:6060&quot;, nil); err != nil {
            log.Fatal(err)
        }
        os.Exit(0)
    }()

    // ç•¥
}
</code></pre>

<p>ç¼–è¯‘è¿è¡Œ</p>

<pre><code>go build
./go-pprof-practice
</code></pre>

<p>ä½¿ç”¨pprofæŸ¥çœ‹èµ„æºä½¿ç”¨æƒ…å†µï¼Œè¿™ä¸ªåœ¨ä¸Šé¢éƒ½è¯¦ç»†è¯´æ˜è¿‡äº†ã€‚</p>

<pre><code>http://localhost:6060/debug/pprof/
</code></pre>

<h2 id="æ’æŸ¥cpuå æ¯”è¿‡é«˜">æ’æŸ¥cpuå æ¯”è¿‡é«˜</h2>

<p>1ã€ä½¿ç”¨å‘½ä»¤ï¼šgo tool pprof <a href="http://localhost:6060/debug/pprof/profile">http://localhost:6060/debug/pprof/profile</a> ï¼Œç­‰å¾…ä¸€ä¼šå„¿åï¼Œè¿›å…¥ä¸€ä¸ªäº¤äº’å¼ç»ˆç«¯ï¼š</p>

<p><img src="/media/golang/net/pprof/pprof1.jpg" alt="" /></p>

<p>2ã€è¾“å…¥ top å‘½ä»¤ï¼ŒæŸ¥çœ‹ CPU å ç”¨è¾ƒé«˜çš„è°ƒç”¨ï¼š</p>

<p><img src="/media/golang/net/pprof/pprof2.jpg" alt="" /></p>

<p>å¾ˆæ˜æ˜¾ï¼ŒCPU å ç”¨è¿‡é«˜æ˜¯ github.com/wolfogre/go-pprof-practice/animal/felidae/tiger.(*Tiger).Eat é€ æˆçš„ã€‚</p>

<p>3ã€è¾“å…¥ list Eatï¼ŒæŸ¥çœ‹é—®é¢˜å…·ä½“åœ¨ä»£ç çš„å“ªä¸€ä¸ªä½ç½®</p>

<p><img src="/media/golang/net/pprof/pprof3.jpg" alt="" /></p>

<p>å¯ä»¥çœ‹åˆ°ï¼Œæ˜¯ç¬¬ 24 è¡Œé‚£ä¸ªä¸€ç™¾äº¿æ¬¡ç©ºå¾ªç¯å ç”¨äº†å¤§é‡ CPU æ—¶é—´ï¼Œè‡³æ­¤ï¼Œé—®é¢˜å®šä½æˆåŠŸï¼</p>

<p>4ã€æˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨webæ¥å½¢è±¡çš„æŸ¥çœ‹</p>

<p><img src="/media/golang/net/pprof/pprof4.jpg" alt="" /></p>

<p>å›¾ä¸­ï¼Œtiger.(*Tiger).Eat å‡½æ•°çš„æ¡†ç‰¹åˆ«å¤§ï¼Œç®­å¤´ç‰¹åˆ«ç²—ï¼Œpprof ç”Ÿæ€•ä½ ä¸çŸ¥é“è¿™ä¸ªå‡½æ•°çš„ CPU å ç”¨å¾ˆé«˜ï¼Œè¿™å¼ å›¾è¿˜åŒ…å«äº†å¾ˆå¤šæœ‰è¶£ä¸”æœ‰ä»·å€¼çš„ä¿¡æ¯ã€‚</p>

<h2 id="æ’æŸ¥å†…å­˜å ç”¨è¿‡é«˜">æ’æŸ¥å†…å­˜å ç”¨è¿‡é«˜</h2>

<p>åŒæ ·å‘½ä»¤ï¼šgo tool pprof <a href="http://localhost:6060/debug/pprof/heapï¼Œ">http://localhost:6060/debug/pprof/heapï¼Œ</a> ç„¶åå†ä¸€æ¬¡ä½¿ç”¨ topã€list æ¥å®šé—®é—®é¢˜ä»£ç ï¼Œå°±ä¸å¤šè¯´äº†</p>

<p><img src="/media/golang/net/pprof/pprof5.jpg" alt="" /></p>

<p>å¯ä»¥çœ‹åˆ°è¿™æ¬¡å‡ºé—®é¢˜çš„åœ°æ–¹åœ¨ github.com/wolfogre/go-pprof-practice/animal/muridae/mouse.(*Mouse).Stealï¼Œå¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œæœ‰ä¸ªå¾ªç¯ä¼šä¸€ç›´å‘ m.buffer é‡Œè¿½åŠ é•¿åº¦ä¸º 1 MiB çš„æ•°ç»„ï¼Œç›´åˆ°æ€»å®¹é‡åˆ°è¾¾ 1 GiB ä¸ºæ­¢ï¼Œä¸”ä¸€ç›´ä¸é‡Šæ”¾è¿™äº›å†…å­˜ï¼Œè¿™å°±éš¾æ€ªä¼šæœ‰è¿™ä¹ˆé«˜çš„å†…å­˜å ç”¨äº†ã€‚</p>

<h2 id="å…¶ä»–">å…¶ä»–</h2>

<p>å…¶å®æ’æŸ¥å…¶ä»–çš„é—®é¢˜éƒ½æ˜¯é€šè¿‡ç›¸åŒçš„æ–¹å¼è¿›è¡Œæ’æŸ¥ï¼Œtopï¼Œlistï¼Œwebæ¥çœ‹å‡ºé—®é¢˜æ‰€åœ¨ï¼Œå½“ç„¶ä½¿ç”¨ç«ç„°å›¾å°±æ›´åŠ çš„å½¢è±¡äº†ã€‚</p>
            </div>
            
            <div style="border: 1px dashed #e0e0e0; margin-bottom: 15px; padding: 10px 10px 10px 10px; background-color: #fffeee; background-repeat: no-repeat; background-attachment: scroll; background-position: 1% 50%; -moz-background-size: auto auto; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial;">
                <div>
                    <p style="margin-top:0px;">ä½œè€…ï¼š<a target="_blank" href="https://kingjcy.github.io/">kingjcy</a>
                    <br />æœ¬æ–‡å‡ºå¤„ï¼š<a target="_blank" href="https://kingjcy.github.io/post/golang/go-net-http-pporf/">https://kingjcy.github.io/post/golang/go-net-http-pporf/</a>
                    <br />
                    æ–‡ç« ç‰ˆæƒå½’æœ¬äººæ‰€æœ‰ï¼Œæ¬¢è¿è½¬è½½ï¼Œä½†æœªç»ä½œè€…åŒæ„å¿…é¡»ä¿ç•™æ­¤æ®µå£°æ˜ï¼Œä¸”åœ¨æ–‡ç« é¡µé¢æ˜æ˜¾ä½ç½®ç»™å‡ºåŸæ–‡é“¾æ¥ï¼Œå¦åˆ™ä¿ç•™è¿½ç©¶æ³•å¾‹è´£ä»»çš„æƒåˆ©ã€‚ </p>
                </div>
            </div>

            <aside>
                
                <ul class="list-inline post-tags">
                    
                    <li>
                        <a href="/tags/golang/">
                            <i class="fa fa-tags"></i>
                            golang
                        </a>
                    </li>
                    
                    <li>
                        <a href="/tags/net/">
                            <i class="fa fa-tags"></i>
                            net
                        </a>
                    </li>
                    
                    <li>
                        <a href="/tags/http/">
                            <i class="fa fa-tags"></i>
                            http
                        </a>
                    </li>
                    
                    <li>
                        <a href="/tags/pprof/">
                            <i class="fa fa-tags"></i>
                            pprof
                        </a>
                    </li>
                    
                </ul>

                
                
                <h4 id="real-rels">ç›¸å…³æ–‡ç« </h4>
                <ul class="post-rels" id="real-rels"><li id="li-rels"><a href="/post/computerbase/network/http/">è®¡ç®—æœºç½‘ç»œç³»åˆ—ï¼ˆå…«ï¼‰---- Http</a>&nbsp;&nbsp;<span class="post-date" style="font-size:14px">&nbsp;(2020å¹´10æœˆ13æ—¥)</span></li><li id="li-rels"><a href="/post/golang/go-channel/">Golangä½¿ç”¨ç³»åˆ—---- channel</a>&nbsp;&nbsp;<span class="post-date" style="font-size:14px">&nbsp;(2020å¹´08æœˆ24æ—¥)</span></li><li id="li-rels"><a href="/post/golang/go-goroutinechannel/">Golangä½¿ç”¨ç³»åˆ—---- Goroutine</a>&nbsp;&nbsp;<span class="post-date" style="font-size:14px">&nbsp;(2020å¹´05æœˆ24æ—¥)</span></li><li id="li-rels"><a href="/post/golang/go-net-http/">Golangä½¿ç”¨ç³»åˆ—---- Net/Http åº”ç”¨å±‚</a>&nbsp;&nbsp;<span class="post-date" style="font-size:14px">&nbsp;(2019å¹´09æœˆ26æ—¥)</span></li><li id="li-rels"><a href="/post/golang/go-gc/">Golangä½¿ç”¨ç³»åˆ—---- Gc</a>&nbsp;&nbsp;<span class="post-date" style="font-size:14px">&nbsp;(2019å¹´08æœˆ27æ—¥)</span></li><li id="li-rels"><a href="/post/golang/go-runtime/">Golangä½¿ç”¨ç³»åˆ—---- Runtime</a>&nbsp;&nbsp;<span class="post-date" style="font-size:14px">&nbsp;(2019å¹´06æœˆ13æ—¥)</span></li><li id="li-rels"><a href="/post/golang/go-concurrence/">Golangä½¿ç”¨ç³»åˆ—---- Concurrence</a>&nbsp;&nbsp;<span class="post-date" style="font-size:14px">&nbsp;(2019å¹´03æœˆ26æ—¥)</span></li><li id="li-rels"><a href="/post/golang/go/">golangä½¿ç”¨ç³»åˆ—---- goåŸºæœ¬ä½¿ç”¨ç§¯ç´¯</a>&nbsp;&nbsp;<span class="post-date" style="font-size:14px">&nbsp;(2019å¹´03æœˆ23æ—¥)</span></li><li id="li-rels"><a href="/post/golang/go-map/">Golangä½¿ç”¨ç³»åˆ—---- Map</a>&nbsp;&nbsp;<span class="post-date" style="font-size:14px">&nbsp;(2019å¹´02æœˆ28æ—¥)</span></li><li id="li-rels"><a href="/post/golang/go-sync/">Golangä½¿ç”¨ç³»åˆ—---- Sync</a>&nbsp;&nbsp;<span class="post-date" style="font-size:14px">&nbsp;(2019å¹´02æœˆ28æ—¥)</span></li></ul>
            </aside>
                
            
            <footer>
                <nav>
                    <ul class="pager">

                        
                        <li class="previous"><a href="/post/cloud/paas/paas/"><span aria-hidden="true">&larr;</span> Prev</a></li>
                        

                        <li><a href="/post/">All Posts</a></li>

                        
                        <li class="next"><a href="/post/distributed/store/fs/hfds/">Next <span aria-hidden="true">&rarr;</span></a></li>
                        

                    </ul>
                </nav>
            </footer>

        </article>
    </div>
    <div class="col-md-4">
        
<aside>
        <div class="toc panel panel-default hidden-xs hidden-sm affix-top" data-spy="affix" data-offset-top="125" data-offset-bottom="300">
            <div class="panel-heading">
                <h2 class="panel-title">Catalog</h2>
            </div>

            <nav id="TableOfContents">
<ul>
<li><a href="#pprof">PProf</a></li>
<li><a href="#åŸºæœ¬åŸç†">åŸºæœ¬åŸç†</a></li>
<li><a href="#åŸºæœ¬ä½¿ç”¨">åŸºæœ¬ä½¿ç”¨</a>
<ul>
<li><a href="#ä½¿ç”¨">ä½¿ç”¨</a></li>
<li><a href="#äº¤äº’åˆ†æ">äº¤äº’åˆ†æ</a></li>
</ul></li>
<li><a href="#å®æˆ˜">å®æˆ˜</a>
<ul>
<li><a href="#è·å–é—®é¢˜ç¨‹åº">è·å–é—®é¢˜ç¨‹åº</a></li>
<li><a href="#æ’æŸ¥cpuå æ¯”è¿‡é«˜">æ’æŸ¥cpuå æ¯”è¿‡é«˜</a></li>
<li><a href="#æ’æŸ¥å†…å­˜å ç”¨è¿‡é«˜">æ’æŸ¥å†…å­˜å ç”¨è¿‡é«˜</a></li>
<li><a href="#å…¶ä»–">å…¶ä»–</a></li>
</ul></li>
</ul>
</nav>
        </div>
</aside>

    </div>
</div>

</div>
<hr>

<footer class="container copy">
    <p>&copy; 2021  kingjcy blog </p>
	<p>Powered by <a href="https://gohugo.io" target="_blank">Hugo</a></p>
</footer>

<script>hljs.initHighlightingOnLoad();</script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?ace3ec99de96c4080ead1eb8d52db3b3";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-92600390-2', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

