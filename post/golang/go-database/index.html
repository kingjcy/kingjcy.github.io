<!DOCTYPE html>

<html lang="zh-cn">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="author" content="fatedier">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="description" content="sql包提供了保证SQL或类SQL数据库的泛用接口。

使用sql包时必须注入（至少）一个数据库驱动。参见http://golang.org/s/sqldrivers 获取驱动列表。">
<meta property="og:url" content="https://kingjcy.github.io/"><meta property="og:type" content="article">
<meta property="og:title" content="Go Database - kingjcy blog"><meta property="og:site_name" content="kingjcy blog">

<title>
    
    Go Database
    
</title>

<link rel="stylesheet" href="/onlyone/onlyone.css">
<link rel="shortcut icon" href="/assets/favicon.ico">
<script src="/onlyone/onlyone.js"></script>
<link rel="alternate" type="application/rss+xml" title="RSS" href="/index.xml">
</head>
<body>


<div class="container">
    <header class="nav">
        <nav class="navbar navbar-default">
            <div class="container-fluid">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="/">kingjcy blog</a>
                </div>

                <div class="collapse navbar-collapse" id="navbar-collapse">
                    <ul class="nav navbar-nav">
                        <li><a href="/categories/技术文章/">技术文章</a></li>
                        <li><a href="/categories/读书笔记/">读书笔记</a></li>
                        <li><a href="/categories/人生感悟/">人生感悟</a></li>
                        <li><a href="/tags/">分类</a></li>
                        <li><a href="/about/">关于我</a></li>
                        <li>
                            <form method="get" style="padding: 8px" action="https://www.google.com/search" target="_blank">
                                <input type="hidden" name="sitesearch" value="kingjcy.github.io"/>
                                <input type="text" class="form-control" name="q" placeholder="Press enter to search">
                            </form>
                        </li>
                    </ul>

                </div>
            </div>
        </nav>
    </header>


<div class="row">
    <div class="col-md-8">
        <article class="post single">

            <header>
                <div class="post-date">
                    2019年05月06日 
                </div>
                <h1 class="post-title">Go Database</h1>
            </header>

            <div class="post-content">
                <p>sql包提供了保证SQL或类SQL数据库的泛用接口。</p>

<p>使用sql包时必须注入（至少）一个数据库驱动。参见<a href="http://golang.org/s/sqldrivers">http://golang.org/s/sqldrivers</a> 获取驱动列表。</p>

<p>使用</p>

<ol>
<li>结构体db</li>
</ol>

<p>sql.DB不是一个连接，它是数据库的抽象接口。它可以根据driver打开关闭数据库连接，管理连接池。正在使用的连接被标记为繁忙，用完后回到连接池等待下次使用。所以，如果你没有把连接释放回连接池，会导致过多连接使系统资源耗尽。</p>

<ol>
<li><p>导入数据库驱动</p>

<p>import (
    &ldquo;database/sql&rdquo;
    _ &ldquo;github.com/go-sql-driver/mysql&rdquo;
)</p></li>

<li><p>连接DB</p>

<p>func main() {
    db, err := sql.Open(&ldquo;mysql&rdquo;,
        &ldquo;user:password@tcp(127.0.0.1:3306)/hello&rdquo;)
    if err != nil {
        log.Fatal(err)
    }
    defer db.Close()
}</p></li>
</ol>

<p>sql.Open的第一个参数是driver名称，第二个参数是driver连接数据库的信息，各个driver可能不同。DB不是连接，并且只有当需要使用时才会创建连接，如果想立即验证连接，需要用Ping()方法，如下：</p>

<pre><code>err = db.Ping()
if err != nil {
    // do something here
}
</code></pre>

<p>sql.DB的设计就是用来作为长连接使用的。不要频繁Open, Close。比较好的做法是，为每个不同的datastore建一个DB对象，保持这些对象Open。如果需要短连接，那么把DB作为参数传入function，而不要在function中Open, Close。</p>

<p>sql.DB 表示一个连接池</p>

<ol>
<li>读取DB</li>
</ol>

<p>如果方法包含Query，那么这个方法是用于查询并返回rows的。其他情况应该用Exec()。</p>

<pre><code>var (
    id int
    name string
)
rows, err := db.Query(&quot;select id, name from users where id = ?&quot;, 1)
if err != nil {
    log.Fatal(err)
}
defer rows.Close()
for rows.Next() {
    err := rows.Scan(&amp;id, &amp;name)
    if err != nil {
        log.Fatal(err)
    }
    log.Println(id, name)
}
err = rows.Err()
if err != nil {
    log.Fatal(err)
}
</code></pre>

<p>上面代码的过程为：db.Query()表示向数据库发送一个query，defer rows.Close()非常重要，遍历rows使用rows.Next()， 把遍历到的数据存入变量使用rows.Scan(), 遍历完成后检查error。有几点需要注意：</p>

<p>检查遍历是否有error
结果集(rows)未关闭前，底层的连接处于繁忙状态。当遍历读到最后一条记录时，会发生一个内部EOF错误，自动调用rows.Close()，但是如果提前退出循环，rows不会关闭，连接不会回到连接池中，连接也不会关闭。所以手动关闭非常重要。rows.Close()可以多次调用，是无害操作。</p>

<ol>
<li>单行Query</li>
</ol>

<p>err在Scan后才产生，所以可以如下写：</p>

<pre><code>var name string
err = db.QueryRow(&quot;select name from users where id = ?&quot;, 1).Scan(&amp;name)
if err != nil {
    log.Fatal(err)
}
fmt.Println(name)
</code></pre>

<ol>
<li>修改数据，事务</li>
</ol>

<p>一般用Prepared Statements和Exec()完成INSERT, UPDATE, DELETE操作。</p>

<pre><code>stmt, err := db.Prepare(&quot;INSERT INTO users(name) VALUES(?)&quot;)
if err != nil {
    log.Fatal(err)
}
res, err := stmt.Exec(&quot;Dolly&quot;)
if err != nil {
    log.Fatal(err)
}
lastId, err := res.LastInsertId()
if err != nil {
    log.Fatal(err)
}
rowCnt, err := res.RowsAffected()
if err != nil {
    log.Fatal(err)
}
</code></pre>

<ol>
<li>事务</li>
</ol>

<p>db.Begin()开始事务，Commit() 或 Rollback()关闭事务。Tx从连接池中取出一个连接，在关闭之前都是使用这个连接。Tx不能和DB层的BEGIN, COMMIT混合使用。</p>

<p>如果你需要通过多条语句修改连接状态，你必须使用Tx，例如：</p>

<p>创建仅对单个连接可见的临时表
设置变量，例如SET @var := somevalue
改变连接选项，例如字符集，超时</p>

<p>插入、更新、删除：(*sql.DB).Exec</p>

<p>// InsertUser 插入用户</p>

<pre><code>func InsertUser(name string) (int64, error) {
    res, err := pool.Exec(&quot;insert into `users` (`name`) values (?)&quot;, name)
    if err != nil {
        return 0, err
    }
    return res.LastInsertId()
}
</code></pre>

<p>// UpdateUser 更新用户</p>

<pre><code>func UpdateUser(id int64, name string) error {
    _, err := pool.Exec(&quot;update `users` set `name` = ? where `id` = ?&quot;, name, id)
    if err != nil {
        return err
    }
    return nil
}
</code></pre>

<p>// DeleteUser 删除用户</p>

<pre><code>func DeleteUser(id int64) error {
    _, err := pool.Exec(&quot;delete from `users` where `id` = ?&quot;, id)
    if err != nil {
        return err
    }
    return nil
}
</code></pre>

<p>NOSQL在go中并没有使用到database／sql的接口，都是直接实现客户端的直接操作</p>

<p>go数据库接口的原理</p>

<p>Go没有官方提供数据库驱动，而是为开发者开发数据库驱动定义了一些标准接口，开发者可以 根据定义的接口来开发相应的数据库驱动，这样做有一个好处，只要按照标准接口开发的代码， 以后需要迁移数据 库时，不需要任何修改。</p>

<p>注册</p>

<p>在我们调用</p>

<pre><code>_ &quot;github.com/go-sql-driver/mysql&quot;
</code></pre>

<p>这个库的时候，就相当于调用了其init函数，而在init里面会调用这个Register(name string, driver driver.Driver)完成本驱动的注册。</p>

<pre><code>//https://github.com/mattn/go-sqlite3驱动 func init() {
sql.Register(&quot;sqlite3&quot;, &amp;SQLiteDriver{}) }
//https://github.com/mikespook/mymysql驱动
// Driver automatically registered in database/sql var d = Driver{proto: &quot;tcp&quot;, raddr: &quot;127.0.0.1:3306&quot;} func init() {
Register(&quot;SET NAMES utf8&quot;)
sql.Register(&quot;mymysql&quot;, &amp;d) }
</code></pre>

<p>driver.Driver接口</p>

<pre><code>type Driver interface {
Open(name string) (Conn, error)
}
</code></pre>

<p>在 database/sql内部通过一个map来存储用户定义的相应驱动。</p>

<pre><code>var drivers = make(map[string]driver.Driver)
drivers[name] = driver
</code></pre>

<p>这边有一个主意点</p>

<p>返回的conn只能进行一次goroutine，否则会错误，其实这样也就是并发控制的问题</p>

<p>driver.Conn接口</p>

<pre><code>type Conn interface {
    Prepare(query string) (Stmt, error) 
    Close() error
    Begin() (Tx, error)
}
</code></pre>

<p>Prepare函数返回与当前连接相关的执行Sql语句的准备状态，可以进行查询、删除等操作。
Close函数关闭当前的连接，执行释放连接拥有的资源等清理工作。因为驱动实现了database/sql里面建议的conn pool，所以你不用再去实现缓存conn之类的，这样会容易引起问题。
Begin函数返回一个代表事务处理的Tx，通过它你可以进行查询,更新等操作，或者对事务进行回滚、递交。</p>

<p>driver.Stmt接口</p>

<pre><code>type Stmt interface { 
    Close() error
    NumInput() int
    Exec(args []Value) (Result, error) 
    Query(args []Value) (Rows, error)
}
</code></pre>

<p>Close函数关闭当前的链接状态，但是如果当前正在执行query，query还是有效返回rows数据。</p>

<p>NumInput函数返回当前预留参数的个数，当返回&gt;=0时数据库驱动就会智能检查调用者的参数。当数据库驱动包不知 道预留参数的时候，返回-1。</p>

<p>Exec函数执行Prepare准备好的sql，传入参数执行update/insert等操作，返回Result数据</p>

<p>Query函数执行Prepare准备好的sql，传入需要的参数执行select操作，返回Rows结果集</p>

<p>driver.Tx 接口</p>

<p>事务处理一般就两个过程，递交或者回滚。数据库驱动里面也只需要实现这两个函数就可以</p>

<pre><code>type Tx interface { 
    Commit() error
    Rollback() error 
}
</code></pre>

<p>这两个函数一个用来递交一个事务，一个用来回滚事务。</p>

<p>driver.Execer 接口</p>

<p>这是一个Conn可选择实现的接口</p>

<pre><code>type Execer interface {
    Exec(query string, args []Value) (Result, error)
}
</code></pre>

<p>如果这个接口没有定义，那么在调用DB.Exec,就会首先调用Prepare返回Stmt，然后执行Stmt的Exec，然后关闭 Stmt。这个其实就是直接可以直接exec语句的接口，只要实现了，就可以直接调用，不需要使用prepare。</p>

<p>driver.Result接口</p>

<p>这个是执行Update/Insert等操作返回的结果接口定义</p>

<pre><code>type Result interface { 
    LastInsertId() (int64, error) 
    RowsAffected() (int64, error)
}
</code></pre>

<p>LastInsertId函数返回由数据库执行插入操作得到的自增ID号。
RowsAffected函数返回query操作影响的数据条目数。</p>

<p>driver.Rows接口</p>

<p>Rows是执行查询返回的结果集接口定义</p>

<pre><code>type Rows interface { 
    Columns() []string 
    Close() error
    Next(dest []Value) error
}
</code></pre>

<p>Columns函数返回查询数据库表的字段信息，这个返回的slice和sql查询的字段一一对应，而不是返回整个表的所有 字段。
Close函数用来关闭Rows迭代器。
Next函数用来返回下一条数据，把数据赋值给dest。dest里面的元素必须是driver.Value的值除了string，返回的数 据里面所有的string都必须要转换成[]byte。如果最后没数据了，Next函数最后返回io.EOF。</p>

<p>driver.RowsAffected</p>

<p>RowsAffested其实就是一个int64的别名，但是他实现了Result接口，用来底层实现Result的表示方式</p>

<pre><code>type RowsAffected int64

func (RowsAffected) LastInsertId() (int64, error) 
func (v RowsAffected) RowsAffected() (int64, error)
</code></pre>

<p>driver.Value接口</p>

<p>Value其实就是一个空接口，他可以容纳任何的数据</p>

<p>type Value interface{}</p>

<p>drive的Value是驱动必须能够操作的Value，Value要么是nil，要么是下面的任意一种</p>

<p>int64 float64 bool []byte string time.Time</p>

<p>driver.ValueConverter</p>

<p>ValueConverter接口定义了如何把一个普通的值转化成driver.Value的接口</p>

<pre><code>type ValueConverter interface {
ConvertValue(v interface{}) (Value, error)
}
</code></pre>

<p>在开发的数据库驱动包里面实现这个接口的函数在很多地方会使用到，这个ValueConverter有很多好处:</p>

<p>转化driver.value到数据库表相应的字段，例如int64的数据如何转化成数据库表uint16字段
把数据库查询结果转化成driver.Value值
在scan函数里面如何把dirve.Value值转化成用户定义的值</p>

<p>driver.Valuer</p>

<p>Valuer接口定义了返回一个driver.Value的方式</p>

<pre><code>type Valuer interface { 
    Value() (Value, error)
}
</code></pre>

<p>很多类型都实现了这个Value方法，用来自身与driver.Value的转化。</p>

<p>通过上面的讲解，你应该对于驱动的开发有了一个基本的了解，一个驱动只要实现了这些接口就能完成增删查改等基本操作了，剩下的就是与相应的数据库进行数据交互等细节问题了，在此不再赘述。</p>

<p>database/sql</p>

<p>database/sql在database/sql/driver提供的接口基础上定义了一些更高阶的方法，用以简化数据库操作,同时内部还 建议性地实现一个conn pool。</p>

<pre><code>type DB struct {
    driver dsn
    mu freeConn closed
    driver.Driver
    string
    sync.Mutex // protects freeConn and closed []driver.Conn
    bool
}
</code></pre>

<p>我们可以看到Open函数返回的是DB对象，里面有一个freeConn，它就是那个简易的连接池。它的实现相当简单或者说 简陋，就是当执行Db.prepare的时候会defer db.putConn(ci, err),也就是把这个连接放入连接池，每次调用 conn的时候会先判断freeConn的长度是否大于0，大于0说明有可以复用的conn，直接拿出来用就是了，如果不大于 0，则创建一个conn,然后再返回之。</p>
            </div>
            
            <div style="border: 1px dashed #e0e0e0; margin-bottom: 15px; padding: 10px 10px 10px 10px; background-color: #fffeee; background-repeat: no-repeat; background-attachment: scroll; background-position: 1% 50%; -moz-background-size: auto auto; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial;">
                <div>
                    <p style="margin-top:0px;">作者：<a target="_blank" href="http://blog.fatedier.com/">kingjcy</a>
                    <br />本文出处：<a target="_blank" href="https://kingjcy.github.io/post/golang/go-database/">https://kingjcy.github.io/post/golang/go-database/</a>
                    <br />
                    文章版权归本人所有，欢迎转载，但未经作者同意必须保留此段声明，且在文章页面明显位置给出原文链接，否则保留追究法律责任的权利。 </p>
                </div>
            </div>

            <aside>
                
                <ul class="list-inline post-tags">
                    
                    <li>
                        <a href="/tags/database/">
                            <i class="fa fa-tags"></i>
                            Database
                        </a>
                    </li>
                    
                </ul>

                
                
                <h4 id="real-rels">相关文章</h4>
                <ul class="post-rels" id="real-rels"></ul>
            </aside>
                
            
            <footer>
                <nav>
                    <ul class="pager">

                        
                        <li class="previous"><a href="/post/programe/profrp/profrp/"><span aria-hidden="true">&larr;</span> Prev</a></li>
                        

                        <li><a href="/post/">All Posts</a></li>

                        
                        <li class="next"><a href="/post/database/sqlite/">Next <span aria-hidden="true">&rarr;</span></a></li>
                        

                    </ul>
                </nav>
            </footer>

        </article>
    </div>
    <div class="col-md-4">
        
<aside>
        <div class="toc panel panel-default hidden-xs hidden-sm affix-top" data-spy="affix" data-offset-top="125" data-offset-bottom="300">
            <div class="panel-heading">
                <h2 class="panel-title">Catalog</h2>
            </div>

            
        </div>
</aside>

    </div>
</div>

</div>
<hr>

<footer class="container copy">
    <p>&copy; 2020  kingjcy blog </p>
	<p>Powered by <a href="https://gohugo.io" target="_blank">Hugo</a></p>
</footer>

<script>hljs.initHighlightingOnLoad();</script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?ace3ec99de96c4080ead1eb8d52db3b3";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-92600390-2', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

