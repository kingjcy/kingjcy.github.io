<!DOCTYPE html>

<html lang="zh-cn">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="author" content="fatedier">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="description" content="kubernetesæ˜¯ä¸€ç§å®¹å™¨ç®¡ç†å¼€æºé¡¹ç›®ï¼Œç”¨äºç®¡ç†å®¹å™¨åŒ–çš„å·¥ä½œè´Ÿè½½å’ŒæœåŠ¡ï¼Œå¯ä¿ƒè¿›å£°æ˜å¼é…ç½®å’Œè‡ªåŠ¨åŒ–ï¼Œæ”¯æŒå®¹å™¨è‡ªèº«çš„ä¸è¶³ã€‚


è§£å†³äº†å®¹å™¨å®‰å…¨é—®é¢˜ï¼šå¯†é’¥ä¸é…ç½®ç®¡ç†
å®¹å™¨ç®¡ç†ï¼šéƒ¨ç½²ï¼Œå‡çº§å›æ»šï¼Œæ‰©ç¼©å®¹ï¼Œè‡ªæ„ˆç­‰ã€‚
ç½‘ç»œé—®é¢˜ï¼šæœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡
">
<meta property="og:url" content="https://kingjcy.github.io/"><meta property="og:type" content="article">
<meta property="og:title" content="äº‘è®¡ç®—K8sç³»åˆ—---- K8s Tutorial - kingjcy blog"><meta property="og:site_name" content="kingjcy blog">

<title>
    
    äº‘è®¡ç®—K8sç³»åˆ—---- K8s Tutorial
    
</title>

<link rel="stylesheet" href="/onlyone/onlyone.css">
<link rel="shortcut icon" href="/assets/favicon.ico">
<script src="/onlyone/onlyone.js"></script>
<link rel="alternate" type="application/rss+xml" title="RSS" href="/index.xml">
</head>
<body>


<div class="container">
    <header class="nav">
        <nav class="navbar navbar-default">
            <div class="container-fluid">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="/">kingjcy blog</a>
                </div>

                <div class="collapse navbar-collapse" id="navbar-collapse">
                    <ul class="nav navbar-nav">
                        <li><a href="/categories/æŠ€æœ¯æ–‡ç« /">æŠ€æœ¯æ–‡ç« </a></li>
			<li><a href="/categories/è¯»ä¹¦ç¬”è®°/">è¯»ä¹¦ç¬”è®°</a></li>
                        <li><a href="/categories/äººç”Ÿæ„Ÿæ‚Ÿ/">äººç”Ÿæ„Ÿæ‚Ÿ</a></li>
                        <li><a href="/categories/">å½’æ¡£</a></li>
                        <li><a href="/tags/">åˆ†ç±»</a></li>
                        <li><a href="/about/">å…³äºæˆ‘</a></li>
                        <li>
                            <form method="get" style="padding: 8px" action="https://www.google.com/search" target="_blank">
                                <input type="hidden" name="sitesearch" value="https://kingjcy.github.io/"/>
                                <input type="text" class="form-control" name="q" placeholder="Press enter to search">
                            </form>
                        </li>
                    </ul>

                </div>
            </div>
        </nav>
    </header>


<div class="row">
    <div class="col-md-8">
        <article class="post single">

            <header>
                <div class="post-date">
                    2019å¹´04æœˆ04æ—¥ 
                </div>
                <h1 class="post-title">äº‘è®¡ç®—K8sç³»åˆ—---- K8s Tutorial</h1>
            </header>

            <div class="post-content">
                <p>kubernetesæ˜¯ä¸€ç§å®¹å™¨ç®¡ç†å¼€æºé¡¹ç›®ï¼Œç”¨äºç®¡ç†å®¹å™¨åŒ–çš„å·¥ä½œè´Ÿè½½å’ŒæœåŠ¡ï¼Œå¯ä¿ƒè¿›å£°æ˜å¼é…ç½®å’Œè‡ªåŠ¨åŒ–ï¼Œæ”¯æŒå®¹å™¨è‡ªèº«çš„ä¸è¶³ã€‚</p>

<ul>
<li>è§£å†³äº†å®¹å™¨å®‰å…¨é—®é¢˜ï¼šå¯†é’¥ä¸é…ç½®ç®¡ç†</li>
<li>å®¹å™¨ç®¡ç†ï¼šéƒ¨ç½²ï¼Œå‡çº§å›æ»šï¼Œæ‰©ç¼©å®¹ï¼Œè‡ªæ„ˆç­‰ã€‚</li>
<li>ç½‘ç»œé—®é¢˜ï¼šæœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡</li>
</ul>

<h1 id="ç»„ä»¶å’Œæ¦‚å¿µ">ç»„ä»¶å’Œæ¦‚å¿µ</h1>

<p>Kubernetesä¸»è¦ç”±ä»¥ä¸‹å‡ ä¸ªæ ¸å¿ƒç»„ä»¶ç»„æˆï¼š</p>

<blockquote>
<p>master</p>
</blockquote>

<ul>
<li>apiserveræä¾›äº†èµ„æºæ“ä½œçš„å”¯ä¸€å…¥å£ï¼Œå¹¶æä¾›è®¤è¯ã€æˆæƒã€è®¿é—®æ§åˆ¶ã€APIæ³¨å†Œå’Œå‘ç°ç­‰æœºåˆ¶ï¼›å¯ä»¥è¯´æ˜¯k8sçš„å†…éƒ¨äº¤äº’çš„ç½‘å…³æ€»çº¿ã€‚</li>
<li>controller managerè´Ÿè´£ç»´æŠ¤é›†ç¾¤çš„çŠ¶æ€ï¼Œæ¯”å¦‚æ•…éšœæ£€æµ‹ã€è‡ªåŠ¨æ‰©å±•ã€æ»šåŠ¨æ›´æ–°ç­‰ï¼›æ˜¯æ§åˆ¶å™¨çš„ç®¡ç†è€…ï¼Œè´Ÿè´£å¾ˆå¤šçš„æ§åˆ¶å™¨ã€‚</li>
<li>schedulerè´Ÿè´£èµ„æºçš„è°ƒåº¦ï¼ŒæŒ‰ç…§ï¼ˆé¢„é€‰ä¼˜é€‰ï¼‰è°ƒåº¦ç­–ç•¥å°†Podè°ƒåº¦åˆ°ç›¸åº”çš„æœºå™¨ä¸Šï¼›</li>
</ul>

<blockquote>
<p>node</p>
</blockquote>

<ul>
<li>kubeletè´Ÿè´£ç»´æŠ¤å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸï¼ŒåŒæ—¶ä¹Ÿè´Ÿè´£Volumeï¼ˆCVIï¼‰å’Œç½‘ç»œï¼ˆCNIï¼‰çš„ç®¡ç†ï¼›ä¸»è¦å¹²æ´»çš„å¯¹è±¡ï¼Œè´Ÿè´£å’Œdockerè¿›è¡Œäº¤äº’ï¼Œåˆ›å»ºå®¹å™¨ï¼Œç»´æŠ¤å®¹å™¨ã€‚</li>
<li>kube-proxyè´Ÿè´£ä¸ºServiceæä¾›clusterå†…éƒ¨çš„æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡ï¼›æä¾›äº†ä¸€ç§ç½‘ç»œæ¨¡å¼ã€‚</li>
<li>docker engine dockerå¼•æ“ï¼Œè´Ÿè´£dockerçš„åˆ›å»ºå’Œç®¡ç†ï¼Œéšç€criçš„å‘å±•ï¼Œä¸åŒå®¹å™¨è¿è¡Œæ—¶çš„æ¥å…¥ï¼Œdockerè¿Ÿæ—©æ˜¯è¦é‡kubeletä¸­å‡ºå»çš„ï¼Œç›®å‰å¼€æºçš„containerdå¯¹äºå¤§å®¶æ¥è¯´æ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚</li>
</ul>

<blockquote>
<p>ç½‘ç»œ</p>
</blockquote>

<ul>
<li>fannelå®ç°podç½‘ç»œçš„äº’é€š</li>
</ul>

<blockquote>
<p>æ•°æ®åº“</p>
</blockquote>

<ul>
<li>etcdä¿å­˜äº†æ•´ä¸ªé›†ç¾¤çš„çŠ¶æ€ï¼›å®ç°æŒä¹…åŒ–æ•°æ®çš„k-vdb</li>
</ul>

<blockquote>
<p>é‡è¦æ¦‚å¿µ</p>
</blockquote>

<ul>
<li>namespaces:å‘½åç©ºé—´ï¼Œä¸»è¦æ˜¯å®ç°èµ„æºçš„éš”ç¦»ï¼ŒNamespaceæ˜¯å¯¹ä¸€ç»„èµ„æºå’Œå¯¹è±¡çš„æŠ½è±¡é›†åˆï¼Œæ¯”å¦‚å¯ä»¥ç”¨æ¥å°†ç³»ç»Ÿå†…éƒ¨çš„å¯¹è±¡åˆ’åˆ†ä¸ºä¸åŒçš„é¡¹ç›®ç»„æˆ–ç”¨æˆ·ç»„ã€‚æ¯”å¦‚æˆ‘ä»¬å°†namespaceå‘½åä¸ºç³»ç»Ÿåï¼Œä¸€ä¸ªç³»ç»Ÿä¸€ä¸ªnamespaceã€‚</li>
<li>pod: ä¸€ç§åº”ç”¨çš„å®ä¾‹ï¼Œä¾‹å¦‚ä¸€ä¸ªwebç«™ç‚¹ï¼ŒåŒ…å«å‰ç«¯ï¼Œåç«¯ï¼Œæ•°æ®åº“è¿™ä¸‰ä¸ªå®¹å™¨ï¼Œæ”¾åœ¨ä¸€ä¸ªpodä¸­å¯¹å¤–å°±æ˜¯ä¸€ä¸ªwebæœåŠ¡ã€‚</li>
<li>serviceï¼špodçš„è·¯ç”±ä»£ç†çš„æŠ½è±¡ï¼Œé›†ç¾¤å†…é€šè¿‡serviceæä¾›çš„å›ºå®šåœ°å€è¿›è¡Œäº¤äº’ï¼Œè€Œserviceæ¥åšæœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡ï¼Œæ¥å’Œå˜åŒ–çš„podè¿›è¡Œäº¤äº’ã€‚</li>
<li>ingressï¼šç±»ä¼¼äºnginxçš„è½¬å‘åŠŸèƒ½ï¼Œæš´éœ²å‡ºserviceçš„åœ°å€æ¥å¯¹å¤–æš´éœ²æœåŠ¡ã€‚</li>
</ul>

<p>ä¸Šé¢æ˜¯æœ€åŸºæœ¬è¦äº†è§£çš„èµ„æºæ¦‚å¿µï¼Œè¿˜æœ‰å¾ˆå¤š<a href="/post/cloud/paas/base/kubernetes/k8s-principle/">æ ¸å¿ƒæ¦‚å¿µ</a>ã€‚</p>

<h1 id="å®‰è£…éƒ¨ç½²">å®‰è£…éƒ¨ç½²</h1>

<h2 id="å®‰è£…åŒ…">å®‰è£…åŒ…</h2>

<blockquote>
<p>æºç ç¼–è¯‘äºŒè¿›åˆ¶æ–‡ä»¶</p>
</blockquote>

<p>1ã€You have a working [Go environment].</p>

<pre><code>$ go get -d k8s.io/kubernetes
$ cd $GOPATH/src/k8s.io/kubernetes
$ make
</code></pre>

<p>2ã€You have a working [Docker environment].</p>

<pre><code>$ git clone https://github.com/kubernetes/kubernetes
$ cd kubernetes
$ make quick-release
</code></pre>

<blockquote>
<p>ç›´æ¥ä¸‹è½½</p>
</blockquote>

<p>å®˜æ–¹æä¾›äº†ç›´æ¥ä¸‹è½½çš„è·¯å¾„<a href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG-1.8.md">https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG-1.8.md</a></p>

<blockquote>
<p>rpm</p>
</blockquote>

<p>æ‰“rpmåŒ…ï¼Œç›´æ¥å·¥ç¨‹ä¸‹è½½å·¥ç¨‹</p>

<p><a href="https://github.com/kubernetes/release">https://github.com/kubernetes/release</a></p>

<p>å°†ä¸Šé¢ç¼–è¯‘å¥½çš„æ–‡ä»¶å¯æ‰§è¡Œæ–‡ä»¶å¤åˆ¶åˆ°è¿™ä¸ªé¡¹ç›®çš„rpmç›®å½•ä¸‹</p>

<p>ä¿®æ”¹è¿™ä¸ªç›®å½•ä¸‹çš„specæ–‡ä»¶ï¼Œæ¯”å¦‚ç‰ˆæœ¬ä¿¡æ¯ï¼Œä½¿ç”¨äºŒè¿›åˆ¶æ–‡ä»¶ä¸ºæœ¬åœ°æ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢ç©¿è¿‡æ¥çš„ï¼Œè€Œä¸æ˜¯å»ç½‘ä¸Šä¸‹è½½</p>

<p>å†ä¸‹è½½ä¸€äº›åŸºç¡€é•œåƒ</p>

<p>æœ€åç›´æ¥æ‰§è¡Œå½“å‰ç›®å½•ä¸‹çš„./docker-build.shå°±å¯ä»¥è‡ªå·±å¯åŠ¨é•œåƒç¼–è¯‘æˆå¯¹åº”çš„rpmæ–‡ä»¶</p>

<p>å¯¹åº”æ‰§è¡Œçš„<a href="/post/cloud/paas/base/kubernetes/k8s-rpm-build/">åŸºæœ¬è¿‡ç¨‹</a></p>

<blockquote>
<p>yumæº</p>
</blockquote>

<p>æœ€åæä¾›ä¸€ä¸ªk8sçš„yumæº</p>

<pre><code>[virt7-testing]
name=virt7-testing
baseurl=http://cbs.centos.org/repos/virt7-testing/x86_64/os/
gpgcheck=0
</code></pre>

<blockquote>
<p>æ€»ç»“</p>
</blockquote>

<p>å¯è§ï¼Œèƒ½ä¸Šç½‘ç›´æ¥yumæºï¼Œä¸èƒ½ä¸Šç½‘ï¼Œå°±æ˜¯ç›´æ¥ä¸‹è½½äºŒè¿›åˆ¶æ–‡ä»¶</p>

<h2 id="å•ä¾‹">å•ä¾‹</h2>

<p>å°±æ˜¯åœ¨ä¸€å°æœºå™¨ä¸Šéƒ¨ç½²ä¸€ä¸ªk8sé›†ç¾¤ï¼Œå¯ä»¥ä¸‹è½½åä¸€ä¸ªä¸ªç»„ä»¶é•œåƒç„¶ååœ¨k8så¯åŠ¨ï¼Œæˆ‘ä»¬è¿™è¾¹æ¨èk8så®˜æ–¹æ¨å‡ºçš„minikubeå·¥å…·æ¥éƒ¨ç½²ï¼Œä¸€èˆ¬ç»™æˆ‘ä»¬æ­£å¸¸åšå¼€å‘æµ‹è¯•ä½¿ç”¨æ˜¯è¶³å¤Ÿçš„ã€‚</p>

<h3 id="minikube">minikube</h3>

<p>Kubernetes é›†ç¾¤çš„æ­å»ºæ˜¯æœ‰ä¸€å®šéš¾åº¦çš„ï¼Œå°¤å…¶æ˜¯å¯¹äºåˆå­¦è€…æ¥è¯´ï¼Œå¥½å¤šæ¦‚å¿µå’ŒåŸç†ä¸æ‡‚ï¼Œå³ä½¿æœ‰ç°æˆçš„æ•™ç¨‹ä¹Ÿä¼šå‡ºç°å¾ˆå¤šä¸å¯é¢„çŸ¥çš„é—®é¢˜ï¼Œå¾ˆå®¹æ˜“æ‰“å‡»å­¦ä¹ çš„ç§¯ææ€§ï¼Œå°±æ­¤å¼ƒå‘ã€‚å¥½åœ¨ Kubernetes ç¤¾åŒºæä¾›äº†å¯ä»¥åœ¨æœ¬åœ°å¼€å‘å’Œä½“éªŒçš„æç®€é›†ç¾¤å®‰è£… MiniKubeï¼Œå¯¹äºå…¥é—¨å­¦ä¹ æ¥è¯´å¾ˆæ–¹ä¾¿ã€‚</p>

<p>MiniKubeå…¶å®å°±æ˜¯æŠŠk8sçš„å‡ ä¸ªç»„ä»¶çš„é•œåƒä¸‹è½½ä¸‹æ¥ï¼Œç„¶åä½¿ç”¨dockerè¿›è¡Œå¯åŠ¨ï¼Œå½“ç„¶è®¾ç½®äº†å¯åŠ¨å‚æ•° ï¼Œåœ¨ä¸€å°æœºå™¨ä¸Šå¯åŠ¨äº†æ‰€æœ‰çš„ç»„ä»¶ç„¶åå°±æ˜¯ä¸€ä¸ªå•èŠ‚ç‚¹çš„k8sé›†ç¾¤ï¼Œæ‰€ä»¥è¯´minikubeå°±æ˜¯ä¸€ä¸ªéƒ¨ç½²å·¥å…·ï¼Œå’Œk8sé›†ç¾¤æœ¬èº«æ²¡æœ‰å…³ç³»ï¼Œå°†k8sé›†ç¾¤è¿è¡Œåœ¨dockerä¸­ï¼Œä¸æƒ³æˆ‘ä»¬ç›´æ¥è¿è¡Œåœ¨ç‰©ç†æœºä¸Šï¼Œä½†æ˜¯åœ¨å›½å†…ç”±äºç½‘ç»œè®¿é—®åŸå› ï¼ˆæ‡‚çš„ï¼‰ï¼Œå³ä½¿æœ‰æ¢¯å­ä¹Ÿå¾ˆæŠ˜è…¾ï¼Œæ‰€ä»¥éœ€è¦ä¿®æ”¹æºä¸ºé˜¿é‡Œçš„åMiniKube å®‰è£…ã€‚ä½¿ç”¨é˜¿é‡Œä¿®æ”¹åçš„ MiniKube å°±å¯ä»¥ä»é˜¿é‡Œäº‘çš„é•œåƒåœ°å€æ¥è·å–æ‰€éœ€ Docker é•œåƒå’Œé…ç½®ï¼Œå…¶å®ƒçš„å¹¶æ²¡æœ‰å·®å¼‚ã€‚</p>

<p>minikubeæœ¬èº«å°±æä¾›äº†å¯æ‰§è¡Œçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¯ä»¥ç›´æ¥ä¸‹è½½ï¼Œç”¨å‘½ä»¤è¡Œå¯åŠ¨ï¼Œå°±èƒ½è‡ªåŠ¨çš„å°†k8séƒ¨ç½²å¥½</p>

<blockquote>
<p><strong>å‰ç½®å·¥ä½œ</strong></p>
</blockquote>

<p>1ã€vm</p>

<p>é¦–å…ˆmacOSæ˜¯å¦æ”¯æŒè™šæ‹ŸåŒ–ï¼Œåœ¨ç»ˆç«¯ä¸Šè¿è¡Œå‘½ä»¤</p>

<pre><code>sysctl -a | grep -E --color 'machdep.cpu.features|VMX'
</code></pre>

<p>å¦‚æœå°šæœªå®‰è£…ç®¡ç†ç¨‹åºï¼Œè¯·ç«‹å³å®‰è£…ä»¥ä¸‹ä¹‹ä¸€ï¼š</p>

<pre><code>1ã€HyperKit
2ã€VirtualBox
3ã€VMware Fusion
</code></pre>

<p>å› ä¸ºminikubeæ˜¯è¿è¡Œåœ¨ä¸€ä¸ªæœ¬åœ°çš„VMä¸Šçš„ï¼Œè€Œä¸æ˜¯è¿è¡Œåœ¨æœ¬åœ°ï¼Œæ‰€ä»¥éœ€è¦vmã€‚</p>

<p>2ã€dockerå·²ç»å®‰è£…</p>

<blockquote>
<p><strong>å®‰è£…åŒ…</strong></p>
</blockquote>

<p>æˆ‘ä»¬ä»¥macosä¸ºä¾‹</p>

<p>macOS å®‰è£… Minikube æœ€ç®€å•çš„æ–¹æ³•æ˜¯ä½¿ç”¨ Homebrewï¼š</p>

<pre><code>brew install minikube
</code></pre>

<p>ä½ ä¹Ÿå¯ä»¥é€šè¿‡ä¸‹è½½å•èŠ‚ç‚¹äºŒè¿›åˆ¶æ–‡ä»¶è¿›è¡Œå®‰è£…ï¼š</p>

<pre><code>curl -Lo minikube https://storage.googleapis.com/minikube/releases/latest/minikube-darwin-amd64 \
&amp;&amp; chmod +x minikube
</code></pre>

<p>è¿™æ˜¯ä¸€ä¸ªç®€å•çš„å°† Minikube å¯æ‰§è¡Œæ–‡ä»¶æ·»åŠ è‡³ path çš„æ–¹æ³•ï¼š</p>

<pre><code>sudo mv minikube /usr/local/bin
</code></pre>

<blockquote>
<p><strong>æ¸…ç†æœ¬åœ°çŠ¶æ€</strong></p>
</blockquote>

<p>å¦‚æœæ‚¨ä¹‹å‰å®‰è£…è¿‡ Minikubeï¼Œå¹¶è¿è¡Œäº†ï¼š</p>

<pre><code>minikube start
</code></pre>

<p>å¹¶ä¸” minikube start è¿”å›äº†ä¸€ä¸ªé”™è¯¯ï¼š</p>

<pre><code>machine does not exist
</code></pre>

<p>é‚£ä¹ˆï¼Œä½ éœ€è¦æ¸…ç† minikube çš„æœ¬åœ°çŠ¶æ€ï¼š</p>

<pre><code>minikube delete
</code></pre>

<blockquote>
<p><strong>ä½¿ç”¨minikubeå®‰è£…k8s</strong></p>
</blockquote>

<p>ä½¿ç”¨minikubeå®‰è£…k8sé›†ç¾¤ååˆ†ç®€å•ï¼Œä¸€æ¡å‘½ä»¤å°±å¯ä»¥ï¼Œminikubeä¼šå»åˆ›å»ºä¸€ä¸ªvmè™šæ‹Ÿæœºï¼Œç„¶ååœ¨æœºå™¨ä¸Šéƒ¨ç½²dockerï¼Œk8sé›†ç¾¤ï¼Œå®Œæˆå†…éƒ¨çš„åŸºæœ¬è®¾ç½®ã€‚</p>

<pre><code>minikube start --image-mirror-country='cn' --image-repository='registry.cn-hangzhou.aliyuncs.com/google_containers' --cache-images=true --vm-driver=virtualbox --kubernetes-version=1.14.10
</code></pre>

<p>å¯åŠ¨å‚æ•°</p>

<pre><code>--vm-driver=*** ä»1.5.0ç‰ˆæœ¬å¼€å§‹ï¼ŒMinikubeç¼ºçœä½¿ç”¨æœ¬åœ°æœ€å¥½çš„é©±åŠ¨æ¥åˆ›å»ºKubernetesæœ¬åœ°ç¯å¢ƒã€‚

    Minikubeåœ¨ä¸åŒæ“ä½œç³»ç»Ÿä¸Šæ”¯æŒä¸åŒçš„é©±åŠ¨

    macOSï¼šxhyve driver ç¼ºçœé©±åŠ¨, VirtualBox æˆ– VMware Fusion
    Linuxï¼š VirtualBox æˆ– KVM2
    Windowsï¼šVirtualBox æˆ– Hyper-V

--image-mirror-country='cn'
--image-repository='registry.cn-hangzhou.aliyuncs.com/google_containers'
å°†ç¼ºçœåˆ©ç”¨ registry.cn-hangzhou.aliyuncs.com/google_containers ä½œä¸ºå®‰è£…Kubernetesçš„å®¹å™¨é•œåƒä»“åº“ ï¼ˆé˜¿é‡Œäº‘ç‰ˆæœ¬å¯é€‰ï¼‰

--iso-url=*** åˆ©ç”¨é˜¿é‡Œäº‘çš„é•œåƒåœ°å€ä¸‹è½½ç›¸åº”çš„ .iso æ–‡ä»¶ ï¼ˆé˜¿é‡Œäº‘ç‰ˆæœ¬å¯é€‰ï¼‰
--registry-mirror=***ä¸ºäº†æ‹‰å–Docker Hubé•œåƒï¼Œéœ€è¦ä¸º Docker daemon é…ç½®é•œåƒåŠ é€Ÿï¼Œå‚è€ƒé˜¿é‡Œäº‘é•œåƒæœåŠ¡
--cpus=2: ä¸ºminikubeè™šæ‹Ÿæœºåˆ†é…CPUæ ¸æ•°
--memory=2048mb: ä¸ºminikubeè™šæ‹Ÿæœºåˆ†é…å†…å­˜æ•°
--kubernetes-version=***: minikube è™šæ‹Ÿæœºå°†ä½¿ç”¨çš„ kubernetes ç‰ˆæœ¬

//è®¾ç½®dockerç¯å¢ƒå˜é‡ï¼Œè¿™ä¸ªæ˜¯ä»£ç†ï¼Œä¸€èˆ¬ä¸éœ€è¦è®¾ç½®ã€‚
â€“docker-env HTTP_PROXY=http://proxy.sha.sap.corp:8080/
â€“docker-env HTTPS_PROXY=http://proxy.sha.sap.corp:8080/
</code></pre>

<p>è¿è¡Œç»“æœå¦‚ä¸‹</p>

<pre><code>$ minikube start --image-mirror-country='cn' --image-repository='registry.cn-hangzhou.aliyuncs.com/google_containers' --cache-images=true --vm-driver=virtualbox --kubernetes-version=1.18.3
ğŸ˜„  minikube v1.11.0 on Darwin 10.15.2
âœ¨  Using the virtualbox driver based on user configuration
âœ…  Using image repository registry.cn-hangzhou.aliyuncs.com/google_containers
ğŸ‘  Starting control plane node minikube in cluster minikube
ğŸ”¥  Creating virtualbox VM (CPUs=2, Memory=4000MB, Disk=20000MB) ...
ğŸŒ  Found network options:
    â–ª HTTP_PROXY=http://127.0.0.1:6666
â—  You appear to be using a proxy, but your NO_PROXY environment does not include the minikube IP (192.168.99.107).
ğŸ“˜  Please see https://minikube.sigs.k8s.io/docs/handbook/vpn_and_proxy/ for more details
    â–ª HTTPS_PROXY=http://127.0.0.1:6666
â—  This VM is having trouble accessing https://registry.cn-hangzhou.aliyuncs.com/google_containers
ğŸ’¡  To pull new external images, you may need to configure a proxy: https://minikube.sigs.k8s.io/docs/reference/networking/proxy/
ğŸ³  Preparing Kubernetes v1.18.3 on Docker 19.03.8 ...
    â–ª env HTTP_PROXY=http://127.0.0.1:6666
    â–ª env HTTPS_PROXY=http://127.0.0.1:6666
^@ğŸ”  Verifying Kubernetes components...
ğŸŒŸ  Enabled addons: default-storageclass, storage-provisioner
ğŸ„  Done! kubectl is now configured to use &quot;minikube&quot;

â—  /usr/local/bin/kubectl is version 1.20.2, which may be incompatible with Kubernetes 1.18.3.
ğŸ’¡  You can also use 'minikube kubectl -- get pods' to invoke a matching version
</code></pre>

<p>å¯ä»¥çœ‹åˆ°ä½¿ç”¨vmboxåˆ›å»ºäº†ä¸€ä¸ªè™šæ‹Ÿæœºï¼Œç„¶ååœ¨è™šæ‹Ÿæœºä¸­è¿è¡Œäº†k8sï¼Œæˆ‘ä»¬ä¸‹é¢ä¼šè¿›å…¥è™šæ‹ŸæœºæŸ¥çœ‹å¯¹åº”çš„è¿›ç¨‹ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹ï¼Œå¯¹åº”çš„é…ç½®æ–‡ä»¶</p>

<pre><code>$ cat .kube/config
apiVersion: v1
clusters:
- cluster:
    certificate-authority: ~/.minikube/ca.crt
    server: https://192.168.99.107:8443
  name: minikube
contexts:
- context:
    cluster: minikube
    user: minikube
  name: minikube
current-context: minikube
kind: Config
preferences: {}
users:
- name: minikube
  user:
    client-certificate: ~/.minikube/profiles/minikube/client.crt
    client-key: ~/.minikube/profiles/minikube/client.key
</code></pre>

<p>å¯ä»¥çœ‹åˆ°minikube startè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªminikubeçš„contextï¼Œæˆ‘ä»¬kubectlå°±æ˜¯ä½¿ç”¨çš„è¿™ä¸ªé…ç½®ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¯¹åº”çš„è¯ä¹¦éƒ½æ˜¯åœ¨~/.minikubeï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹è¿™ä¸ªç›®å½•</p>

<pre><code>.minikube $ ll
total 64
drwxr-xr-x  2 chunyinjiang  staff    64 Aug  9 09:49 addons
-rw-r--r--  1 chunyinjiang  staff  1066 Aug  9 10:24 ca.crt
-rw-------  1 chunyinjiang  staff  1679 Aug  9 10:24 ca.key
-rwxr-xr-x  1 chunyinjiang  staff  1054 Aug  9 10:45 ca.pem
drwxr-xr-x  6 chunyinjiang  staff   192 Aug  9 10:47 cache
-rwxr-xr-x  1 chunyinjiang  staff  1094 Aug  9 10:45 cert.pem
drwxr-xr-x  6 chunyinjiang  staff   192 Aug  9 10:05 certs
drwxr-xr-x  3 chunyinjiang  staff    96 Aug  9 10:44 config
drwxr-xr-x  2 chunyinjiang  staff    64 Aug  9 09:49 files
-rwxr-xr-x  1 chunyinjiang  staff  1675 Aug  9 10:45 key.pem
-rw-r--r--  1 chunyinjiang  staff    29 Aug  9 09:50 last_update_check
drwxr-xr-x  2 chunyinjiang  staff    64 Aug  9 09:49 logs
drwxr-xr-x  5 chunyinjiang  staff   160 Aug  9 10:45 machines
drwx------  3 chunyinjiang  staff    96 Aug  9 10:45 profiles
-rw-r--r--  1 chunyinjiang  staff  1074 Aug  9 10:24 proxy-client-ca.crt
-rw-------  1 chunyinjiang  staff  1675 Aug  9 10:24 proxy-client-ca.key
</code></pre>

<p>ç®€å•çš„å¯ä»¥çœ‹å‡ºminikubeç›¸å…³æ–‡ä»¶éƒ½åœ¨è¿™é‡Œï¼Œåé¢æœ‰éœ€è¦æ·±å…¥ç ”ç©¶çš„åœ¨çœ‹ã€‚</p>

<blockquote>
<p><strong>å®‰è£…kubectl</strong></p>
</blockquote>

<p>minikubeåªæ˜¯åœ¨åˆ›å»ºçš„è™šæ‹Ÿæœºminikubeä¸­å®‰è£…äº†k8sé›†ç¾¤å’Œç›¸å…³ç»„ä»¶ï¼Œæˆ‘ä»¬è¿˜éœ€è¦åœ¨æœ¬åœ°å»å®‰è£…ç®¡ç†å·¥å…·kubectlæ¥ç®¡ç†è¿™ä¸ªè™šæ‹Ÿæœºä¸­çš„é›†ç¾¤ã€‚</p>

<p>æˆ‘æ˜¯macOS ç³»ç»Ÿå¹¶ä½¿ç”¨ Homebrew åŒ…ç®¡ç†å™¨ï¼Œé€šè¿‡ Homebrew å®‰è£… kubectlã€‚</p>

<pre><code>è¿è¡Œå®‰è£…å‘½ä»¤ï¼š

    brew install kubernetes-cli

æµ‹è¯•ä»¥ç¡®ä¿æ‚¨å®‰è£…çš„ç‰ˆæœ¬æ˜¯æœ€æ–°çš„ï¼š

MacBook-Pro:minikube chunyinjiang$ kubectl version
Client Version: version.Info{Major:&quot;1&quot;, Minor:&quot;18&quot;, GitVersion:&quot;v1.18.3&quot;, GitCommit:&quot;2e7996e3e2712684bc73f0dec0200d64eec7fe40&quot;, GitTreeState:&quot;clean&quot;, BuildDate:&quot;2020-05-21T14:51:23Z&quot;, GoVersion:&quot;go1.14.3&quot;, Compiler:&quot;gc&quot;, Platform:&quot;darwin/amd64&quot;}
Server Version: version.Info{Major:&quot;1&quot;, Minor:&quot;18&quot;, GitVersion:&quot;v1.18.3&quot;, GitCommit:&quot;2e7996e3e2712684bc73f0dec0200d64eec7fe40&quot;, GitTreeState:&quot;clean&quot;, BuildDate:&quot;2020-05-20T12:43:34Z&quot;, GoVersion:&quot;go1.13.9&quot;, Compiler:&quot;gc&quot;, Platform:&quot;linux/amd64&quot;}
</code></pre>

<p>å½“ç„¶ä¹Ÿå¯ä»¥ä¸‹è½½äºŒè¿›åˆ¶æ–‡ä»¶è¿›è¡Œå®‰è£…ï¼Œä¸‹é¢æœ‰kubectlçš„å…·ä½“è¯´æ˜ã€‚</p>

<blockquote>
<p><strong>æ£€æŸ¥ kubectl çš„é…ç½®</strong></p>
</blockquote>

<p>é€šè¿‡è·å–é›†ç¾¤çŠ¶æ€æ£€æŸ¥ kubectl æ˜¯å¦è¢«æ­£ç¡®é…ç½®ï¼š</p>

<pre><code>kubectl cluster-info
</code></pre>

<p>å¦‚æœæ‚¨çœ‹åˆ°ä¸€ä¸ª URL è¢«è¿”å›ï¼Œé‚£ä¹ˆ kubectl å·²ç»è¢«æ­£ç¡®é…ç½®ï¼Œèƒ½å¤Ÿæ­£å¸¸è®¿é—®æ‚¨çš„ Kubernetes é›†ç¾¤ã€‚</p>

<p>å¦‚æœæ‚¨çœ‹åˆ°ç±»ä¼¼ä»¥ä¸‹çš„ä¿¡æ¯è¢«è¿”å›ï¼Œé‚£ä¹ˆ kubectl æ²¡æœ‰è¢«æ­£ç¡®é…ç½®ï¼Œæ— æ³•æ­£å¸¸è®¿é—®æ‚¨çš„ Kubernetes é›†ç¾¤ã€‚</p>

<pre><code>The connection to the server &lt;server-name:port&gt; was refused - did you specify the right host or port?
</code></pre>

<p>å¦‚æœ kubectl cluster-info èƒ½å¤Ÿè¿”å› url å“åº”ï¼Œä½†æ‚¨æ— æ³•è®¿é—®æ‚¨çš„é›†ç¾¤ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤æ£€æŸ¥é…ç½®æ˜¯å¦æ­£ç¡®ï¼š</p>

<pre><code>kubectl cluster-info dump
</code></pre>

<p>è‡³äº<a href="#kubectl">kubectlçš„å…·ä½“ä½¿ç”¨</a>åŒ…æ‹¬è‡ªåŠ¨è¡¥å…¨åŠŸèƒ½ï¼Œä¸‹é¢ä¼šè¯¦ç»†è¯´æ˜ã€‚</p>

<blockquote>
<p><strong>æŸ¥çœ‹é›†ç¾¤çŠ¶æ€</strong></p>
</blockquote>

<pre><code>MacBook-Pro:minikube chunyinjiang$ kubectl get pod --all-namespaces -o wide
NAMESPACE     NAME                               READY   STATUS    RESTARTS   AGE   IP               NODE       NOMINATED NODE   READINESS GATES
kube-system   coredns-546565776c-dcvb4           1/1     Running   0          10m   172.17.0.3       minikube   &lt;none&gt;           &lt;none&gt;
kube-system   coredns-546565776c-m9qlc           1/1     Running   0          10m   172.17.0.2       minikube   &lt;none&gt;           &lt;none&gt;
kube-system   etcd-minikube                      1/1     Running   0          10m   192.168.99.101   minikube   &lt;none&gt;           &lt;none&gt;
kube-system   kube-apiserver-minikube            1/1     Running   0          10m   192.168.99.101   minikube   &lt;none&gt;           &lt;none&gt;
kube-system   kube-controller-manager-minikube   1/1     Running   0          10m   192.168.99.101   minikube   &lt;none&gt;           &lt;none&gt;
kube-system   kube-proxy-hw2qb                   1/1     Running   0          10m   192.168.99.101   minikube   &lt;none&gt;           &lt;none&gt;
kube-system   kube-scheduler-minikube            1/1     Running   0          10m   192.168.99.101   minikube   &lt;none&gt;           &lt;none&gt;
kube-system   storage-provisioner                1/1     Running   0          10m   192.168.99.101   minikube   &lt;none&gt;           &lt;none&gt;
MacBook-Pro:exercise chunyinjiang$ kubectl get nodes -o wide
NAME       STATUS   ROLES    AGE    VERSION   INTERNAL-IP      EXTERNAL-IP   OS-IMAGE               KERNEL-VERSION   CONTAINER-RUNTIME
minikube   Ready    master   2d5h   v1.18.3   192.168.99.101   &lt;none&gt;        Buildroot 2019.02.10   4.19.107         docker://19.3.8
</code></pre>

<p>è¿™è¾¹è®²ä¸€ä¸‹vmè™šæ‹Ÿæœºï¼Œå®‰è£…äº†vmboxï¼Œå¯ä»¥ç›´æ¥æ‰“å¼€å®¢æˆ·ç«¯ï¼Œä½ ä¼šå‘ç°ä¸€ä¸ªminikubeçš„è™šæ‹Ÿæœºåœ¨è¿è¡Œï¼Œä½ å¯ä»¥ç›´æ¥åœ¨è¿™è¾¹ç™»é™†rootï¼Œä¸éœ€è¦å¯†ç ï¼Œä¹Ÿå¯ä»¥ç”¨å…¶ä»–çš„ç»ˆç«¯sshç™»é™†ä¸Šé¢çš„masterä¸»æœºæ¥æŸ¥çœ‹ç›¸å…³ä¿¡æ¯ï¼šssh docker@192.168.99.101 ç°åœ¨æˆ‘ä»¬sshåˆ°æˆ‘ä»¬çš„masterèŠ‚ç‚¹ï¼Œé»˜è®¤ç”¨æˆ·åï¼šdocker å¯†ç ï¼štcuser</p>

<p>ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨minikube sshæ¥ç›´æ¥è¿æ¥ç™»é™†ã€‚</p>

<p>k8sè¿›ç¨‹</p>

<pre><code>$ ps -ef | grep kube
root      3977  3936  1 Jun10 ?        00:22:19 kube-controller-manager --authentication-kubeconfig=/etc/kubernetes/controller-manager.conf --authorization-kubeconfig=/etc/kubernetes/controller-manager.conf --bind-address=127.0.0.1 --client-ca-file=/var/lib/minikube/certs/ca.crt --cluster-name=mk --cluster-signing-cert-file=/var/lib/minikube/certs/ca.crt --cluster-signing-key-file=/var/lib/minikube/certs/ca.key --controllers=*,bootstrapsigner,tokencleaner --kubeconfig=/etc/kubernetes/controller-manager.conf --leader-elect=true --requestheader-client-ca-file=/var/lib/minikube/certs/front-proxy-ca.crt --root-ca-file=/var/lib/minikube/certs/ca.crt --service-account-private-key-file=/var/lib/minikube/certs/sa.key --use-service-account-credentials=true
root      4012  3947  0 Jun10 ?        00:04:57 kube-scheduler --authentication-kubeconfig=/etc/kubernetes/scheduler.conf --authorization-kubeconfig=/etc/kubernetes/scheduler.conf --bind-address=127.0.0.1 --kubeconfig=/etc/kubernetes/scheduler.conf --leader-elect=true
root      4046  3967  1 Jun10 ?        00:24:05 etcd --advertise-client-urls=https://192.168.99.101:2379 --cert-file=/var/lib/minikube/certs/etcd/server.crt --client-cert-auth=true --data-dir=/var/lib/minikube/etcd --initial-advertise-peer-urls=https://192.168.99.101:2380 --initial-cluster=minikube=https://192.168.99.101:2380 --key-file=/var/lib/minikube/certs/etcd/server.key --listen-client-urls=https://127.0.0.1:2379,https://192.168.99.101:2379 --listen-metrics-urls=http://127.0.0.1:2381 --listen-peer-urls=https://192.168.99.101:2380 --name=minikube --peer-cert-file=/var/lib/minikube/certs/etcd/peer.crt --peer-client-cert-auth=true --peer-key-file=/var/lib/minikube/certs/etcd/peer.key --peer-trusted-ca-file=/var/lib/minikube/certs/etcd/ca.crt --snapshot-count=10000 --trusted-ca-file=/var/lib/minikube/certs/etcd/ca.crt
root      4066  3993  3 Jun10 ?        00:55:50 kube-apiserver --advertise-address=192.168.99.101 --allow-privileged=true --authorization-mode=Node,RBAC --client-ca-file=/var/lib/minikube/certs/ca.crt --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,ResourceQuota --enable-bootstrap-token-auth=true --etcd-cafile=/var/lib/minikube/certs/etcd/ca.crt --etcd-certfile=/var/lib/minikube/certs/apiserver-etcd-client.crt --etcd-keyfile=/var/lib/minikube/certs/apiserver-etcd-client.key --etcd-servers=https://127.0.0.1:2379 --insecure-port=0 --kubelet-client-certificate=/var/lib/minikube/certs/apiserver-kubelet-client.crt --kubelet-client-key=/var/lib/minikube/certs/apiserver-kubelet-client.key --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname --proxy-client-cert-file=/var/lib/minikube/certs/front-proxy-client.crt --proxy-client-key-file=/var/lib/minikube/certs/front-proxy-client.key --requestheader-allowed-names=front-proxy-client --requestheader-client-ca-file=/var/lib/minikube/certs/front-proxy-ca.crt --requestheader-extra-headers-prefix=X-Remote-Extra- --requestheader-group-headers=X-Remote-Group --requestheader-username-headers=X-Remote-User --secure-port=8443 --service-account-key-file=/var/lib/minikube/certs/sa.pub --service-cluster-ip-range=10.96.0.0/12 --tls-cert-file=/var/lib/minikube/certs/apiserver.crt --tls-private-key-file=/var/lib/minikube/certs/apiserver.key
docker    4155  4114  0 06:49 pts/0    00:00:00 grep kube
root      4362     1  2 Jun10 ?        00:38:48 /var/lib/minikube/binaries/v1.18.3/kubelet --authorization-mode=Webhook --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --cgroup-driver=systemd --client-ca-file=/var/lib/minikube/certs/ca.crt --cluster-domain=cluster.local --config=/var/lib/kubelet/config.yaml --container-runtime=docker --fail-swap-on=false --hostname-override=minikube --kubeconfig=/etc/kubernetes/kubelet.conf --node-ip=192.168.99.101 --pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.2 --pod-manifest-path=/etc/kubernetes/manifests
root      4688  4668  0 Jun10 ?        00:00:35 /usr/local/bin/kube-proxy --config=/var/lib/kube-proxy/config.conf --hostname-override=minikube
</code></pre>

<p>k8sé•œåƒ</p>

<pre><code>$ docker images
REPOSITORY                                                                    TAG                 IMAGE ID            CREATED             SIZE
registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy                v1.18.3             3439b7546f29        3 weeks ago         117MB
registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler            v1.18.3             76216c34ed0c        3 weeks ago         95.3MB
registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager   v1.18.3             da26705ccb4b        3 weeks ago         162MB
registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver            v1.18.3             7e28efa976bd        3 weeks ago         173MB
registry.cn-hangzhou.aliyuncs.com/google_containers/dashboard                 v2.0.0              8b32422733b3        7 weeks ago         222MB
registry.cn-hangzhou.aliyuncs.com/google_containers/pause                     3.2                 80d28bedfe5d        3 months ago        683kB
registry.cn-hangzhou.aliyuncs.com/google_containers/coredns                   1.6.7               67da37a9a360        4 months ago        43.8MB
registry.cn-hangzhou.aliyuncs.com/google_containers/etcd                      3.4.3-0             303ce5db0e90        7 months ago        288MB
registry.cn-hangzhou.aliyuncs.com/google_containers/metrics-scraper           v1.0.2              3b08661dc379        7 months ago        40.1MB
registry.cn-hangzhou.aliyuncs.com/google_containers/storage-provisioner       v1.8.1              4689081edb10        2 years ago         80.8MB
</code></pre>

<blockquote>
<p><strong>ç®¡ç†é›†ç¾¤</strong></p>
</blockquote>

<p>æŸ¥çœ‹çŠ¶æ€</p>

<pre><code>MacBook-Pro:exercise chunyinjiang$ minikube status
minikube
type: Control Plane
host: Running
kubelet: Running
apiserver: Running
kubeconfig: Configured
</code></pre>

<p>å¼€å¯dashboard</p>

<pre><code>minikube dashboradå¯åŠ¨pod
kubernetes-dashboard   dashboard-metrics-scraper-84bfdf55ff-m6hlx   1/1     Running   0          4d20h
kubernetes-dashboard   kubernetes-dashboard-696dbcc666-vfrks        1/1     Running   0          4d20h
</code></pre>

<p>ç„¶åå¯ä»¥</p>

<pre><code>MacBook-Pro:~ chunyinjiang$ minikube dashboard --url
ğŸ¤”  Verifying dashboard health ...
ğŸš€  Launching proxy ...
ğŸ¤”  Verifying proxy health ...
http://127.0.0.1:59625/api/v1/namespaces/kubernetes-dashboard/services/http:kubernetes-dashboard:/proxy/
</code></pre>

<p>å…¶å®è¿˜æœ‰æœ‰ç”¨çš„ç»„ä»¶éƒ½æ˜¯é€šè¿‡æ’ä»¶æ¨¡å¼å¯ä»¥å¼€å¯çš„</p>

<p>åˆ—å‡ºå½“å‰æ”¯æŒçš„æ’ä»¶</p>

<pre><code>MacBook-Pro:exercise chunyinjiang$ minikube addons list
|-----------------------------|----------|--------------|
|         ADDON NAME          | PROFILE  |    STATUS    |
|-----------------------------|----------|--------------|
| ambassador                  | minikube | disabled     |
| dashboard                   | minikube | enabled âœ…   |
| default-storageclass        | minikube | enabled âœ…   |
| efk                         | minikube | disabled     |
| freshpod                    | minikube | disabled     |
| gvisor                      | minikube | disabled     |
| helm-tiller                 | minikube | disabled     |
| ingress                     | minikube | disabled     |
| ingress-dns                 | minikube | disabled     |
| istio                       | minikube | disabled     |
| istio-provisioner           | minikube | disabled     |
| logviewer                   | minikube | disabled     |
| metallb                     | minikube | disabled     |
| metrics-server              | minikube | disabled     |
| nvidia-driver-installer     | minikube | disabled     |
| nvidia-gpu-device-plugin    | minikube | disabled     |
| olm                         | minikube | disabled     |
| registry                    | minikube | disabled     |
| registry-aliases            | minikube | disabled     |
| registry-creds              | minikube | disabled     |
| storage-provisioner         | minikube | enabled âœ…   |
| storage-provisioner-gluster | minikube | disabled     |
|-----------------------------|----------|--------------|
</code></pre>

<p>å¼€å¯æ’ä»¶</p>

<pre><code>ä¾‹å¦‚ metrics-serverï¼š

minikube addons enable metrics-server
</code></pre>

<p>å…³é—­æ’ä»¶</p>

<pre><code>minikube addons disable metrics-server
</code></pre>

<p>ç™»é™†minikubeè™šæ‹Ÿæœº</p>

<pre><code>miniube ssh
</code></pre>

<p>åœæ­¢é›†ç¾¤</p>

<pre><code>minikube stop
</code></pre>

<p>åˆ é™¤é›†ç¾¤</p>

<pre><code>minikube delete
minikube delete --all
</code></pre>

<p>æŸ¥çœ‹minikubeçš„çŠ¶æ€</p>

<pre><code>$ minikube status
minikube
type: Control Plane
host: Running
kubelet: Running
apiserver: Running
kubeconfig: Configured
</code></pre>

<p>æŸ¥çœ‹minikubeçš„æœåŠ¡åˆ—è¡¨</p>

<pre><code>$ minikube service list
|----------------------|-----------------------------------|--------------|-----------------------------|
|      NAMESPACE       |               NAME                | TARGET PORT  |             URL             |
|----------------------|-----------------------------------|--------------|-----------------------------|
| default              | kubernetes                        | No node port |
| default              | nginx                             | http/80      | http://192.168.99.101:30080 |
| default              | redis-master                      | No node port |
| default              | redis-slave                       | No node port |
| kruise-system        | kruise-controller-manager-service | No node port |
| kruise-system        | kruise-webhook-server-service     | No node port |
| kube-system          | elasticsearch-logging             | No node port |
| kube-system          | etcd-k8s                          | No node port |
| kube-system          | kibana-logging                    |         5601 | http://192.168.99.101:30003 |
| kube-system          | kube-dns                          | No node port |
| kube-system          | kube-scheduler                    | No node port |
| kube-system          | kubelet                           | No node port |
| kube-system          | metrics-server                    | No node port |
| kubernetes-dashboard | dashboard-metrics-scraper         | No node port |
| kubernetes-dashboard | kubernetes-dashboard              | No node port |
| monitoring           | alertmanager-main                 | web/9093     | http://192.168.99.101:31234 |
| monitoring           | alertmanager-operated             | No node port |
| monitoring           | grafana                           | http/3000    | http://192.168.99.101:30267 |
| monitoring           | kube-state-metrics                | No node port |
| monitoring           | node-exporter                     | No node port |
| monitoring           | prometheus-adapter                | No node port |
| monitoring           | prometheus-k8s                    | web/9090     | http://192.168.99.101:31174 |
| monitoring           | prometheus-operated               | No node port |
| monitoring           | prometheus-operator               | No node port |
|----------------------|-----------------------------------|--------------|-----------------------------|
</code></pre>

<p>Pause Kubernetes without impacting deployed applications:</p>

<pre><code>minikube pause
</code></pre>

<p>Halt the cluster:</p>

<pre><code>minikube stop
</code></pre>

<p>Increase the default memory limit (requires a restart):</p>

<pre><code>minikube config set memory 16384
</code></pre>

<p>Browse the catalog of easily installed Kubernetes services:</p>

<pre><code>minikube addons list
</code></pre>

<p>Create a second cluster running an older Kubernetes release:</p>

<pre><code>minikube start -p aged --kubernetes-version=v1.16.1
</code></pre>

<p>Delete all of the minikube clusters:</p>

<pre><code>minikube delete --all
</code></pre>

<p>å¤§ä½“ä¸Šminikubeåˆ°è¿™è¾¹ä¹Ÿå°±å¤Ÿç”¨äº†ï¼Œå¦‚æœè¿˜éœ€è¦æ·±å…¥ç ”ç©¶ï¼Œå¯ä»¥å»çœ‹<a href="https://minikube.sigs.k8s.io/docs/">minikube</a>ï¼Œ<a href="https://v1-18.docs.kubernetes.io/zh/docs/setup/learning-environment/minikube/">kubernetes</a>å®˜æ–¹æ–‡æ¡£ã€‚</p>

<h2 id="é›†ç¾¤">é›†ç¾¤</h2>

<p>çœŸæ­£ç”Ÿäº§ä½¿ç”¨çš„k8séƒ½æ˜¯é›†ç¾¤éƒ¨ç½²çš„ï¼Œæ‰€ä»¥åœ¨éƒ¨ç½²è¿™ä¸€å—ä¹Ÿæ˜¯æ¯”è¾ƒé‡è¦çš„ï¼Œç¤¾åŒºå’Œå„ä¸ªå¤§å‚éƒ½æœ‰ç€ä¸åŒçš„éƒ¨ç½²è¿ç»´æ–¹æ¡ˆï¼Œæˆ‘ä»¬éœ€è¦é‡ç‚¹ç ”ç©¶ä¸€ä¸‹[k8sçš„é›†ç¾¤éƒ¨ç½²]()ã€‚</p>

<p>åœ¨ 1.4ç‰ˆæœ¬ä¹‹å‰éƒ½æ˜¯æ‰‹åŠ¨éƒ¨ç½²ï¼Œåœ¨1.4ä¹‹åæä¾›äº†éƒ¨ç½²å·¥å…·kubeadmï¼Œkubeadmå¸®å¿™å¤§å¤§ä¼˜åŒ–äº†k8sçš„éƒ¨ç½²ï¼Œæ‰€ä»¥ç›®å‰æœ‰ä¸¤ç§éƒ¨ç½²æ–¹å¼ï¼Œå½“ç„¶kubeadmæ˜¯å¯¹æ‰‹åŠ¨éƒ¨ç½²çš„å°è£…ï¼Œç›®å‰å¤§éƒ¨åˆ†è¿˜æ˜¯ä½¿ç”¨æ‰‹åŠ¨éƒ¨ç½²k8sï¼Œç†Ÿæ‚‰å¯åŠ¨å‚æ•°æ„ä¹‰ï¼Œå½“ç„¶å¤§å®¶éƒ½åœ¨åšéƒ¨ç½²å·¥å…·ï¼Œåé¢ä½¿ç”¨kubeadmæ˜¯ä¸€ç§è¶‹åŠ¿ã€‚</p>

<p>é¦–å…ˆä¸ç®¡ä»€ä¹ˆéƒ¨ç½²ï¼Œä¸€äº›æœºå™¨ä¸Šçš„åŸºç¡€å·¥ä½œéƒ½æ˜¯ä¸€æ ·éœ€è¦åš</p>

<p>1ã€å…³é—­é˜²ç«å¢™</p>

<pre><code>systemctl stop firewalld
</code></pre>

<p>è®¾ç½®å¼€å¯ä¸å¯åŠ¨</p>

<pre><code>systemctl disable firewalld
</code></pre>

<p>å…³é—­SELINUX</p>

<pre><code>setenforce 0
</code></pre>

<p>æ°¸ä¹…å…³é—­</p>

<pre><code>SELINUX sed -i 's/SELINUX=enforcing/SELINUX=disabled/g' /etc/selinux/config
</code></pre>

<p>2ã€å®‰è£…iptables</p>

<pre><code>yum install iptables -y
yum install iptables-services -y
</code></pre>

<p>æ¸…ç©ºiptablesè§„åˆ™</p>

<pre><code>iptables -F
iptables -X
iptables -Z
iptables -F -t nat
service iptables save
</code></pre>

<p>3ã€ntpdate æ—¶é—´åŒæ­¥</p>

<pre><code>ntpdate time1.aliyun.com
</code></pre>

<h3 id="kubeadm">kubeadm</h3>

<p>å…¶å®åœ¨ä¸€å¼€å§‹ä¼ä¸šçº§çš„k8sçš„éƒ¨ç½²ä¸€ç›´æ˜¯ä¸€ä¸ªé—®é¢˜ï¼ŒåŸºæœ¬ä¸Šéƒ½æ˜¯ä½¿ç”¨ä¼ ç»Ÿçš„kvméƒ¨ç½²æ–¹å¼ï¼Œæ¯”å¦‚ansibleï¼Œsupervisordï¼Œslatï¼Œå¯èƒ½è¿™äº›é¡¹ç›®æœ¬èº«çš„å­¦ä¹ å°±è¦æ¯”k8sè¿˜è¦é«˜ï¼Œä½¿å¾—k8sä¸€ç›´æ˜¯ä¸€ä¸ªé«˜é—¨æ§›çš„æŠ€æœ¯ã€‚
åæ¥åœ¨2017å¹´æ‰æœ‰ç¤¾åŒºæ¨åŠ¨ï¼Œå‘å¸ƒäº†è¿™ä¸ªkubeadmé¡¹ç›®ï¼ˆå€¼å¾—ä¸€ä¸€æçš„æ˜¯è¿™ä¸ªé¡¹ç›®æ˜¯ä¸€ä¸ª18å²çš„é«˜ä¸­ç”Ÿå†™çš„ï¼Œè¿™å°±æ˜¯å¼€æºé¡¹ç›®çš„é­…åŠ›ï¼‰</p>

<p>kubeadmæ˜¯Kubernetes 1.4å¼€å§‹æ–°å¢çš„ç‰¹æ€§ï¼Œç”¨äºå¿«é€Ÿæ­å»ºKubernetesé›†ç¾¤ç¯å¢ƒï¼Œä¸¤ä¸ªå‘½ä»¤å°±èƒ½æŠŠä¸€ä¸ªk8sé›†ç¾¤æ­å»ºèµ·æ¥ã€‚</p>

<blockquote>
<p>åŸç†</p>
</blockquote>

<p>kubeadmæŠŠ kubelet ç›´æ¥è¿è¡Œåœ¨å®¿ä¸»æœºä¸Šï¼Œç„¶åä½¿ç”¨å®¹å™¨éƒ¨ç½²å…¶ä»–çš„ Kubernetes ç»„ä»¶ã€‚</p>

<p>ä¸ºä»€ä¹ˆä¸èƒ½ä½¿ç”¨å®¹å™¨è¿è¡Œkubeletï¼Ÿ</p>

<p>kubeleté™¤äº†è·Ÿå®¹å™¨è¿è¡Œæ—¶æ‰“äº¤é“å¤–ï¼Œkubelet åœ¨é…ç½®å®¹å™¨ç½‘ç»œã€ç®¡ç†å®¹å™¨æ•°æ®å·æ—¶ï¼Œéƒ½éœ€è¦ç›´æ¥æ“ä½œå®¿ä¸»æœºã€‚è€Œå¦‚æœç°åœ¨ kubelet æœ¬èº«å°±è¿è¡Œåœ¨ä¸€ä¸ªå®¹å™¨é‡Œï¼Œé‚£ä¹ˆç›´æ¥æ“ä½œå®¿ä¸»æœºå°±ä¼šå˜å¾—å¾ˆéº»çƒ¦ã€‚å¯¹äºç½‘ç»œé…ç½®æ¥è¯´è¿˜å¥½ï¼Œkubelet å®¹å™¨å¯ä»¥é€šè¿‡ä¸å¼€å¯ Network Namespaceï¼ˆå³ Docker çš„ host network æ¨¡å¼ï¼‰çš„æ–¹å¼ï¼Œç›´æ¥å…±äº«å®¿ä¸»æœºçš„ç½‘ç»œæ ˆã€‚å¯æ˜¯ï¼Œè¦è®© kubelet éš”ç€å®¹å™¨çš„ Mount Namespace å’Œæ–‡ä»¶ç³»ç»Ÿï¼Œæ“ä½œå®¿ä¸»æœºçš„æ–‡ä»¶ç³»ç»Ÿï¼Œå°±æœ‰ç‚¹å„¿å›°éš¾äº†ã€‚</p>

<blockquote>
<p>å‘½ä»¤</p>
</blockquote>

<p>kubeadmä¸€å…±æä¾›äº†5ä¸ªå­å‘½ä»¤ï¼š</p>

<pre><code>kubeadm init
kubeadm join
kubeadm token
kubeadm reset
kubeadm version
</code></pre>

<p>æ­£å¸¸æˆ‘ä»¬ä½¿ç”¨ä¸¤ä¸ªå‘½ä»¤å°±å¯ä»¥æ­å»ºk8sé›†ç¾¤äº†ã€‚</p>

<pre><code># åˆ›å»ºä¸€ä¸ªMasterèŠ‚ç‚¹
$ kubeadm init
# å°†ä¸€ä¸ªNodeèŠ‚ç‚¹åŠ å…¥åˆ°å½“å‰é›†ç¾¤ä¸­
$ kubeadm join
</code></pre>

<p>kubeadm initçš„ä¸»è¦å·¥ä½œ</p>

<ul>
<li>åˆ›å»ºé›†ç¾¤å®‰å…¨ç›¸å…³çš„çš„keyã€certså’Œconfæ–‡ä»¶ã€‚</li>
<li>åˆ›å»ºkube-apiserverã€kube-controller-managerã€kube-schedulerã€etcd(å¦‚æœæ²¡æœ‰é…ç½®external etcd)è¿™äº›static podçš„jsonæ ¼å¼çš„manifestæ–‡ä»¶ï¼Œkubeletè´Ÿè´£å¯åŠ¨è¿™äº›masterç»„ä»¶ã€‚</li>
<li>é€šè¿‡addonsæ–¹å¼å¯åŠ¨kube-discovery deploymentã€kube-proxy daemonSetã€kube-dns deploymentã€‚</li>
</ul>

<p>kubeadm joinä¸»è¦è´Ÿè´£åˆ›å»ºkubelet.confï¼Œä½¿kubeletèƒ½ä¸API Serverå»ºç«‹è¿æ¥ï¼š</p>

<ul>
<li>è®¿é—®kube-discoveryæœåŠ¡è·å–cluster infoï¼ˆåŒ…å«cluster caè¯ä¹¦ã€API Server endpointåˆ—è¡¨å’Œtokenã€‚</li>
<li>åˆ©ç”¨å®šçš„tokenï¼Œæ£€éªŒcluster infoçš„ç­¾åã€‚</li>
<li>æ£€éªŒæˆåŠŸåï¼Œå†ä¸API Serverå»ºç«‹è¿æ¥ï¼Œè¯·æ±‚API Serverä¸ºè¯¥nodeåˆ›å»ºè¯ä¹¦ã€‚</li>
<li>æ ¹æ®è·å–åˆ°çš„è¯ä¹¦åˆ›å»ºkubelet.confã€‚</li>
</ul>

<p>éšç€Kubernetes 1.13 çš„å‘å¸ƒï¼Œç°åœ¨Kubeadmæ­£å¼æˆä¸ºGAã€‚ä¹‹å‰éƒ½æ˜¯æµ‹è¯•ç‰ˆæœ¬ï¼Œå¹¶ä¸èƒ½ç”¨äºç”Ÿäº§ã€‚</p>

<h3 id="æ‰‹åŠ¨éƒ¨ç½²">æ‰‹åŠ¨éƒ¨ç½²</h3>

<blockquote>
<h4 id="shellä¸€é”®éƒ¨ç½²">shellä¸€é”®éƒ¨ç½²</h4>
</blockquote>

<p>ä¸Šé¢kubeadmæ˜¯ä¸€ç§éƒ¨ç½²æ–¹å¼çš„è¶‹åŠ¿ï¼Œåœ¨ç°åœ¨å¾ˆå¤šæƒ…å†µä¸‹è¿˜ä¸å¤Ÿæˆç†Ÿï¼Œéƒ½åœ¨æ¢ç´¢ï¼Œåœ¨è¿™ä¸ªè¿‡åº¦æœŸé—´å¤§éƒ¨åˆ†éƒ½ä¼šä½¿ç”¨shellè„šæœ¬è¿›è¡Œä¸€é”®éƒ¨ç½²ã€‚</p>

<p>è¿™ä¸€å—å°±æ¯”è¾ƒåè¿ç»´ï¼Œéœ€è¦å†™å¤§é‡çš„è¿ç»´è„šæœ¬ï¼Œä½¿ç”¨ä¸€äº›æˆç†Ÿçš„è¿ç»´å·¥å…·ï¼Œæ¯”å¦‚puppetï¼Œcobblerï¼Œabsibleï¼Œsupervisorç­‰,éƒ½æ˜¯<a href="/post/linux/tool/ops-tool/">æœåŠ¡å™¨è‡ªåŠ¨åŒ–éƒ¨ç½²åŠè¿ç»´å¸¸è§å·¥å…·</a>ã€‚</p>

<blockquote>
<h4 id="äºŒè¿›åˆ¶éƒ¨ç½²">äºŒè¿›åˆ¶éƒ¨ç½²</h4>
</blockquote>

<p>å°±æ˜¯æˆ‘ä»¬æœ€å¸¸ç”¨çš„æ‰‹åŠ¨éƒ¨ç½²æ–¹å¼ï¼Œä¹Ÿæ˜¯éœ€è¦å¤šæ¬¡ç»ƒä¹ äº†è§£çš„ã€‚</p>

<blockquote>
<p>æƒé™è®¾ç½®</p>
</blockquote>

<p>1ã€è®¾ç½®caè¯ä¹¦å’Œç§˜é’¥</p>

<p>å®‰è£…<a href="/posts/linux/server/ssl/">ssl</a>ï¼š</p>

<pre><code>  wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64
  wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64
  wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64

  sudo cp cfssl_linux-amd64 /usr/local/bin/cfssl 
  sudo cp cfssljson_linux-amd64 /usr/local/bin/cfssljson
  sudo cp cfssl-certinfo_linux-amd64 /usr/local/bin/cfssl-certinfo

  cd /usr/local/bin/ 

  chmod +x cfssl
  chmod +x cfssljson
  chmod +x cfssl-certinfo
</code></pre>

<p>åˆå§‹åŒ–</p>

<pre><code>mkdir ~/cfssl
cd ~/cfssl
cfssl print-defaults config &gt; ca-config.json
cfssl print-defaults csr &gt; ca-csr.json
</code></pre>

<p>åˆ›å»ºcaä¸­å¿ƒ</p>

<pre><code>cat &gt; ca-config.json &lt;&lt;EOF
{
  &quot;signing&quot;: {
    &quot;default&quot;: {
      &quot;expiry&quot;: &quot;87600h&quot;
    },
    &quot;profiles&quot;: {
      &quot;kubernetes&quot;: {
        &quot;usages&quot;: [
            &quot;signing&quot;,
            &quot;key encipherment&quot;,
            &quot;server auth&quot;,
            &quot;client auth&quot;
        ],
        &quot;expiry&quot;: &quot;87600h&quot;
      }
    }
  }
}
EOF
</code></pre>

<p>ca-config.jsonï¼šå¯ä»¥å®šä¹‰å¤šä¸ª profilesï¼Œåˆ†åˆ«æŒ‡å®šä¸åŒçš„è¿‡æœŸæ—¶é—´ã€ä½¿ç”¨åœºæ™¯ç­‰å‚æ•°ï¼›åç»­åœ¨ç­¾åè¯ä¹¦æ—¶ä½¿ç”¨æŸä¸ª profileï¼›</p>

<p>signingï¼šè¡¨ç¤ºè¯¥è¯ä¹¦å¯ç”¨äºç­¾åå…¶å®ƒè¯ä¹¦ï¼›ç”Ÿæˆçš„ ca.pem è¯ä¹¦ä¸­ CA=TRUEï¼›</p>

<p>server authï¼šè¡¨ç¤ºclientå¯ä»¥ç”¨è¯¥ CA å¯¹serveræä¾›çš„è¯ä¹¦è¿›è¡ŒéªŒè¯ï¼›</p>

<p>client authï¼šè¡¨ç¤ºserverå¯ä»¥ç”¨è¯¥CAå¯¹clientæä¾›çš„è¯ä¹¦è¿›è¡ŒéªŒè¯ï¼›</p>

<p>åˆ›å»º CA è¯ä¹¦ç­¾åè¯·æ±‚æ–‡ä»¶</p>

<p>åˆ›å»º ca-csr.json æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>

<pre><code>{
  &quot;CN&quot;: &quot;kubernetes&quot;,
  &quot;key&quot;: {
    &quot;algo&quot;: &quot;rsa&quot;,
    &quot;size&quot;: 2048
  },
  &quot;names&quot;: [
    {
      &quot;C&quot;: &quot;CN&quot;,
      &quot;ST&quot;: &quot;BeiJing&quot;,
      &quot;L&quot;: &quot;BeiJing&quot;,
      &quot;O&quot;: &quot;k8s&quot;,
      &quot;OU&quot;: &quot;System&quot;
    }
  ]
}
</code></pre>

<p>&ldquo;CN&rdquo;ï¼šCommon Nameï¼Œkube-apiserver ä»è¯ä¹¦ä¸­æå–è¯¥å­—æ®µä½œä¸ºè¯·æ±‚çš„ç”¨æˆ·å (User Name)ï¼›æµè§ˆå™¨ä½¿ç”¨è¯¥å­—æ®µéªŒè¯ç½‘ç«™æ˜¯å¦åˆæ³•ï¼›</p>

<p>&ldquo;O&rdquo;ï¼šOrganizationï¼Œkube-apiserver ä»è¯ä¹¦ä¸­æå–è¯¥å­—æ®µä½œä¸ºè¯·æ±‚ç”¨æˆ·æ‰€å±çš„ç»„ (Group)ï¼›</p>

<pre><code>$ cfssl gencert -initca ca-csr.json | cfssljson -bare ca
</code></pre>

<p>ç”Ÿäº§å¯¹åº”çš„caè¯ä¹¦ï¼Œå¦‚ä¸‹ï¼š</p>

<pre><code>[root@promesdevapp18 ssl]# vi ca-config.json
[root@promesdevapp18 ssl]# vi ca-csr.json
[root@promesdevapp18 ssl]# cfssl gencert -initca ca-csr.json | cfssljson -bare ca
2019/04/11 11:06:53 [INFO] generating a new CA key and certificate from CSR
2019/04/11 11:06:53 [INFO] generate received request
2019/04/11 11:06:53 [INFO] received CSR
2019/04/11 11:06:53 [INFO] generating key: rsa-2048
2019/04/11 11:06:54 [INFO] encoded CSR
2019/04/11 11:06:54 [INFO] signed certificate with serial number 551260756352944283434991089528819033235135295505
[root@promesdevapp18 ssl]# ll
total 18828
-rw-r--r-- 1 root root      292 Apr 11 11:06 ca-config.json
-rw-r--r-- 1 root root     1001 Apr 11 11:06 ca.csr
-rw-r--r-- 1 root root      208 Apr 11 11:06 ca-csr.json
-rw------- 1 root root     1679 Apr 11 11:06 ca-key.pem
-rw-r--r-- 1 root root     1359 Apr 11 11:06 ca.pem
-rwxrwxrwx 1 root root  6595195 Apr 11 11:02 cfssl-certinfo_linux-amd64
-rwxrwxrwx 1 root root  2277873 Apr 11 11:02 cfssljson_linux-amd64
-rwxrwxrwx 1 root root 10376657 Apr 11 11:02 cfssl_linux-amd64
</code></pre>

<p>ç”Ÿæˆè¿è¡ŒCAæ‰€å¿…éœ€çš„æ–‡ä»¶ca-key.pemï¼ˆç§é’¥ï¼‰å’Œca.pemï¼ˆè¯ä¹¦ï¼‰ï¼Œè¿˜ä¼šç”Ÿæˆca.csrï¼ˆè¯ä¹¦ç­¾åè¯·æ±‚ï¼‰ï¼Œç”¨äºäº¤å‰ç­¾åæˆ–é‡æ–°ç­¾åã€‚</p>

<p>è¯·ä¿æŒca-key.pemæ–‡ä»¶çš„å®‰å…¨ã€‚æ­¤å¯†é’¥å…è®¸åœ¨CAä¸­åˆ›å»ºä»»ä½•ç±»å‹çš„è¯ä¹¦ã€‚*.csr æ–‡ä»¶åœ¨æ•´ä¸ªè¿‡ç¨‹ä¸­ä¸ä¼šä½¿ç”¨</p>

<p>è¿™è¾¹æ‰€æœ‰caç›¸å…³è¯ä¹¦å°±æ˜¯æ ¹è¯ä¹¦ï¼Œç”¨äºç­¾å‘ä¸‹é¢çš„æ¯ä¸ªç»„ä»¶çš„è¯ä¹¦ï¼Œåœ¨è¿™ä¸ªé›†ç¾¤ä¸­ï¼Œä»–å°±æ˜¯æƒå¨æœºæ„ï¼Œæœ€é«˜æƒé™ï¼Œé»˜è®¤ç­¾å‘çš„è¯ä¹¦æ˜¯ä¸€å¹´ï¼Œéœ€è¦æ³¨æ„ä¿®æ”¹ã€‚</p>

<p>2ã€åˆ›å»º kubernetes è¯ä¹¦</p>

<p>åˆ›å»º kubernetes è¯ä¹¦ç­¾åè¯·æ±‚æ–‡ä»¶ kubernetes-csr.jsonï¼š</p>

<pre><code>{
    &quot;CN&quot;: &quot;kubernetes&quot;,
    &quot;hosts&quot;: [
      &quot;127.0.0.1&quot;,
      &quot;192.168.56.107&quot;,
      &quot;192.168.56.106&quot;,
      &quot;192.168.56.105&quot;,
      &quot;10.254.0.1&quot;,
      &quot;kubernetes&quot;,
      &quot;kubernetes.default&quot;,
      &quot;kubernetes.default.svc&quot;,
      &quot;kubernetes.default.svc.cluster&quot;,
      &quot;kubernetes.default.svc.cluster.local&quot;
    ],
    &quot;key&quot;: {
        &quot;algo&quot;: &quot;rsa&quot;,
        &quot;size&quot;: 2048
    },
    &quot;names&quot;: [
        {
            &quot;C&quot;: &quot;CN&quot;,
            &quot;ST&quot;: &quot;BeiJing&quot;,
            &quot;L&quot;: &quot;BeiJing&quot;,
            &quot;O&quot;: &quot;k8s&quot;,
            &quot;OU&quot;: &quot;System&quot;
        }
    ]
}
</code></pre>

<p>å¦‚æœ hosts å­—æ®µä¸ä¸ºç©ºåˆ™éœ€è¦æŒ‡å®šæˆæƒä½¿ç”¨è¯¥è¯ä¹¦çš„ IP æˆ–åŸŸååˆ—è¡¨ï¼Œç”±äºè¯¥è¯ä¹¦åç»­è¢« etcd é›†ç¾¤å’Œ kubernetes master é›†ç¾¤ä½¿ç”¨ï¼Œæ‰€ä»¥ä¸Šé¢åˆ†åˆ«æŒ‡å®šäº† etcd é›†ç¾¤ã€kubernetes master é›†ç¾¤çš„ä¸»æœº IP å’Œ kubernetes æœåŠ¡çš„æœåŠ¡ IPï¼ˆä¸€èˆ¬æ˜¯ kube-apiserver æŒ‡å®šçš„ service-cluster-ip-range ç½‘æ®µçš„ç¬¬ä¸€ä¸ªIPï¼Œå¦‚ 10.254.0.1ï¼‰ã€‚</p>

<p>è¿™æ˜¯æœ€å°åŒ–å®‰è£…çš„kubernetesé›†ç¾¤ï¼ŒåŒ…æ‹¬ä¸€ä¸ªç§æœ‰é•œåƒä»“åº“ï¼Œä¸‰ä¸ªèŠ‚ç‚¹çš„kubernetesé›†ç¾¤ï¼Œä»¥ä¸Šç‰©ç†èŠ‚ç‚¹çš„IPä¹Ÿå¯ä»¥æ›´æ¢ä¸ºä¸»æœºåã€‚</p>

<pre><code>cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes -hostname=&quot;127.0.0.1,192.168.56.107,192.168.56.106,192.168.56.105,10.254.0.1,kubernetes,kubernetes.default,kubernetes.default.svc,kubernetes.default.svc.cluster,kubernetes.default.svc.cluster.local&quot; kubernetes-csr.json | cfssljson -bare kubernetes
</code></pre>

<p>æˆ–è€…</p>

<pre><code>echo '{&quot;CN&quot;:&quot;kubernetes&quot;,&quot;hosts&quot;:[&quot;&quot;],&quot;key&quot;:{&quot;algo&quot;:&quot;rsa&quot;,&quot;size&quot;:2048}}' | cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes -hostname=&quot;127.0.0.1,172.20.0.112,172.20.0.113,172.20.0.114,172.20.0.115,kubernetes,kubernetes.default&quot; - | cfssljson -bare kubernetes
</code></pre>

<p>ç”Ÿæˆkubernetesçš„å¯¹åº”ä¸‰ä¸ªæ–‡ä»¶</p>

<pre><code>[root@promesdevapp18 ssl]# vi kubernetes-csr.json
[root@promesdevapp18 ssl]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes -hostname=&quot;127.0.0.1,10.47.210.31,10.47.210.30,10.47.210.94,10.254.0.1,kubernetes,kubernetes.default,kubernetes.default.svc,kubernetes.default.svc.cluster,kubernetes.default.svc.cluster.local&quot; kubernetes-csr.json | cfssljson -bare kubernetes
2019/04/11 11:45:17 [INFO] generate received request
2019/04/11 11:45:17 [INFO] received CSR
2019/04/11 11:45:17 [INFO] generating key: rsa-2048
2019/04/11 11:45:17 [INFO] encoded CSR
2019/04/11 11:45:17 [INFO] signed certificate with serial number 4144021668890124555398076217136881830789156682
[root@promesdevapp18 ssl]#
[root@promesdevapp18 ssl]#
[root@promesdevapp18 ssl]# ll
total 18844
-rw-r--r-- 1 root root      292 Apr 11 11:43 ca-config.json
-rw-r--r-- 1 root root     1001 Apr 11 11:44 ca.csr
-rw-r--r-- 1 root root      209 Apr 11 11:44 ca-csr.json
-rw------- 1 root root     1679 Apr 11 11:44 ca-key.pem
-rw-r--r-- 1 root root     1359 Apr 11 11:44 ca.pem
-rwxrwxrwx 1 root root  6595195 Apr 11 11:02 cfssl-certinfo_linux-amd64
-rwxrwxrwx 1 root root  2277873 Apr 11 11:02 cfssljson_linux-amd64
-rwxrwxrwx 1 root root 10376657 Apr 11 11:02 cfssl_linux-amd64
-rw-r--r-- 1 root root     1261 Apr 11 11:45 kubernetes.csr
-rw-r--r-- 1 root root      556 Apr 11 11:45 kubernetes-csr.json
-rw------- 1 root root     1675 Apr 11 11:45 kubernetes-key.pem
-rw-r--r-- 1 root root     1627 Apr 11 11:45 kubernetes.pem
</code></pre>

<p>3ã€åˆ›å»º admin è¯ä¹¦</p>

<p>åˆ›å»º admin è¯ä¹¦ç­¾åè¯·æ±‚æ–‡ä»¶ admin-csr.jsonï¼š</p>

<pre><code>{
  &quot;CN&quot;: &quot;admin&quot;,
  &quot;hosts&quot;: [],
  &quot;key&quot;: {
    &quot;algo&quot;: &quot;rsa&quot;,
    &quot;size&quot;: 2048
  },
  &quot;names&quot;: [
    {
      &quot;C&quot;: &quot;CN&quot;,
      &quot;ST&quot;: &quot;BeiJing&quot;,
      &quot;L&quot;: &quot;BeiJing&quot;,
      &quot;O&quot;: &quot;system:masters&quot;,
      &quot;OU&quot;: &quot;System&quot;
    }
  ]
}
</code></pre>

<p>åç»­ kube-apiserver ä½¿ç”¨ RBAC å¯¹å®¢æˆ·ç«¯(å¦‚ kubeletã€kube-proxyã€Pod)è¯·æ±‚è¿›è¡Œæˆæƒï¼›</p>

<p>kube-apiserver é¢„å®šä¹‰äº†ä¸€äº› RBAC ä½¿ç”¨çš„ RoleBindingsï¼Œå¦‚ cluster-admin å°† Group system:masters ä¸ Role cluster-admin ç»‘å®šï¼Œè¯¥ Role æˆäºˆäº†è°ƒç”¨kube-apiserver çš„æ‰€æœ‰ APIçš„æƒé™ï¼›</p>

<p>O æŒ‡å®šè¯¥è¯ä¹¦çš„ Group ä¸º system:mastersï¼Œkubelet ä½¿ç”¨è¯¥è¯ä¹¦è®¿é—® kube-apiserver æ—¶ ï¼Œç”±äºè¯ä¹¦è¢« CA ç­¾åï¼Œæ‰€ä»¥è®¤è¯é€šè¿‡ï¼ŒåŒæ—¶ç”±äºè¯ä¹¦ç”¨æˆ·ç»„ä¸ºç»è¿‡é¢„æˆæƒçš„ system:mastersï¼Œæ‰€ä»¥è¢«æˆäºˆè®¿é—®æ‰€æœ‰ API çš„æƒé™ï¼›</p>

<p>æ³¨æ„ï¼šè¿™ä¸ªadmin è¯ä¹¦ï¼Œæ˜¯å°†æ¥ç”Ÿæˆç®¡ç†å‘˜ç”¨çš„kube config é…ç½®æ–‡ä»¶ç”¨çš„ï¼Œç°åœ¨æˆ‘ä»¬ä¸€èˆ¬å»ºè®®ä½¿ç”¨RBAC æ¥å¯¹kubernetes è¿›è¡Œè§’è‰²æƒé™æ§åˆ¶ï¼Œ kubernetes å°†è¯ä¹¦ä¸­çš„CN å­—æ®µ ä½œä¸ºUserï¼Œ O å­—æ®µä½œä¸º Groupï¼ˆå…·ä½“å‚è€ƒ Kubernetesä¸­çš„ç”¨æˆ·ä¸èº«ä»½è®¤è¯æˆæƒä¸­ X509 Client Certs ä¸€æ®µï¼‰ã€‚</p>

<p>åœ¨æ­å»ºå®Œ kubernetes é›†ç¾¤åï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å‘½ä»¤: kubectl get clusterrolebinding cluster-admin -o yaml ,æŸ¥çœ‹åˆ° clusterrolebinding cluster-admin çš„ subjects çš„ kind æ˜¯ Groupï¼Œname æ˜¯ system:mastersã€‚ roleRef å¯¹è±¡æ˜¯ ClusterRole cluster-adminã€‚ æ„æ€æ˜¯å‡¡æ˜¯ system:masters Group çš„ user æˆ–è€… serviceAccount éƒ½æ‹¥æœ‰ cluster-admin çš„è§’è‰²ã€‚ å› æ­¤æˆ‘ä»¬åœ¨ä½¿ç”¨ kubectl å‘½ä»¤æ—¶å€™ï¼Œæ‰æ‹¥æœ‰æ•´ä¸ªé›†ç¾¤çš„ç®¡ç†æƒé™ã€‚å¯ä»¥ä½¿ç”¨ kubectl get clusterrolebinding cluster-admin -o yaml æ¥æŸ¥çœ‹ã€‚</p>

<p>ç”Ÿæˆ admin è¯ä¹¦å’Œç§é’¥ï¼š</p>

<pre><code>$ cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes admin-csr.json | cfssljson -bare admin
</code></pre>

<p>4ã€åˆ›å»º kube-proxy è¯ä¹¦</p>

<p>åˆ›å»º kube-proxy è¯ä¹¦ç­¾åè¯·æ±‚æ–‡ä»¶ kube-proxy-csr.jsonï¼š</p>

<pre><code>{
  &quot;CN&quot;: &quot;system:kube-proxy&quot;,
  &quot;hosts&quot;: [],
  &quot;key&quot;: {
    &quot;algo&quot;: &quot;rsa&quot;,
    &quot;size&quot;: 2048
  },
  &quot;names&quot;: [
    {
      &quot;C&quot;: &quot;CN&quot;,
      &quot;ST&quot;: &quot;BeiJing&quot;,
      &quot;L&quot;: &quot;BeiJing&quot;,
      &quot;O&quot;: &quot;k8s&quot;,
      &quot;OU&quot;: &quot;System&quot;
    }
  ]
}
</code></pre>

<p>CN æŒ‡å®šè¯¥è¯ä¹¦çš„ User ä¸º system:kube-proxyï¼›</p>

<p>kube-apiserver é¢„å®šä¹‰çš„ RoleBinding cluster-admin å°†User system:kube-proxy ä¸ Role system:node-proxier ç»‘å®šï¼Œè¯¥ Role æˆäºˆäº†è°ƒç”¨ kube-apiserver Proxy ç›¸å…³ API çš„æƒé™ï¼›</p>

<p>ç”Ÿæˆ kube-proxy å®¢æˆ·ç«¯è¯ä¹¦å’Œç§é’¥</p>

<pre><code>$ cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes  kube-proxy-csr.json | cfssljson -bare kube-proxy
$ ls kube-proxy*
</code></pre>

<p>5ã€æ ¡éªŒè¯ä¹¦</p>

<p>1.openssl</p>

<pre><code>$ openssl x509  -noout -text -in  kubernetes.pem



ç¡®è®¤ Issuer å­—æ®µçš„å†…å®¹å’Œ ca-csr.json ä¸€è‡´ï¼›
ç¡®è®¤ Subject å­—æ®µçš„å†…å®¹å’Œ kubernetes-csr.json ä¸€è‡´ï¼›
ç¡®è®¤ X509v3 Subject Alternative Name å­—æ®µçš„å†…å®¹å’Œ kubernetes-csr.json ä¸€è‡´ï¼›
ç¡®è®¤ X509v3 Key Usageã€Extended Key Usage å­—æ®µçš„å†…å®¹å’Œ ca-config.json ä¸­ kubernetes profile ä¸€è‡´ï¼›
</code></pre>

<p>2.cfssl-certinfo</p>

<p>ä½¿ç”¨ cfssl-certinfo å‘½ä»¤</p>

<pre><code>$ cfssl-certinfo -cert kubernetes.pem
</code></pre>

<p>6ã€åˆ†å‘è¯ä¹¦</p>

<p>å°†ç”Ÿæˆçš„è¯ä¹¦å’Œç§˜é’¥æ–‡ä»¶ï¼ˆåç¼€åä¸º.pemï¼‰æ‹·è´åˆ°æ‰€æœ‰æœºå™¨çš„ /etc/kubernetes/ssl ç›®å½•ä¸‹å¤‡ç”¨</p>

<p>7ã€åˆ›å»ºkubectl kubeconfig</p>

<p>å…ˆåœ¨masterä¸Šå®‰è£…kubectl</p>

<p>åˆ›å»º kubectl kubeconfig æ–‡ä»¶</p>

<pre><code>export MASTER_IP=192.168.56.107
export KUBE_APISERVER=&quot;https://${MASTER_IP}:6443&quot;
</code></pre>

<p>è®¾ç½®é›†ç¾¤å‚æ•°</p>

<pre><code>kubectl config set-cluster kubernetes \
  --certificate-authority=/home/ssl/ca.pem \
  --embed-certs=true \
  --server=${KUBE_APISERVER}
</code></pre>

<p>è®¾ç½®å®¢æˆ·ç«¯è®¤è¯å‚æ•°</p>

<pre><code>kubectl config set-credentials admin \
  --client-certificate=/home/ssl/admin.pem \
  --embed-certs=true \
  --client-key=/home/ssl/admin-key.pem
</code></pre>

<p>è®¾ç½®ä¸Šä¸‹æ–‡å‚æ•°</p>

<pre><code>kubectl config set-context kubernetes \
  --cluster=kubernetes \
  --user=admin
</code></pre>

<p>è®¾ç½®é»˜è®¤ä¸Šä¸‹æ–‡</p>

<pre><code>kubectl config use-context kubernetes
</code></pre>

<p>admin.pem è¯ä¹¦ OU å­—æ®µå€¼ä¸º system:mastersï¼Œkube-apiserver é¢„å®šä¹‰çš„ RoleBinding cluster-admin å°† Group system:masters ä¸ Role cluster-admin ç»‘å®šï¼Œè¯¥ Role æˆäºˆäº†è°ƒç”¨kube-apiserver ç›¸å…³ API çš„æƒé™ï¼›</p>

<p>ç”Ÿæˆçš„ kubeconfig è¢«ä¿å­˜åˆ° ~/.kube/config æ–‡ä»¶ï¼›</p>

<p>æ³¨æ„ï¼š~/.kube/configæ–‡ä»¶æ‹¥æœ‰å¯¹è¯¥é›†ç¾¤çš„æœ€é«˜æƒé™ï¼Œè¯·å¦¥å–„ä¿ç®¡ã€‚</p>

<p>8ã€TLS Bootstrappingä½¿ç”¨kubeapiserverç»™kubeletç”Ÿæˆè¯ä¹¦</p>

<p>kubeletã€kube-proxy ç­‰ Node æœºå™¨ä¸Šçš„è¿›ç¨‹ä¸ Master æœºå™¨çš„ kube-apiserver è¿›ç¨‹é€šä¿¡æ—¶éœ€è¦è®¤è¯å’Œæˆæƒï¼›</p>

<p>kubernetes 1.4 å¼€å§‹æ”¯æŒç”± kube-apiserver ä¸ºå®¢æˆ·ç«¯ç”Ÿæˆ TLS è¯ä¹¦çš„ TLS Bootstrapping åŠŸèƒ½ï¼Œè¿™æ ·å°±ä¸éœ€è¦ä¸ºæ¯ä¸ªå®¢æˆ·ç«¯ç”Ÿæˆè¯ä¹¦äº†ï¼›è¯¥åŠŸèƒ½å½“å‰ä»…æ”¯æŒä¸º kubelet ç”Ÿæˆè¯ä¹¦ï¼›</p>

<p>ä»¥ä¸‹æ“ä½œåªéœ€è¦åœ¨masterèŠ‚ç‚¹ä¸Šæ‰§è¡Œï¼Œç”Ÿæˆçš„*.kubeconfigæ–‡ä»¶å¯ä»¥ç›´æ¥æ‹·è´åˆ°nodeèŠ‚ç‚¹çš„/etc/kubernetesç›®å½•ä¸‹ã€‚</p>

<p>åˆ›å»º TLS Bootstrapping Token</p>

<pre><code>export BOOTSTRAP_TOKEN=$(head -c 16 /dev/urandom | od -An -t x | tr -d ' ')
cat &gt; token.csv &lt;&lt;EOF
${BOOTSTRAP_TOKEN},kubelet-bootstrap,10001,&quot;system:kubelet-bootstrap&quot;
EOF
</code></pre>

<p>BOOTSTRAP_TOKEN å°†è¢«å†™å…¥åˆ° kube-apiserver ä½¿ç”¨çš„ token.csv æ–‡ä»¶å’Œ kubelet ä½¿ç”¨çš„ bootstrap.kubeconfig æ–‡ä»¶ï¼Œå¦‚æœåç»­é‡æ–°ç”Ÿæˆäº† BOOTSTRAP_TOKENï¼Œåˆ™éœ€è¦ï¼š</p>

<p>1.æ›´æ–° token.csv æ–‡ä»¶ï¼Œåˆ†å‘åˆ°æ‰€æœ‰æœºå™¨ (master å’Œ nodeï¼‰çš„ /etc/kubernetes/ ç›®å½•ä¸‹ï¼Œåˆ†å‘åˆ°nodeèŠ‚ç‚¹ä¸Šéå¿…éœ€ï¼›
2.é‡æ–°ç”Ÿæˆ bootstrap.kubeconfig æ–‡ä»¶ï¼Œåˆ†å‘åˆ°æ‰€æœ‰ node æœºå™¨çš„ /etc/kubernetes/ ç›®å½•ä¸‹ï¼›
3.é‡å¯ kube-apiserver å’Œ kubelet è¿›ç¨‹ï¼›
4.é‡æ–° approve kubelet çš„ csr è¯·æ±‚ï¼›
5.cp token.csv /etc/kubernetes/</p>

<p>9ã€åˆ›å»º kubelet bootstrapping kubeconfig æ–‡ä»¶</p>

<p>cd /etc/kubernetes</p>

<pre><code>export MASTER_IP=192.168.56.107
export KUBE_APISERVER=&quot;https://${MASTER_IP}:6443&quot;
</code></pre>

<p>è®¾ç½®é›†ç¾¤å‚æ•°</p>

<pre><code>kubectl config set-cluster kubernetes \
  --certificate-authority=/home/ssl/ca.pem \
  --embed-certs=true \
  --server=${KUBE_APISERVER} \
  --kubeconfig=bootstrap.kubeconfig
</code></pre>

<p>è®¾ç½®å®¢æˆ·ç«¯è®¤è¯å‚æ•°</p>

<pre><code>kubectl config set-credentials kubelet-bootstrap \
  --token=${BOOTSTRAP_TOKEN} \
  --kubeconfig=bootstrap.kubeconfig
</code></pre>

<p>è®¾ç½®ä¸Šä¸‹æ–‡å‚æ•°</p>

<pre><code>kubectl config set-context default \
  --cluster=kubernetes \
  --user=kubelet-bootstrap \
  --kubeconfig=bootstrap.kubeconfig
</code></pre>

<p>è®¾ç½®é»˜è®¤ä¸Šä¸‹æ–‡</p>

<pre><code>kubectl config use-context default --kubeconfig=bootstrap.kubeconfig
</code></pre>

<p>&ndash;embed-certs ä¸º true æ—¶è¡¨ç¤ºå°† certificate-authority è¯ä¹¦å†™å…¥åˆ°ç”Ÿæˆçš„ bootstrap.kubeconfig æ–‡ä»¶ä¸­ï¼›</p>

<p>è®¾ç½®å®¢æˆ·ç«¯è®¤è¯å‚æ•°æ—¶æ²¡æœ‰æŒ‡å®šç§˜é’¥å’Œè¯ä¹¦ï¼Œåç»­ç”± kube-apiserver è‡ªåŠ¨ç”Ÿæˆï¼›</p>

<p>10ã€åˆ›å»º kube-proxy kubeconfig æ–‡ä»¶</p>

<pre><code>cd /etc/kubernetes
export KUBE_APISERVER=&quot;https://192.168.56.107:6443&quot;
</code></pre>

<p>è®¾ç½®é›†ç¾¤å‚æ•°</p>

<pre><code>kubectl config set-cluster kubernetes \
  --certificate-authority=/home/ssl/ca.pem \
  --embed-certs=true \
  --server=${KUBE_APISERVER} \
  --kubeconfig=kube-proxy.kubeconfig
</code></pre>

<p>è®¾ç½®å®¢æˆ·ç«¯è®¤è¯å‚æ•°</p>

<pre><code>kubectl config set-credentials kube-proxy \
  --client-certificate=/home/ssl/kube-proxy.pem \
  --client-key=/home/ssl/kube-proxy-key.pem \
  --embed-certs=true \
  --kubeconfig=kube-proxy.kubeconfig
</code></pre>

<p>è®¾ç½®ä¸Šä¸‹æ–‡å‚æ•°</p>

<pre><code>kubectl config set-context default \
  --cluster=kubernetes \
  --user=kube-proxy \
  --kubeconfig=kube-proxy.kubeconfig
</code></pre>

<p>è®¾ç½®é»˜è®¤ä¸Šä¸‹æ–‡</p>

<pre><code>kubectl config use-context default --kubeconfig=kube-proxy.kubeconfig
</code></pre>

<p>è®¾ç½®é›†ç¾¤å‚æ•°å’Œå®¢æˆ·ç«¯è®¤è¯å‚æ•°æ—¶ &ndash;embed-certs éƒ½ä¸º trueï¼Œè¿™ä¼šå°† certificate-authorityã€client-certificate å’Œ client-key æŒ‡å‘çš„è¯ä¹¦æ–‡ä»¶å†…å®¹å†™å…¥åˆ°ç”Ÿæˆçš„ kube-proxy.kubeconfig æ–‡ä»¶ä¸­ï¼›</p>

<p>kube-proxy.pem è¯ä¹¦ä¸­ CN ä¸º system:kube-proxyï¼Œkube-apiserver é¢„å®šä¹‰çš„ RoleBinding cluster-admin å°†User system:kube-proxy ä¸ Role system:node-proxier ç»‘å®šï¼Œè¯¥ Role æˆäºˆäº†è°ƒç”¨ kube-apiserver Proxy ç›¸å…³ API çš„æƒé™ï¼›</p>

<p>åˆ†å‘ï¼š</p>

<p>å°†ä¸¤ä¸ª kubeconfig æ–‡ä»¶åˆ†å‘åˆ°æ‰€æœ‰ Node æœºå™¨çš„ /etc/kubernetes/ ç›®å½•</p>

<p>cp bootstrap.kubeconfig kube-proxy.kubeconfig /etc/kubernetes/</p>

<blockquote>
<p>å®‰è£…etcd&mdash;&ndash;å¸¦tlsçš„</p>
</blockquote>

<p>æœ¬æ¬¡å®‰è£…ç”¨åˆ°çš„å˜é‡è®¾ç½®</p>

<pre><code>$ export NODE_NAME=opt6 # å½“å‰éƒ¨ç½²çš„æœºå™¨åç§°(éšä¾¿å®šä¹‰ï¼Œåªè¦èƒ½åŒºåˆ†ä¸åŒæœºå™¨å³å¯)
$ export NODE_IP=192.168.56.107 # å½“å‰éƒ¨ç½²çš„æœºå™¨ IP
$ export NODE_IPS=&quot;192.168.56.107 192.168.56.106 192.168.56.105&quot; # etcd é›†ç¾¤æ‰€æœ‰æœºå™¨ IP
$ # etcd é›†ç¾¤é—´é€šä¿¡çš„IPå’Œç«¯å£
$ export ETCD_NODES=opt6=https://192.168.56.105:2380,opt7=https://192.168.56.106:2380,opt8=https://192.168.56.107:2380
$ # å¯¼å…¥ç”¨åˆ°çš„å…¶å®ƒå…¨å±€å˜é‡ï¼šETCD_ENDPOINTSã€FLANNEL_ETCD_PREFIXã€CLUSTER_CIDR
$ source /root/local/bin/environment.sh
</code></pre>

<p>1.è®¾ç½®etcdäºŒè¿›åˆ¶æ–‡ä»¶</p>

<p>Etcdæ˜¯Kubernetesé›†ç¾¤ä¸­çš„ä¸€ä¸ªååˆ†é‡è¦çš„ç»„ä»¶ï¼Œç”¨äºä¿å­˜é›†ç¾¤æ‰€æœ‰çš„ç½‘ç»œé…ç½®å’Œå¯¹è±¡çš„çŠ¶æ€ä¿¡æ¯ã€‚</p>

<p>æ•´ä¸ªkubernetesç³»ç»Ÿä¸­ä¸€å…±æœ‰ä¸¤ä¸ªæœåŠ¡éœ€è¦ç”¨åˆ°etcdç”¨æ¥ååŒå’Œå­˜å‚¨é…ç½®ï¼Œåˆ†åˆ«æ˜¯ï¼š</p>

<pre><code>ç½‘ç»œæ’ä»¶flannelã€å¯¹äºå…¶å®ƒç½‘ç»œæ’ä»¶ä¹Ÿéœ€è¦ç”¨åˆ°etcdå­˜å‚¨ç½‘ç»œçš„é…ç½®ä¿¡æ¯
kubernetesæœ¬èº«ï¼ŒåŒ…æ‹¬å„ç§å¯¹è±¡çš„çŠ¶æ€å’Œå…ƒä¿¡æ¯é…ç½®
</code></pre>

<p>ç›®å‰ä½¿ç”¨etcdç‰ˆæœ¬3.1.6</p>

<pre><code>wget https://github.com/coreos/etcd/releases/download/v3.1.5/etcd-v3.1.5-linux-amd64.tar.gz
</code></pre>

<p>è§£å‹è®¾ç½®ç¯å¢ƒå˜é‡</p>

<pre><code>tar -xvf etcd-v3.1.5-linux-amd64.tar.gz
echo 'export PATH=/home/etcd/etcd-v3.1.6-linux-amd64:$PATH' &gt;&gt; /etc/profile
source /etc/profile
</code></pre>

<p>æˆ–è€…æŠŠäºŒè¿›åˆ¶æ–‡ä»¶ç§»åˆ°ç³»ç»Ÿè·¯å¾„ä¸‹ï¼Œæ¯”å¦‚/usr/local/src</p>

<p>2.åˆ›å»º etcdçš„TLS ç§˜é’¥å’Œè¯ä¹¦</p>

<p>ç¼–è¾‘etcd-csr.json</p>

<pre><code>cat &gt; etcd-csr.json &lt;&lt;EOF
{
  &quot;CN&quot;: &quot;etcd&quot;,
  &quot;hosts&quot;: [
    &quot;127.0.0.1&quot;,
    &quot;192.168.56.107&quot;----è®¾ç½®æœ¬åœ°ip,ä¹Ÿå°±æ˜¯ä¸Šé¢çš„${NODE_IP}
  ],
  &quot;key&quot;: {
    &quot;algo&quot;: &quot;rsa&quot;,
    &quot;size&quot;: 2048
  },
  &quot;names&quot;: [
    {
      &quot;C&quot;: &quot;CN&quot;,
      &quot;ST&quot;: &quot;BeiJing&quot;,
      &quot;L&quot;: &quot;BeiJing&quot;,
      &quot;O&quot;: &quot;k8s&quot;,
      &quot;OU&quot;: &quot;System&quot;
    }
  ]
}
EOF
</code></pre>

<p>ç”Ÿæˆ etcd è¯ä¹¦å’Œç§é’¥ï¼š</p>

<pre><code>cfssl gencert -ca=/home/ssl/ca.pem \
  -ca-key=/home/ssl/ca-key.pem \
  -config=/home/ssl/ca-config.json \
  -profile=kubernetes etcd-csr.json | cfssljson -bare etcd
</code></pre>

<p>è¿™è¾¹å¯ä»¥ä½¿ç”¨kuberneteçš„è¯ä¹¦ï¼Œå› ä¸ºè¯ä¹¦åŒ…å«äº†etcdèŠ‚ç‚¹</p>

<p>å› ä¸ºåŒ…å«ä¸»æœºçš„ipæ¯å°æœºå™¨çš„è¯ä¹¦éƒ½è¦å•ç‹¬ç”Ÿæˆï¼Œä¸èƒ½æ‹·è´</p>

<p>3.åˆ›å»º etcd çš„ systemd unit æ–‡ä»¶</p>

<p>åœ¨/usr/lib/systemd/system/ç›®å½•ä¸‹åˆ›å»ºæ–‡ä»¶etcd.service</p>

<p>opt8</p>

<pre><code>cat &gt; etcd.service &lt;&lt;EOF
[Unit]
Description=Etcd Server
After=network.target
After=network-online.target
Wants=network-online.target
Documentation=https://github.com/coreos

[Service]
Type=notify
WorkingDirectory=/var/lib/etcd/
ExecStart=/home/etcd/etcd-v3.1.6-linux-amd64/etcd \\
  --name=opt8 \\
  --cert-file=/home/ssl/etcd.pem \\
  --key-file=/home/ssl/etcd-key.pem \\
  --peer-cert-file=/home/ssl/etcd.pem \\
  --peer-key-file=/home/ssl/etcd-key.pem \\
  --trusted-ca-file=/home/ssl/ca.pem \\
  --peer-trusted-ca-file=/home/ssl/ca.pem \\
  --initial-advertise-peer-urls=https://192.168.56.107:2380 \\
  --listen-peer-urls=https://192.168.56.107:2380 \\
  --listen-client-urls=https://192.168.56.107:2379,http://127.0.0.1:2379 \\
  --advertise-client-urls=https://192.168.56.107:2379 \\
  --initial-cluster-token=etcd-cluster-0 \\
  --initial-cluster=opt8=https://192.168.56.107:2380,opt7=https://192.168.56.106:2380,opt6=https://192.168.56.105:2380 \\
  --initial-cluster-state=new \\
  --data-dir=/var/lib/etcd
Restart=on-failure
RestartSec=5
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
EOF
</code></pre>

<p>opt7</p>

<pre><code>cat &gt; etcd.service &lt;&lt;EOF
[Unit]
Description=Etcd Server
After=network.target
After=network-online.target
Wants=network-online.target
Documentation=https://github.com/coreos

[Service]
Type=notify
WorkingDirectory=/var/lib/etcd/
ExecStart=/home/etcd/etcd-v3.1.6-linux-amd64/etcd \\
  --name=opt7 \\
  --cert-file=/home/ssl/etcd.pem \\
  --key-file=/home/ssl/etcd-key.pem \\
  --peer-cert-file=/home/ssl/etcd.pem \\
  --peer-key-file=/home/ssl/etcd-key.pem \\
  --trusted-ca-file=/home/ssl/ca.pem \\
  --peer-trusted-ca-file=/home/ssl/ca.pem \\
  --initial-advertise-peer-urls=https://192.168.56.106:2380 \\
  --listen-peer-urls=https://192.168.56.106:2380 \\
  --listen-client-urls=https://192.168.56.106:2379,http://127.0.0.1:2379 \\
  --advertise-client-urls=https://192.168.56.106:2379 \\
  --initial-cluster-token=etcd-cluster-0 \\
  --initial-cluster=opt8=https://192.168.56.107:2380,opt7=https://192.168.56.106:2380,opt6=https://192.168.56.105:2380 \\
  --initial-cluster-state=new \\
  --data-dir=/var/lib/etcd
Restart=on-failure
RestartSec=5
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
EOF
</code></pre>

<p>opt6</p>

<pre><code>cat &gt; etcd.service &lt;&lt;EOF
[Unit]
Description=Etcd Server
After=network.target
After=network-online.target
Wants=network-online.target
Documentation=https://github.com/coreos

[Service]
Type=notify
WorkingDirectory=/var/lib/etcd/
ExecStart=/home/etcd/etcd-v3.1.6-linux-amd64/etcd \\
  --name=opt6 \\
  --cert-file=/home/ssl/etcd.pem \\
  --key-file=/home/ssl/etcd-key.pem \\
  --peer-cert-file=/home/ssl/etcd.pem \\
  --peer-key-file=/home/ssl/etcd-key.pem \\
  --trusted-ca-file=/home/ssl/ca.pem \\
  --peer-trusted-ca-file=/home/ssl/ca.pem \\
  --initial-advertise-peer-urls=https://192.168.56.105:2380 \\
  --listen-peer-urls=https://192.168.56.105:2380 \\
  --listen-client-urls=https://192.168.56.105:2379,http://127.0.0.1:2379 \\
  --advertise-client-urls=https://192.168.56.105:2379 \\
  --initial-cluster-token=etcd-cluster-0 \\
  --initial-cluster=opt8=https://192.168.56.107:2380,opt7=https://192.168.56.106:2380,opt6=https://192.168.56.105:2380 \\
  --initial-cluster-state=new \\
  --data-dir=/var/lib/etcd
Restart=on-failure
RestartSec=5
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
EOF
</code></pre>

<p>å¯åŠ¨å‚æ•°åœ¨serviceä¸­ä¸ç”¨åŠ â€œâ€ï¼Œå¦åˆ™å¯åŠ¨å¤±è´¥ã€‚</p>

<p>ä¹Ÿå¯ä»¥ä½¿ç”¨å‘½ä»¤è¡Œå¯åŠ¨</p>

<p>opt8</p>

<pre><code>etcd -name niub1 -debug \
    -initial-advertise-peer-urls http://192.168.56.107:2380 \
    -listen-peer-urls http://192.168.56.107:2380 \
    -listen-client-urls http://192.168.56.107:2379,http://127.0.0.1:2379 \
    -advertise-client-urls http://192.168.56.107:2379 \
    -initial-cluster-token etcd-cluster-1 \
    -initial-cluster niub1=http://192.168.56.107:2380,niub2=http://192.168.56.106:2380,niub3=http://192.168.56.105:2380 \
    -initial-cluster-state new  &gt;&gt; ./etcd.log 2&gt;&amp;1 &amp;
</code></pre>

<p>opt7</p>

<pre><code>etcd -name niub2 -debug \
    -initial-advertise-peer-urls http://192.168.56.106:2380 \
    -listen-peer-urls http://192.168.56.106:2380 \
    -listen-client-urls http://192.168.56.106:2379,http://127.0.0.1:2379 \
    -advertise-client-urls http://192.168.56.106:2379 \
    -initial-cluster-token etcd-cluster-1 \
    -initial-cluster niub1=http://192.168.56.107:2380,niub2=http://192.168.56.106:2380,niub3=http://192.168.56.105:2380 \
    -initial-cluster-state new  &gt;&gt; ./etcd.log 2&gt;&amp;1 &amp;
</code></pre>

<p>opt6</p>

<pre><code>etcd -name niub3 -debug \
    -initial-advertise-peer-urls http://192.168.56.105:2380 \
    -listen-peer-urls http://192.168.56.105:2380 \
    -listen-client-urls http://192.168.56.105:2379,http://127.0.0.1:2379 \
    -advertise-client-urls http://192.168.56.105:2379 \
    -initial-cluster-token etcd-cluster-1 \
    -initial-cluster niub1=http://192.168.56.107:2380,niub2=http://192.168.56.106:2380,niub3=http://192.168.56.105:2380 \
    -initial-cluster-state new  &gt;&gt; ./etcd.log 2&gt;&amp;1 &amp;
</code></pre>

<p>4.åŠ è½½serviceï¼Œå¯åŠ¨</p>

<pre><code>systemctl daemon-reload
systemctl enable etcd
systemctl start etcd
</code></pre>

<p>5.æµ‹è¯•é›†ç¾¤&mdash;è¿™ä¸ªæ˜¯å¸¦caçš„</p>

<pre><code>etcdctl \
  --ca-file=/home/ssl/ca.pem \
  --cert-file=/home/ssl/kubernetes.pem \
  --key-file=/home/ssl/kubernetes-key.pem \
  cluster-health
</code></pre>

<p>æŸ¥çœ‹é›†ç¾¤ä¸­k8sçš„æ•°æ®</p>

<p>Kubenretes1.6ä¸­ä½¿ç”¨etcd V3ç‰ˆæœ¬çš„APIï¼Œä½¿ç”¨etcdctlç›´æ¥lsçš„è¯åªèƒ½çœ‹åˆ°/kube-centosä¸€ä¸ªè·¯å¾„ã€‚éœ€è¦åœ¨å‘½ä»¤å‰åŠ ä¸ŠETCDCTL_API=3è¿™ä¸ªç¯å¢ƒå˜é‡æ‰èƒ½çœ‹åˆ°kuberentesåœ¨etcdä¸­ä¿å­˜çš„æ•°æ®ã€‚</p>

<pre><code>ETCDCTL_API=3 etcdctl get /registry/namespaces/default -w=json|python -m json.tool
</code></pre>

<p>-wæŒ‡å®šè¾“å‡ºæ ¼å¼</p>

<p>ä½¿ç”¨&ndash;prefixå¯ä»¥çœ‹åˆ°æ‰€æœ‰çš„å­ç›®å½•ï¼Œå¦‚æŸ¥çœ‹é›†ç¾¤ä¸­çš„namespaceï¼š</p>

<pre><code>ETCDCTL_API=3 etcdctl get /registry/namespaces --prefix -w=json|python -m json.tool
</code></pre>

<p>keyçš„å€¼æ˜¯ç»è¿‡base64ç¼–ç ï¼Œéœ€è¦è§£ç åæ‰èƒ½çœ‹åˆ°å®é™…å€¼ï¼Œå¦‚ï¼š</p>

<pre><code>[root@opt8 ssl]# echo L3JlZ2lzdHJ5L25hbWVzcGFjZXMva3ViZS1zeXN0ZW0=|base64 -d
/registry/namespaces/kube-system[root@opt8 ssl]#
</code></pre>

<p>etcdä¸­kubernetesçš„å…ƒæ•°æ®</p>

<pre><code>#!/bin/bash
# Get kubernetes keys from etcd
export ETCDCTL_API=3
keys=`etcdctl get /registry --prefix -w json|python -m json.tool|grep key|cut -d &quot;:&quot; -f2|tr -d '&quot;'|tr -d &quot;,&quot;`
for x in $keys;do
  echo $x|base64 -d|sort
done
</code></pre>

<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ‰€æœ‰çš„Kuberentesçš„æ‰€æœ‰å…ƒæ•°æ®éƒ½ä¿å­˜åœ¨/registryç›®å½•ä¸‹ï¼Œä¸‹ä¸€å±‚å°±æ˜¯APIå¯¹è±¡ç±»å‹ï¼ˆå¤æ•°å½¢å¼ï¼‰ï¼Œå†ä¸‹ä¸€å±‚æ˜¯namespaceï¼Œæœ€åä¸€å±‚æ˜¯å¯¹è±¡çš„åå­—ã€‚</p>

<blockquote>
<p>masterå®‰è£…</p>
</blockquote>

<p>éƒ¨ç½²æœºå™¨</p>

<pre><code>10.47.210.30
</code></pre>

<p>éƒ¨ç½²ç»„ä»¶</p>

<pre><code>kube-apiserver
kube-controller-manager
kube-scheduler
</code></pre>

<p>1ã€é…ç½®å’Œå¯åŠ¨ kube-apiserver</p>

<p>åˆ›å»º kube-apiserver ä½¿ç”¨çš„å®¢æˆ·ç«¯ token æ–‡ä»¶</p>

<p>kubelet é¦–æ¬¡å¯åŠ¨æ—¶å‘ kube-apiserver å‘é€ TLS Bootstrapping è¯·æ±‚ï¼Œkube-apiserver éªŒè¯ kubelet è¯·æ±‚ä¸­çš„ token æ˜¯å¦ä¸å®ƒé…ç½®çš„ token.csv ä¸€è‡´ï¼Œå¦‚æœä¸€è‡´åˆ™è‡ªåŠ¨ä¸º kubeletç”Ÿæˆè¯ä¹¦å’Œç§˜é’¥ã€‚</p>

<p>ç›®å½•</p>

<pre><code>/etc/systemd/system


cat  &gt; kube-apiserver.service &lt;&lt;EOF
[Unit]
Description=Kubernetes API Server
Documentation=https://github.com/GoogleCloudPlatform/kubernetes
After=network.target

[Service]
ExecStart=/usr/bin/kube-apiserver \
  --admission-control=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,ResourceQuota \
  --advertise-address=10.47.210.30 \
  --insecure-bind-address=10.47.210.30 \
  --authorization-mode=RBAC \
  --runtime-config=rbac.authorization.k8s.io/v1alpha1 \
  --kubelet-https=true \
  --enable-bootstrap-token-auth \
  --service-cluster-ip-range=10.254.0.0/16 \
  --service-node-port-range=8400-9000 \
  --etcd-cafile=/root/ssl/ca.pem \
  --etcd-certfile=/root/ssl/etcd.pem \
  --etcd-keyfile=/root/ssl/etcd-key.pem \
  --etcd-servers=https://10.47.210.30:2379,https://10.47.210.31:2379,https://10.47.210.94:2379 \
  --enable-swagger-ui=true \
  --allow-privileged=true \
  --apiserver-count=3 \
  --audit-log-maxage=30 \
  --audit-log-maxbackup=3 \
  --audit-log-maxsize=100 \
  --audit-log-path=/var/lib/audit.log \
  --event-ttl=1h \
  --v=0 \
  --logtostderr=true \
  --bind-address=10.47.210.30 \
  --token-auth-file=/etc/kubernetes/token.csv \
  --tls-cert-file=/root/ssl/kubernetes.pem \
  --tls-private-key-file=/root/ssl/kubernetes-key.pem \
  --client-ca-file=/root/ssl/ca.pem \
  --service-account-key-file=/root/ssl/ca-key.pem
Restart=on-failure
RestartSec=5
Type=notify
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
EOF
</code></pre>

<p>å‚æ•°è§£æ</p>

<ul>
<li>&ndash;v=2 æ—¥å¿—çº§åˆ«ï¼Œdebugçº§åˆ«æ˜¯0</li>
<li>&ndash;logtostderr=false  ä¸è¾“å‡ºåˆ°logerr</li>
<li>&ndash;allow-privileged=true ä½¿ç”¨docker run &ndash;privileged</li>
<li>&ndash;etcd-servers=â€œâ€ etcdçš„é›†ç¾¤åœ°ï¼Œkube-apiserver 1.6 ç‰ˆæœ¬å¼€å§‹ä½¿ç”¨ etcd v3 API å’Œå­˜å‚¨æ ¼å¼</li>
<li>&ndash;insecure-bind-address éå®‰å…¨ç«¯å£ç›‘å¬çš„ip</li>
<li>&ndash;advertise-address=192.168.14.132 è‡ªèº«åœ°å€</li>
<li>&ndash;bind-address=0.0.0.0 å®‰å…¨ç«¯å£ç›‘å¬çš„ip</li>
<li>&ndash;log-dir=/data/log/kubernetes/kube-apiserver æ—¥å¿—è·¯å¾„ï¼Œæˆ‘ä»¬ä¸€èˆ¬æ ¹æ®è¿™äº›å‚æ•°æ¥æŸ¥çœ‹æ—¥å¿—è·¯å¾„ï¼Œç„¶åå»æŸ¥çœ‹ç›¸å…³æ—¥å¿—</li>
<li>&ndash;authorization-mode=RBAC æŒ‡å®šåœ¨å®‰å…¨ç«¯å£ä½¿ç”¨ RBAC æˆæƒæ¨¡å¼ï¼Œæ‹’ç»æœªé€šè¿‡æˆæƒçš„è¯·æ±‚</li>
<li>&ndash;admission-control å€¼å¿…é¡»åŒ…å« ServiceAccountï¼Œå¦åˆ™éƒ¨ç½²é›†ç¾¤æ’ä»¶æ—¶ä¼šå¤±è´¥</li>
<li>&ndash;bind-address ç»‘å®šåœ°å€ï¼Œä¸èƒ½ä¸º 127.0.0.1</li>
<li>&ndash;service-cluster-ip-range=10.252.0.0/16 æŒ‡å®š Service Cluster IP åœ°å€æ®µï¼Œè¯¥åœ°å€æ®µä¸èƒ½è·¯ç”±å¯è¾¾,å¦‚æœä¸­é€”ä¿®æ”¹è¿‡&ndash;service-cluster-ip-rangeåœ°å€ï¼Œåˆ™å¿…é¡»å°†defaultå‘½åç©ºé—´çš„kubernetesçš„serviceç»™åˆ é™¤ï¼Œä½¿ç”¨å‘½ä»¤ï¼škubectl delete service kubernetesï¼Œç„¶åç³»ç»Ÿä¼šè‡ªåŠ¨ç”¨æ–°çš„ipé‡å»ºè¿™ä¸ªserviceï¼Œä¸ç„¶apiserverçš„logæœ‰æŠ¥é”™the cluster IP x.x.x.x for service kubernetes/default is not within the service CIDR x.x.x.x/16; please recreate</li>
<li>&ndash;service-node-port-range=30000-40000 æŒ‡å®š NodePort çš„ç«¯å£èŒƒå›´ï¼Œ</li>
<li>&ndash;experimental-bootstrap-token-auth Bootstrap Token Authenticationåœ¨1.9ç‰ˆæœ¬å·²ç»å˜æˆäº†æ­£å¼featureï¼Œå‚æ•°åç§°æ”¹ä¸º&ndash;enable-bootstrap-token-auth</li>
<li>&ndash;insecure-port=8080 å¼€é€šhttpçš„æ— è®¤è¯çš„æ¥å£</li>
<li>&ndash;insecure-bind-address=127.0.0.1ã€‚æ³¨æ„ï¼Œç”Ÿäº§ä¸Šä¸è¦ç»‘å®šåˆ°é127.0.0.1çš„åœ°å€ä¸Š</li>
</ul>

<p>å¯åŠ¨</p>

<pre><code>systemctl daemon-reload
systemctl enable kube-apiserver
systemctl start kube-apiserver
systemctl status kube-apiserver
</code></pre>

<p>2ã€åˆ›å»º kube-controller-manager çš„ systemd unit æ–‡ä»¶</p>

<pre><code>cat &gt; kube-controller-manager.service &lt;&lt;EOF
[Unit]
Description=Kubernetes Controller Manager
Documentation=https://github.com/GoogleCloudPlatform/kubernetes

[Service]
ExecStart=/usr/bin/kube-controller-manager \
  --address=127.0.0.1 \
  --master=http://10.47.210.30:8080 \
  --allocate-node-cidrs=true \
  --service-cluster-ip-range=10.254.0.0/16 \
  --cluster-cidr=172.30.0.0/16 \
  --cluster-name=kubernetes \
  --leader-elect=true \
  --v=2 \
  --cluster-signing-cert-file=/root/ssl/ca.pem \
  --cluster-signing-key-file=/root/ssl/ca-key.pem  \
  --service-account-private-key-file=/root/ssl/ca-key.pem \
  --root-ca-file=/root/ssl/ca.pem
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF
</code></pre>

<p>å‚æ•°è§£æ</p>

<p>&ndash;addresså€¼å¿…é¡»æ˜¯127.0.0.1ï¼Œå› ä¸ºå½“å‰çš„kube-apiserveræœŸæœ›schedulerå’Œcontroller-manageråœ¨åŒä¸€å°æœºå™¨ä¸Š</p>

<p>&ndash;master=http://{MASTER_IP}:8080ï¼šä½¿ç”¨éå®‰å…¨ 8080 ç«¯å£ä¸ kube-apiserver é€šä¿¡ï¼›</p>

<p>&ndash;cluster-cidr æŒ‡å®š Cluster ä¸­ Pod çš„ CIDR èŒƒå›´ï¼Œè¯¥ç½‘æ®µåœ¨å„ Node é—´å¿…é¡»è·¯ç”±å¯è¾¾(flanneldä¿è¯)ï¼›</p>

<p>&ndash;service-cluster-ip-range å‚æ•°æŒ‡å®š Cluster ä¸­ Service çš„CIDRèŒƒå›´ï¼Œè¯¥ç½‘ç»œåœ¨å„ Node é—´å¿…é¡»è·¯ç”±ä¸å¯è¾¾ï¼Œå¿…é¡»å’Œ kube-apiserver ä¸­çš„å‚æ•°ä¸€è‡´ï¼›</p>

<p>&ndash;cluster-signing-* æŒ‡å®šçš„è¯ä¹¦å’Œç§é’¥æ–‡ä»¶ç”¨æ¥ç­¾åä¸º TLS BootStrap åˆ›å»ºçš„è¯ä¹¦å’Œç§é’¥ï¼›</p>

<p>&ndash;root-ca-file ç”¨æ¥å¯¹ kube-apiserver è¯ä¹¦è¿›è¡Œæ ¡éªŒï¼ŒæŒ‡å®šè¯¥å‚æ•°åï¼Œæ‰ä¼šåœ¨Pod å®¹å™¨çš„ ServiceAccount ä¸­æ”¾ç½®è¯¥ CA è¯ä¹¦æ–‡ä»¶ï¼›</p>

<p>&ndash;leader-elect=true éƒ¨ç½²å¤šå°æœºå™¨ç»„æˆçš„ master é›†ç¾¤æ—¶é€‰ä¸¾äº§ç”Ÿä¸€å¤„äºå·¥ä½œçŠ¶æ€çš„ kube-controller-manager è¿›ç¨‹ï¼›</p>

<p>å¯åŠ¨ kube-controller-manager</p>

<pre><code>systemctl daemon-reload
systemctl enable kube-controller-manager
systemctl start kube-controller-manager
systemctl status kube-controller-manager
</code></pre>

<p>æˆ‘ä»¬å¯åŠ¨æ¯ä¸ªç»„ä»¶åå¯ä»¥é€šè¿‡æ‰§è¡Œå‘½ä»¤kubectl get componentstatusesï¼Œæ¥æŸ¥çœ‹å„ä¸ªç»„ä»¶çš„çŠ¶æ€;</p>

<pre><code>$ kubectl get componentstatuses
NAME                 STATUS      MESSAGE                                                                                        ERROR
scheduler            Unhealthy   Get http://127.0.0.1:10251/healthz: dial tcp 127.0.0.1:10251: getsockopt: connection refused
controller-manager   Healthy     ok
etcd-2               Healthy     {&quot;health&quot;: &quot;true&quot;}
etcd-0               Healthy     {&quot;health&quot;: &quot;true&quot;}
etcd-1               Healthy     {&quot;health&quot;: &quot;true&quot;}
</code></pre>

<p>3ã€åˆ›å»º kube-scheduler çš„ systemd unit æ–‡ä»¶</p>

<pre><code>cat &gt; kube-scheduler.service &lt;&lt;EOF
[Unit]
Description=Kubernetes Scheduler
Documentation=https://github.com/GoogleCloudPlatform/kubernetes

[Service]
ExecStart=/usr/bin/kube-scheduler \
  --address=127.0.0.1 \
  --master=http://10.47.210.30:8080 \
  --leader-elect=true \
  --v=2
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF
</code></pre>

<p>å‚æ•°è§£æ</p>

<p>&ndash;address å€¼å¿…é¡»ä¸º 127.0.0.1ï¼Œå› ä¸ºå½“å‰ kube-apiserver æœŸæœ› scheduler å’Œ controller-manager åœ¨åŒä¸€å°æœºå™¨ï¼›</p>

<p>&ndash;master=http://{MASTER_IP}:8080ï¼šä½¿ç”¨éå®‰å…¨ 8080 ç«¯å£ä¸ kube-apiserver é€šä¿¡ï¼›</p>

<p>&ndash;leader-elect=true éƒ¨ç½²å¤šå°æœºå™¨ç»„æˆçš„ master é›†ç¾¤æ—¶é€‰ä¸¾äº§ç”Ÿä¸€å¤„äºå·¥ä½œçŠ¶æ€çš„ kube-controller-manager è¿›ç¨‹ï¼›</p>

<p>å¯åŠ¨</p>

<pre><code>systemctl daemon-reload
systemctl enable kube-scheduler
systemctl start kube-scheduler
systemctl status kube-scheduler
</code></pre>

<p>éªŒè¯ master èŠ‚ç‚¹åŠŸèƒ½</p>

<pre><code>$ kubectl get componentstatuses
NAME                 STATUS    MESSAGE              ERROR
controller-manager   Healthy   ok
scheduler            Healthy   ok
etcd-0               Healthy   {&quot;health&quot;: &quot;true&quot;}
etcd-1               Healthy   {&quot;health&quot;: &quot;true&quot;}
etcd-2               Healthy   {&quot;health&quot;: &quot;true&quot;}
</code></pre>

<blockquote>
<p>nodeéƒ¨ç½²</p>
</blockquote>

<p>éƒ¨ç½²æœºå™¨</p>

<pre><code>10.47.210.30
10.47.210.31
10.47.210.94
</code></pre>

<p>éƒ¨ç½²ç»„ä»¶</p>

<pre><code>flannel
docker
kubelet
kube-proxy
</code></pre>

<p>1ã€flannel</p>

<p>1.å®‰è£…äºŒè¿›åˆ¶æ–‡ä»¶</p>

<p>Flannelæ˜¯ä½œä¸ºä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶çš„æ–¹å¼éƒ¨ç½²åœ¨æ¯ä¸ªnodeä¸Šï¼Œä¸»è¦å®ç°ä¸¤ä¸ªåŠŸèƒ½ï¼š</p>

<pre><code>1.ä¸ºæ¯ä¸ªnodeåˆ†é…subnetï¼Œå®¹å™¨å°†è‡ªåŠ¨ä»è¯¥å­ç½‘ä¸­è·å–IPåœ°å€

2.å½“æœ‰nodeåŠ å…¥åˆ°ç½‘ç»œä¸­æ—¶ï¼Œä¸ºæ¯ä¸ªnodeå¢åŠ è·¯ç”±é…ç½®
</code></pre>

<p>ç›®å‰ä½¿ç”¨ç‰ˆæœ¬é»˜è®¤å®‰è£…çš„æ˜¯0.7.1ç‰ˆæœ¬çš„flannelã€‚</p>

<pre><code>wget  https://github.com/coreos/flannel/releases/download/v0.7.1/flannel-v0.7.1-linux-amd64.tar.gz
</code></pre>

<p>æˆ‘æ²¡æœ‰ä¸‹è½½ä¸‹æ¥ï¼Œç›´æ¥githubä¸‹è½½</p>

<p>è§£å‹è®¾ç½®ç¯å¢ƒå˜é‡</p>

<pre><code>tar -zxvf flannel-v0.7.1-linux-amd64.tar.gz
echo 'export PATH=/home/flannel:$PATH' &gt;&gt; /etc/profile
source /etc/profile
</code></pre>

<p>æˆ–è€…æŠŠäºŒè¿›åˆ¶æ–‡ä»¶ç§»åˆ°ç³»ç»Ÿè·¯å¾„ä¸‹ï¼Œæ¯”å¦‚/usr/local/src</p>

<p>2.åˆ›å»ºcaè¯ä¹¦</p>

<pre><code>cat &gt; flanneld-csr.json &lt;&lt;EOF
{
  &quot;CN&quot;: &quot;flanneld&quot;,
  &quot;hosts&quot;: [],
  &quot;key&quot;: {
    &quot;algo&quot;: &quot;rsa&quot;,
    &quot;size&quot;: 2048
  },
  &quot;names&quot;: [
    {
      &quot;C&quot;: &quot;CN&quot;,
      &quot;ST&quot;: &quot;BeiJing&quot;,
      &quot;L&quot;: &quot;BeiJing&quot;,
      &quot;O&quot;: &quot;k8s&quot;,
      &quot;OU&quot;: &quot;System&quot;
    }
  ]
}
EOF
</code></pre>

<p>ç”Ÿæˆ flanneld è¯ä¹¦å’Œç§é’¥ï¼š</p>

<pre><code>$ cfssl gencert -ca=/home/ssl/ca.pem \
  -ca-key=/home/ssl/ca-key.pem \
  -config=/home/ssl/ca-config.json \
  -profile=kubernetes flanneld-csr.json | cfssljson -bare flanneld
</code></pre>

<p>æ‹·è´åˆ°æ‰€æœ‰ä¸»æœº</p>

<p>å‘ etcd å†™å…¥é›†ç¾¤ Pod ç½‘æ®µä¿¡æ¯</p>

<pre><code>etcdctl \
  --endpoints=https://10.47.210.30:2379,https://10.47.210.31:2379,https://10.47.210.94:2379 \
  --ca-file=/root/ssl/ca.pem \
  --cert-file=/root/ssl/flanneld.pem \
  --key-file=/root/ssl/flanneld-key.pem \
  set /kubernetes/network/config '{&quot;Network&quot;:&quot;'172.30.0.0/16'&quot;, &quot;SubnetLen&quot;: 24, &quot;Backend&quot;: {&quot;Type&quot;: &quot;vxlan&quot;}}'
</code></pre>

<p>å†™å…¥çš„ Pod ç½‘æ®µ(${CLUSTER_CIDR}ï¼Œ172.30.0.0/16) å¿…é¡»ä¸ kube-controller-manager çš„ &ndash;cluster-cidr é€‰é¡¹å€¼ä¸€è‡´ï¼›</p>

<p>ä¹Ÿå¯ä»¥è¿™æ ·å†™</p>

<pre><code>etcdctl --endpoints=https://192.168.56.107:2379,https://192.168.56.106:2379,https://192.168.56.105:2379 \
  --ca-file=/home/ssl/ca.pem \
  --cert-file=/home/ssl/kubernetes.pem \
  --key-file=/home/ssl/kubernetes-key.pem \
  mkdir /kubernetes/network
etcdctl --endpoints=https://192.168.56.107:2379,https://192.168.56.106:2379,https://192.168.56.105:2379 \
  --ca-file=/home/ssl/ca.pem \
  --cert-file=/home/ssl/kubernetes.pem \
  --key-file=/home/ssl/kubernetes-key.pem \
  mk /kubernetes/network/config '{&quot;Network&quot;:&quot;172.30.0.0/16&quot;,&quot;SubnetLen&quot;:24,&quot;Backend&quot;:{&quot;Type&quot;:&quot;vxlan&quot;}}'
</code></pre>

<p>å¦‚æœä½ è¦ä½¿ç”¨host-gwæ¨¡å¼ï¼Œå¯ä»¥ç›´æ¥å°†vxlanæ”¹æˆhost-gwå³å¯</p>

<p>åˆ›å»º flanneld çš„ systemd unit æ–‡ä»¶</p>

<p>ç›®å½•</p>

<pre><code>/usr/lib/systemd/system



cat &gt; flanneld.service &lt;&lt; EOF
[Unit]
Description=Flanneld overlay address etcd agent
After=network.target
After=network-online.target
Wants=network-online.target
After=etcd.service
Before=docker.service

[Service]
Type=notify
ExecStart=/usr/bin/flanneld \\
  -etcd-cafile=/root/ssl/ca.pem \\
  -etcd-certfile=/root/ssl/flanneld.pem \\
  -etcd-keyfile=/root/ssl/flanneld-key.pem \\
  -etcd-endpoints=https://10.47.210.30:2379,https://10.47.210.31:2379,https://10.47.210.94:2379 \
  -etcd-prefix=/kubernetes/network \\
  -iface=eth0
ExecStartPost=/root/flannel/mk-docker-opts.sh -k DOCKER_NETWORK_OPTIONS -d /run/flannel/docker
Restart=on-failure

[Install]
WantedBy=multi-user.target
RequiredBy=docker.service
EOF
</code></pre>

<p>åœ¨å‚æ•°æœ€åæœ‰ç©ºæ ¼ä¹Ÿä¼šå¯¼è‡´å¯åŠ¨å¤±è´¥</p>

<p>etcdé›†ç¾¤å¯åŠ¨äº†åŒå‘tlsè®¤è¯ï¼Œæ‰€ä»¥éœ€è¦ä¸ºflanneldæŒ‡å®šä¸etcdé›†ç¾¤é€šä¿¡çš„caå’Œå¯†é’¥</p>

<p>mk-docker-opts.shè„šæœ¬å°†åˆ†é…ç»™flanneldçš„podå­ç½‘ç½‘æ®µä¿¡æ¯å†™å…¥åˆ°/run/flannel/dockeræ–‡ä»¶ä¸­ï¼Œåç»­dockerå¯åŠ¨æ—¶ä½¿ç”¨è¿™ä¸ªæ–‡ä»¶ä¸­å‚æ•°å€¼è®¾ç½®ä¸ºdocker0çš„ç½‘æ¡¥</p>

<p>-iface é€‰é¡¹æŒ‡å®šflanneldå’Œå…¶ä»–nodeé€šä¿¡çš„æ¥å£ï¼Œå¦‚æœæœºå™¨æœ‰å†…å¤–ç½‘ï¼Œåˆ™æœ€å¥½æŒ‡å®šä¸ºå†…ç½‘æ¥å£</p>

<p>4.åŠ è½½serviceï¼Œå¯åŠ¨</p>

<pre><code>systemctl daemon-reload
systemctl enable flanneld
systemctl start flanneld
systemctl status flanneld
</code></pre>

<p>æ£€æŸ¥ flanneld æœåŠ¡</p>

<pre><code>$ journalctl  -u flanneld |grep 'Lease acquired'
$ ifconfig flannel.1
</code></pre>

<p>æŸ¥çœ‹é›†ç¾¤ Pod ç½‘æ®µ(/16)</p>

<pre><code>$ /root/local/bin/etcdctl \
  --endpoints=${ETCD_ENDPOINTS} \
  --ca-file=/etc/kubernetes/ssl/ca.pem \
  --cert-file=/etc/flanneld/ssl/flanneld.pem \
  --key-file=/etc/flanneld/ssl/flanneld-key.pem \
  get ${FLANNEL_ETCD_PREFIX}/config
{ &quot;Network&quot;: &quot;172.30.0.0/16&quot;, &quot;SubnetLen&quot;: 24, &quot;Backend&quot;: { &quot;Type&quot;: &quot;vxlan&quot; } }
</code></pre>

<p>æŸ¥çœ‹å·²åˆ†é…çš„ Pod å­ç½‘æ®µåˆ—è¡¨(/24)</p>

<pre><code>$ /root/local/bin/etcdctl \
  --endpoints=${ETCD_ENDPOINTS} \
  --ca-file=/etc/kubernetes/ssl/ca.pem \
  --cert-file=/etc/flanneld/ssl/flanneld.pem \
  --key-file=/etc/flanneld/ssl/flanneld-key.pem \
  ls ${FLANNEL_ETCD_PREFIX}/subnets
/kubernetes/network/subnets/172.30.19.0-24
</code></pre>

<p>æŸ¥çœ‹æŸä¸€ Pod ç½‘æ®µå¯¹åº”çš„ flanneld è¿›ç¨‹ç›‘å¬çš„ IP å’Œç½‘ç»œå‚æ•°</p>

<pre><code>$ /root/local/bin/etcdctl \
  --endpoints=${ETCD_ENDPOINTS} \
  --ca-file=/etc/kubernetes/ssl/ca.pem \
  --cert-file=/etc/flanneld/ssl/flanneld.pem \
  --key-file=/etc/flanneld/ssl/flanneld-key.pem \
  get ${FLANNEL_ETCD_PREFIX}/subnets/172.30.19.0-24
{&quot;PublicIP&quot;:&quot;10.64.3.7&quot;,&quot;BackendType&quot;:&quot;vxlan&quot;,&quot;BackendData&quot;:{&quot;VtepMAC&quot;:&quot;d6:51:2e:80:5c:69&quot;}}
</code></pre>

<p>ç¡®ä¿å„èŠ‚ç‚¹é—´ Pod ç½‘æ®µèƒ½äº’è”äº’é€š</p>

<p>åœ¨å„èŠ‚ç‚¹ä¸Šéƒ¨ç½²å®Œ Flannel åï¼ŒæŸ¥çœ‹å·²åˆ†é…çš„ Pod å­ç½‘æ®µåˆ—è¡¨(/24)</p>

<pre><code>etcdctl \
  --endpoints=https://192.168.56.107:2379,https://192.168.56.106:2379,https://192.168.56.105:2379 \
  --ca-file=/home/ssl/ca.pem \
  --cert-file=/home/ssl/kubernetes.pem \
  --key-file=/home/ssl/kubernetes-key.pem \
  ls /kubernetes/network/subnets
/kubernetes/network/subnets/172.30.19.0-24
/kubernetes/network/subnets/172.30.20.0-24
/kubernetes/network/subnets/172.30.21.0-24
</code></pre>

<p>å½“å‰ä¸‰ä¸ªèŠ‚ç‚¹åˆ†é…çš„ Pod ç½‘æ®µåˆ†åˆ«æ˜¯ï¼š172.30.19.0-24ã€172.30.20.0-24ã€172.30.21.0-24ã€‚</p>

<p>åœ¨å„èŠ‚ç‚¹ä¸Šåˆ†é… ping è¿™ä¸‰ä¸ªç½‘æ®µçš„ç½‘å…³åœ°å€ï¼Œç¡®ä¿èƒ½é€šï¼š</p>

<pre><code>$ ping 172.30.19.1
$ ping 172.30.20.2
$ ping 172.30.21.3
</code></pre>

<p>3ã€docker</p>

<p>å®‰è£…å’Œé…ç½® docker</p>

<p>ä¸‹è½½æœ€æ–°çš„ docker äºŒè¿›åˆ¶æ–‡ä»¶</p>

<pre><code>$ wget https://get.docker.com/builds/Linux/x86_64/docker-17.04.0-ce.tgz
$ tar -xvf docker-17.04.0-ce.tgz
$ cp docker/docker* /root/local/bin
$ cp docker/completion/bash/docker /etc/bash_completion.d/
</code></pre>

<p>åˆ›å»º docker çš„ systemd unit æ–‡ä»¶</p>

<pre><code>cat &gt; docker.service &lt;&lt; EOF
[Unit]
Description=Docker Application Container Engine
Documentation=http://docs.docker.io

[Service]
Environment=&quot;PATH=/root/local/bin:/bin:/sbin:/usr/bin:/usr/sbin&quot;
EnvironmentFile=-/run/flannel/docker
ExecStart=/usr/bin/dockerd --log-level=error $DOCKER_NETWORK_OPTIONS
ExecReload=/bin/kill -s HUP $MAINPID
Restart=on-failure
RestartSec=5
LimitNOFILE=infinity
LimitNPROC=infinity
LimitCORE=infinity
Delegate=yes
KillMode=process

[Install]
WantedBy=multi-user.target
EOF
</code></pre>

<p>dockerd è¿è¡Œæ—¶ä¼šè°ƒç”¨å…¶å®ƒ docker å‘½ä»¤ï¼Œå¦‚ docker-proxyï¼Œæ‰€ä»¥éœ€è¦å°† docker å‘½ä»¤æ‰€åœ¨çš„ç›®å½•åŠ åˆ° PATH ç¯å¢ƒå˜é‡ä¸­ï¼›</p>

<p>flanneld å¯åŠ¨æ—¶å°†ç½‘ç»œé…ç½®å†™å…¥åˆ° /run/flannel/docker æ–‡ä»¶ä¸­çš„å˜é‡ DOCKER_NETWORK_OPTIONSï¼Œdockerd å‘½ä»¤è¡Œä¸ŠæŒ‡å®šè¯¥å˜é‡å€¼æ¥è®¾ç½® docker0 ç½‘æ¡¥å‚æ•°ï¼›</p>

<p>å¦‚æœæŒ‡å®šäº†å¤šä¸ª EnvironmentFile é€‰é¡¹ï¼Œåˆ™å¿…é¡»å°† /run/flannel/docker æ”¾åœ¨æœ€å(ç¡®ä¿ docker0 ä½¿ç”¨ flanneld ç”Ÿæˆçš„ bip å‚æ•°)ï¼›</p>

<p>ä¸èƒ½å…³é—­é»˜è®¤å¼€å¯çš„ &ndash;iptables å’Œ &ndash;ip-masq é€‰é¡¹ï¼›</p>

<p>å¦‚æœå†…æ ¸ç‰ˆæœ¬æ¯”è¾ƒæ–°ï¼Œå»ºè®®ä½¿ç”¨ overlay å­˜å‚¨é©±åŠ¨ï¼›</p>

<p>docker ä» 1.13 ç‰ˆæœ¬å¼€å§‹ï¼Œå¯èƒ½å°† iptables FORWARD chainçš„é»˜è®¤ç­–ç•¥è®¾ç½®ä¸ºDROPï¼Œä»è€Œå¯¼è‡´ ping å…¶å®ƒ Node ä¸Šçš„ Pod IP å¤±è´¥ï¼Œé‡åˆ°è¿™ç§æƒ…å†µæ—¶ï¼Œéœ€è¦æ‰‹åŠ¨è®¾ç½®ç­–ç•¥ä¸º ACCEPTï¼š</p>

<pre><code>$ sudo iptables -P FORWARD ACCEPT
$
</code></pre>

<p>å¹¶ä¸”æŠŠä»¥ä¸‹å‘½ä»¤å†™å…¥/etc/rc.localæ–‡ä»¶ä¸­ï¼Œé˜²æ­¢èŠ‚ç‚¹é‡å¯iptables FORWARD chainçš„é»˜è®¤ç­–ç•¥åˆè¿˜åŸä¸ºDROP</p>

<pre><code>sleep 60 &amp;&amp; /sbin/iptables -P FORWARD ACCEPT
</code></pre>

<p>ä¸ºäº†åŠ å¿« pull image çš„é€Ÿåº¦ï¼Œå¯ä»¥ä½¿ç”¨å›½å†…çš„ä»“åº“é•œåƒæœåŠ¡å™¨ï¼ŒåŒæ—¶å¢åŠ ä¸‹è½½çš„å¹¶å‘æ•°ã€‚(å¦‚æœ dockerd å·²ç»è¿è¡Œï¼Œåˆ™éœ€è¦é‡å¯ dockerd ç”Ÿæ•ˆã€‚)</p>

<pre><code>  $ cat /etc/docker/daemon.json
  {
    &quot;registry-mirrors&quot;: [&quot;https://docker.mirrors.ustc.edu.cn&quot;, &quot;hub-mirror.c.163.com&quot;],
    &quot;max-concurrent-downloads&quot;: 10
  }
</code></pre>

<p>å¯åŠ¨</p>

<pre><code>systemctl daemon-reload
systemctl stop firewalld
systemctl disable firewalld
iptables -F &amp;&amp; sudo iptables -X &amp;&amp; sudo iptables -F -t nat &amp;&amp; sudo iptables -X -t nat
systemctl enable docker
systemctl start docker
</code></pre>

<p>å¦‚æœæŒ‡å®šäº†å¤šä¸ª EnvironmentFile é€‰é¡¹ï¼Œåˆ™å¿…é¡»å°† /run/flannel/docker æ”¾åœ¨æœ€å(ç¡®ä¿ docker0 ä½¿ç”¨ flanneld ç”Ÿæˆçš„ bip å‚æ•°)ï¼›</p>

<p>4ã€kubelet</p>

<p>kubelet å¯åŠ¨æ—¶å‘ kube-apiserver å‘é€ TLS bootstrapping è¯·æ±‚ï¼Œéœ€è¦å…ˆå°† bootstrap token æ–‡ä»¶ä¸­çš„ kubelet-bootstrap ç”¨æˆ·èµ‹äºˆ system:node-bootstrapper è§’è‰²ï¼Œç„¶å kubelet æ‰æœ‰æƒé™åˆ›å»ºè®¤è¯è¯·æ±‚(certificatesigningrequests)ï¼š</p>

<pre><code>$ kubectl create clusterrolebinding kubelet-bootstrap --clusterrole=system:node-bootstrapper --user=kubelet-bootstrap
$
</code></pre>

<p>&ndash;user=kubelet-bootstrap æ˜¯æ–‡ä»¶ /etc/kubernetes/token.csv ä¸­æŒ‡å®šçš„ç”¨æˆ·åï¼ŒåŒæ—¶ä¹Ÿå†™å…¥äº†æ–‡ä»¶ /etc/kubernetes/bootstrap.kubeconfigï¼›</p>

<p>ä¸‹è½½æœ€æ–°çš„ kubelet å’Œ kube-proxy äºŒè¿›åˆ¶æ–‡ä»¶</p>

<pre><code>$ wget https://dl.k8s.io/v1.6.2/kubernetes-server-linux-amd64.tar.gz
$ tar -xzvf kubernetes-server-linux-amd64.tar.gz
$ cd kubernetes
$ tar -xzvf  kubernetes-src.tar.gz
$ sudo cp -r ./server/bin/{kube-proxy,kubelet} /root/local/bin/
</code></pre>

<p>åˆ›å»º kubelet çš„ systemd unit æ–‡ä»¶</p>

<pre><code>$ sudo mkdir /var/lib/kubelet # å¿…é¡»å…ˆåˆ›å»ºå·¥ä½œç›®å½•


cat &gt; kubelet.service &lt;&lt;EOF
[Unit]
Description=Kubernetes Kubelet
Documentation=https://github.com/GoogleCloudPlatform/kubernetes
After=docker.service
Requires=docker.service

[Service]
WorkingDirectory=/var/lib/kubelet
ExecStart=/usr/bin/kubelet \\
  --address=10.47.210.30 \\
  --hostname-override=10.47.210.30 \\
  --pod-infra-container-image=registry.access.redhat.com/rhel7/pod-infrastructure:latest \\
  --bootstrap-kubeconfig=/etc/kubernetes/bootstrap.kubeconfig \\
  --kubeconfig=/etc/kubernetes/kubelet.kubeconfig \\
  --cert-dir=/root/ssl \\
  --cluster-dns=10.254.0.2 \\
  --cluster-domain=cluster.local. \\
  --hairpin-mode promiscuous-bridge \\
  --allow-privileged=true \\
  --serialize-image-pulls=false \\
  --logtostderr=true \\
  --runtime-cgroups=/systemd/system.slice \\
  --kubelet-cgroups=/systemd/system.slice \\
  --v=2
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF

ExecStartPost=/sbin/iptables -A INPUT -s 10.0.0.0/8 -p tcp --dport 4194 -j ACCEPT
ExecStartPost=/sbin/iptables -A INPUT -s 172.16.0.0/12 -p tcp --dport 4194 -j ACCEPT
ExecStartPost=/sbin/iptables -A INPUT -s 192.168.0.0/16 -p tcp --dport 4194 -j ACCEPT
ExecStartPost=/sbin/iptables -A INPUT -p tcp --dport 4194 -j DROP
</code></pre>

<p>å‚æ•°è§£æ</p>

<p>&ndash;address ä¸èƒ½è®¾ç½®ä¸º 127.0.0.1ï¼Œå¦åˆ™åç»­ Pods è®¿é—® kubelet çš„ API æ¥å£æ—¶ä¼šå¤±è´¥ï¼Œå› ä¸º Pods è®¿é—®çš„ 127.0.0.1 æŒ‡å‘è‡ªå·±è€Œä¸æ˜¯ kubeletï¼›</p>

<p>å¦‚æœè®¾ç½®äº† &ndash;hostname-override é€‰é¡¹ï¼Œåˆ™ kube-proxy ä¹Ÿéœ€è¦è®¾ç½®è¯¥é€‰é¡¹ï¼Œå¦åˆ™ä¼šå‡ºç°æ‰¾ä¸åˆ° Node çš„æƒ…å†µï¼›</p>

<p>&ndash;experimental-bootstrap-kubeconfig æŒ‡å‘ bootstrap kubeconfig æ–‡ä»¶ï¼Œkubelet ä½¿ç”¨è¯¥æ–‡ä»¶ä¸­çš„ç”¨æˆ·åå’Œ token å‘ kube-apiserver å‘é€ TLS Bootstrapping è¯·æ±‚ï¼›</p>

<p>ç®¡ç†å‘˜é€šè¿‡äº† CSR è¯·æ±‚åï¼Œkubelet è‡ªåŠ¨åœ¨ &ndash;cert-dir ç›®å½•åˆ›å»ºè¯ä¹¦å’Œç§é’¥æ–‡ä»¶(kubelet-client.crt å’Œ kubelet-client.key)ï¼Œç„¶åå†™å…¥ &ndash;kubeconfig æ–‡ä»¶ï¼›</p>

<p>å»ºè®®åœ¨ &ndash;kubeconfig é…ç½®æ–‡ä»¶ä¸­æŒ‡å®š kube-apiserver åœ°å€ï¼Œå¦‚æœæœªæŒ‡å®š &ndash;api-servers é€‰é¡¹ï¼Œåˆ™å¿…é¡»æŒ‡å®š &ndash;require-kubeconfig é€‰é¡¹åæ‰ä»é…ç½®æ–‡ä»¶ä¸­è¯»å– kube-apiserver çš„åœ°å€ï¼Œå¦åˆ™ kubelet å¯åŠ¨åå°†æ‰¾ä¸åˆ° kube-apiserver (æ—¥å¿—ä¸­æç¤ºæœªæ‰¾åˆ° API Serverï¼‰ï¼Œkubectl get nodes ä¸ä¼šè¿”å›å¯¹åº”çš„ Node ä¿¡æ¯;1.14ä¸å†æ”¯æŒrequire-kubeconfigé€‰é¡¹</p>

<p>&ndash;cluster-dns æŒ‡å®š kubedns çš„ Service IP(å¯ä»¥å…ˆåˆ†é…ï¼Œåç»­åˆ›å»º kubedns æœåŠ¡æ—¶æŒ‡å®šè¯¥ IP)ï¼Œ&ndash;cluster-domain æŒ‡å®šåŸŸååç¼€ï¼Œè¿™ä¸¤ä¸ªå‚æ•°åŒæ—¶æŒ‡å®šåæ‰ä¼šç”Ÿæ•ˆï¼›</p>

<p>å¯¹äºkuberentes1.8é›†ç¾¤ä¸­çš„kubeleté…ç½®ï¼Œå–æ¶ˆäº†KUBELET_API_SERVERçš„é…ç½®ï¼Œè€Œæ”¹ç”¨kubeconfigæ–‡ä»¶æ¥å®šä¹‰masteråœ°å€ï¼Œæ‰€ä»¥è¯·æ³¨é‡Šæ‰&ndash;api-servers=<a href="http://172.20.0.113:8080é…ç½®ã€‚">http://172.20.0.113:8080é…ç½®ã€‚</a></p>

<p>å¦‚æœä½¿ç”¨systemdæ–¹å¼å¯åŠ¨ï¼Œåˆ™éœ€è¦é¢å¤–å¢åŠ ä¸¤ä¸ªå‚æ•°&ndash;runtime-cgroups=/systemd/system.slice &ndash;kubelet-cgroups=/systemd/system.sliceï¼Œ1.14ä¸åŠ ä¹Ÿå¯ä»¥</p>

<p>&ndash;experimental-bootstrap-kubeconfig åœ¨1.9ç‰ˆæœ¬å·²ç»å˜æˆäº†&ndash;bootstrap-kubeconfig</p>

<p>&rdquo;&ndash;cgroup-driver é…ç½®æˆ systemdï¼Œä¸è¦ä½¿ç”¨cgroupï¼Œå¦åˆ™åœ¨ CentOS ç³»ç»Ÿä¸­ kubelet å°†å¯åŠ¨å¤±è´¥ï¼ˆä¿æŒdockerå’Œkubeletä¸­çš„cgroup driveré…ç½®ä¸€è‡´å³å¯ï¼Œä¸ä¸€å®šéä½¿ç”¨systemdï¼‰ã€‚</p>

<p>&ndash;cluster-domain æŒ‡å®š pod å¯åŠ¨æ—¶ /etc/resolve.conf æ–‡ä»¶ä¸­çš„ search domain ï¼Œèµ·åˆæˆ‘ä»¬å°†å…¶é…ç½®æˆäº† cluster.local.ï¼Œè¿™æ ·åœ¨è§£æ service çš„ DNS åç§°æ—¶æ˜¯æ­£å¸¸çš„ï¼Œå¯æ˜¯åœ¨è§£æ headless service ä¸­çš„ FQDN pod name çš„æ—¶å€™å´é”™è¯¯ï¼Œå› æ­¤æˆ‘ä»¬å°†å…¶ä¿®æ”¹ä¸º cluster.localï¼Œå»æ‰å˜´åé¢çš„ â€ç‚¹å·â€œ å°±å¯ä»¥è§£å†³è¯¥é—®é¢˜ï¼Œå…³äº kubernetes ä¸­çš„åŸŸå/æœåŠ¡åç§°è§£æè¯·å‚è§æˆ‘çš„å¦ä¸€ç¯‡æ–‡ç« ã€‚</p>

<p>&ndash;kubeconfig=/etc/kubernetes/kubelet.kubeconfigä¸­æŒ‡å®šçš„kubelet.kubeconfigæ–‡ä»¶åœ¨ç¬¬ä¸€æ¬¡å¯åŠ¨kubeletä¹‹å‰å¹¶ä¸å­˜åœ¨ï¼Œè¯·çœ‹ä¸‹æ–‡ï¼Œå½“é€šè¿‡CSRè¯·æ±‚åä¼šè‡ªåŠ¨ç”Ÿæˆkubelet.kubeconfigæ–‡ä»¶ï¼Œå¦‚æœä½ çš„èŠ‚ç‚¹ä¸Šå·²ç»ç”Ÿæˆäº†~/.kube/configæ–‡ä»¶ï¼Œä½ å¯ä»¥å°†è¯¥æ–‡ä»¶æ‹·è´åˆ°è¯¥è·¯å¾„ä¸‹ï¼Œå¹¶é‡å‘½åä¸ºkubelet.kubeconfigï¼Œæ‰€æœ‰nodeèŠ‚ç‚¹å¯ä»¥å…±ç”¨åŒä¸€ä¸ªkubelet.kubeconfigæ–‡ä»¶ï¼Œè¿™æ ·æ–°æ·»åŠ çš„èŠ‚ç‚¹å°±ä¸éœ€è¦å†åˆ›å»ºCSRè¯·æ±‚å°±èƒ½è‡ªåŠ¨æ·»åŠ åˆ°kubernetesé›†ç¾¤ä¸­ã€‚åŒæ ·ï¼Œåœ¨ä»»æ„èƒ½å¤Ÿè®¿é—®åˆ°kubernetesé›†ç¾¤çš„ä¸»æœºä¸Šä½¿ç”¨kubectl &ndash;kubeconfigå‘½ä»¤æ“ä½œé›†ç¾¤æ—¶ï¼Œåªè¦ä½¿ç”¨~/.kube/configæ–‡ä»¶å°±å¯ä»¥é€šè¿‡æƒé™è®¤è¯ï¼Œå› ä¸ºè¿™é‡Œé¢å·²ç»æœ‰è®¤è¯ä¿¡æ¯å¹¶è®¤ä¸ºä½ æ˜¯adminç”¨æˆ·ï¼Œå¯¹é›†ç¾¤æ‹¥æœ‰æ‰€æœ‰æƒé™ã€‚</p>

<p>KUBELET_POD_INFRA_CONTAINER æ˜¯åŸºç¡€é•œåƒå®¹å™¨ï¼Œè¿™é‡Œæˆ‘ç”¨çš„æ˜¯ç§æœ‰é•œåƒä»“åº“åœ°å€ï¼Œå¤§å®¶éƒ¨ç½²çš„æ—¶å€™éœ€è¦ä¿®æ”¹ä¸ºè‡ªå·±çš„é•œåƒã€‚æˆ‘ä¸Šä¼ äº†ä¸€ä¸ªåˆ°æ—¶é€Ÿäº‘ä¸Šï¼Œå¯ä»¥ç›´æ¥ docker pull index.tenxcloud.com/jimmy/pod-infrastructure ä¸‹è½½ã€‚pod-infrastructureé•œåƒæ˜¯Redhatåˆ¶ä½œçš„ï¼Œå¤§å°æ¥è¿‘80Mï¼Œä¸‹è½½æ¯”è¾ƒè€—æ—¶ï¼Œå…¶å®è¯¥é•œåƒå¹¶ä¸è¿è¡Œä»€ä¹ˆå…·ä½“è¿›ç¨‹ï¼Œå¯ä»¥ä½¿ç”¨Googleçš„pauseé•œåƒgcr.io/google_containers/pause-amd64:3.0ï¼Œè¿™ä¸ªé•œåƒåªæœ‰300å¤šKï¼Œæˆ–è€…é€šè¿‡DockerHubä¸‹è½½jimmysong/pause-amd64:3.0ã€‚</p>

<p>kubelet cAdvisor é»˜è®¤åœ¨æ‰€æœ‰æ¥å£ç›‘å¬ 4194 ç«¯å£çš„è¯·æ±‚ï¼Œå¯¹äºæœ‰å¤–ç½‘çš„æœºå™¨æ¥è¯´ä¸å®‰å…¨ï¼ŒExecStartPost é€‰é¡¹æŒ‡å®šçš„ iptables è§„åˆ™åªå…è®¸å†…ç½‘æœºå™¨è®¿é—® 4194 ç«¯å£ï¼›</p>

<p>ä¸æ”¯æŒ</p>

<p>å¯åŠ¨é”™è¯¯</p>

<p>1.é‡åˆ°kubeletæŠ¥é”™ï¼Œè¯¥æœåŠ¡æ¯æ²¡éš”å‡ ç§’é‡å¯ä¸€ä¸‹ï¼Œç„¶åè‡ªåŠ¨åœæ­¢ã€‚æ—¥å¿—æç¤ºä¿¡æ¯ä¸­æœ‰ä¸€è¡Œï¼šcontainer_manager_linux.go:205] Running with swap on is not supported, please disable swap! This will be a fatal error by default starting in K8s v1.6!ã€‚å°è¯•å…³é—­swapå†è¯•ï¼Œè™½ç„¶æ—¥å¿—ä¸­æ²¡æœ‰è¯¥æç¤ºä¿¡æ¯äº†ï¼Œ</p>

<p>ä¸€ã€ä¸é‡å¯ç”µè„‘ï¼Œç¦ç”¨å¯ç”¨swapï¼Œç«‹åˆ»ç”Ÿæ•ˆ</p>

<p>1ã€ç¦ç”¨å‘½ä»¤</p>

<pre><code>sudo swapoff -a
</code></pre>

<p>2ã€å¯ç”¨å‘½ä»¤</p>

<pre><code>sudo swapon -a
</code></pre>

<p>3ã€æŸ¥çœ‹äº¤æ¢åˆ†åŒºçš„çŠ¶æ€</p>

<pre><code>sudo free -m
</code></pre>

<p>äºŒã€é‡æ–°å¯åŠ¨ç”µè„‘ï¼Œæ°¸ä¹…ç¦ç”¨Swap</p>

<p>1ã€æŠŠæ ¹ç›®å½•æ–‡ä»¶ç³»ç»Ÿè®¾ä¸ºå¯è¯»å†™</p>

<pre><code>sudo mount -n -o remount,rw /
</code></pre>

<p>2ã€ç”¨viä¿®æ”¹/etc/fstabæ–‡ä»¶ï¼Œåœ¨swapåˆ†åŒºè¿™è¡Œå‰åŠ  # ç¦ç”¨æ‰ï¼Œä¿å­˜é€€å‡º</p>

<pre><code>vi /etc/fstab

i      #è¿›å…¥insert æ’å…¥æ¨¡å¼

:wq   #ä¿å­˜é€€å‡º
</code></pre>

<p>3ã€é‡æ–°å¯åŠ¨ç”µè„‘ï¼Œä½¿ç”¨free -mæŸ¥çœ‹åˆ†åŒºçŠ¶æ€</p>

<pre><code>reboot

sudo free -m
</code></pre>

<p>ç›¸å¯¹äºkubernetes1.6é›†ç¾¤å¿…é¡»è¿›è¡Œçš„é…ç½®æœ‰ï¼š</p>

<p>å¯¹äºkuberentes1.8é›†ç¾¤ï¼Œå¿…é¡»å…³é—­swapï¼Œå¦åˆ™kubeletå¯åŠ¨å°†å¤±è´¥ã€‚</p>

<p>ä¿®æ”¹/etc/fstabå°†ï¼Œswapç³»ç»Ÿæ³¨é‡Šæ‰ã€‚</p>

<p>2.failed to run Kubelet: failed to create kubelet: misconfiguration: kubelet cgroup driver: &ldquo;cgroupfs&rdquo;</p>

<p>ä¿®æ”¹dockerçš„cgroupé©±åŠ¨</p>

<pre><code>vim /lib/systemd/system/docker.service
# å°† --exec-opt native.cgroupdriver=systemd  ä¿®æ”¹ä¸ºï¼š
#  --exec-opt native.cgroupdriver=cgroupfs
# systemctl daemon-reload 
# systemctl restart docker.service
# kubeletæ˜¾ç¤ºæ­£å¸¸
</code></pre>

<p>3.é‡å¯äº†dockeråè¿˜è¦é‡å¯kubeletï¼Œè¿™æ—¶åˆé‡åˆ°é—®é¢˜ï¼Œkubeletå¯åŠ¨å¤±è´¥ã€‚æŠ¥é”™ï¼š</p>

<pre><code>Mar 31 16:44:41 sz-pg-oam-docker-test-002.tendcloud.com kubelet[81047]: error: failed to run Kubelet: failed to create kubelet: misconfiguration: kubelet cgroup driver: &quot;cgroupfs&quot; is different from docker cgroup driver: &quot;systemd&quot;
è¿™æ˜¯kubeletä¸dockerçš„cgroup driverä¸ä¸€è‡´å¯¼è‡´çš„ï¼Œkubeletå¯åŠ¨çš„æ—¶å€™æœ‰ä¸ªâ€”cgroup-driverå‚æ•°å¯ä»¥æŒ‡å®šä¸º&quot;cgroupfs&quot;æˆ–è€…â€œsystemdâ€ã€‚

--cgroup-driver string                                    Driver that the kubelet uses to manipulate cgroups on the host.  Possible values: 'cgroupfs', 'systemd' (default &quot;cgroupfs&quot;)
é…ç½®dockerçš„serviceé…ç½®æ–‡ä»¶/usr/lib/systemd/system/docker.serviceï¼Œè®¾ç½®ExecStartä¸­çš„--exec-opt native.cgroupdriver=systemdã€‚
</code></pre>

<p>å¯åŠ¨</p>

<pre><code>systemctl daemon-reload
systemctl enable kubelet
systemctl start kubelet
systemctl status kubelet
</code></pre>

<p>é€šè¿‡ kubelet çš„ TLS è¯ä¹¦è¯·æ±‚</p>

<p>kubelet é¦–æ¬¡å¯åŠ¨æ—¶å‘ kube-apiserver å‘é€è¯ä¹¦ç­¾åè¯·æ±‚ï¼Œå¿…é¡»é€šè¿‡å kubernetes ç³»ç»Ÿæ‰ä¼šå°†è¯¥ Node åŠ å…¥åˆ°é›†ç¾¤ã€‚</p>

<p>æŸ¥çœ‹æœªæˆæƒçš„ CSR è¯·æ±‚ï¼š</p>

<pre><code>$ kubectl get csr
NAME        AGE       REQUESTOR           CONDITION
csr-2b308   4m        kubelet-bootstrap   Pending
$ kubectl get nodes
No resources found.
</code></pre>

<p>é€šè¿‡ CSR è¯·æ±‚ï¼š</p>

<pre><code>$ kubectl certificate approve csr-2b308
certificatesigningrequest &quot;csr-2b308&quot; approved



$ kubectl get nodes
NAME        STATUS    AGE       VERSION
10.64.3.7   Ready     49m       v1.6.2
</code></pre>

<p>è‡ªåŠ¨ç”Ÿæˆäº† kubelet kubeconfig æ–‡ä»¶å’Œå…¬ç§é’¥ï¼š</p>

<pre><code>$ ls -l /etc/kubernetes/kubelet.kubeconfig
-rw------- 1 root root 2284 Apr  7 02:07 /etc/kubernetes/kubelet.kubeconfig
$ ls -l /etc/kubernetes/ssl/kubelet*
-rw-r--r-- 1 root root 1046 Apr  7 02:07 /etc/kubernetes/ssl/kubelet-client.crt
-rw------- 1 root root  227 Apr  7 02:04 /etc/kubernetes/ssl/kubelet-client.key
-rw-r--r-- 1 root root 1103 Apr  7 02:07 /etc/kubernetes/ssl/kubelet.crt
-rw------- 1 root root 1675 Apr  7 02:07 /etc/kubernetes/ssl/kubelet.key
</code></pre>

<p>2ã€kube-proxy</p>

<p>åˆ›å»º kube-proxy çš„ systemd unit æ–‡ä»¶</p>

<pre><code>$ sudo mkdir -p /var/lib/kube-proxy # å¿…é¡»å…ˆåˆ›å»ºå·¥ä½œç›®å½•




cat &gt; kube-proxy.service &lt;&lt;EOF
[Unit]
Description=Kubernetes Kube-Proxy Server
Documentation=https://github.com/GoogleCloudPlatform/kubernetes
After=network.target

[Service]
WorkingDirectory=/var/lib/kube-proxy
ExecStart=/usr/bin/kube-proxy \
  --bind-address=10.47.210.30 \
  --hostname-override=10.47.210.30 \
  --cluster-cidr=172.30.0.0/16 \
  --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig \
  --logtostderr=true \
  --v=2
Restart=on-failure
RestartSec=5
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
EOF
</code></pre>

<p>å‚æ•°è§£æ</p>

<p>&ndash;hostname-override å‚æ•°å€¼å¿…é¡»ä¸ kubelet çš„å€¼ä¸€è‡´ï¼Œå¦åˆ™ kube-proxy å¯åŠ¨åä¼šæ‰¾ä¸åˆ°è¯¥ Nodeï¼Œä»è€Œä¸ä¼šåˆ›å»ºä»»ä½• iptables è§„åˆ™ï¼›</p>

<p>&ndash;cluster-cidr å¿…é¡»ä¸ kube-controller-manager çš„ &ndash;cluster-cidr é€‰é¡¹å€¼ä¸€è‡´ï¼›</p>

<p>kube-proxy æ ¹æ® &ndash;cluster-cidr åˆ¤æ–­é›†ç¾¤å†…éƒ¨å’Œå¤–éƒ¨æµé‡ï¼ŒæŒ‡å®š &ndash;cluster-cidr æˆ– &ndash;masquerade-all é€‰é¡¹å kube-proxy æ‰ä¼šå¯¹è®¿é—® Service IP çš„è¯·æ±‚åš SNATï¼›</p>

<p>&ndash;kubeconfig æŒ‡å®šçš„é…ç½®æ–‡ä»¶åµŒå…¥äº† kube-apiserver çš„åœ°å€ã€ç”¨æˆ·åã€è¯ä¹¦ã€ç§˜é’¥ç­‰è¯·æ±‚å’Œè®¤è¯ä¿¡æ¯ï¼›</p>

<p>é¢„å®šä¹‰çš„ RoleBinding cluster-admin å°†User system:kube-proxy ä¸ Role system:node-proxier ç»‘å®šï¼Œè¯¥ Role æˆäºˆäº†è°ƒç”¨ kube-apiserver Proxy ç›¸å…³ API çš„æƒé™ï¼›</p>

<p>å¯åŠ¨</p>

<pre><code>systemctl daemon-reload
systemctl enable kube-proxy
systemctl start kube-proxy
systemctl status kube-proxy
</code></pre>

<p>åˆ°è¿™è¾¹é›†ç¾¤å°±å·²ç»æ‰‹åŠ¨éƒ¨ç½²å®Œæˆäº†ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨äº†ã€‚</p>

<blockquote>
<p>harbor</p>
</blockquote>

<p>ç§æœ‰é•œåƒä»“åº“æ˜¯æˆ‘ä»¬è‡ªå·±ä½¿ç”¨k8sé›†ç¾¤å¿…é¡»è¦ä½¿ç”¨çš„ï¼Œå¯ä»¥ä½¿ç”¨åŸç”Ÿçš„registryï¼Œç›®å‰æœ€æ´»è·ƒçš„å°±æ˜¯harborï¼Œæ˜¯å›½äººå†™çš„ï¼Œå„ç§æ¯”è¾ƒå‹å¥½ï¼Œæœ€å¥½ä½¿ç”¨1.7.5ç‰ˆæœ¬ä¹‹åçš„</p>

<p>harboræ˜¯ç›´æ¥ä½¿ç”¨docker-composeå•æœºç¼–æ’çš„</p>

<p>æ‰€ä»¥å®‰è£…dockerå’Œdocker-compose</p>

<pre><code>#ä¸‹è½½ç¦»çº¿å®‰è£…è½¯ä»¶
wget http://harbor.orientsoft.cn/harbor-v1.3.0-rc4/harbor-offline-installer-v1.3.0-rc4.tgz
#è§£å‹æ–‡ä»¶
tar -zxf harbor-offline-installer-v1.3.0-rc4.tgz
#è§£å‹åçš„æ–‡ä»¶å¤¹æ˜¯harbor
</code></pre>

<p>ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼šåŸŸåï¼Œç«¯å£ï¼Œå¯†ç ï¼Œå­˜æ”¾è·¯å¾„</p>

<p>ç„¶åç›´æ¥ä½¿ç”¨harborç›®å½•ä¸­çš„install.shå°±å¯ä»¥å®‰è£…å¯åŠ¨äº†ï¼Œç„¶åå°±å¯ä»¥æ ¹æ®åŸŸå+portæ¥è®¿é—®ï¼Œå½“ç„¶æˆ‘ä»¬æ­£å¸¸ä½¿ç”¨çš„æƒ…å†µä¸‹éƒ½æ˜¯ä¼šåœ¨harborå‰åŠ ä¸€å±‚nginxè½¬å‘ï¼Œè¿™ä¸ªnginxéœ€è¦æ³¨æ„è½¬å‘å¤§å°çš„è®¾ç½®</p>

<h1 id="åŸºæœ¬ä½¿ç”¨">åŸºæœ¬ä½¿ç”¨</h1>

<h2 id="kubectl">kubectl</h2>

<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‰ç§æ–¹å¼æ¥è®¿é—®apiserveræä¾›çš„æ¥å£</p>

<ol>
<li><p>REST API</p>

<p>å…¶å®å°±æ˜¯<a href="/post/cloud/paas/base/kubernetes/k8s-api">apiserverè‡ªèº«æä¾›çš„api</a>ï¼Œæ¯”å¦‚è®¿é—®nodesï¼Œæˆ‘ä»¬å¯ä»¥è®¿é—®/api/v1/proxy/nodes/{names}ã€‚</p></li>

<li><p>å„ç§è¯­è¨€çš„client lib</p>

<p>æˆ‘ä»¬æœ€å¸¸ç”¨çš„å°±æ˜¯<a href="/post/cloud/paas/base/kubernetes/k8s-client/">client-go</a>ã€‚</p></li>

<li><p>å‘½ä»¤è¡Œkubectl</p>

<p>æˆ‘ä»¬æœ€ç›´æ¥çš„å°±æ˜¯ä½¿ç”¨kubectlæ¥çœ‹å„ç§åº”ç”¨çš„æƒ…å†µ</p></li>
</ol>

<blockquote>
<p>å®‰è£…</p>
</blockquote>

<p>æˆ‘æ˜¯macOS ç³»ç»Ÿå¹¶ä½¿ç”¨ Homebrew åŒ…ç®¡ç†å™¨ï¼Œé€šè¿‡ Homebrew å®‰è£… kubectlã€‚</p>

<p>è¿è¡Œå®‰è£…å‘½ä»¤ï¼š</p>

<pre><code>brew install kubernetes-cli
</code></pre>

<p>æµ‹è¯•ä»¥ç¡®ä¿æ‚¨å®‰è£…çš„ç‰ˆæœ¬æ˜¯æœ€æ–°çš„ï¼š</p>

<pre><code>MacBook-Pro:minikube chunyinjiang$ kubectl version
Client Version: version.Info{Major:&quot;1&quot;, Minor:&quot;18&quot;, GitVersion:&quot;v1.18.3&quot;, GitCommit:&quot;2e7996e3e2712684bc73f0dec0200d64eec7fe40&quot;, GitTreeState:&quot;clean&quot;, BuildDate:&quot;2020-05-21T14:51:23Z&quot;, GoVersion:&quot;go1.14.3&quot;, Compiler:&quot;gc&quot;, Platform:&quot;darwin/amd64&quot;}
Server Version: version.Info{Major:&quot;1&quot;, Minor:&quot;18&quot;, GitVersion:&quot;v1.18.3&quot;, GitCommit:&quot;2e7996e3e2712684bc73f0dec0200d64eec7fe40&quot;, GitTreeState:&quot;clean&quot;, BuildDate:&quot;2020-05-20T12:43:34Z&quot;, GoVersion:&quot;go1.13.9&quot;, Compiler:&quot;gc&quot;, Platform:&quot;linux/amd64&quot;}
</code></pre>

<p>å½“ç„¶ä¹Ÿå¯ä»¥ä¸‹è½½äºŒè¿›åˆ¶æ–‡ä»¶è¿›è¡Œå®‰è£…</p>

<pre><code>é€šè¿‡ä»¥ä¸‹å‘½ä»¤ä¸‹è½½ kubectl çš„æœ€æ–°ç‰ˆæœ¬ï¼š

curl -LO https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/darwin/amd64/kubectl

è‹¥éœ€è¦ä¸‹è½½ç‰¹å®šç‰ˆæœ¬çš„ kubectlï¼Œè¯·å°†ä¸Šè¿°å‘½ä»¤ä¸­çš„ $(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt) éƒ¨åˆ†æ›¿æ¢æˆä¸ºéœ€è¦ä¸‹è½½çš„ kubectl çš„å…·ä½“ç‰ˆæœ¬å³å¯ã€‚

ä¾‹å¦‚ï¼Œå¦‚æœéœ€è¦ä¸‹è½½ v1.18.0 ç‰ˆæœ¬åœ¨ macOS ç³»ç»Ÿä¸Š,éœ€è¦ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ï¼š

    curl -LO https://storage.googleapis.com/kubernetes-release/release/v1.18.0/bin/darwin/amd64/kubectl
    ä¿®æ”¹æ‰€ä¸‹è½½çš„ kubectl äºŒè¿›åˆ¶æ–‡ä»¶ä¸ºå¯æ‰§è¡Œæ¨¡å¼ã€‚

    chmod +x ./kubectl
    å°† kubectl å¯æ‰§è¡Œæ–‡ä»¶æ”¾ç½®åˆ°ä½ çš„ PATH ç›®å½•ä¸‹ã€‚

    sudo mv ./kubectl /usr/local/bin/kubectl
</code></pre>

<blockquote>
<p>é…ç½®</p>
</blockquote>

<p>kubectlé»˜è®¤æƒ…å†µä¸‹ï¼Œkubectl ä¼šä» $HOME/.kube ç›®å½•ä¸‹æŸ¥æ‰¾æ–‡ä»¶åä¸º config çš„æ–‡ä»¶ã€‚æˆ‘ä»¬åœ¨ä¸Šé¢ä½¿ç”¨minikube startçš„æ—¶å€™ï¼Œè‡ªåŠ¨ç”Ÿæˆäº†å¯¹åº”çš„é»˜è®¤configï¼Œå¯ä»¥é€šè¿‡è®¾ç½®ç¯å¢ƒå˜é‡ KUBECONFIG ï¼ˆç¯å¢ƒå˜é‡ KUBECONFIG ä¿å­˜ä¸€ä¸ª kubeconfig æ–‡ä»¶åˆ—è¡¨ã€‚å¯¹äº Linux å’Œ Mac ç³»ç»Ÿï¼Œåˆ—è¡¨ä½¿ç”¨å†’å·å°†æ–‡ä»¶åè¿›è¡Œåˆ†éš”ï¼›å¯¹äº Windows ç³»ç»Ÿï¼Œåˆ™ä»¥åˆ†å·åˆ†éš”ã€‚ï¼‰æˆ–è€…é€šè¿‡è®¾ç½® &ndash;kubeconfig å»æŒ‡å®šå…¶å®ƒ kubeconfig æ–‡ä»¶ã€‚</p>

<p>æˆ‘ä»¬çœ‹ä¸€ä¸‹è¿™ä¸ªé»˜è®¤çš„é…ç½®</p>

<pre><code>MacBook-Pro:exercise chunyinjiang$ cat ~/.kube/config
apiVersion: v1
clusters:ï¼ˆé›†ç¾¤ï¼Œä¸‹é¢æ˜¯é›†ç¾¤ç›¸å…³çš„ä¿¡æ¯ï¼‰
- cluster:
    certificate-authority: /Users/chunyinjiang/.minikube/ca.crt
    server: https://192.168.99.101:8443
  name: minikube
contexts:ï¼ˆä¸Šä¸‹æ–‡ï¼Œå…³è”é›†ç¾¤ï¼Œç”¨æˆ·å’Œå‘½åç©ºé—´ï¼‰
- context:
    cluster: minikube
    user: minikube
  name: minikube
current-context: minikube
kind: Config
preferences: {}
users:ï¼ˆç”¨æˆ·ï¼Œä¸‹é¢æ˜¯ç”¨æˆ·ç›¸å…³çš„ä¿¡æ¯ï¼‰
- name: minikube
  user:
    client-certificate: /Users/chunyinjiang/.minikube/profiles/minikube/client.crt
    client-key: /Users/chunyinjiang/.minikube/profiles/minikube/client.key
</code></pre>

<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°é…ç½®æ–‡ä»¶ä¸­æœ‰ä¸‰éƒ¨åˆ†ï¼š</p>

<ul>
<li>clusterï¼ˆé›†ç¾¤ï¼‰: å­˜å‚¨api-serverçš„CAæ ¹è¯ä¹¦ã€api-serveråœ°å€ã€é›†ç¾¤åç§°ç­‰ã€‚</li>
<li>userï¼ˆç”¨æˆ·ï¼‰: çœŸæ­£é…ç½®ç”¨æˆ·è®¤è¯æ—¶çš„å‡­è¯ä¿¡æ¯ï¼Œä½¿ç”¨ä¸åŒçš„è®¤è¯ç­–ç•¥ï¼ŒåŒ…å«ä¸åŒçš„å­—æ®µã€‚</li>
<li>contextï¼ˆä¸Šä¸‹æ–‡ï¼‰: æŠŠclusterå’Œuserå…³è”èµ·æ¥ç»„æˆä¸€ä¸ªé›†ç¾¤ç¯å¢ƒä¿¡æ¯ï¼Œå£°æ˜é€šè¿‡å“ªä¸ªuserè¿å“ªä¸ªclusterã€‚</li>
</ul>

<p>kubeconfig æ–‡ä»¶å¯ä»¥åŒ…å« context å…ƒç´ ï¼Œæ¯ä¸ª context éƒ½æ˜¯ä¸€ä¸ªç”±ï¼ˆé›†ç¾¤ã€å‘½åç©ºé—´ã€ç”¨æˆ·ï¼‰æè¿°çš„ä¸‰å…ƒç»„ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ kubectl config use-context å»è®¾ç½®å½“å‰çš„ contextã€‚å‘½ä»¤è¡Œå·¥å…· kubectl ä¸å½“å‰ context ä¸­æŒ‡å®šçš„é›†ç¾¤å’Œå‘½åç©ºé—´è¿›è¡Œé€šä¿¡ï¼Œå¹¶ä¸”ä½¿ç”¨å½“å‰ context ä¸­åŒ…å«çš„ç”¨æˆ·å‡­è¯ã€‚</p>

<p><strong>å‘½ä»¤é…ç½®</strong></p>

<p>æ‰‹åŠ¨ç¼–è¾‘configæ–‡ä»¶éå¸¸éº»çƒ¦ï¼Œkubectl configå­å‘½ä»¤æä¾›äº†å¤§éƒ¨åˆ†çš„å‚æ•°è‡ªåŠ¨å¡«å……kubeconfigæ–‡ä»¶ï¼Œåˆ†åˆ«å¯¹åº”set-clusterã€set-credentialsã€set-contextï¼Œç›¸å¯¹åº”çš„æœ‰get-clustersã€get-contextsä»¥åŠdelete-clusterã€delete-contextï¼Œç›®å‰æ²¡æœ‰å¯¹åº”credential getå’Œdeleteæ“ä½œ,åªèƒ½æ‰‹åŠ¨ç¼–è¾‘kubeconfigæ–‡ä»¶ã€‚</p>

<p>kubeconfigç”Ÿæˆæœ‰ä¸‰æ­¥</p>

<p>1ã€è®¾ç½®é›†ç¾¤ä¿¡æ¯</p>

<pre><code>kubectl config set-cluster kubernetes   --certificate-authority=/etc/kubernetes/ssl/ca.pem   --embed-certs=true   --server=${KUBE_APISERVER}
</code></pre>

<p>é›†ç¾¤å‚æ•°ä¸»è¦è®¾ç½®äº†æ‰€éœ€è¦è®¿é—®çš„é›†ç¾¤çš„ä¿¡æ¯ã€‚</p>

<ul>
<li>set-clusterè®¾ç½®äº†éœ€è¦è®¿é—®çš„é›†ç¾¤ï¼Œå¦‚ä¸Šä¸ºkubernetesï¼›</li>
<li>&ndash;certificate-authorityè®¾ç½®äº†è¯¥é›†ç¾¤çš„å…¬é’¥ï¼›</li>
<li>&ndash;embed-certsä¸ºtrueè¡¨ç¤ºå°†&ndash;certificate-authorityè¯ä¹¦å†™å…¥åˆ°kubeconfigä¸­ï¼›</li>
<li>&ndash;serveråˆ™è¡¨ç¤ºè¯¥é›†ç¾¤çš„kube-apiserveråœ°å€ã€‚</li>
</ul>

<p>2ã€è®¾ç½®ç”¨æˆ·ä¿¡æ¯</p>

<pre><code>kubectl config set-credentials adminÂ Â  --client-certificate=/etc/kubernetes/ssl/admin.pemÂ Â  --embed-certs=trueÂ Â  --client-key=/etc/kubernetes/ssl/admin-key.pem
</code></pre>

<p>ç”¨æˆ·å‚æ•°ä¸»è¦è®¾ç½®ç”¨æˆ·çš„ç›¸å…³ä¿¡æ¯ï¼Œä¸»è¦æ˜¯ç”¨æˆ·è¯ä¹¦ã€‚</p>

<ul>
<li>ç”¨æˆ·åä¸ºadminï¼Œ</li>
<li>è¯ä¹¦ä¸ºï¼š/etc/kubernetes/ssl/admin.pemï¼Œ</li>
<li>ç§é’¥ä¸ºï¼š/etc/kubernetes/ssl/admin-key.pemã€‚æ³¨æ„å®¢æˆ·ç«¯çš„è¯ä¹¦é¦–å…ˆè¦ç»è¿‡é›†ç¾¤CAçš„ç­¾ç½²ï¼Œå¦åˆ™ä¸ä¼šè¢«é›†ç¾¤è®¤å¯ã€‚æ­¤å¤„ä½¿ç”¨çš„æ˜¯caè®¤è¯æ–¹å¼ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨tokenè®¤è¯ï¼Œå¦‚kubeletçš„Â TLS Boostrapæœºåˆ¶ä¸‹çš„bootstrappingä½¿ç”¨çš„å°±æ˜¯tokenè®¤è¯æ–¹å¼ã€‚</li>
</ul>

<p>3ã€è®¾ç½®ä¸Šä¸‹æ–‡</p>

<pre><code>kubectl config set-context kubernetesÂ Â  --cluster=kubernetesÂ Â  --user=admin #å¯ä»¥æŒ‡å®šè·¯å¾„kubeconfig=/root/config.conf
</code></pre>

<p>ä¸Šä¸‹æ–‡å‚æ•°å°†é›†ç¾¤å‚æ•°å’Œç”¨æˆ·å‚æ•°å…³è”èµ·æ¥ã€‚</p>

<ul>
<li>ä¸Šä¸‹æ–‡åç§°ä¸ºkubenetesï¼Œé›†ç¾¤ä¸ºkubenetesï¼Œç”¨æˆ·ä¸ºadminï¼Œè¡¨ç¤ºä½¿ç”¨adminçš„ç”¨æˆ·å‡­è¯æ¥è®¿é—®kubenetesé›†ç¾¤çš„defaultå‘½åç©ºé—´ï¼Œä¹Ÿå¯ä»¥å¢åŠ &ndash;namspaceæ¥æŒ‡å®šè®¿é—®çš„å‘½åç©ºé—´ã€‚</li>
</ul>

<p>4ã€è®¾ç½®å½“å‰ä½¿ç”¨çš„ä¸Šä¸‹æ–‡</p>

<pre><code>kubectl config use-context kubernetes
</code></pre>

<p><strong>é…ç½®å¯¹å¤šé›†ç¾¤çš„è®¿é—®</strong></p>

<p>1ã€é€šè¿‡contextæ¥å®Œæˆé…ç½®</p>

<p>å‡è®¾ç”¨æˆ·æœ‰ä¸¤ä¸ªé›†ç¾¤ï¼Œä¸€ä¸ªç”¨äºæ­£å¼å¼€å‘å·¥ä½œï¼ˆdevelopmentï¼‰ï¼Œä¸€ä¸ªç”¨äºå…¶å®ƒä¸´æ—¶ç”¨é€”ï¼ˆscratchï¼‰ã€‚ åœ¨ development é›†ç¾¤ä¸­ï¼Œæœ‰ä¸¤ä¸ªå¼€å‘è€…ï¼Œå‰ç«¯å¼€å‘è€…åœ¨åä¸º frontend çš„å‘½åç©ºé—´ä¸‹å·¥ä½œï¼Œ å­˜å‚¨å¼€å‘è€…åœ¨åä¸º storage çš„å‘½åç©ºé—´ä¸‹å·¥ä½œã€‚ åœ¨ scratch é›†ç¾¤ä¸­ï¼Œ å¼€å‘äººå‘˜å¯èƒ½åœ¨é»˜è®¤å‘½åç©ºé—´ä¸‹å·¥ä½œï¼Œä¹Ÿå¯èƒ½è§†æƒ…å†µåˆ›å»ºé™„åŠ çš„å‘½åç©ºé—´ã€‚</p>

<p>è®¿é—®å¼€å‘é›†ç¾¤éœ€è¦é€šè¿‡è¯ä¹¦è¿›è¡Œè®¤è¯ã€‚ è®¿é—®å…¶å®ƒä¸´æ—¶ç”¨é€”çš„é›†ç¾¤éœ€è¦é€šè¿‡ç”¨æˆ·åå’Œå¯†ç è¿›è¡Œè®¤è¯ã€‚</p>

<p>åˆ›å»ºåä¸º config-demo çš„æ–‡ä»¶ï¼Œå…¶å†…å®¹ä¸ºï¼š</p>

<pre><code>apiVersion: v1
kind: Config
preferences: {}

clusters:
- cluster:
  name: development
- cluster:
  name: scratch

users:
- name: developer
- name: experimenter

contexts:
- context:
  name: dev-frontend
- context:
  name: dev-storage
- context:
  name: exp-scratch
</code></pre>

<p>é…ç½®æ–‡ä»¶æè¿°äº†é›†ç¾¤ã€ç”¨æˆ·åå’Œä¸Šä¸‹æ–‡ã€‚ config-demo æ–‡ä»¶ä¸­å«æœ‰æè¿°ä¸¤ä¸ªé›†ç¾¤ã€ä¸¤ä¸ªç”¨æˆ·å’Œä¸‰ä¸ªä¸Šä¸‹æ–‡çš„æ¡†æ¶ï¼Œæ ¹æ®ä¸Šé¢çš„æè¿°ç„¶åè¿›è¡Œé…ç½®</p>

<ul>
<li><p>å°†ç¾¤é›†è¯¦ç»†ä¿¡æ¯æ·»åŠ åˆ°é…ç½®æ–‡ä»¶ä¸­ï¼š</p>

<pre><code>kubectl config --kubeconfig=config-demo set-cluster development --server=https://1.2.3.4 --certificate-authority=fake-ca-file
kubectl config --kubeconfig=config-demo set-cluster scratch --server=https://5.6.7.8 --insecure-skip-tls-verify
</code></pre></li>

<li><p>å°†ç”¨æˆ·è¯¦ç»†ä¿¡æ¯æ·»åŠ åˆ°é…ç½®æ–‡ä»¶ä¸­ï¼š</p>

<pre><code>kubectl config --kubeconfig=config-demo set-credentials developer --client-certificate=fake-cert-file --client-key=fake-key-seefile
kubectl config --kubeconfig=config-demo set-credentials experimenter --username=exp --password=some-password
</code></pre></li>

<li><p>å°†ä¸Šä¸‹æ–‡è¯¦ç»†ä¿¡æ¯æ·»åŠ åˆ°é…ç½®æ–‡ä»¶ä¸­ï¼š</p>

<pre><code>kubectl config --kubeconfig=config-demo set-context dev-frontend --cluster=development --namespace=frontend --user=developer
kubectl config --kubeconfig=config-demo set-context dev-storage --cluster=development --namespace=storage --user=developer
kubectl config --kubeconfig=config-demo set-context exp-scratch --cluster=scratch --namespace=default --user=experimenter
</code></pre></li>
</ul>

<p>æ‰“å¼€ config-demo æ–‡ä»¶æŸ¥çœ‹æ·»åŠ çš„è¯¦ç»†ä¿¡æ¯ã€‚ ä¹Ÿå¯ä»¥ä½¿ç”¨ config view å‘½ä»¤è¿›è¡ŒæŸ¥çœ‹ï¼š</p>

<pre><code>kubectl config --kubeconfig=config-demo view
</code></pre>

<p>è¾“å‡ºå±•ç¤ºäº†ä¸¤ä¸ªé›†ç¾¤ã€ä¸¤ä¸ªç”¨æˆ·å’Œä¸‰ä¸ªä¸Šä¸‹æ–‡ï¼š</p>

<pre><code>apiVersion: v1
clusters:
- cluster:
    certificate-authority: fake-ca-file
    server: https://1.2.3.4
  name: development
- cluster:
    insecure-skip-tls-verify: true
    server: https://5.6.7.8
  name: scratch
contexts:
- context:
    cluster: development
    namespace: frontend
    user: developer
  name: dev-frontend
- context:
    cluster: development
    namespace: storage
    user: developer
  name: dev-storage
- context:
    cluster: scratch
    namespace: default
    user: experimenter
  name: exp-scratch
current-context: &quot;&quot;
kind: Config
preferences: {}
users:
- name: developer
  user:
    client-certificate: fake-cert-file
    client-key: fake-key-file
- name: experimenter
  user:
    password: some-password
    username: exp
</code></pre>

<p>æ¯ä¸ªä¸Šä¸‹æ–‡åŒ…å«ä¸‰éƒ¨åˆ†ï¼ˆé›†ç¾¤ã€ç”¨æˆ·å’Œå‘½åç©ºé—´ï¼‰ï¼Œä¾‹å¦‚ï¼Œ dev-frontend ä¸Šä¸‹æ–‡è¡¨æ˜ï¼šä½¿ç”¨ developer ç”¨æˆ·çš„å‡­è¯æ¥è®¿é—® development é›†ç¾¤çš„ frontend å‘½åç©ºé—´ã€‚</p>

<p>è®¾ç½®å½“å‰ä¸Šä¸‹æ–‡ï¼š</p>

<pre><code>kubectl config --kubeconfig=config-demo use-context dev-frontend
</code></pre>

<p>ç°åœ¨å½“è¾“å…¥ kubectl å‘½ä»¤æ—¶ï¼Œç›¸åº”åŠ¨ä½œä¼šåº”ç”¨äº dev-frontend ä¸Šä¸‹æ–‡ä¸­æ‰€åˆ—çš„é›†ç¾¤å’Œå‘½åç©ºé—´ï¼ŒåŒæ—¶ï¼Œå‘½ä»¤ä¼šä½¿ç”¨ dev-frontend ä¸Šä¸‹æ–‡ä¸­æ‰€åˆ—ç”¨æˆ·çš„å‡­è¯ã€‚</p>

<p>ä½¿ç”¨ &ndash;minify å‚æ•°ï¼Œæ¥æŸ¥çœ‹ä¸å½“å‰ä¸Šä¸‹æ–‡ç›¸å…³è”çš„é…ç½®ä¿¡æ¯ã€‚</p>

<pre><code>kubectl config --kubeconfig=config-demo view --minify
</code></pre>

<p>è¾“å‡ºç»“æœå±•ç¤ºäº† dev-frontend ä¸Šä¸‹æ–‡ç›¸å…³çš„é…ç½®ä¿¡æ¯ï¼š</p>

<pre><code>apiVersion: v1
clusters:
- cluster:
    certificate-authority: fake-ca-file
    server: https://1.2.3.4
  name: development
contexts:
- context:
    cluster: development
    namespace: frontend
    user: developer
  name: dev-frontend
current-context: dev-frontend
kind: Config
preferences: {}
users:
- name: developer
  user:
    client-certificate: fake-cert-file
    client-key: fake-key-file
</code></pre>

<p>ç°åœ¨å‡è®¾ç”¨æˆ·å¸Œæœ›åœ¨å…¶å®ƒä¸´æ—¶ç”¨é€”é›†ç¾¤ä¸­å·¥ä½œä¸€æ®µæ—¶é—´ã€‚</p>

<p>å°†å½“å‰ä¸Šä¸‹æ–‡æ›´æ”¹ä¸º exp-scratchï¼š</p>

<pre><code>kubectl config --kubeconfig=config-demo use-context exp-scratch
</code></pre>

<p>ç°åœ¨ç”¨æˆ· kubectl ä¸‹è¾¾çš„ä»»ä½•å‘½ä»¤éƒ½å°†åº”ç”¨äº scratch é›†ç¾¤çš„é»˜è®¤å‘½åç©ºé—´ã€‚ åŒæ—¶ï¼Œå‘½ä»¤ä¼šä½¿ç”¨ exp-scratch ä¸Šä¸‹æ–‡ä¸­æ‰€åˆ—ç”¨æˆ·çš„å‡­è¯ã€‚</p>

<p>æŸ¥çœ‹æ›´æ–°åçš„å½“å‰ä¸Šä¸‹æ–‡ exp-scratch ç›¸å…³çš„é…ç½®ï¼š</p>

<pre><code>kubectl config --kubeconfig=config-demo view --minify
</code></pre>

<p>æœ€åï¼Œå‡è®¾ç”¨æˆ·å¸Œæœ›åœ¨ development é›†ç¾¤ä¸­çš„ storage å‘½åç©ºé—´ä¸‹å·¥ä½œä¸€æ®µæ—¶é—´ã€‚</p>

<p>å°†å½“å‰ä¸Šä¸‹æ–‡æ›´æ”¹ä¸º dev-storageï¼š</p>

<pre><code>kubectl config --kubeconfig=config-demo use-context dev-storage
</code></pre>

<p>æŸ¥çœ‹æ›´æ–°åçš„å½“å‰ä¸Šä¸‹æ–‡ dev-storage ç›¸å…³çš„é…ç½®ï¼š</p>

<pre><code>kubectl config --kubeconfig=config-demo view --minify
</code></pre>

<p>2ã€é€šè¿‡å¤šä¸ªé…ç½®æ–‡ä»¶</p>

<p>åˆ›å»ºåä¸º config-demo-2 çš„æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«ä»¥ä¸‹å†…å®¹ï¼š</p>

<pre><code>apiVersion: v1
kind: Config
preferences: {}

contexts:
- context:
    cluster: development
    namespace: ramp
    user: developer
  name: dev-ramp-up
</code></pre>

<p>ä¸Šè¿°é…ç½®æ–‡ä»¶å®šä¹‰äº†ä¸€ä¸ªæ–°çš„ä¸Šä¸‹æ–‡ï¼Œåä¸º dev-ramp-upã€‚</p>

<p>ä¸´æ—¶æ·»åŠ ä¸¤æ¡è·¯å¾„åˆ° KUBECONFIG ç¯å¢ƒå˜é‡ä¸­ã€‚ ä¾‹å¦‚ï¼Œåœ¨ Linux ä¸­ï¼š</p>

<pre><code>export  KUBECONFIG=$KUBECONFIG:config-demo:config-demo-2
</code></pre>

<p>åœ¨ config-exercise ç›®å½•ä¸­è¾“å…¥ä»¥ä¸‹å‘½ä»¤ï¼š</p>

<pre><code>kubectl config view
</code></pre>

<p>è¾“å‡ºå±•ç¤ºäº† KUBECONFIG ç¯å¢ƒå˜é‡ä¸­æ‰€åˆ—ä¸¾çš„æ‰€æœ‰æ–‡ä»¶åˆå¹¶åçš„ä¿¡æ¯ã€‚ ç‰¹åˆ«åœ°ï¼Œ æ³¨æ„åˆå¹¶ä¿¡æ¯ä¸­åŒ…å«æ¥è‡ª config-demo-2 æ–‡ä»¶çš„ dev-ramp-up ä¸Šä¸‹æ–‡å’Œæ¥è‡ª config-demo æ–‡ä»¶çš„ä¸‰ä¸ªä¸Šä¸‹æ–‡ï¼š</p>

<pre><code>contexts:
- context:
    cluster: development
    namespace: frontend
    user: developer
  name: dev-frontend
- context:
    cluster: development
    namespace: ramp
    user: developer
  name: dev-ramp-up
- context:
    cluster: development
    namespace: storage
    user: developer
  name: dev-storage
- context:
    cluster: scratch
    namespace: default
    user: experimenter
  name: exp-scratch
</code></pre>

<p>æ›´å¤šå…³äº kubeconfig æ–‡ä»¶å¦‚ä½•åˆå¹¶çš„ä¿¡æ¯å¯ä»¥å»æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£ã€‚</p>

<p><strong>æ£€æŸ¥é…ç½®</strong></p>

<p>é€šè¿‡è·å–é›†ç¾¤çŠ¶æ€æ£€æŸ¥ kubectl æ˜¯å¦è¢«æ­£ç¡®é…ç½®ï¼š</p>

<pre><code>kubectl cluster-info
</code></pre>

<p>å¦‚æœæ‚¨çœ‹åˆ°ä¸€ä¸ª URL è¢«è¿”å›ï¼Œé‚£ä¹ˆ kubectl å·²ç»è¢«æ­£ç¡®é…ç½®ï¼Œèƒ½å¤Ÿæ­£å¸¸è®¿é—®æ‚¨çš„ Kubernetes é›†ç¾¤ã€‚</p>

<p>å¦‚æœæ‚¨çœ‹åˆ°ç±»ä¼¼ä»¥ä¸‹çš„ä¿¡æ¯è¢«è¿”å›ï¼Œé‚£ä¹ˆ kubectl æ²¡æœ‰è¢«æ­£ç¡®é…ç½®ï¼Œæ— æ³•æ­£å¸¸è®¿é—®æ‚¨çš„ Kubernetes é›†ç¾¤ã€‚</p>

<pre><code>The connection to the server &lt;server-name:port&gt; was refused - did you specify the right host or port?
</code></pre>

<p>å¦‚æœ kubectl cluster-info èƒ½å¤Ÿè¿”å› url å“åº”ï¼Œä½†æ‚¨æ— æ³•è®¿é—®æ‚¨çš„é›†ç¾¤ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤æ£€æŸ¥é…ç½®æ˜¯å¦æ­£ç¡®ï¼š</p>

<pre><code>kubectl cluster-info dump
</code></pre>

<blockquote>
<p><strong>å¯ç”¨ shell è‡ªåŠ¨è¡¥å…¨åŠŸèƒ½</strong></p>
</blockquote>

<p>kubectl æ”¯æŒè‡ªåŠ¨è¡¥å…¨åŠŸèƒ½ï¼Œå¯ä»¥èŠ‚çœå¤§é‡è¾“å…¥ï¼</p>

<p>è‡ªåŠ¨è¡¥å…¨è„šæœ¬ç”± kubectl äº§ç”Ÿï¼Œæ‚¨ä»…éœ€è¦åœ¨æ‚¨çš„ shell é…ç½®æ–‡ä»¶ä¸­è°ƒç”¨å³å¯ã€‚</p>

<p>ä»¥ä¸‹ä»…æä¾›äº†ä½¿ç”¨å‘½ä»¤è¡¥å…¨çš„å¸¸ç”¨ç¤ºä¾‹ï¼Œæ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·æŸ¥é˜… kubectl completion -h å¸®åŠ©å‘½ä»¤çš„è¾“å‡ºã€‚</p>

<p>1ã€Linux ç³»ç»Ÿï¼Œä½¿ç”¨ bash</p>

<p>åœ¨ CentOS Linuxç³»ç»Ÿä¸Šï¼Œæ‚¨å¯èƒ½éœ€è¦å®‰è£…é»˜è®¤æƒ…å†µä¸‹æœªå®‰è£…çš„ bash-completion è½¯ä»¶åŒ…ã€‚</p>

<pre><code>yum install bash-completion -y
</code></pre>

<p>æ‰§è¡Œ source &lt;(kubectl completion bash) å‘½ä»¤åœ¨æ‚¨ç›®å‰æ­£åœ¨è¿è¡Œçš„ shell ä¸­å¼€å¯ kubectl è‡ªåŠ¨è¡¥å…¨åŠŸèƒ½ã€‚</p>

<p>å¯ä»¥å°†ä¸Šè¿°å‘½ä»¤æ·»åŠ åˆ° shell é…ç½®æ–‡ä»¶ä¸­ï¼Œè¿™æ ·åœ¨ä»Šåè¿è¡Œçš„ shell ä¸­å°†è‡ªåŠ¨å¼€å¯ kubectl è‡ªåŠ¨è¡¥å…¨ï¼š</p>

<pre><code>echo &quot;source &lt;(kubectl completion bash)&quot; &gt;&gt; ~/.bashrc
</code></pre>

<p>2ã€macOS ç³»ç»Ÿï¼Œä½¿ç”¨ bash</p>

<p>macOS ç³»ç»Ÿéœ€è¦å…ˆé€šè¿‡ Homebrew å®‰è£… bash-completionï¼š</p>

<p>å¦‚æœæ‚¨è¿è¡Œçš„æ˜¯ macOS è‡ªå¸¦çš„ Bash 3.2ï¼Œè¯·è¿è¡Œï¼š</p>

<pre><code>brew install bash-completion
</code></pre>

<p>å¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯ Bash 4.1+ï¼Œè¯·è¿è¡Œï¼š</p>

<pre><code>brew install bash-completion@2
</code></pre>

<p>è¯·æ ¹æ® Homebrew è¾“å‡ºçš„â€æ³¨æ„äº‹é¡¹ï¼ˆcaveatsï¼‰â€éƒ¨åˆ†çš„å†…å®¹å°† bash-completion çš„è·¯å¾„æ·»åŠ åˆ°æœ¬åœ° .bashrc æ–‡ä»¶ä¸­ã€‚</p>

<p>å¦‚æœæ‚¨æ˜¯æŒ‰ç…§ Homebrew æŒ‡ç¤ºä¸­çš„æ­¥éª¤å®‰è£…çš„ kubectlï¼Œé‚£ä¹ˆæ— éœ€å…¶ä»–é…ç½®ï¼Œkubectl çš„è‡ªåŠ¨è¡¥å…¨åŠŸèƒ½å·²ç»è¢«å¯ç”¨ã€‚</p>

<p>å¦‚æœæ‚¨æ˜¯æ‰‹å·¥ä¸‹è½½å¹¶å®‰è£…çš„ kubectlï¼Œé‚£ä¹ˆæ‚¨éœ€è¦å°† kubectl è‡ªåŠ¨è¡¥å…¨æ·»åŠ åˆ° bash-completionï¼š</p>

<pre><code>kubectl completion bash &gt; $(brew --prefix)/etc/bash_completion.d/kubectl
</code></pre>

<p>ç”±äº Homebrew é¡¹ç›®ä¸ Kubernetes æ— å…³ï¼Œæ‰€ä»¥å¹¶ä¸èƒ½ä¿è¯ bash-completion æ€»èƒ½å¤Ÿæ”¯æŒ kubectl çš„è‡ªåŠ¨è¡¥å…¨åŠŸèƒ½ã€‚</p>

<p>3ã€macOS ç³»ç»Ÿï¼Œä½¿ç”¨ Zsh</p>

<p>å¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯ zsh,è¯·ç¼–è¾‘ ~/.zshrc æ–‡ä»¶å¹¶æ·»åŠ ä»¥ä¸‹ä»£ç ä»¥å¯ç”¨ kubectl è‡ªåŠ¨è¡¥å…¨åŠŸèƒ½ã€‚</p>

<pre><code>if [ $commands[kubectl] ]; then
  source &lt;(kubectl completion zsh)
fi
</code></pre>

<p>å¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯ Oh-My-Zshï¼Œè¯·ç¼–è¾‘ ~/.zshrc æ–‡ä»¶å¹¶æ›´æ–° plugins= è¡Œä»¥åŒ…å« kubectl æ’ä»¶ã€‚</p>

<pre><code>plugins=(kubectl)
</code></pre>

<blockquote>
<p>ä½¿ç”¨</p>
</blockquote>

<p>kubectlçš„åŸç†æ˜¯å°†è¾“å…¥çš„è½¬åŒ–ä¸ºREST APIæ¥è°ƒç”¨ï¼Œå°†è¿”å›ç»“æœè¾“å‡ºã€‚åªæ˜¯å¯¹REST APIçš„ä¸€ç§å°è£…ï¼Œå¯ä»¥è¯´æ˜¯apiserverçš„ä¸€ä¸ªå®¢æˆ·ç«¯ã€‚</p>

<p><img src="/media/cloud/k8s/kubectl.jpg" alt="" /></p>

<p>ç”¨æ³•ï¼š</p>

<pre><code>kubectl [command] [options]
</code></pre>

<p>æ¯”è¾ƒæ ¸å¿ƒå’Œå¸¸ç”¨çš„å‘½ä»¤éƒ½åœ¨ä¸Šé¢çš„å›¾ä¸­ï¼Œè¿™è¾¹å¯¹ä¸»è¦å‘½ä»¤åšä¸€ä¸ªç®€å•çš„è¯´æ˜ã€‚</p>

<p><strong>1ã€kubectl annotate</strong></p>

<p>æ›´æ–°æŸä¸ªèµ„æºçš„æ³¨è§£ï¼Œæ”¯æŒçš„èµ„æºåŒ…æ‹¬ä½†ä¸é™äºï¼ˆå¤§å°å†™ä¸é™ï¼‰ï¼špods (po)ã€services (svc)ã€ replicationcontrollers (rc)ã€nodes (no)ã€events (ev)ã€componentstatuses (cs)ã€ limitranges (limits)ã€persistentvolumes (pv)ã€persistentvolumeclaims (pvc)ã€ resourcequotas (quota)å’Œsecretsã€‚</p>

<p>ç¤ºä¾‹</p>

<pre><code># æ›´æ–°pod â€œfooâ€ï¼Œè®¾ç½®å…¶æ³¨è§£descriptionçš„å€¼ä¸ºmy frontendã€‚
# å¦‚æœåŒä¸€ä¸ªæ³¨è§£è¢«èµ‹å€¼äº†å¤šæ¬¡ï¼Œåªä¿å­˜æœ€åä¸€æ¬¡è®¾ç½®çš„å€¼ã€‚
$ kubectl annotate pods foo description='my frontend'

# æ›´æ–°â€œpod.jsonâ€æ–‡ä»¶ä¸­typeå’Œnameå­—æ®µæŒ‡å®šçš„podçš„æ³¨è§£ã€‚
$ kubectl annotate -f pod.json description='my frontend'

# æ›´æ–°pod â€œfooâ€ï¼Œè®¾ç½®å…¶æ³¨è§£descriptionçš„å€¼ä¸ºmy frontend running nginxï¼Œå·²æœ‰çš„å€¼å°†è¢«è¦†ç›–ã€‚
$ kubectl annotate --overwrite pods foo description='my frontend running nginx'

# æ›´æ–°åŒä¸€namespaceä¸‹æ‰€æœ‰çš„podã€‚
$ kubectl annotate pods --all description='my frontend running nginx'

# ä»…å½“pod â€œfooâ€å½“å‰ç‰ˆæœ¬ä¸º1æ—¶ï¼Œæ›´æ–°å…¶æ³¨è§£
$ kubectl annotate pods foo description='my frontend running nginx' --resource-version=1

# æ›´æ–°pod â€œfooâ€ï¼Œåˆ é™¤å…¶æ³¨è§£descriptionã€‚
# ä¸éœ€è¦--overrideé€‰é¡¹ã€‚
$ kubectl annotate pods foo description-
</code></pre>

<p><strong>2ã€kubectl api-versions</strong></p>

<p>ä»¥â€œç»„/ç‰ˆæœ¬â€çš„æ ¼å¼è¾“å‡ºæœåŠ¡ç«¯æ”¯æŒçš„APIç‰ˆæœ¬ã€‚</p>

<p><strong>3ã€kubectl apply</strong></p>

<p>é€šè¿‡æ–‡ä»¶åæˆ–æ§åˆ¶å°è¾“å…¥ï¼Œå¯¹èµ„æºè¿›è¡Œé…ç½®ã€‚</p>

<p>ç¤ºä¾‹</p>

<pre><code># å°†pod.jsonä¸­çš„é…ç½®åº”ç”¨åˆ°pod,å½“ç„¶yamlä¹Ÿå¯ä»¥
$ kubectl apply -f ./pod.json

# å°†æ§åˆ¶å°è¾“å…¥çš„JSONé…ç½®åº”ç”¨åˆ°Pod
$ cat pod.json | kubectl apply -f -
</code></pre>

<p><strong>4ã€kubectl attach</strong></p>

<p>è¿æ¥åˆ°ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„å®¹å™¨ã€‚</p>

<p>ç¤ºä¾‹</p>

<pre><code># è·å–æ­£åœ¨è¿è¡Œä¸­çš„pod 123456-7890çš„è¾“å‡ºï¼Œé»˜è®¤è¿æ¥åˆ°ç¬¬ä¸€ä¸ªå®¹å™¨
$ kubectl attach 123456-7890

# è·å–pod 123456-7890ä¸­ruby-containerçš„è¾“å‡º
$ kubectl attach 123456-7890 -c ruby-container date

# åˆ‡æ¢åˆ°ç»ˆç«¯æ¨¡å¼ï¼Œå°†æ§åˆ¶å°è¾“å…¥å‘é€åˆ°pod 123456-7890çš„ruby-containerçš„â€œbashâ€å‘½ä»¤ï¼Œå¹¶å°†å…¶è¾“å‡ºåˆ°æ§åˆ¶å°/
# é”™è¯¯æ§åˆ¶å°çš„ä¿¡æ¯å‘é€å›å®¢æˆ·ç«¯ã€‚
$ kubectl attach 123456-7890 -c ruby-container -i -t
</code></pre>

<p><strong>5ã€kubectl cluster-info</strong></p>

<p>æ˜¾ç¤ºé›†ç¾¤ä¿¡æ¯ã€‚</p>

<p><strong>6ã€kubectl config</strong></p>

<p>ä¿®æ”¹kubeconfigé…ç½®æ–‡ä»¶ã€‚</p>

<p><strong>7ã€kubectl create</strong></p>

<p>é€šè¿‡æ–‡ä»¶åæˆ–æ§åˆ¶å°è¾“å…¥ï¼Œåˆ›å»ºèµ„æºã€‚</p>

<p>æ¥å—JSONå’ŒYAMLæ ¼å¼çš„æè¿°æ–‡ä»¶ã€‚</p>

<pre><code>kubectl create -f FILENAME
kubectl create -f rc-nginx.yaml
</code></pre>

<p><strong>8ã€kubectl delete</strong></p>

<p>é€šè¿‡æ–‡ä»¶åã€æ§åˆ¶å°è¾“å…¥ã€èµ„æºåæˆ–è€…label selectoråˆ é™¤èµ„æºã€‚</p>

<pre><code>kubectl delete -f rc-nginx.yaml
kubectl delete po rc-nginx-btv4j
kubectl delete po -lapp=nginx-2
</code></pre>

<p>æˆ‘ä»¬ä¸€èˆ¬é‡å¯å®¹å™¨ï¼Œä½¿ç”¨kubectlæ˜¯æ²¡æœ‰åŠæ³•é‡å¯çš„ï¼Œéœ€è¦åˆ°å¯¹åº”çš„nodeèŠ‚ç‚¹ä¸Šï¼Œç„¶åä½¿ç”¨docker killï¼Œå¦‚æœæ²¡æœ‰åŠæ³•ï¼Œå°±åªèƒ½ä½¿ç”¨kubectl delete podç„¶åæ§åˆ¶å™¨ä¼šé‡å¯podï¼Œå½“ç„¶è¿™ç§æƒ…å†µä¸‹ï¼Œpodæ˜¯é‡å¯çš„ï¼Œå…³äºpodç›¸å…³çš„éƒ½ä¼šå‘ç”Ÿå˜åŒ–ï¼Œå’Œé‡å¯å®¹å™¨è¿˜æ˜¯æœ‰åŒºåˆ«çš„ã€‚æœ‰æ—¶å€™åˆ é™¤podï¼Œæˆ‘ä»¬éœ€è¦ä¿å­˜æ§åˆ¶å™¨ï¼Œæˆ‘ä»¬åªè¦å°†å‰¯æœ¬æ•°è°ƒæ•´æˆ0ï¼Œä¹Ÿæ˜¯æˆ‘ä»¬å¸¸ç”¨çš„æ–¹æ³•ã€‚</p>

<p><strong>9ã€kubectl describe</strong></p>

<p>è¾“å‡ºæŒ‡å®šçš„ä¸€ä¸ª/å¤šä¸ªèµ„æºçš„è¯¦ç»†ä¿¡æ¯ã€‚</p>

<p>æ”¯æŒçš„èµ„æºåŒ…æ‹¬ä½†ä¸é™äºï¼ˆå¤§å°å†™ä¸é™ï¼‰ï¼špods (po)ã€services (svc)ã€ replicationcontrollers (rc)ã€nodes (no)ã€events (ev)ã€componentstatuses (cs)ã€ limitranges (limits)ã€persistentvolumes (pv)ã€persistentvolumeclaims (pvc)ã€ resourcequotas (quota)å’Œsecretsã€‚</p>

<p>ç¤ºä¾‹</p>

<pre><code># æè¿°ä¸€ä¸ªnode
$ kubectl describe nodes kubernetes-minion-emt8.c.myproject.internal

# æè¿°ä¸€ä¸ªpod
$ kubectl describe pods/nginx

# æè¿°pod.jsonä¸­çš„èµ„æºç±»å‹å’Œåç§°æŒ‡å®šçš„pod
$ kubectl describe -f pod.json

# æè¿°æ‰€æœ‰çš„pod
$ kubectl describe pods

# æè¿°æ‰€æœ‰åŒ…å«label name=myLabelçš„pod
$ kubectl describe po -l name=myLabel

# æè¿°æ‰€æœ‰è¢«replication controller â€œfrontendâ€ç®¡ç†çš„podï¼ˆrcåˆ›å»ºçš„podéƒ½ä»¥rcçš„åå­—ä½œä¸ºå‰ç¼€ï¼‰
$ kubectl describe pods frontend
</code></pre>

<p>describeæ˜¯æˆ‘ä»¬å¸¸ç”¨çš„å‘½ä»¤ï¼Œæ¯”å¦‚æˆ‘ä»¬ä½¿ç”¨describeåˆ†ænodeä¿¡æ¯ï¼š</p>

<pre><code>[root@xgpccsit02m010243129129 ~]# kubectl get nodes
NAME   STATUS   ROLES         AGE    VERSION
dev1   Ready    master.node   515d   v1.14.8
dev2   Ready    master.node   515d   v1.14.8
dev3   Ready    master.node   515d   v1.14.8
dev4   Ready    node          305d   v1.14.8
dev5   Ready    node          509d   v1.14.8
[root@xgpccsit02m010243129129 ~]# kubectl describe node dev5
Name:               dev5
Roles:              node
Labels:             APP=true
                    WEB=true
                    beta.kubernetes.io/arch=amd64
                    beta.kubernetes.io/os=linux
                    dragonflyTest=true
                    kubernetes.io/arch=amd64
                    kubernetes.io/hostname=dev5
                    kubernetes.io/os=linux
                    netType=B2C
                    node-network-driver=ovs
                    node-role.kubernetes.io/node=
Annotations:        csi.volume.kubernetes.io/nodeid: {&quot;ossplugin.csi&quot;:&quot;10.243.133.2&quot;}
                    node.alpha.kubernetes.io/ttl: 0
                    sncloud.com/cpu-policy: none
                    sncloud.com/diskIOPSCapacity: 1000000
                    sncloud.com/gpu.usage: null
                    sncloud.com/gpu.used: 0
                    sncloud.com/networkBandwidthCapacity: 2000000000
CreationTimestamp:  Wed, 11 Dec 2019 17:20:26 +0800
Taints:             &lt;none&gt;
Unschedulable:      false
Conditions:
  Type                     Status  LastHeartbeatTime                 LastTransitionTime                Reason                       Message
  ----                     ------  -----------------                 ------------------                ------                       -------
  ServiceReady             False   Tue, 12 May 2020 10:16:14 +0800   Tue, 12 May 2020 10:16:14 +0800   NodeServiceReadyChange       [cni status:unknown,]
  FrequentLxcfsRestart     False   Tue, 12 May 2020 10:16:30 +0800   Wed, 06 May 2020 18:26:52 +0800   NoFrequentLxcfsRestart       lxcfs is functioning properly
  FrequentKubeletRestart   False   Tue, 12 May 2020 10:16:30 +0800   Wed, 06 May 2020 18:26:52 +0800   NoFrequentKubeletRestart     kubelet is functioning properly
  FrequentDockerRestart    False   Tue, 12 May 2020 10:16:30 +0800   Wed, 06 May 2020 18:26:52 +0800   NoFrequentDockerRestart      docker is functioning properly
  OrphanedPodFileExist     False   Fri, 27 Mar 2020 01:53:49 +0800   Tue, 24 Mar 2020 12:10:13 +0800   NoOrphanedPodFileExist       OrphanedPod is not exist
  MemoryPressure           False   Tue, 12 May 2020 10:17:09 +0800   Wed, 08 Apr 2020 18:03:40 +0800   KubeletHasSufficientMemory   kubelet has sufficient memory available
  DiskPressure             False   Tue, 12 May 2020 10:17:09 +0800   Wed, 08 Apr 2020 18:03:40 +0800   KubeletHasNoDiskPressure     kubelet has no disk pressure
  PIDPressure              False   Tue, 12 May 2020 10:17:09 +0800   Wed, 08 Apr 2020 18:03:40 +0800   KubeletHasSufficientPID      kubelet has sufficient PID available
  Ready                    True    Tue, 12 May 2020 10:17:09 +0800   Thu, 07 May 2020 09:57:01 +0800   KubeletReady                 kubelet is posting ready status
Addresses:
  InternalIP:  10.243.133.2
  Hostname:    dev5
Capacity:
 cpu:                24
 ephemeral-storage:  51877124Ki
 hugepages-1Gi:      0
 hugepages-2Mi:      0
 memory:             263852704Ki
 pods:               110
Allocatable:
 cpu:                22
 ephemeral-storage:  47809957400
 hugepages-1Gi:      0
 hugepages-2Mi:      0
 memory:             261653152Ki
 pods:               110
System Info:
 Machine ID:                 6328e225a9fe47d1bac0d3a6004c0ada
 System UUID:                6328e225a9fe47d1bac0d3a6004c0ada
 Boot ID:                    7b9342ff-16ae-4bcd-8631-dc367652de52
 Kernel Version:             4.18.0-80.11.1.el7.centos.sn11.x86_64
 OS Image:                   CentOS Linux 7 (Core)
 Operating System:           linux
 Architecture:               amd64
 Container Runtime Version:  docker://18.9.9
 Kubelet Version:            v1.14.8
 Kube-Proxy Version:         v1.14.8
Non-terminated Pods:         (10 in total)
  Namespace                  Name                           CPU Requests  CPU Limits  Memory Requests  Memory Limits  AGE
  ---------                  ----                           ------------  ----------  ---------------  -------------  ---
  kube-system                cadvisor-proxy-5t9jk           100m (0%)     500m (2%)   100Mi (0%)       250Mi (0%)     18d
  kube-system                csi-ossplugin-gpvz8            0 (0%)        0 (0%)      0 (0%)           0 (0%)         4d23h
  kube-system                dfclient-cgzdm                 1 (4%)        2 (9%)      2Gi (0%)         3Gi (1%)       12d
  kube-system                filebeat-8ckl9                 3750m (17%)   4 (18%)     2273Mi (0%)      2660Mi (1%)    19d
  kube-system                machine-worker-nx2gc           100m (0%)     100m (0%)   100Mi (0%)       100Mi (0%)     126d
  kube-system                node-exporter-m8jc8            100m (0%)     200m (0%)   128Mi (0%)       256Mi (0%)     3d16h
  kube-system                node-problem-detector-qcwln    25m (0%)      200m (0%)   100Mi (0%)       100Mi (0%)     5d15h
  kube-system                preheat-worker-2sn7g           200m (0%)     500m (2%)   128Mi (0%)       512Mi (0%)     46d
  kube-system                voyage-agent-qb9rd             1100m (5%)    1100m (5%)  1124Mi (0%)      1124Mi (0%)    4d1h
  kube-system                voyage-openvswitch-ccdg8       1 (4%)        4 (18%)     1Gi (0%)         4Gi (1%)       113d
Allocated resources:
  (Total limits may be over 100 percent, i.e., overcommitted.)
  Resource           Requests     Limits
  --------           --------     ------
  cpu                7375m (33%)  12600m (57%)
  memory             7025Mi (2%)  12170Mi (4%)
  ephemeral-storage  0 (0%)       0 (0%)
Events:              &lt;none&gt;


è§£æ

1ã€nodeçš„åŸºæœ¬ä¿¡æ¯ï¼šåç§°ï¼Œæ ‡ç­¾ï¼Œåˆ›å»ºæ—¶é—´
2ã€nodeå½“å‰è¿è¡Œçš„çŠ¶æ€ï¼Œnodeå¯åŠ¨åä¼šåšä¸€äº›è‡ªæ£€å·¥ä½œï¼Œæ¯”å¦‚ç£ç›˜æ»¡äº†ï¼Œå¦‚æœæ»¡äº†å°±æ ‡æ³¨OutOfDisk=Trueï¼Œå¦åˆ™å°±ç»§ç»­æ£€æŸ¥å†…å­˜æ˜¯å¤Ÿä¸è¶³ï¼Œæœ€åä¸€åˆ‡æ­£å¸¸ï¼Œå°±Ready=Trueï¼Œå¯ä»¥åœ¨ä¸Šé¢æŸ¥çœ‹ï¼Œè¿™ç§æƒ…å†µä»£è¡¨nodeå¤„äºå¥åº·çŠ¶æ€ï¼Œå¯ä»¥åœ¨ä¸Šåˆ›å»ºpodäº†ã€‚
3ã€nodeä¸»æœºåå’Œä¸»æœºåœ°å€
4ã€nodeä¸Šçš„èµ„æºæ€»é‡ï¼Œæ¯”å¦‚cpuï¼Œå†…å­˜ï¼Œæœ€å¤§å¯è°ƒåº¦podçš„æ•°é‡
5ã€nodeå¯åˆ†é…çš„èµ„æº
6ã€æœ¬æœºç³»ç»Ÿä¿¡æ¯ï¼šUUIDï¼Œç‰ˆæœ¬ç­‰
7ã€å½“å‰æ­£åœ¨è¿è¡Œçš„podçš„æ¦‚è¦ä¿¡æ¯
8ã€å·²åˆ†é…çš„èµ„æºä½¿ç”¨æƒ…å†µ
9ã€nodeç›¸å…³çš„äº‹ä»¶event
</code></pre>

<p><strong>10ã€kubectl replace</strong></p>

<p>æ›´æ–°æ›¿æ¢</p>

<pre><code>kubectl replace -f rc-nginx.yaml
</code></pre>

<p><strong>11ã€kubectl patch</strong></p>

<p>å¦‚æœä¸€ä¸ªå®¹å™¨å·²ç»åœ¨è¿è¡Œï¼Œè¿™æ—¶éœ€è¦å¯¹ä¸€äº›å®¹å™¨å±æ€§è¿›è¡Œä¿®æ”¹ï¼Œåˆä¸æƒ³åˆ é™¤å®¹å™¨ï¼Œæˆ–ä¸æ–¹ä¾¿é€šè¿‡replaceçš„æ–¹å¼è¿›è¡Œæ›´æ–°ã€‚kubernetesè¿˜æä¾›äº†ä¸€ç§åœ¨å®¹å™¨è¿è¡Œæ—¶ï¼Œç›´æ¥å¯¹å®¹å™¨è¿›è¡Œä¿®æ”¹çš„æ–¹å¼ï¼Œå°±æ˜¯patchå‘½ä»¤.</p>

<pre><code>kubectl patch pod rc-nginx-2-kpiqt -p '{&quot;metadata&quot;:{&quot;labels&quot;:{&quot;app&quot;:&quot;nginx-3&quot;}}}'
</code></pre>

<p><strong>12ã€kubectl edit</strong></p>

<p>ç¼–è¾‘æœåŠ¡ç«¯çš„èµ„æºã€‚</p>

<p>ç¤ºä¾‹</p>

<pre><code>  # ç¼–è¾‘åä¸ºâ€œdocker-registryâ€çš„service
  $ kubectl edit svc/docker-registry

  # ä½¿ç”¨ä¸€ä¸ªä¸åŒçš„ç¼–è¾‘å™¨
  $ KUBE_EDITOR=&quot;nano&quot; kubectl edit svc/docker-registry

  # ç¼–è¾‘åä¸ºâ€œdocker-registryâ€çš„serviceï¼Œä½¿ç”¨JSONæ ¼å¼ã€v1 APIç‰ˆæœ¬
  $ kubectl edit svc/docker-registry --output-version=v1 -o json
</code></pre>

<p><strong>13ã€kubectl exec</strong></p>

<p>åœ¨å®¹å™¨å†…éƒ¨æ‰§è¡Œå‘½ä»¤ã€‚</p>

<p>ç¤ºä¾‹</p>

<pre><code># é»˜è®¤åœ¨pod 123456-7890çš„ç¬¬ä¸€ä¸ªå®¹å™¨ä¸­è¿è¡Œâ€œdateâ€å¹¶è·å–è¾“å‡º
$ kubectl exec 123456-7890 date

# åœ¨pod 123456-7890çš„å®¹å™¨ruby-containerä¸­è¿è¡Œâ€œdateâ€å¹¶è·å–è¾“å‡º
$ kubectl exec 123456-7890 -c ruby-container date

# åˆ‡æ¢åˆ°ç»ˆç«¯æ¨¡å¼ï¼Œå°†æ§åˆ¶å°è¾“å…¥å‘é€åˆ°pod 123456-7890çš„ruby-containerçš„â€œbashâ€å‘½ä»¤ï¼Œå¹¶å°†å…¶è¾“å‡ºåˆ°æ§åˆ¶å°/
# é”™è¯¯æ§åˆ¶å°çš„ä¿¡æ¯å‘é€å›å®¢æˆ·ç«¯ã€‚
$ kubectl exec 123456-7890 -c ruby-container -i -t -- bash -il

kubectl exec filebeat-27 -c container -n namespaces sh
</code></pre>

<p><strong>14ã€kubectl logs</strong></p>

<p>è¾“å‡ºpodä¸­ä¸€ä¸ªå®¹å™¨çš„æ—¥å¿—ã€‚</p>

<p>ç¤ºä¾‹</p>

<pre><code># è¿”å›ä»…åŒ…å«ä¸€ä¸ªå®¹å™¨çš„pod nginxçš„æ—¥å¿—å¿«ç…§
$ kubectl logs nginx

# è¿”å›pod rubyä¸­å·²ç»åœæ­¢çš„å®¹å™¨web-1çš„æ—¥å¿—å¿«ç…§
$ kubectl logs -p -c ruby web-1

# æŒç»­è¾“å‡ºpod rubyä¸­çš„å®¹å™¨web-1çš„æ—¥å¿—
$ kubectl logs -f -c ruby web-1

# ä»…è¾“å‡ºpod nginxä¸­æœ€è¿‘çš„20æ¡æ—¥å¿—
$ kubectl logs --tail=20 nginx

# æŒç»­è¾“å‡ºpod nginxä¸­çš„æ—¥å¿—ï¼Œé‡æœ€è¿‘çš„20æ¡æ—¥å¿—å¼€å§‹
$ kubectl logs --tail=20 -f nginx

# è¾“å‡ºpod nginxä¸­æœ€è¿‘ä¸€å°æ—¶å†…äº§ç”Ÿçš„æ‰€æœ‰æ—¥å¿—
$ kubectl logs --since=1h nginx
</code></pre>

<p><strong>15ã€kubectl version</strong></p>

<p>è¾“å‡ºæœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯çš„ç‰ˆæœ¬ä¿¡æ¯ã€‚</p>

<p><strong>16ã€kubectl get</strong></p>

<p>è·å–ä¿¡æ¯</p>

<pre><code>kubectl get po
</code></pre>

<p><strong>17ã€kubectl rolling-update</strong></p>

<p>æ»šåŠ¨æ›´æ–°.</p>

<pre><code>kubectl rolling-update rc-nginx-2 -f rc-nginx.yamlï¼Œ
</code></pre>

<p>è¿™ä¸ªè¿˜æä¾›å¦‚æœåœ¨å‡çº§è¿‡ç¨‹ä¸­ï¼Œå‘ç°æœ‰é—®é¢˜è¿˜å¯ä»¥ä¸­é€”åœæ­¢updateï¼Œå¹¶å›æ»šåˆ°å‰é¢ç‰ˆæœ¬</p>

<pre><code>kubectl rolling-update rc-nginx-2 â€”rollback
</code></pre>

<p><strong>18ã€kubectl scale</strong></p>

<p>æ‰©å®¹ç¼©å®¹</p>

<pre><code>kubectl scale rc rc-nginx-3 â€”replicas=4
</code></pre>

<p><strong>19ã€kubectl cp</strong></p>

<p>å°†æ–‡ä»¶ç›´æ¥æ‹·è¿›å®¹å™¨å†…</p>

<pre><code>kubectl cp æ–‡ä»¶ podï¼šè·¯å¾„
kubectl cp ./test.war logtestjbossforone-7b89dd5c9-297pf:/opt/wildfly/standalone/deployments
</code></pre>

<p>å°†æ–‡ä»¶é‡å®¹å™¨ä¸­æ‹·è´åˆ°æœ¬åœ°</p>

<pre><code>kubectl cp namespace(é»˜è®¤æ˜¯default)/podï¼šè·¯å¾„ è·¯å¾„
kubectl cp logtestjbossforone-7b89dd5c9-297pf:/opt/wildfly/standalone/deployments ./
</code></pre>

<p><strong>20ã€kubectl label</strong></p>

<p>ç»™èŠ‚ç‚¹æ‰“ä¸Šlabel</p>

<pre><code>kubectl label nodes &lt;node-name&gt; &lt;label-key&gt;=&lt;label-value&gt;
</code></pre>

<p>å¯ä»¥é€šè¿‡&ndash;show-labelsæ¥æŸ¥çœ‹nodeä¸Šçš„label</p>

<pre><code>kubectl get node --show-labels
</code></pre>

<p>åˆ é™¤label</p>

<pre><code>kubectl label nodes &lt;node-name&gt; &lt;label-key&gt;-
</code></pre>

<p><strong>21ã€kubectl cordon</strong></p>

<p>è¦æ ‡è®°ä¸€ä¸ªèŠ‚ç‚¹ä¸ºä¸å¯è°ƒåº¦ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p>

<pre><code>kubectl cordon $NODENAME
</code></pre>

<p>å¦‚æœæ ‡è®°èŠ‚ç‚¹ä¸ºä¸å¯è°ƒåº¦ï¼ˆunschedulableï¼‰ï¼Œå°†é˜»æ­¢æ–° Pod è°ƒåº¦åˆ°è¯¥èŠ‚ç‚¹ä¹‹ä¸Šï¼Œä½†ä¸ä¼š å½±å“ä»»ä½•å·²ç»åœ¨å…¶ä¸Šçš„ Podã€‚</p>

<p>è¢« DaemonSet æ§åˆ¶å™¨åˆ›å»ºçš„ Pod èƒ½å¤Ÿå®¹å¿èŠ‚ç‚¹çš„ä¸å¯è°ƒåº¦å±æ€§ã€‚ DaemonSet é€šå¸¸æä¾›èŠ‚ç‚¹æœ¬åœ°çš„æœåŠ¡ï¼Œå³ä½¿èŠ‚ç‚¹ä¸Šçš„è´Ÿè½½åº”ç”¨å·²ç»è¢«è…¾ç©ºï¼Œè¿™äº›æœåŠ¡ä¹Ÿä»éœ€ è¿è¡Œåœ¨èŠ‚ç‚¹ä¹‹ä¸Šã€‚</p>

<p><strong>22ã€kubectl help</strong></p>

<p>help å¸®åŠ©å‘½ä»¤ï¼Œå¯ä»¥æŸ¥æ‰¾æ‰€æœ‰çš„å‘½ä»¤ï¼Œåœ¨æˆ‘ä»¬ä¸ä¼šç”¨çš„æ—¶å€™ï¼Œè¦å­¦ä¼šä½¿ç”¨è¿™ä¸ªå‘½ä»¤ã€‚</p>

<p>kubectlå…¶å®ä¹Ÿæ˜¯k8sä¸€ä¸ªæ¯”è¾ƒæ ¸å¿ƒçš„ç»„ä»¶ï¼Œåªä¸è¿‡ä½“ç°åœ¨å®¢æˆ·ç«¯ï¼Œæˆ‘ä»¬ä¹Ÿæ˜¯å¾ˆæœ‰å¿…è¦ç ”ç©¶ä¸€ä¸‹kubectlå’Œæ ¸å¿ƒå‘½ä»¤çš„çš„<a href="/post/cloud/paas/base/kubernetes/k8s-kubectl/">åŸç†</a>ã€‚</p>

<h2 id="yamlæ–‡ä»¶è¯¦è§£">yamlæ–‡ä»¶è¯¦è§£</h2>

<p>å…¶å®æœ€åéƒ½æ˜¯è½¬åŒ–ä¸ºapiå¯¹è±¡ï¼Œæ‰€ä»¥ç¬¦åˆk8sè®¾è®¡çš„é¡¶çº§apiå¯¹è±¡ï¼Œæ‰€ä»¥ç›´æ¥çœ‹<a href="/post/cloud/paas/base/kubernetes/k8s-api/">é¡¶çº§apiå¯¹è±¡çš„ç»„æˆ</a>ã€‚</p>

<blockquote>
<p>rcå®ä¾‹è¯¦è§£</p>
</blockquote>

<pre><code>apiVersion: v1 #æŒ‡å®šapiç‰ˆæœ¬ï¼Œæ­¤å€¼å¿…é¡»åœ¨kubectl apiversionä¸­
kind: ReplicationController #æŒ‡å®šåˆ›å»ºèµ„æºçš„è§’è‰²/ç±»å‹
metadata: #èµ„æºçš„å…ƒæ•°æ®/å±æ€§
  name: test-rc #èµ„æºçš„åå­—ï¼Œåœ¨åŒä¸€ä¸ªnamespaceä¸­å¿…é¡»å”¯ä¸€
  labels: #è®¾å®šèµ„æºçš„æ ‡ç­¾ï¼Œè¯¦æƒ…è¯·è§http://blog.csdn.net/liyingke112/article/details/77482384
  k8s-app: apache
    software: apache
    project: test
    app: test-rc
    version: v1
  annotations:            #è‡ªå®šä¹‰æ³¨è§£åˆ—è¡¨
    - name: String        #è‡ªå®šä¹‰æ³¨è§£åå­—
spec:
  replicas: 2 #å‰¯æœ¬æ•°é‡2
  selector: #RCé€šè¿‡spec.selectoræ¥ç­›é€‰è¦æ§åˆ¶çš„Pod
    software: apache
    project: test
    app: test-rc
    version: v1
    name: test-rc
  template: #è¿™é‡ŒPodçš„å®šä¹‰
    metadata:
      labels: #Podçš„labelï¼Œå¯ä»¥çœ‹åˆ°è¿™ä¸ªlabelä¸spec.selectorç›¸åŒ
        software: apache
        project: test
        app: test-rc
        version: v1
        name: test-rc
    spec:#specification of the resource content æŒ‡å®šè¯¥èµ„æºçš„å†…å®¹
      restartPolicy: Always #è¡¨æ˜è¯¥å®¹å™¨ä¸€ç›´è¿è¡Œï¼Œé»˜è®¤k8sçš„ç­–ç•¥ï¼Œåœ¨æ­¤å®¹å™¨é€€å‡ºåï¼Œä¼šç«‹å³åˆ›å»ºä¸€ä¸ªç›¸åŒçš„å®¹å™¨
      nodeSelector:     #èŠ‚ç‚¹é€‰æ‹©ï¼Œå…ˆç»™ä¸»æœºæ‰“æ ‡ç­¾kubectl label nodes kube-node1 zone=node1
        zone: node1
      containers:
      - name: web04-pod #å®¹å™¨çš„åå­—
        image: web:apache #å®¹å™¨ä½¿ç”¨çš„é•œåƒåœ°å€
        imagePullPolicy: Never #ä¸‰ä¸ªé€‰æ‹©Alwaysã€Neverã€IfNotPresentï¼Œæ¯æ¬¡å¯åŠ¨æ—¶æ£€æŸ¥å’Œæ›´æ–°ï¼ˆä»registeryï¼‰imagesçš„ç­–ç•¥ï¼Œ
                               # Alwaysï¼Œæ¯æ¬¡éƒ½æ£€æŸ¥,é‡è¿œç¨‹æ‹‰å»
                               # Neverï¼Œæ¯æ¬¡éƒ½ä¸æ£€æŸ¥ï¼ˆä¸ç®¡æœ¬åœ°æ˜¯å¦æœ‰ï¼‰
                               # IfNotPresentï¼Œå¦‚æœæœ¬åœ°æœ‰å°±ä¸æ£€æŸ¥ï¼Œå¦‚æœæ²¡æœ‰å°±æ‹‰å–
        command: ['sh'] #å¯åŠ¨å®¹å™¨çš„è¿è¡Œå‘½ä»¤ï¼Œå°†è¦†ç›–å®¹å™¨ä¸­çš„Entrypoint,å¯¹åº”Dockefileä¸­çš„ENTRYPOINT
        args: [&quot;$(str)&quot;] #å¯åŠ¨å®¹å™¨çš„å‘½ä»¤å‚æ•°ï¼Œå¯¹åº”Dockerfileä¸­CMDå‚æ•°
        env: #æŒ‡å®šå®¹å™¨ä¸­çš„ç¯å¢ƒå˜é‡
        - name: str #å˜é‡çš„åå­—
          value: &quot;/etc/run.sh&quot; #å˜é‡çš„å€¼
        resources: #èµ„æºç®¡ç†ï¼Œè¯·æ±‚è¯·è§http://blog.csdn.net/liyingke112/article/details/77452630
          requests: #å®¹å™¨è¿è¡Œæ—¶ï¼Œæœ€ä½èµ„æºéœ€æ±‚ï¼Œä¹Ÿå°±æ˜¯è¯´æœ€å°‘éœ€è¦å¤šå°‘èµ„æºå®¹å™¨æ‰èƒ½æ­£å¸¸è¿è¡Œ
            cpu: 0.1 #CPUèµ„æºï¼ˆæ ¸æ•°ï¼‰ï¼Œä¸¤ç§æ–¹å¼ï¼Œæµ®ç‚¹æ•°æˆ–è€…æ˜¯æ•´æ•°+mï¼Œ0.1=100mï¼Œæœ€å°‘å€¼ä¸º0.001æ ¸ï¼ˆ1mï¼‰
            memory: 32Mi #å†…å­˜ä½¿ç”¨é‡
          limits: #èµ„æºé™åˆ¶
            cpu: 0.5
            memory: 32Mi
        ports:
        - containerPort: 80 #å®¹å™¨å¼€å‘å¯¹å¤–çš„ç«¯å£
          name: httpd  #åç§°
          protocol: TCP
        livenessProbe: #podå†…å®¹å™¨å¥åº·æ£€æŸ¥çš„è®¾ç½®ï¼Œè¯¦æƒ…è¯·è§http://blog.csdn.net/liyingke112/article/details/77531584
          httpGet: #é€šè¿‡httpgetæ£€æŸ¥å¥åº·ï¼Œè¿”å›200-399ä¹‹é—´ï¼Œåˆ™è®¤ä¸ºå®¹å™¨æ­£å¸¸
            path: / #URIåœ°å€
            port: 80
            #host: 127.0.0.1 #ä¸»æœºåœ°å€
            scheme: HTTP
          initialDelaySeconds: 180 #è¡¨æ˜ç¬¬ä¸€æ¬¡æ£€æµ‹åœ¨å®¹å™¨å¯åŠ¨åå¤šé•¿æ—¶é—´åå¼€å§‹
          timeoutSeconds: 5 #æ£€æµ‹çš„è¶…æ—¶æ—¶é—´
          periodSeconds: 15  #æ£€æŸ¥é—´éš”æ—¶é—´
          #ä¹Ÿå¯ä»¥ç”¨è¿™ç§æ–¹æ³•
          #exec: æ‰§è¡Œå‘½ä»¤çš„æ–¹æ³•è¿›è¡Œç›‘æµ‹ï¼Œå¦‚æœå…¶é€€å‡ºç ä¸ä¸º0ï¼Œåˆ™è®¤ä¸ºå®¹å™¨æ­£å¸¸
          #  command:
          #    - cat
          #    - /tmp/health
          #ä¹Ÿå¯ä»¥ç”¨è¿™ç§æ–¹æ³•
          #tcpSocket: //é€šè¿‡tcpSocketæ£€æŸ¥å¥åº·
          #  port: number
        lifecycle: #ç”Ÿå‘½å‘¨æœŸç®¡ç†
          postStart: #å®¹å™¨è¿è¡Œä¹‹å‰è¿è¡Œçš„ä»»åŠ¡
            exec:
              command:
                - 'sh'
                - 'yum upgrade -y'
          preStop:#å®¹å™¨å…³é—­ä¹‹å‰è¿è¡Œçš„ä»»åŠ¡
            exec:
              command: ['service httpd stop']
        volumeMounts:  #è¯¦æƒ…è¯·è§http://blog.csdn.net/liyingke112/article/details/76577520
        - name: volume #æŒ‚è½½è®¾å¤‡çš„åå­—ï¼Œä¸volumes[*].name éœ€è¦å¯¹åº”
          mountPath: /data #æŒ‚è½½åˆ°å®¹å™¨çš„æŸä¸ªè·¯å¾„ä¸‹
          readOnly: True
  volumes: #å®šä¹‰ä¸€ç»„æŒ‚è½½è®¾å¤‡
  - name: volume #å®šä¹‰ä¸€ä¸ªæŒ‚è½½è®¾å¤‡çš„åå­—
    #meptyDir: {}
    hostPath:
      path: /opt #æŒ‚è½½è®¾å¤‡ç±»å‹ä¸ºhostPathï¼Œè·¯å¾„ä¸ºå®¿ä¸»æœºä¸‹çš„/opt,è¿™é‡Œè®¾å¤‡ç±»å‹æ”¯æŒå¾ˆå¤šç§
</code></pre>

<h2 id="è¿ç§»">è¿ç§»</h2>

<p>è¿ç§»ä¸€èˆ¬ç”¨äºé›†ç¾¤çš„å‡çº§ï¼Œk8sé›†ç¾¤çš„å‡çº§æ¯”è¾ƒå›°éš¾ï¼Œè€Œè¿ç§»ç›¸å¯¹æ¥è¯´å°±ç®€å•å¾ˆå¤šï¼Œå¯ä»¥é€šè¿‡å‘æ–°é›†ç¾¤ä¸­é€ä¸ªè¿ç§»åº”ç”¨ï¼Œå‘ç°æ‡‚å•Šå…·ä½“é—®é¢˜ï¼Œè€Œä¸åƒå‡çº§å‘ç°é—®é¢˜ï¼Œ
éƒ½éš¾ä»¥ä¸‹æ‰‹æˆ–è€…èŒƒå›´æ¯”è¾ƒå¹¿ï¼Œæ¯”å¦‚å°†1.16ä»¥ä¸‹çš„é›†ç¾¤å‡çº§åˆ°1.16ï¼Œå› ä¸ºapiç‰ˆæœ¬å‘ç”Ÿå˜åŒ–ï¼Œåœ¨1.16ä¸­k8såˆ é™¤v1 and v1beta1ï¼Œæ‰€ä»¥åœ¨ä¹‹å‰ä½¿ç”¨è¿™äº›apiçš„å°±éœ€è¦åšå¯¹åº”çš„æ›´æ”¹ï¼Œå¦‚æœç›´æ¥å‡çº§ï¼Œå°±ä¼šå‡ºç°å¾ˆå¤šé—®é¢˜ã€‚
å½“ç„¶å‡çº§ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œéœ€è¦ä¸“é—¨çš„å»åšchangelogè°ƒç ”ï¼Œé’ˆå¯¹ä¸€äº›å¯èƒ½çš„é—®é¢˜åšå¤„ç†ï¼Œä¹Ÿæ˜¯å¯ä»¥åšåˆ°æ— æŸå‡çº§çš„ã€‚</p>

<p>å½“ç„¶è¿ç§»ä¹Ÿå¯ä»¥æ˜¯è¿ç§»ç°æœ‰åº”ç”¨ä¸Šäº‘ï¼Œè¿ç§»ç°æœ‰åº”ç”¨æ­¥éª¤è¯´æ˜ï¼š</p>

<ul>
<li>å°†åŸæœ‰åº”ç”¨æ‹†è§£ä¸ºæœåŠ¡</li>
<li>å®¹å™¨åŒ–ã€åˆ¶ä½œé•œåƒ</li>
<li>å‡†å¤‡åº”ç”¨é…ç½®æ–‡ä»¶</li>
<li>å‡†å¤‡kubernetes YAMLæ–‡ä»¶</li>
<li>ç¼–å†™bootstarpè„šæœ¬</li>
<li>åˆ›å»ºConfigMaps</li>
</ul>

<p>ä¸Šäº‘çš„æ­¥éª¤</p>

<ul>
<li>æ­å»ºåŸºç¡€å¹³å°ï¼Œæä¾›èƒ½åŠ›</li>
<li>å°†å•ä½“åº”ç”¨åˆ¶ä½œé•œåƒäº‘ä¸Šè¿è¡Œ</li>
<li>åˆ¶å®šè§„èŒƒ</li>
<li>å°†ä¸­é—´ä»¶åº”ç”¨ï¼ˆæ¡†æ¶ï¼Œæ•°æ®åº“ï¼Œé˜Ÿåˆ—ï¼Œè´Ÿè½½å‡è¡¡ç­‰ç­‰ï¼‰ä¸Šäº‘</li>
<li>æœ€ååœ¨ä»¥ä¸Šèƒ½åŠ›çš„åŸºç¡€ä¸Šå»ºè®¾å¾®æœåŠ¡æ¶æ„ï¼Œå°†ä¸šåŠ¡ä¸Šäº‘</li>
</ul>

<h2 id="ç®¡ç†">ç®¡ç†</h2>

<p>1ã€é™ˆåˆ—å¼</p>

<p>å°±æ˜¯æˆ‘ä»¬æ­£å¸¸ä½¿ç”¨çš„å‘½ä»¤è¡Œï¼Œåœ¨æŸ¥ï¼Œåˆ›å»ºï¼Œåˆ é™¤çš„æ—¶å€™ï¼Œæ¯”è¾ƒå¥½æ“ä½œï¼Œä½†æ˜¯ä¿®æ”¹å°±æ¯”è¾ƒéº»çƒ¦ï¼Œä½¿ç”¨å£°æ˜å¼çš„æ–‡ä»¶æ–¹å¼æ¯”è¾ƒå¥½æ“ä½œ</p>

<p>2ã€å£°æ˜å¼</p>

<p>å°±æ˜¯æˆ‘ä»¬ä½¿ç”¨çš„yamlæˆ–è€…jsonæ ¼å¼ï¼Œä¿®æ”¹æ–‡ä»¶å°±ç®€å•äº†ï¼Œå¯ä»¥åœ¨çº¿editä¿®æ”¹ï¼Œä¹Ÿå¯ä»¥ç¦»çº¿ä¿®æ”¹ã€‚</p>

<p>3ã€GUI</p>

<p>å°±æ˜¯æˆ‘ä»¬dashboardã€‚</p>

<h3 id="ç‰ˆæœ¬å·ç®¡ç†">ç‰ˆæœ¬å·ç®¡ç†</h3>

<p>ç»å¸¸çœ‹åˆ°ä¸€ä¸²ç‰ˆæœ¬å·v1.17.0-alpha.3.227+7d13dfe3c34f44-dirtyï¼Œçœ‹èµ·æ¥éå¸¸å¤æ‚ï¼Œå…¶å®ç†Ÿæ‚‰gitçš„åŒå­¦ä¸€çœ¼å°±èƒ½çœ‹å‡ºæ­£æ˜¯gitçš„æºç ç‰ˆæœ¬ä¿¡æ¯ã€‚</p>

<table>
<thead>
<tr>
<th>åˆ†è§£å­—æ®µ</th>
<th>è¯´æ˜</th>
</tr>
</thead>

<tbody>
<tr>
<td>v1.17.0-alpha.3</td>
<td>ä¸Šä¸€æ¬¡tagï¼Œè¡¨ç¤ºv1.17.0çš„ç¬¬3ä¸ªalphaç‰ˆæœ¬</td>
</tr>

<tr>
<td>227</td>
<td>ä¸Šä¸€æ¬¡tagä¹‹åæäº¤æ•°</td>
</tr>

<tr>
<td>7d13dfe3c34f44</td>
<td>æœ€æ–°ä¸€æ¬¡æäº¤id</td>
</tr>

<tr>
<td>dirty</td>
<td>æºç æ˜¯å¦ä¿®æ”¹</td>
</tr>
</tbody>
</table>

<p><a href="https://github.com/kubernetes/community/blob/master/contributors/design-proposals/release/versioning.md">è¿™é‡Œ</a>æè¿°äº†kubernetesçš„ç‰ˆæœ¬ç®¡ç†è§„åˆ™ï¼Œæ®æ­¤å¯ä»¥çœ‹å‡ºä¸Šè¿°ç‰ˆæœ¬ä¸€å®šæ˜¯åœ¨masteråˆ†æ”¯ä¸Šã€‚</p>

<h2 id="é—®é¢˜å¤„ç†">é—®é¢˜å¤„ç†</h2>

<p>1ã€åˆ›å»ºNginx Podè¿‡ç¨‹ä¸­æŠ¥å¦‚ä¸‹é”™è¯¯ï¼š</p>

<pre><code>#kubectlcreate -f nginx-pod.yaml

Error from server: error when creating &quot;nginx-pod.yaml&quot;: Pod &quot;nginx&quot; is forbidden: no API token found for service account default/default, retry after the token is automatically created and added to the service account
</code></pre>

<p>è§£å†³æ–¹æ³•ï¼š</p>

<p>ä¿®æ”¹/etc/kubernetes/apiserveræ–‡ä»¶ä¸­KUBE_ADMISSION_CONTROLå‚æ•°ã€‚</p>

<p>ä¿®æ”¹å‰ï¼š</p>

<pre><code>KUBE_ADMISSION_CONTROL=&quot;--admission_control=NamespaceLifecycle,NamespaceExists,LimitRanger,SecurityContextDeny,ServiceAccount,ResourceQuota&quot;
</code></pre>

<p>å»æ‰â€œServiceAccountâ€é€‰é¡¹ã€‚</p>

<p>2ã€åˆ›å»ºPodè¿‡ç¨‹ä¸­ï¼Œæ˜¾ç¤ºå¼‚å¸¸ï¼Œé€šè¿‡æŸ¥çœ‹æ—¥å¿—/var/log/messagesï¼Œæœ‰ä»¥ä¸‹æŠ¥é”™ä¿¡æ¯ï¼š</p>

<pre><code>Nov 26 21:52:06 localhost kube-apiserver: E1126 21:52:06.697708    1963 server.go:454] Unable to generate self signed cert: open /var/run/kubernetes/apiserver.crt: permission denied
Nov 26 21:52:06 localhost kube-apiserver: E1126 21:52:06.697818    1963 server.go:464] Unable to listen for secure (open /var/run/kubernetes/apiserver.crt: no such file or directory); will try again.
</code></pre>

<p>è§£å†³æ–¹æ³•æœ‰ä¸¤ç§ï¼š</p>

<p>ç¬¬ä¸€ç§æ–¹æ³•ï¼š</p>

<pre><code># vim /usr/lib/systemd/system/kube-apiserver.service

[Service]
PermissionsStartOnly=true
ExecStartPre=-/usr/bin/mkdir /var/run/kubernetes
ExecStartPre=/usr/bin/chown -R kube:kube /var/run/kubernetes/

# systemctl daemon-reload
# systemctl restart kube-apiserver
</code></pre>

<p>ç¬¬äºŒç§æ–¹æ³•ï¼š</p>

<pre><code># vim /etc/kubernetes/apiserver

KUBE_API_ARGS=&quot;--secure-port=0&quot;
</code></pre>

<p>åœ¨KUBE_API_ARGSåŠ ä¸Š&ndash;secure-port=0å‚æ•°ã€‚</p>

<p>åŸå› å¦‚ä¸‹ï¼š</p>

<pre><code>--secure-port=6443: The port on which to serve HTTPS with authentication and authorization. If 0, don't serve HTTPS at all.
</code></pre>

<h1 id="k8såŸç†">k8såŸç†</h1>

<p><a href="/post/cloud/paas/base/kubernetes/k8s-principle/">k8såŸç†è¯¦è§£</a></p>
            </div>
            
            <div style="border: 1px dashed #e0e0e0; margin-bottom: 15px; padding: 10px 10px 10px 10px; background-color: #fffeee; background-repeat: no-repeat; background-attachment: scroll; background-position: 1% 50%; -moz-background-size: auto auto; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial;">
                <div>
                    <p style="margin-top:0px;">ä½œè€…ï¼š<a target="_blank" href="https://kingjcy.github.io/">kingjcy</a>
                    <br />æœ¬æ–‡å‡ºå¤„ï¼š<a target="_blank" href="https://kingjcy.github.io/post/cloud/paas/base/kubernetes/k8s-tutorial/">https://kingjcy.github.io/post/cloud/paas/base/kubernetes/k8s-tutorial/</a>
                    <br />
                    æ–‡ç« ç‰ˆæƒå½’æœ¬äººæ‰€æœ‰ï¼Œæ¬¢è¿è½¬è½½ï¼Œä½†æœªç»ä½œè€…åŒæ„å¿…é¡»ä¿ç•™æ­¤æ®µå£°æ˜ï¼Œä¸”åœ¨æ–‡ç« é¡µé¢æ˜æ˜¾ä½ç½®ç»™å‡ºåŸæ–‡é“¾æ¥ï¼Œå¦åˆ™ä¿ç•™è¿½ç©¶æ³•å¾‹è´£ä»»çš„æƒåˆ©ã€‚ </p>
                </div>
            </div>

            <aside>
                
                <ul class="list-inline post-tags">
                    
                    <li>
                        <a href="/tags/cloudnative/">
                            <i class="fa fa-tags"></i>
                            cloudnative
                        </a>
                    </li>
                    
                    <li>
                        <a href="/tags/paas/">
                            <i class="fa fa-tags"></i>
                            paas
                        </a>
                    </li>
                    
                    <li>
                        <a href="/tags/k8s/">
                            <i class="fa fa-tags"></i>
                            k8s
                        </a>
                    </li>
                    
                    <li>
                        <a href="/tags/base/">
                            <i class="fa fa-tags"></i>
                            base
                        </a>
                    </li>
                    
                    <li>
                        <a href="/tags/tutorial/">
                            <i class="fa fa-tags"></i>
                            tutorial
                        </a>
                    </li>
                    
                </ul>

                
                
                <h4 id="real-rels">ç›¸å…³æ–‡ç« </h4>
                <ul class="post-rels" id="real-rels"><li id="li-rels"><a href="/post/cloud/paas/base/kubernetes/k8s-store-csi/">äº‘è®¡ç®—K8sç»„ä»¶ç³»åˆ—â€”- å­˜å‚¨CSI</a>&nbsp;&nbsp;<span class="post-date" style="font-size:14px">&nbsp;(2021å¹´08æœˆ12æ—¥)</span></li><li id="li-rels"><a href="/post/cloud/paas/base/kubernetes/k8s-store/">äº‘è®¡ç®—K8sç»„ä»¶ç³»åˆ—ï¼ˆå…«ï¼‰---- å­˜å‚¨</a>&nbsp;&nbsp;<span class="post-date" style="font-size:14px">&nbsp;(2021å¹´08æœˆ03æ—¥)</span></li><li id="li-rels"><a href="/post/cloud/paas/base/docker/docker-image/">äº‘è®¡ç®—å®¹å™¨ç³»åˆ—---- Docker image ä¼˜åŒ–</a>&nbsp;&nbsp;<span class="post-date" style="font-size:14px">&nbsp;(2021å¹´07æœˆ31æ—¥)</span></li><li id="li-rels"><a href="/post/cloud/paas/base/kubernetes/k8s-client/">äº‘è®¡ç®—K8sç³»åˆ—---- K8s client</a>&nbsp;&nbsp;<span class="post-date" style="font-size:14px">&nbsp;(2021å¹´07æœˆ04æ—¥)</span></li><li id="li-rels"><a href="/post/cloud/paas/base/kubernetes/k8s-autoscaler/">äº‘è®¡ç®—K8sç³»åˆ—---- K8s autoscaler</a>&nbsp;&nbsp;<span class="post-date" style="font-size:14px">&nbsp;(2021å¹´02æœˆ04æ—¥)</span></li><li id="li-rels"><a href="/post/cloud/paas/base/kubernetes/k8s-kruise/">äº‘è®¡ç®—K8sç³»åˆ—---- kruise</a>&nbsp;&nbsp;<span class="post-date" style="font-size:14px">&nbsp;(2021å¹´01æœˆ17æ—¥)</span></li><li id="li-rels"><a href="/post/cloud/paas/base/kubernetes/k8s-network-cni/">äº‘è®¡ç®—K8sç³»åˆ—---- ç½‘ç»œCNI</a>&nbsp;&nbsp;<span class="post-date" style="font-size:14px">&nbsp;(2021å¹´01æœˆ17æ—¥)</span></li><li id="li-rels"><a href="/post/cloud/paas/base/kubernetes/k8s-controller/">äº‘è®¡ç®—K8sç³»åˆ—---- K8s controller</a>&nbsp;&nbsp;<span class="post-date" style="font-size:14px">&nbsp;(2020å¹´11æœˆ24æ—¥)</span></li><li id="li-rels"><a href="/post/cloud/paas/base/kubernetes/k8s-apiserver/">äº‘è®¡ç®—K8sç»„ä»¶ç³»åˆ—ï¼ˆä¸€ï¼‰---- K8s apiserver è¯¦è§£</a>&nbsp;&nbsp;<span class="post-date" style="font-size:14px">&nbsp;(2020å¹´10æœˆ24æ—¥)</span></li><li id="li-rels"><a href="/post/cloud/paas/base/kubernetes/k8s-kubelet/">äº‘è®¡ç®—K8sç»„ä»¶ç³»åˆ—ï¼ˆå››ï¼‰---- K8s kubelet è¯¦è§£</a>&nbsp;&nbsp;<span class="post-date" style="font-size:14px">&nbsp;(2020å¹´10æœˆ20æ—¥)</span></li></ul>
            </aside>
                
            
            <footer>
                <nav>
                    <ul class="pager">

                        
                        <li class="previous"><a href="/post/monitor/metrics/prometheus/exporter/process_exporter/"><span aria-hidden="true">&larr;</span> Prev</a></li>
                        

                        <li><a href="/post/">All Posts</a></li>

                        
                        <li class="next"><a href="/post/distributed/distributed-lock/">Next <span aria-hidden="true">&rarr;</span></a></li>
                        

                    </ul>
                </nav>
            </footer>

        </article>
    </div>
    <div class="col-md-4">
        
<aside>
        <div class="toc panel panel-default hidden-xs hidden-sm affix-top" data-spy="affix" data-offset-top="125" data-offset-bottom="300">
            <div class="panel-heading">
                <h2 class="panel-title">Catalog</h2>
            </div>

            <nav id="TableOfContents">
<ul>
<li><a href="#ç»„ä»¶å’Œæ¦‚å¿µ">ç»„ä»¶å’Œæ¦‚å¿µ</a></li>
<li><a href="#å®‰è£…éƒ¨ç½²">å®‰è£…éƒ¨ç½²</a>
<ul>
<li><a href="#å®‰è£…åŒ…">å®‰è£…åŒ…</a></li>
<li><a href="#å•ä¾‹">å•ä¾‹</a>
<ul>
<li><a href="#minikube">minikube</a></li>
</ul></li>
<li><a href="#é›†ç¾¤">é›†ç¾¤</a>
<ul>
<li><a href="#kubeadm">kubeadm</a></li>
<li><a href="#æ‰‹åŠ¨éƒ¨ç½²">æ‰‹åŠ¨éƒ¨ç½²</a>
<ul>
<li><a href="#shellä¸€é”®éƒ¨ç½²">shellä¸€é”®éƒ¨ç½²</a></li>
<li><a href="#äºŒè¿›åˆ¶éƒ¨ç½²">äºŒè¿›åˆ¶éƒ¨ç½²</a></li>
</ul></li>
</ul></li>
</ul></li>
<li><a href="#åŸºæœ¬ä½¿ç”¨">åŸºæœ¬ä½¿ç”¨</a>
<ul>
<li><a href="#kubectl">kubectl</a></li>
<li><a href="#yamlæ–‡ä»¶è¯¦è§£">yamlæ–‡ä»¶è¯¦è§£</a></li>
<li><a href="#è¿ç§»">è¿ç§»</a></li>
<li><a href="#ç®¡ç†">ç®¡ç†</a>
<ul>
<li><a href="#ç‰ˆæœ¬å·ç®¡ç†">ç‰ˆæœ¬å·ç®¡ç†</a></li>
</ul></li>
<li><a href="#é—®é¢˜å¤„ç†">é—®é¢˜å¤„ç†</a></li>
</ul></li>
<li><a href="#k8såŸç†">k8såŸç†</a></li>
</ul>
</nav>
        </div>
</aside>

    </div>
</div>

</div>
<hr>

<footer class="container copy">
    <p>&copy; 2021  kingjcy blog </p>
	<p>Powered by <a href="https://gohugo.io" target="_blank">Hugo</a></p>
</footer>

<script>hljs.initHighlightingOnLoad();</script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?ace3ec99de96c4080ead1eb8d52db3b3";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-92600390-2', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

