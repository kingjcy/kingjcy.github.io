<!DOCTYPE html>

<html lang="zh-cn">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="author" content="fatedier">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="description" content="etcd operator管理部署到Kubernetes的 etcd集群，并自动执行与操作etcd集群相关的任务(创建，销毁，调整，故障转移，滚动升级，备份还原)。">
<meta property="og:url" content="https://kingjcy.github.io/"><meta property="og:type" content="article">
<meta property="og:title" content="云计算数据库系列---- etcd-operator - kingjcy blog"><meta property="og:site_name" content="kingjcy blog">

<title>
    
    云计算数据库系列---- etcd-operator
    
</title>

<link rel="stylesheet" href="/onlyone/onlyone.css">
<link rel="shortcut icon" href="/assets/favicon.ico">
<script src="/onlyone/onlyone.js"></script>
<link rel="alternate" type="application/rss+xml" title="RSS" href="/index.xml">
</head>
<body>


<div class="container">
    <header class="nav">
        <nav class="navbar navbar-default">
            <div class="container-fluid">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="/">kingjcy blog</a>
                </div>

                <div class="collapse navbar-collapse" id="navbar-collapse">
                    <ul class="nav navbar-nav">
                        <li><a href="/categories/技术文章/">技术文章</a></li>
			<li><a href="/categories/读书笔记/">读书笔记</a></li>
                        <li><a href="/categories/人生感悟/">人生感悟</a></li>
                        <li><a href="/categories/">归档</a></li>
                        <li><a href="/tags/">分类</a></li>
                        <li><a href="/about/">关于我</a></li>
                        <li>
                            <form method="get" style="padding: 8px" action="https://www.google.com/search" target="_blank">
                                <input type="hidden" name="sitesearch" value="https://kingjcy.github.io/"/>
                                <input type="text" class="form-control" name="q" placeholder="Press enter to search">
                            </form>
                        </li>
                    </ul>

                </div>
            </div>
        </nav>
    </header>


<div class="row">
    <div class="col-md-8">
        <article class="post single">

            <header>
                <div class="post-date">
                    2019年05月04日 
                </div>
                <h1 class="post-title">云计算数据库系列---- etcd-operator</h1>
            </header>

            <div class="post-content">
                <p>etcd operator管理部署到Kubernetes的 etcd集群，并自动执行与操作etcd集群相关的任务(创建，销毁，调整，故障转移，滚动升级，备份还原)。</p>

<h1 id="安装">安装</h1>

<p>安装etcd-opertaor</p>

<pre><code>rpm -ivh etcd-operator-1.0.0-1.el7.x86_64.rpm          // 安装rpm包
rpm -qa | grep etcd-operator                            // 检查rpm包是否安装成功
</code></pre>

<p>创建etcdtask crd和etcdcluster crd对象</p>

<p>将etcdtask-crd.yaml和etcdcluster-crd.yaml文件拷贝至目标服务器，文件见附件</p>

<pre><code>kubectl create -f etcdtask-crd.yaml                           // 创建etcdtask对象
kubectl create -f etcdcluster-crd.yaml                        // 创建etcdcluster对象
kubectl get crd | grep etcdtasks.extensions.sncloud.com       // 检查etcdtask对象是否建立成功
kubectl get crd | grep etcdclusters.extensions.sncloud.com    // 检查etcdcluster对象是否建立成功
</code></pre>

<p>启动etcd-operator服务</p>

<pre><code>systemctl enable etcd-operator          // 启动etcd-operator服务
systemctl start etcd-operator          // 启动etcd-operator服务
systemctl status etcd-operator         // 查看etcd-operator服务状态，确定状态为running。
</code></pre>

<h1 id="基本概念">基本概念</h1>

<p>etcd-operator 所包含的几个自定义资源对象(CRDs):</p>

<ul>
<li>EtcdCluster : etcdcluster 用来描述用户自定义的 etcd 集群，可一键式部署和配置一个相关的 etcd 集群。</li>
<li>EtcdBackup : etcdbackup 用来描述和管理一个 etcd 集群的备份，当前支持定期备份到云端存储，如 AWS s3, Aliyun oss(oss 当前需使用 quay.io/coreos/etcd-operator:dev 镜像)。</li>
<li>EtcdRestore: etcdrestore 用来帮助将 etcdbackup 服务所创建的备份恢复到一个指定的 etcd 的集群。</li>
</ul>

<h1 id="基本使用">基本使用</h1>

<h2 id="创建etcd集群">创建etcd集群</h2>

<p>使用EtcdCluster来创建</p>

<pre><code>cat &lt;&lt;EOF | kubectl apply -f -
apiVersion: etcd.database.coreos.com/v1beta2
kind: EtcdCluster
metadata:
  name: &quot;etcd-cluster&quot;
spec:
  size: 3 # 默认etcd节点数
  version: &quot;3.2.25&quot; # etcd版本号
EOF
</code></pre>

<p>查看</p>

<pre><code>$ kubectl get etcdcluster
NAME            AGE
etcd-cluster    2m

$ kubectl get pod
NAME                     READY   STATUS  RESTARTS AGE
etcd-cluster-g28f552vvx  1/1   Running    0      2m
etcd-cluster-lpftgqngl8  1/1   Running    0      2m
etcd-cluster-sdpcfrtv99  1/1   Running    0      2m
</code></pre>

<h2 id="备份">备份</h2>

<p>下面以阿里云的 OSS 举例</p>

<pre><code>cat &lt;&lt;EOF | kubectl apply -f -
apiVersion: etcd.database.coreos.com/v1beta2
kind: EtcdBackup
metadata:
  name: example-etcd-cluster-periodic-backup
spec:
  etcdEndpoints: [http://etcd-cluster-client:2379] #内网可使用svc地址，外网可用NodePort或LB代理地址
  storageType: OSS
  backupPolicy:
    backupIntervalInSecond: 120 #备份时间间隔
    maxBackups: 4 #最大备份数
  oss:
    path: my-bucket/etcd.backup
    ossSecret: oss-secret #需预先创建oss secret
    endpoint: oss-cn-hangzhou.aliyuncs.com
EOF
</code></pre>

<p>待 etcdbackup 创建成功后，用户可以通过 kubectl describe etcdbackup 或查看 etcd-backup controller 日志来查看备份状态，如状态显示为 Succeeded: true，可以前往 oss 查看具体的备份内容。</p>

<h2 id="恢复">恢复</h2>

<p>假设我们要将 etcd 集群 A 的备份数据恢复到另一个新的 etcd 集群 B，那么我们先手动创建一个名为 etcd-cluster2 的新集群(oss 备份/恢复当前需使用 quay.io/coreos/etcd-operator:dev 镜像)。</p>

<pre><code>cat &lt;&lt;EOF | kubectl apply -f -
apiVersion: etcd.database.coreos.com/v1beta2
kind: EtcdCluster
metadata:
  name: &quot;etcd-cluster2&quot;
spec:
  size: 3
  version: &quot;3.2.25&quot;
EOF
</code></pre>

<p>然后通过创建 etcdresotre 将备份数据恢复到 etcd-cluster2 集群</p>

<pre><code>cat &lt;&lt;EOF | kubectl apply -f -
apiVersion: etcd.database.coreos.com/v1beta2
kind: EtcdRestore
metadata:
  # name必须与下面的spec.etcdCluster.name保持一致
  name: etcd-cluster2
spec:
  etcdCluster:
    name: etcd-cluster2
  backupStorageType: OSS
  oss:
    path: my-bucket/etcd.backup_v1_2019-08-07-06:44:17
    ossSecret: oss-secret
    endpoint: oss-cn-hangzhou.aliyuncs.com
EOF
</code></pre>

<p>待 etcdresotre 对象创建成功后，可以查看 etcd-operator-restore 的日志，大致内容如下，</p>

<pre><code>$ kubectl logs -f etcd-operator-restore
...
time=&quot;2019-08-07T06:50:26Z&quot; level=info msg=&quot;listening on 0.0.0.0:19999&quot;
time=&quot;2019-08-07T06:50:26Z&quot; level=info msg=&quot;starting restore controller&quot; pkg=controller
time=&quot;2019-08-07T06:56:25Z&quot; level=info msg=&quot;serving backup for restore CR etcd-cluster2&quot;
</code></pre>

<h1 id="实战">实战</h1>

<h2 id="创建备份任务-立即备份-定时备份-根据实际需求去选择">创建备份任务（立即备份、定时备份，根据实际需求去选择）</h2>

<h3 id="立即备份">立即备份</h3>

<p>根据需求修改backup-now.yaml文件</p>

<pre><code>$ cat backup-now.yaml

apiVersion: extensions.sncloud.com/v1beta1
kind: EtcdTask
metadata:
  name: backup-now-052701           #命名规则待定
  namespace: kube-system
spec:
  type: backup                      #任务类型，包括backup、restore
  backup:
    backupSpec:                     #备份信息
      etcdCluster: etcd-cluster     #需要备份的etcd集群的EtcdCluster名称
      storageType: OSS              #备份类型，暂时只支持OSS和Local
      backupPolicy:                            #备份策略
        backupCron: &quot;0&quot;             #定时备份，用crontab格式设置
        localMaxBackups: 10                       #本地最大备份份数
        remoteMaxBackups: 10                    #远端最大备份份数
</code></pre>

<p>创建立即备份任务</p>

<pre><code>kubectl create -f backup-now.yaml     // 创建立即备份任务

kubectl get etcdtask -n kube-system | grep &lt;back-task-name&gt;   // 检查备份任务是否创建成功
kubectl describe etcdtask -n kube-system  &lt;back-task-name&gt;    // 查看备份任务结果
</code></pre>

<h3 id="定时备份任务">定时备份任务</h3>

<p>根据需求修改backup.yaml文件</p>

<pre><code>$ cat backup.yaml

apiVersion: extensions.sncloud.com/v1beta1
kind: EtcdTask
metadata:
  name: backup-cron-052602           #命名规则待定
  namespace: kube-system
spec:
  type: backup                      #任务类型，包括backup、restore
  backup:
    backupSpec:                        #备份信息
      etcdCluster: etcd-cluster     #需要备份的etcd集群的EtcdCluster名称
      storageType: OSS              #备份类型，暂时只支持OSS和Local
      backupPolicy:                                #备份策略
        backupCron: &quot;0 */10 * * * ?&quot;       #定时备份，用crontab格式设置
        localMaxBackups: 10                       #本地最大备份份数
        remoteMaxBackups: 20                    #远端最大备份份数
</code></pre>

<p>创建定时备份任务</p>

<pre><code>kubectl create -f  backup.yaml                                // 创建定时备份任务

kubectl get etcdtask -n kube-system | grep &lt;back-task-name&gt;   // 检查备份任务是否创建成功
kubectl describe etcdtask -n kube-system  &lt;back-task-name&gt;    // 查看备份任务结果
</code></pre>

<h2 id="创建恢复任务">创建恢复任务</h2>

<p>查看备份文件列表</p>

<pre><code>cat /var/lib/etcd_backup/etcd-cluster.meta   // 查看备份元数据
</code></pre>

<p>停止服务</p>

<pre><code>在集群的所有master节点执行如下命令

$  systemctl stop etcd-operator; systemctl stop etcd; systemctl stop kube-apiserver
</code></pre>

<p>etcd数据恢复</p>

<p>在所有的master节点上执行命令，根据提示操作，会提示确认是否停止，停止完毕则输入yes,其中etcd-data-2020-11-12_22_0_0.tar文件换成所有恢复到的版本文件</p>

<p>使用本地备份文件恢复，使用本地备份文件恢复，确认所有master节点存在备份文件</p>

<pre><code>$ etcd-operator  -restore=true -restore.file=etcd-data-2020-11-12_22_0_0.tar -restore.metafile=/var/lib/etcd_backup/etcd-cluster.meta  -restore.type=local
</code></pre>

<p>使用远端oss备份文件进行恢复</p>

<pre><code>$ etcd-operator  -restore=true -restore.file=etcd-data-2020-11-12_22_0_0.tar -restore.metafile=/var/lib/etcd_backup/etcd-cluster.meta  -restore.type=oss
</code></pre>

<p>恢复服务</p>

<p>在所有的master节点执行命令</p>

<pre><code>$  systemctl start etcd; systemctl start kube-apiserver;systemctl start etcd-operator
$  systemctl status etcd; systemctl status kube-apiserver;systemctl status etcd-operator
</code></pre>

<h2 id="手动使用备份文件恢复etcd">手动使用备份文件恢复ETCD</h2>

<p>若集群etcd出错，需要使用备份文件来恢复数据时，可按以下步骤操作：</p>

<p>使用本地备份恢复etcd</p>

<ul>
<li>在集群的每个master节点上的 /var/lib/etcd_backup 目录下，有etcd的备份文件，文件的命名规则是 etcd-year-month-day-hour-minute-second.tar ，可以从 文件名中看出备份的时间；</li>
<li>找到需要的备份文件；</li>
<li>使用 tar zxvf xxx.tar 命令解压；</li>
<li>将解压出来的etcd.conf 和 etcd.service 和 etcd_snapshot.db 文件拷贝到每个 master 节点上；</li>
<li>停止每个master节点的apiserver 和 etcd 服务  systemctl stop kube-apiserver  ;   kubectl stop etcd;</li>
<li>删除 /var/lib/etcd/default.etcd 目录 rm -rf /var/lib/etcd/default.etcd/ ； 如果etcd的配置文件或服务文件丢失，将etcd.conf拷贝至/etc/etcd/目录下，将etcd.service 拷贝至/usr/lib/systemd/system/下；etcd.conf中  ETCD_LISTEN_PEER_URLS 、 ETCD_LISTEN_CLIENT_URLS 、 ETCD_INITIAL_ADVERTISE_PEER_URLS 、 ETCD_ADVERTISE_CLIENT_URLS 需要按照拷贝到的节点ip进行相应的修改；(在每个master节点上执行)</li>

<li><p>使用如下命令进行数据的恢复， 其中的一些参数可在etcd.conf配置文件中得到：（在每个master节点上执行）</p>

<pre><code> ETCDCTL_API=3 /usr/bin/etcdctl \
snapshot restore etcd_snapshot.db \
--name $ETCD_NAME \
--data-dir /var/lib/etcd/default.etcd/ \
--initial-cluster $ETCD_INITIAL_CLUSTER \
--initial-cluster-token $ETCD_INITIAL_CLUSTER_TOKEN \
--initial-advertise-peer-urls $ETCD_INITIAL_ADVERTISE_PEER_URLS \
--cacert=$ETCD_CA_PEM --cert=$ETCD_ETCD_PEM --key=$ETCD_ETCDKEY_PEM
</code></pre></li>

<li><p>修改etcd数据目录权限：   chown etcd:etcd -R /var/lib/etcd/default.etcd/   （在每个master节点上执行）</p></li>

<li><p>启动每个master节点的 apiserver和etcd服务：  systemctl start etcd ;  systemctl start kube-apiserver ;</p></li>
</ul>
            </div>
            
            <div style="border: 1px dashed #e0e0e0; margin-bottom: 15px; padding: 10px 10px 10px 10px; background-color: #fffeee; background-repeat: no-repeat; background-attachment: scroll; background-position: 1% 50%; -moz-background-size: auto auto; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial;">
                <div>
                    <p style="margin-top:0px;">作者：<a target="_blank" href="https://kingjcy.github.io/">kingjcy</a>
                    <br />本文出处：<a target="_blank" href="https://kingjcy.github.io/post/cloud/paas/db/etcd-operator/">https://kingjcy.github.io/post/cloud/paas/db/etcd-operator/</a>
                    <br />
                    文章版权归本人所有，欢迎转载，但未经作者同意必须保留此段声明，且在文章页面明显位置给出原文链接，否则保留追究法律责任的权利。 </p>
                </div>
            </div>

            <aside>
                
                <ul class="list-inline post-tags">
                    
                    <li>
                        <a href="/tags/paas/">
                            <i class="fa fa-tags"></i>
                            paas
                        </a>
                    </li>
                    
                    <li>
                        <a href="/tags/db/">
                            <i class="fa fa-tags"></i>
                            db
                        </a>
                    </li>
                    
                    <li>
                        <a href="/tags/etcd/">
                            <i class="fa fa-tags"></i>
                            etcd
                        </a>
                    </li>
                    
                    <li>
                        <a href="/tags/cloudnative/">
                            <i class="fa fa-tags"></i>
                            cloudnative
                        </a>
                    </li>
                    
                    <li>
                        <a href="/tags/operator/">
                            <i class="fa fa-tags"></i>
                            operator
                        </a>
                    </li>
                    
                </ul>

                
                
                <h4 id="real-rels">相关文章</h4>
                <ul class="post-rels" id="real-rels"><li id="li-rels"><a href="/post/cloud/paas/base/kubernetes/k8s-autoscaler/">云计算K8s系列---- K8s autoscaler</a>&nbsp;&nbsp;<span class="post-date" style="font-size:14px">&nbsp;(2021年02月04日)</span></li><li id="li-rels"><a href="/post/cloud/paas/base/kubernetes/k8s-kruise/">云计算K8s系列---- kruise</a>&nbsp;&nbsp;<span class="post-date" style="font-size:14px">&nbsp;(2021年01月17日)</span></li><li id="li-rels"><a href="/post/cloud/paas/base/kubernetes/k8s-network-cni/">云计算K8s系列---- 网络CNI</a>&nbsp;&nbsp;<span class="post-date" style="font-size:14px">&nbsp;(2021年01月17日)</span></li><li id="li-rels"><a href="/post/cloud/paas/base/kubernetes/k8s-controller/">云计算K8s系列---- K8s controller</a>&nbsp;&nbsp;<span class="post-date" style="font-size:14px">&nbsp;(2020年11月24日)</span></li><li id="li-rels"><a href="/post/cloud/paas/base/kubernetes/k8s-apiserver/">云计算K8s组件系列（一）---- K8s apiserver 详解</a>&nbsp;&nbsp;<span class="post-date" style="font-size:14px">&nbsp;(2020年10月24日)</span></li><li id="li-rels"><a href="/post/cloud/paas/base/kubernetes/k8s-kubelet/">云计算K8s组件系列（四）---- K8s kubelet 详解</a>&nbsp;&nbsp;<span class="post-date" style="font-size:14px">&nbsp;(2020年10月20日)</span></li><li id="li-rels"><a href="/post/cloud/paas/base/docker/docker-network/">云计算容器系列---- Docker network</a>&nbsp;&nbsp;<span class="post-date" style="font-size:14px">&nbsp;(2020年10月14日)</span></li><li id="li-rels"><a href="/post/cloud/paas/base/kubernetes/k8s-proxy/">云计算K8s组件系列（五）---- K8s proxy 详解</a>&nbsp;&nbsp;<span class="post-date" style="font-size:14px">&nbsp;(2020年10月13日)</span></li><li id="li-rels"><a href="/post/cloud/paas/base/kubernetes/k8s-scheduler/">云计算K8s组件系列（二）---- K8s scheduler 详解</a>&nbsp;&nbsp;<span class="post-date" style="font-size:14px">&nbsp;(2020年09月24日)</span></li><li id="li-rels"><a href="/post/cloud/cncf/">云计算系列---- 云计算概念</a>&nbsp;&nbsp;<span class="post-date" style="font-size:14px">&nbsp;(2020年09月02日)</span></li></ul>
            </aside>
                
            
            <footer>
                <nav>
                    <ul class="pager">

                        
                        <li class="previous"><a href="/post/distributed/distributed-config/"><span aria-hidden="true">&larr;</span> Prev</a></li>
                        

                        <li><a href="/post/">All Posts</a></li>

                        
                        <li class="next"><a href="/post/middleware/serverdiscovery/zookeeper/">Next <span aria-hidden="true">&rarr;</span></a></li>
                        

                    </ul>
                </nav>
            </footer>

        </article>
    </div>
    <div class="col-md-4">
        
<aside>
        <div class="toc panel panel-default hidden-xs hidden-sm affix-top" data-spy="affix" data-offset-top="125" data-offset-bottom="300">
            <div class="panel-heading">
                <h2 class="panel-title">Catalog</h2>
            </div>

            <nav id="TableOfContents">
<ul>
<li><a href="#安装">安装</a></li>
<li><a href="#基本概念">基本概念</a></li>
<li><a href="#基本使用">基本使用</a>
<ul>
<li><a href="#创建etcd集群">创建etcd集群</a></li>
<li><a href="#备份">备份</a></li>
<li><a href="#恢复">恢复</a></li>
</ul></li>
<li><a href="#实战">实战</a>
<ul>
<li><a href="#创建备份任务-立即备份-定时备份-根据实际需求去选择">创建备份任务（立即备份、定时备份，根据实际需求去选择）</a>
<ul>
<li><a href="#立即备份">立即备份</a></li>
<li><a href="#定时备份任务">定时备份任务</a></li>
</ul></li>
<li><a href="#创建恢复任务">创建恢复任务</a></li>
<li><a href="#手动使用备份文件恢复etcd">手动使用备份文件恢复ETCD</a></li>
</ul></li>
</ul>
</nav>
        </div>
</aside>

    </div>
</div>

</div>
<hr>

<footer class="container copy">
    <p>&copy; 2021  kingjcy blog </p>
	<p>Powered by <a href="https://gohugo.io" target="_blank">Hugo</a></p>
</footer>

<script>hljs.initHighlightingOnLoad();</script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?ace3ec99de96c4080ead1eb8d52db3b3";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-92600390-2', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

