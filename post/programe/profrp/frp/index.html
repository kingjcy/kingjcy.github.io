<!DOCTYPE html>

<html lang="zh-cn">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="author" content="fatedier">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="description" content="frp 是一个高性能的反向代理应用，可以帮助您轻松地进行内网穿透，对外网提供服务，支持 tcp, udp, http, https 等协议类型，并且 web 服务支持根据域名进行路由转发。">
<meta property="og:url" content="https://kingjcy.github.io/"><meta property="og:type" content="article">
<meta property="og:title" content="项目系列---- Frp - kingjcy blog"><meta property="og:site_name" content="kingjcy blog">

<title>
    
    项目系列---- Frp
    
</title>

<link rel="stylesheet" href="/onlyone/onlyone.css">
<link rel="shortcut icon" href="/assets/favicon.ico">
<script src="/onlyone/onlyone.js"></script>
<link rel="alternate" type="application/rss+xml" title="RSS" href="/index.xml">
</head>
<body>


<div class="container">
    <header class="nav">
        <nav class="navbar navbar-default">
            <div class="container-fluid">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="/">kingjcy blog</a>
                </div>

                <div class="collapse navbar-collapse" id="navbar-collapse">
                    <ul class="nav navbar-nav">
                        <li><a href="/categories/技术文章/">技术文章</a></li>
                        <li><a href="/categories/读书笔记/">读书笔记</a></li>
                        <li><a href="/categories/人生感悟/">人生感悟</a></li>
                        <li><a href="/tags/">分类</a></li>
                        <li><a href="/about/">关于我</a></li>
                        <li>
                            <form method="get" style="padding: 8px" action="https://www.google.com/search" target="_blank">
                                <input type="hidden" name="sitesearch" value="kingjcy.github.io"/>
                                <input type="text" class="form-control" name="q" placeholder="Press enter to search">
                            </form>
                        </li>
                    </ul>

                </div>
            </div>
        </nav>
    </header>


<div class="row">
    <div class="col-md-8">
        <article class="post single">

            <header>
                <div class="post-date">
                    2016年06月17日 
                </div>
                <h1 class="post-title">项目系列---- Frp</h1>
            </header>

            <div class="post-content">
                <p>frp 是一个高性能的反向代理应用，可以帮助您轻松地进行内网穿透，对外网提供服务，支持 tcp, udp, http, https 等协议类型，并且 web 服务支持根据域名进行路由转发。</p>

<h2 id="安装">安装</h2>

<p>首先需要安装go语言环境，然后可以直接使用go工具来下载安装</p>

<pre><code>go get github.com/fatedier/frp
make
</code></pre>

<p>就会在对应的bin文件中产生可执行文件，在对应的conf下有对应的配置文件</p>

<h2 id="基本使用">基本使用</h2>

<h3 id="ssh内网穿透">ssh内网穿透</h3>

<ol>
<li><p>修改 frps.ini 文件，配置一个名为 ssh 的反向代理：</p>

<h1 id="frps-ini">frps.ini</h1>

<p>[common]
bind_port = 7000</p>

<p>[ssh]
listen_port = 6000
auth_token = 123</p></li>

<li><p>启动 frps：</p>

<p>./frps -c ./frps.ini</p></li>

<li><p>修改 frpc.ini 文件，设置 frps 所在服务器的 IP 为 x.x.x.x；</p>

<p>#frpc.ini
[common]
server_addr = x.x.x.x
server_port = 7000
auth_token = 123</p>

<p>[ssh]
local_ip = 127.0.0.1
local_port = 22</p></li>

<li><p>启动 frpc：</p>

<p>./frpc -c ./frpc.ini</p></li>

<li><p>通过 ssh 访问内网机器，假设用户名为 test：</p>

<p>ssh -oPort=6000 test@x.x.x.x</p></li>
</ol>

<h3 id="通过自定义域名访问部署于内网的-web-服务">通过自定义域名访问部署于内网的 web 服务</h3>

<p>有时想要让其他人通过域名访问或者测试我们在本地搭建的 web 服务，但是由于本地机器没有公网 IP，无法将域名解析到本地的机器，通过 frp 就可以实现这一功能，以下示例为 http 服务，https 服务配置方法相同， vhost_http_port 替换为 vhost_https_port， type 设置为 https 即可。</p>

<p>修改 frps.ini 文件，设置 http 访问端口为 8080：</p>

<pre><code># frps.ini
[common]
bind_port = 7000
vhost_http_port = 8080
</code></pre>

<p>这边可以端口复用，也就是</p>

<pre><code>vhost_http_port = 7000
</code></pre>

<p>启动 frps；</p>

<pre><code>./frps -c ./frps.ini
</code></pre>

<p>修改 frpc.ini 文件，假设 frps 所在的服务器的 IP 为 x.x.x.x，local_port 为本地机器上 web 服务对应的端口, 绑定自定义域名 www.yourdomain.com:</p>

<pre><code># frpc.ini
[common]
server_addr = x.x.x.x
server_port = 7000

[web]
type = http
local_port = 80
custom_domains = www.yourdomain.com
</code></pre>

<p>启动 frpc：</p>

<pre><code>./frpc -c ./frpc.ini
</code></pre>

<p>在你访问网址的机器需要 www.yourdomain.com 的域名 A 记录解析到 IP x.x.x.x，（可以直接设置/etc/hosts）如果服务器已经有对应的域名，也可以将 CNAME 记录解析到服务器原先的域名。</p>

<p>通过浏览器访问 <a href="http://www.yourdomain.com:8080">http://www.yourdomain.com:8080</a> 即可访问到处于内网机器上的 web 服务。</p>

<p>A记录是域名到ip的映射，即为ip起别名；CNAME是域名别名到域名的映射，即为域名起别名。</p>

<h1 id="代码详解">代码详解</h1>

<blockquote>
<p>所有的代码核心在于双向拷贝流量。</p>
</blockquote>

<ol>
<li>ssh代码的实现</li>
</ol>

<p>*客户端和服务端建立连接，各启动一个gorutine来接受和发送消息，分别使用channel：sendch和readch</p>

<p>*相互通信完成了login，ping，proxy等工作</p>

<p>*login是客户端发送一个login的结构体，包含一个基本信息，然后服务端接收到后进行解析，返回一个logreq的结构体，同时两端接连一个连接，同时启动好对应的首发gouroutine，来处理后的事情，同时还初始化了一个工作连接池，用于后面的数据传输</p>

<p>*ping就是客户端发送一个ping，服务端返回一个pong的结构体</p>

<p>*proxy就是客户端根据配置来发送相关请求，来建立代理，客户端本身建立一个和22端口的本地连接，服务端则等待用户建立制定端口的连接，连接建立，则想用户连接的内容copubuffer到获取的work连接，然后客户端再将工作连接的内容copubuffer到本地连接中，一条线，反之亦然。完成ssh的反向代理。</p>

<p>*使用tcp的多路复用，在客户端和服务端建立连接，就会创建一个ctl，在ctl中有两个channel，一个发送，一个接收，然后建立一个ssh连接就会重连接池中拿一个stream使用，新建一个stream放入池中，所有的straem公用这个channel。</p>

<p>其他的都可以参考这个流程</p>

<ol>
<li>plugin解析</li>
</ol>

<p>plugin是在客户端做的一层应用扩展，相当于在客户端收到请求后的一种扩展处理模式。</p>
            </div>
            
            <div style="border: 1px dashed #e0e0e0; margin-bottom: 15px; padding: 10px 10px 10px 10px; background-color: #fffeee; background-repeat: no-repeat; background-attachment: scroll; background-position: 1% 50%; -moz-background-size: auto auto; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial;">
                <div>
                    <p style="margin-top:0px;">作者：<a target="_blank" href="http://blog.fatedier.com/">kingjcy</a>
                    <br />本文出处：<a target="_blank" href="https://kingjcy.github.io/post/programe/profrp/frp/">https://kingjcy.github.io/post/programe/profrp/frp/</a>
                    <br />
                    文章版权归本人所有，欢迎转载，但未经作者同意必须保留此段声明，且在文章页面明显位置给出原文链接，否则保留追究法律责任的权利。 </p>
                </div>
            </div>

            <aside>
                
                <ul class="list-inline post-tags">
                    
                    <li>
                        <a href="/tags/frp/">
                            <i class="fa fa-tags"></i>
                            Frp
                        </a>
                    </li>
                    
                    <li>
                        <a href="/tags/programe/">
                            <i class="fa fa-tags"></i>
                            programe
                        </a>
                    </li>
                    
                </ul>

                
                
                <h4 id="real-rels">相关文章</h4>
                <ul class="post-rels" id="real-rels"><li id="li-rels"><a href="/post/programe/tracechain/datacollector/">项目系列---- DataTransfer</a>&nbsp;&nbsp;<span class="post-date" style="font-size:14px">&nbsp;(2019年08月30日)</span></li></ul>
            </aside>
                
            
            <footer>
                <nav>
                    <ul class="pager">

                        
                        <li class="previous"><a href="/post/golang/go-path/"><span aria-hidden="true">&larr;</span> Prev</a></li>
                        

                        <li><a href="/post/">All Posts</a></li>

                        
                        <li class="next"><a href="/post/architecture/cache/">Next <span aria-hidden="true">&rarr;</span></a></li>
                        

                    </ul>
                </nav>
            </footer>

        </article>
    </div>
    <div class="col-md-4">
        
<aside>
        <div class="toc panel panel-default hidden-xs hidden-sm affix-top" data-spy="affix" data-offset-top="125" data-offset-bottom="300">
            <div class="panel-heading">
                <h2 class="panel-title">Catalog</h2>
            </div>

            <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#安装">安装</a></li>
<li><a href="#基本使用">基本使用</a>
<ul>
<li><a href="#ssh内网穿透">ssh内网穿透</a></li>
</ul></li>
</ul></li>
<li><a href="#frps-ini">frps.ini</a>
<ul>
<li>
<ul>
<li><a href="#通过自定义域名访问部署于内网的-web-服务">通过自定义域名访问部署于内网的 web 服务</a></li>
</ul></li>
</ul></li>
<li><a href="#代码详解">代码详解</a></li>
</ul>
</nav>
        </div>
</aside>

    </div>
</div>

</div>
<hr>

<footer class="container copy">
    <p>&copy; 2020  kingjcy blog </p>
	<p>Powered by <a href="https://gohugo.io" target="_blank">Hugo</a></p>
</footer>

<script>hljs.initHighlightingOnLoad();</script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?ace3ec99de96c4080ead1eb8d52db3b3";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-92600390-2', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

